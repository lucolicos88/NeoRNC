<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- TASK-005: Content Security Policy (Phase 1 - com 'unsafe-inline') -->
    <!-- TASK-007: Report-URI para monitoramento de viola√ß√µes CSP -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https://script.google.com https://script.googleusercontent.com;
        script-src 'self' 'unsafe-inline'
            https://cdn.jsdelivr.net
            https://cdnjs.cloudflare.com
            https://script.google.com
            https://script.googleusercontent.com;
        style-src 'self' 'unsafe-inline'
            https://fonts.googleapis.com;
        font-src 'self'
            https://fonts.gstatic.com;
        img-src 'self' data: https:;
        connect-src 'self'
            https://cdn.jsdelivr.net
            https://cdnjs.cloudflare.com
            https://script.google.com
            https://script.googleusercontent.com;
        report-uri /csp-report;
    ">

    <title>RNC ‚Ä¢ Neoformula</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìã</text></svg>">

    <!-- ‚ú® APEXCHARTS - Biblioteca de Gr√°ficos Modernos -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>

    <!-- ‚ú® PDFMAKE - Gera√ß√£o Profissional de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>

/* ========================================
   SISTEMA MULTISELECT COM CHIPS/TAGS
   VERS√ÉO 4.0 - CORES PADR√ÉO DO APP
   ======================================== */

.multiselect-wrapper {
    margin-bottom: 20px;
    position: relative;
    z-index: 1;
}

.multiselect-wrapper label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
    font-size: 14px;
}

/* ‚úÖ Container de Chips - FUNDO BRANCO */
.chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    min-height: 50px;
    padding: 10px;
    border: 1px solid #ddd;  /* ‚úÖ Borda igual aos outros inputs */
    border-radius: 4px;      /* ‚úÖ Border radius padr√£o */
    background: #ffffff;     /* ‚úÖ FUNDO BRANCO */
    margin-bottom: 12px;
    transition: all 0.3s;
}

.chips-container:hover {
    border-color: #009688;
}

.chips-container:focus-within {
    border-color: #009688;
    box-shadow: 0 0 0 0.2rem rgba(0, 150, 136, 0.1);
}

/* Container vazio */
.chips-container.empty {
    border-style: dashed;
    border-color: #ccc;
    background: #fafafa;
    justify-content: center;
    align-items: center;
}

.chips-container.empty::after {
    content: 'Nenhuma op√ß√£o selecionada';
    color: #999;
    font-size: 13px;
    font-style: italic;
}

/* ‚úÖ Chips - Verde do sistema */
.chip {
    background: linear-gradient(135deg, #009688 0%, #00796b 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 16px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0, 150, 136, 0.2);
    transition: all 0.2s;
    animation: chipAppear 0.3s ease;
}

@keyframes chipAppear {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.chip:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 150, 136, 0.3);
}

.chip button {
    background: rgba(255, 255, 255, 0.3);
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;
    padding: 0;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    line-height: 1;
}

.chip button:hover {
    background: rgba(255, 255, 255, 0.5);
    transform: rotate(90deg);
}

/* ‚úÖ Select - IGUAL AOS OUTROS CAMPOS DO SISTEMA */
.multiselect-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;              /* ‚úÖ Mesma borda */
    border-radius: 4px;                  /* ‚úÖ Mesmo border radius */
    font-size: 14px;                     /* ‚úÖ Mesmo tamanho de fonte */
    background: #ffffff;                 /* ‚úÖ FUNDO BRANCO */
    color: #333;                         /* ‚úÖ Texto escuro */
    cursor: pointer;
    transition: all 0.3s;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    margin-bottom: 8px;
    height: 40px;                        /* ‚úÖ Mesma altura dos outros inputs */
    line-height: 1.5;
}

.multiselect-select:hover {
    border-color: #009688;
}

.multiselect-select:focus {
    outline: none;
    border-color: #009688;
    box-shadow: 0 0 0 0.2rem rgba(0, 150, 136, 0.1);
}

.multiselect-select:disabled {
    background: #e9ecef;
    cursor: not-allowed;
    opacity: 0.6;
}

/* ‚úÖ Op√ß√µes do dropdown - FUNDO BRANCO */
.multiselect-select option {
    background: #ffffff;     /* ‚úÖ FUNDO BRANCO */
    color: #333;            /* ‚úÖ Texto escuro */
    padding: 8px 12px;
}

.multiselect-select option:hover {
    background: #f8f9fa;    /* ‚úÖ Hover suave */
}

.multiselect-select option:checked {
    background: #009688;    /* ‚úÖ Selecionado verde */
    color: white;
}

/* Hint text */
.multiselect-hint {
    display: block;
    font-size: 12px;
    color: #6c757d;
    font-style: italic;
    margin-top: 4px;
}

/* ‚úÖ Campo obrigat√≥rio vazio */
.multiselect-wrapper.required .chips-container.empty {
    border-color: #ffc107;
    background: #fff3cd;
}

.multiselect-wrapper.required .chips-container.empty::after {
    content: '‚ö†Ô∏è Campo obrigat√≥rio - selecione ao menos uma op√ß√£o';
    color: #856404;
}

/* ‚úÖ Garantir que n√£o sobreponha outros campos */
.multiselect-wrapper {
    margin-bottom: 25px;
}

textarea.form-control,
.form-control {
    position: relative;
    z-index: 2;
}

/* ‚úÖ Badge de somente leitura */
.multiselect-wrapper .badge-readonly {
    display: inline-block;
    padding: 2px 8px;
    background: #6c757d;
    color: white;
    font-size: 11px;
    border-radius: 12px;
    margin-left: 8px;
    font-weight: normal;
}

/* ‚úÖ Campo somente leitura */
.multiselect-wrapper.field-readonly .chips-container {
    background: #e9ecef;
    cursor: not-allowed;
}

.multiselect-wrapper.field-readonly .chip button {
    display: none;  /* Esconder bot√£o X em modo somente leitura */
}

/* Responsivo */
@media (max-width: 768px) {
    .chip {
        font-size: 11px;
        padding: 5px 10px;
    }
    
    .multiselect-select {
        font-size: 13px;
    }
}

/* ‚úÖ REMOVER qualquer estilo de tema escuro que possa estar interferindo */
@media (prefers-color-scheme: dark) {
    .chips-container,
    .multiselect-select,
    .multiselect-select option {
        background: #ffffff !important;  /* For√ßar branco */
        color: #333 !important;          /* For√ßar texto escuro */
    }
}

/* ‚úÖ Garantir que o select dropdown n√£o seja transparente */
.multiselect-select::-webkit-scrollbar {
    width: 8px;
}

.multiselect-select::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.multiselect-select::-webkit-scrollbar-thumb {
    background: #009688;
    border-radius: 4px;
}

.multiselect-select::-webkit-scrollbar-thumb:hover {
    background: #00796b;
}


      /* ===== SISTEMA DE PERMISS√ïES - Deploy 32 ===== */
/* Campo somente leitura */
.field-readonly {
    position: relative;
}

.field-readonly input,
.field-readonly textarea,
.field-readonly select {
    background-color: #f5f5f5 !important;
    border: 1px solid #ddd !important;
    cursor: not-allowed !important;
    color: #666 !important;
}

.field-readonly input:disabled,
.field-readonly textarea:disabled,
.field-readonly select:disabled {
    opacity: 0.7;
}

/* Badge de somente leitura */
.badge-readonly {
    display: inline-block;
    background: #FF9800;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    margin-left: 8px;
    font-weight: normal;
}

/* Se√ß√£o bloqueada */
.section-blocked {
    opacity: 0.5;
    pointer-events: none;
    position: relative;
}

.section-blocked::before {
    content: 'üîí Se√ß√£o Bloqueada';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(244, 67, 54, 0.9);
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 10;
}

/* Indicador de roles */
.user-roles {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-top: 5px;
}

.role-badge {
    background: #009688;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
}

.role-badge.admin {
    background: #F44336;
}

.role-badge.abertura {
    background: #2196F3;
}

.role-badge.qualidade {
    background: #4CAF50;
}

.role-badge.lideranca {
    background: #FF9800;
}

.role-badge.espectador {
    background: #9E9E9E;
}
        /* === DEPLOY 39 - ESTILOS CORRIGIDOS === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #009688;
            --primary-dark: #00796B;
            --primary-light: #4DB6AC;
            --accent: #FFB300;
            --accent-light: #FFD54F;
            --background: #F8F9FA;
            --surface: #FFFFFF;
            --surface-2: #F5F5F5;
            --text: #1E1E1E;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --border: #E5E7EB;
            --border-light: #F3F4F6;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 8px;
            --radius-lg: 12px;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            font-size: 14px;
        }
        
       /* ========================================== */
        /* ‚úÖ HEADER FIXO NO TOPO - DEPLOY 41 */
        /* ========================================== */
        .header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            z-index: 1001 !important;
            background: var(--surface) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
            border-bottom: 1px solid var(--border) !important;
            height: 80px !important;
            padding: 0 !important;
            margin: 0 !important;
            display: block !important;
        }

        .header-content {
            max-width: 1400px !important;
            margin: 0 auto !important;
            padding: 0.75rem 1.5rem !important;
            display: grid !important;
            grid-template-columns: 180px 1fr 240px !important;
            align-items: center !important;
            gap: 1.5rem !important;
            height: 100% !important;
        }

        .logo {
            display: flex !important;
            align-items: center !important;
            gap: 0.75rem !important;
            font-size: 1.125rem !important;
            font-weight: 600 !important;
            color: var(--primary) !important;
            justify-self: start !important;
        }

        .logo img {
            height: 60px !important;
            width: auto !important;
            border-radius: 4px !important;
            display: block !important;
        }

        .system-title {
            justify-self: center !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .system-title span {
            font-size: 2rem !important;
            font-weight: 700 !important;
            color: var(--primary) !important;
            white-space: nowrap !important;
            letter-spacing: 0.5px !important;
            line-height: 1.2 !important;
        }

      .user-info {
            justify-self: end !important;
            display: flex !important;
            flex-direction: row !important;  /* ‚úÖ HORIZONTAL */
            align-items: center !important;  /* ‚úÖ CENTRALIZADO VERTICALMENTE */
            gap: 0.75rem !important;  /* ‚úÖ ESPA√áO ENTRE EMAIL E BADGES */
            font-size: 0.65rem !important;
            color: var(--text-secondary) !important;
            background: var(--surface-2) !important;
            padding: 0.4rem 0.8rem !important;
            border-radius: var(--radius) !important;
            border: 1px solid var(--border) !important;
            min-height: auto !important;
            max-height: 45px !important;  /* ‚úÖ ALTURA M√ÅXIMA CONTROLADA */
            white-space: nowrap !important;
        }

      .user-info > div {
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-end !important;
            gap: 0.2rem !important;
        }

        .user-info #userEmail {
            font-size: 0.6rem !important;
            opacity: 0.9 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            max-width: 160px !important;
            line-height: 1.2 !important;
        }

        .user-info .user-roles {
            display: flex !important;
            gap: 0.25rem !important;
            flex-wrap: nowrap !important;
            overflow: hidden !important;
        }

        .user-info .role-badge {
            font-size: 0.5rem !important;
            padding: 0.1rem 0.3rem !important;
            border-radius: 4px !important;
            white-space: nowrap !important;
        }

        /* Badge principal (Admin) - ao lado direito */
        .user-info .user-badge {
            background: var(--primary) !important;
            color: white !important;
            padding: 0.25rem 0.5rem !important;
            border-radius: 8px !important;
            font-size: 0.65rem !important;
            font-weight: 600 !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;  /* ‚úÖ N√ÉO ENCOLHE */
        }

        /* Deploy 71: Badge de setor com design diferenciado */
        .user-info .user-badge-setor {
            background: linear-gradient(135deg, #2196F3 0%, #009688 100%) !important;
            color: white !important;
            padding: 0.25rem 0.6rem !important;
            border-radius: 8px !important;
            font-size: 0.65rem !important;
            font-weight: 600 !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3) !important;
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
        }


      /* ========================================== */
      /* ‚úÖ TABS FIXAS LOGO ABAIXO - DEPLOY 41 */
      /* ========================================== */
        .tabs-wrapper {
            position: fixed !important;
            top: 80px !important;  /* ‚úÖ EXATAMENTE ABAIXO DO HEADER */
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            z-index: 1000 !important;
            background: var(--surface) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
            border-bottom: 2px solid var(--border) !important;
            height: 58px !important;
            padding: 0 !important;
            margin: 0 !important;
            display: block !important;
        }
        
        .tabs {
            display: flex !important;
            max-width: 1400px !important;
            margin: 0 auto !important;
            padding: 0 1rem !important;
            background: transparent !important;
            height: 100% !important;
            align-items: center !important;
        }

        .tab {
            flex: 1 !important;
            padding: 0 0.75rem !important;
            height: 100% !important;
            text-align: center !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            border: none !important;
            background: transparent !important;
            font-size: 0.85rem !important;
            font-weight: 500 !important;
            color: var(--text-secondary) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 0.5rem !important;
            white-space: nowrap !important;
        }
        
        .tab:hover {
            background: var(--surface-2) !important;
            color: var(--text) !important;
        }

        .tab.active {
            background: var(--primary) !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(0, 150, 136, 0.3) !important;
        }

        .tab span {
            display: inline-block !important;
        }

        /* Deploy 69: Ocultar tabs admin-only por padr√£o */
        .tab.admin-only {
            display: none !important;
        }

        /* ========================================== */
        /* ‚úÖ CONTAINER COM ESPA√áO CORRETO */
        /* ========================================== */
        .container {
            max-width: 1400px !important;
            margin: 0 auto !important;
            padding: 1.5rem 1rem !important;
            padding-top: 160px !important;  /* ‚úÖ Header (80) + Tabs (58) + Margem (22) */
        }
        
        .tab-content {
            display: none;
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            min-height: 600px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .form-section {
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: var(--surface);
        }
        
        .form-section h3 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.875rem;
        }
        
        .form-group.required label::after {
            content: '*';
            color: var(--error);
            margin-left: 0.25rem;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: var(--surface);
            color: var(--text);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.1);
        }
        
        .form-control:invalid {
            border-color: var(--error);
        }
        
        .form-control::placeholder {
            color: var(--text-muted);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 150px;
        }
        
        .file-upload {
            border: 3px dashed var(--primary);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, rgba(0, 150, 136, 0.03) 0%, rgba(0, 150, 136, 0.08) 100%);
            position: relative;
            overflow: hidden;
            max-height: 180px;
        }

        .file-upload::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        
        .file-upload:hover {
            border-color: var(--primary-dark);
            background: linear-gradient(135deg, rgba(0, 150, 136, 0.08) 0%, rgba(0, 150, 136, 0.15) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 150, 136, 0.15);
        }
        
        .file-upload:hover::before {
            left: 100%;
        }


       .file-upload.dragover {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(255, 179, 0, 0.1) 0%, rgba(255, 179, 0, 0.2) 100%);
            transform: scale(1.02);
            box-shadow: 0 12px 30px rgba(255, 179, 0, 0.25);
        }

        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            color: var(--primary);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .file-upload p {
            margin: 0.25rem 0;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .file-upload p:first-of-type {
            font-size: 1rem;
            color: var(--text);
            font-weight: 600;
        }

        .file-upload small {
            display: block;
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* ========================================== */
        /* CONTADOR DE ARQUIVOS SELECIONADOS - Deploy 37 */
        /* ========================================== */

          .file-upload-counter {
              position: absolute;
              top: 10px;
              right: 10px;
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 5px;
              background: linear-gradient(135deg, #009688 0%, #00796B 100%);
              padding: 10px 15px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);
              animation: slideInRight 0.3s ease;
          }

          .counter-badge {
              font-size: 1.2rem;
              font-weight: 700;
              color: white;
              display: flex;
              align-items: center;
              gap: 5px;
          }

          .counter-text {
              font-size: 0.75rem;
              color: rgba(255, 255, 255, 0.9);
              text-align: center;
              font-weight: 500;
          }

          @keyframes slideInRight {
              from {
                  opacity: 0;
                  transform: translateX(20px);
              }
              to {
                  opacity: 1;
                  transform: translateX(0);
              }
          }

          /* Ajustar posi√ß√£o relativa do file-upload para o contador absolute funcionar */
          .file-upload {
              position: relative;
          }


        .file-list {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s ease;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

        .file-item:hover {
          background: var(--surface-2);
          border-color: var(--primary);
          transform: translateX(5px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .file-item .file-info {
          display: flex;
          align-items: center;
          gap: 1rem;
          flex: 1;
      }

      .file-item .file-icon {
          font-size: 2rem;
          filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }

      .file-item .file-details {
          flex: 1;
      }

      .file-item .file-name {
          font-weight: 600;
          color: var(--text);
          font-size: 0.9375rem;
          margin-bottom: 0.25rem;
          display: block;
      }

      .file-item .file-size {
          color: var(--text-muted);
          font-size: 0.8125rem;
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .file-item .file-size::before {
          content: 'üìä';
          font-size: 0.875rem;
      }

      .file-item button {
          background: linear-gradient(135deg, var(--error) 0%, #DC2626 100%);
          color: white;
          border: none;
          padding: 0.5rem 1rem;
          border-radius: 6px;
          cursor: pointer;
          font-size: 0.8125rem;
          font-weight: 600;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          gap: 0.375rem;
          box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
      }

      .file-item button::before {
          content: 'üóëÔ∏è';
      }

      .file-item button:hover {
          background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
      }

      .file-item button:active {
          transform: translateY(0);
      }
        


.attachments-section {
    margin-top: 2rem;
    padding: 0;
    background: transparent;
    border: none;
    border-radius: 0;
}

.attachments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: var(--radius);
    border-left: 4px solid var(--primary);
}

.attachments-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.attachments-count {
    background: var(--primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
}

.attachments-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.attachment-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    transition: all 0.2s ease;
}

.attachment-item:hover {
    background: #f9f9f9;
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(0, 150, 136, 0.1);
    transform: translateX(5px);
}

.attachment-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.attachment-icon {
    font-size: 2rem;
    min-width: 40px;
    text-align: center;
}

.attachment-details {
    flex: 1;
}

.attachment-name {
    font-weight: 600;
    color: var(--text);
    font-size: 0.9375rem;
    margin-bottom: 0.25rem;
    display: block;
    word-break: break-word;
}

.attachment-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.8125rem;
    color: var(--text-muted);
}

.attachment-actions {
    display: flex;
    gap: 0.5rem;
}

.attachment-actions button {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8125rem;
    font-weight: 600;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.btn-download {
    background: linear-gradient(135deg, var(--info) 0%, #2563EB 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
}

.btn-download:hover {
    background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
}

.btn-delete-attachment {
    background: linear-gradient(135deg, var(--error) 0%, #DC2626 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
}

.btn-delete-attachment:hover {
    background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
}

.no-attachments {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
    font-size: 0.9375rem;
    background: #f9f9f9;
    border-radius: var(--radius);
}

.no-attachments-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}



/* Modal/Popup de confirma√ß√£o */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.2s ease;
}

.modal-content {
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow: auto;
  animation: slideUp 0.3s ease;
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid #eee;
}

.modal-header h3 {
  margin: 0;
  font-size: 20px;
  color: #222;
}

.modal-body {
  padding: 24px;
  color: #555;
  line-height: 1.6;
}

.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid #eee;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.btn-secondary {
  background: #e0e0e0;
  color: #555;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-secondary:hover {
  background: #d0d0d0;
}

.btn-danger {
  background: #F44336;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-danger:hover {
  background: #d32f2f;
}

.btn-danger:disabled,
.btn-secondary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--surface-2);
            border-color: var(--text-secondary);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #059669;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #D97706;
        }
        
        .btn-error {
            background: var(--error);
            color: white;
        }
        
        .btn-error:hover:not(:disabled) {
            background: #DC2626;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            border-left: 4px solid;
            font-size: 0.875rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
            color: #065F46;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error);
            color: #991B1B;
        }
        
        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--info);
            color: #1E3A8A;
        }
        
        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
            color: #92400E;
        }
        
        /* === KANBAN CORRIGIDO Deploy 72.3 - COM FINALIZADAS === */
        .kanban-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .kanban-column {
            background: var(--background);
            border-radius: var(--radius-lg);
            padding: 0;
            border: 1px solid var(--border);
            min-height: 600px;
        }
        
        .kanban-header {
            text-align: center;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            font-weight: 600;
            color: white;
            font-size: 0.875rem;
        }
        
        .kanban-header.abertura { background: var(--info); }
        .kanban-header.analise-qualidade { background: var(--warning); }
        .kanban-header.analise-acao { background: var(--accent); }
        .kanban-header.finalizada { background: var(--success); }
        
        .kanban-cards {
            padding: 0 1rem 1rem;
        }
        
        .kanban-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
        }
        
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .card-number {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.875rem;
        }
        
        .card-priority {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .priority-alta { background: #FEE2E2; color: #991B1B; }
        .priority-media { background: #FEF3C7; color: #92400E; }
        .priority-normal { background: #E0F2FE; color: #0E7490; }
        
        .card-cliente {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-weight: 500;
        }
        
        .card-descricao {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
        }
        
        .card-responsavel {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .card-dias {
            background: var(--surface-2);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .card-risco {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
            margin-top: 0.5rem;
        }
        
        /* Deploy 125: Atualizado valores de risco (Menor/Maior/Cr√≠tico/N√£o Informado) */
        .risco-menor { background: #DCFCE7; color: #166534; }
        .risco-maior { background: #FEF3C7; color: #92400E; }
        .risco-critico { background: #FEE2E2; color: #991B1B; }
        .risco-nao-informado { background: #F3F4F6; color: #6B7280; }
        
        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }
        
        .card-tag {
            font-size: 0.6875rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            background: var(--surface-2);
            color: var(--text-muted);
            font-weight: 500;
        }
        
        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .dashboard-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            border-top: 4px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 4px;
              background: linear-gradient(90deg, currentColor, transparent);
              opacity: 0;
              transition: opacity 0.3s ease;
          }
        
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .dashboard-card:hover::before {
            opacity: 1;
        }
        
        .dashboard-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            line-height: 1;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dashboard-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .dashboard-icon {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.8;
        }
        
        .chart-container {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: var(--shadow-md);
        }
        
        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        
        /* Relat√≥rios Styles */
        .filters-grid {
              display: grid;
              gap: 1rem;
              margin-bottom: 1.5rem;
          }

          .filters-container {
              background: var(--surface);
              border-radius: var(--radius-lg);
              padding: 1.5rem;
              margin-bottom: 1.5rem;
              box-shadow: var(--shadow);
              border: 1px solid var(--border);
          }

          .filters-container h3 {
              margin-bottom: 1.5rem;
              color: var(--primary);
              font-size: 1.125rem;
              font-weight: 600;
              display: flex;
              align-items: center;
              gap: 0.5rem;
              padding-bottom: 0.75rem;
              border-bottom: 2px solid var(--border);
          }

          .form-group {
              margin-bottom: 0;
          }

          .form-group label {
              display: block;
              margin-bottom: 0.5rem;
              font-weight: 500;
              color: var(--text);
              font-size: 0.875rem;
          }

          @media (max-width: 768px) {
              .filters-grid {
                  grid-template-columns: 1fr !important;
              }
          }
        
        .report-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .report-summary {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        
        .report-table th,
        .report-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .report-table th {
            background: var(--surface-2);
            font-weight: 600;
            color: var(--text);
        }
        
        .report-table tbody tr:hover {
            background: var(--background);
        }
        
        /* RNC Selection */
        .rnc-selector {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .rnc-selector h3 {
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .rnc-selector .form-control {
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* === CONFIG STYLES RESTAURADAS COM ABAS (Deploy 72.3) === */
        .config-tabs {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius-lg);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .config-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .config-tab:hover {
            background: var(--surface-2);
            color: var(--text);
        }
        
        .config-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .config-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .config-tab-content.active {
            display: block;
        }
        
        .config-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        
        .config-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .config-item {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--background);
        }

                /* Bot√µes de a√ß√µes nos cards de usu√°rios */
        .config-item button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .config-item button:active {
            transform: translateY(0);
        }

        /* Melhorar espa√ßamento dos cards */
        .config-item {
            transition: all 0.2s ease;
        }

        .config-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .config-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .config-item-title {
            font-weight: 500;
            color: var(--text);
            font-size: 0.875rem;
        }
        
        .config-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .config-item-actions button {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            background: var(--surface);
            color: var(--text);
            transition: all 0.2s ease;
        }
        
        .config-item-actions button:hover {
            background: var(--surface-2);
        }
        
        .config-item-actions .btn-edit {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .config-item-actions .btn-delete {
            border-color: var(--error);
            color: var(--error);
        }
        
        .config-item-meta {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }
        
        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1F2937;
            color: #10B981;
            padding: 1rem;
            border-radius: var(--radius-lg);
            font-family: 'Fira Code', 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 2000;
            display: none;
            box-shadow: var(--shadow-lg);
            border: 1px solid #374151;
        }
        
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #374151;
        }
        
        .debug-title {
            font-weight: 600;
            color: #F3F4F6;
        }
        
        .debug-clear {
            background: #374151;
            color: #10B981;
            border: 1px solid #10B981;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.6875rem;
        }
        
        .debug-section {
            margin-bottom: 0.75rem;
        }
        
        .debug-section h4 {
            color: #F59E0B;
            margin-bottom: 0.25rem;
        }
        
        .debug-log {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 2001;
            box-shadow: var(--shadow-lg);
            transition: all 0.2s ease;
        }
        
        .debug-toggle:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }
        
        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .loading-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .container { padding: 1rem 0.75rem; padding-top: calc(80px + 60px + 1rem); }
            .header-content { padding: 0 0.75rem; }
            .tabs { overflow-x: auto; }
            .tab { min-width: 120px; }
            .config-tabs { overflow-x: auto; }
            .config-tab { min-width: 120px; }
            .kanban-container { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
        }
        

/* ========================================== */
/* ‚úÖ RESPONSIVO MOBILE - DEPLOY 41 */
/* ========================================== */
@media (max-width: 768px) {
    .header {
        min-height: auto;
        padding: 0.6rem 0;
    }
    
    .header-content {
        grid-template-columns: 1fr;  /* ‚úÖ 1 coluna em mobile */
        grid-template-rows: auto auto auto;
        gap: 0.5rem;
        padding: 0 0.75rem;
        min-height: auto;
    }
    
    .logo {
        justify-self: center;
        order: 1;  /* ‚úÖ Logo primeiro */
    }
    
    .logo img {
        height: 50px;  /* ‚úÖ Logo menor em mobile */
    }
    
    .system-title {
        justify-self: center;
        order: 2;  /* ‚úÖ T√≠tulo segundo */
    }
    
    .system-title span {
        font-size: 1.25rem;  /* Titulo menor em mobile */
        letter-spacing: 0.3px;
    }
    
    .user-info {
        justify-self: center;
        order: 3;  /* ‚úÖ User info por √∫ltimo */
        font-size: 0.6rem;
        padding: 0.35rem 0.65rem;
        min-height: auto;
        gap: 0.35rem;
    }
    
    .user-info #userEmail {
        font-size: 0.55rem;
    }
    
    .user-info .user-badge {
        font-size: 0.6rem;
        padding: 0.1rem 0.35rem;
    }
    
    /* ‚úÖ TABS RESPONSIVAS EM MOBILE */
    .tabs-wrapper {
        position: sticky !important;  /* ‚úÖ Sticky em vez de fixed */
        top: 0 !important;
        min-height: 52px;
    }
    
    .tabs {
        overflow-x: auto;  /* ‚úÖ Scroll horizontal se necess√°rio */
        -webkit-overflow-scrolling: touch;
    }
    
    .tab {
        padding: 0.75rem 1rem;
        min-height: 48px;
        min-width: 100px;  /* ‚úÖ Largura m√≠nima */
        font-size: 0.8rem;
    }
    
    .container {
        padding: 1rem 0.75rem;
        padding-top: 1rem !important;  /* ‚úÖ Sem margem extra */
    }
    
    .tab-content {
        padding: 1rem;
    }
}

@media (max-width: 480px) {
    .logo img {
        height: 45px;
    }
    
    .system-title span {
        font-size: 1.15rem;
    }
    
    .tab {
        padding: 0.65rem 0.75rem;
        font-size: 0.75rem;
        min-width: 90px;
    }
}
        
        @media (max-width: 480px) {
            .container { padding: 0.75rem 0.5rem; padding-top: calc(80px + 60px + 0.75rem); }
            .header-content { 
                flex-direction: column; 
                gap: 0.75rem; 
                text-align: center; 
            }
            .logo { font-size: 1rem; }
            .tab-content { padding: 1rem; }
            .form-section { padding: 1rem; }
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-weight-bold { font-weight: 600; }
        .text-muted { color: var(--text-muted); }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .text-warning { color: var(--warning); }
        .text-info { color: var(--info); }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--background);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Filtros por Setor */
        .filter-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-container label {
            color: #333;
            font-size: 0.95em;
            font-weight: 600;
        }

        .filter-container select {
            flex: 1;
            max-width: 300px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.95em;
            cursor: pointer;
        }

        .filter-container select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.1);
        }

        @media (max-width: 768px) {
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-container select {
                max-width: 100%;
            }
        }

        /* Deploy 74.5.2: Rodap√© */
        .app-footer {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 1rem 2rem;
            text-align: center;
            margin-top: 2rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .app-footer .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .app-footer .footer-version {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 0.75rem;
        }

        @media (max-width: 768px) {
            .app-footer .footer-content {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

    </style>
</head>
<body>
    <!-- ========================================== -->
    <!-- HEADER FIXO NO TOPO -->
    <!-- ========================================== -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <img src="https://neoformula.com.br/cdn/shop/files/Logotipo-NeoFormula-Manipulacao-Homeopatia_76b2fa98-5ffa-4cc3-ac0a-6d41e1bc8810.png?height=100&v=1677088468" alt="Neoformula">
            </div>
            
            <!-- T√≠tulo centralizado -->
            <div class="system-title">
                <span>REGISTRO DE N√ÉO CONFORMIDADE</span>
            </div>
            
            <div class="user-info">
                <div>
                    <span id="userEmail">Carregando...</span>
                    <div class="user-roles" id="userRoles"></div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="user-badge" id="userRole">Admin</span>
                    <span class="user-badge-setor" id="userSetor">
                        <span>üè¢</span>
                        <span>Setor</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- TABS FIXAS (FORA DO CONTAINER) -->
    <!-- ========================================== -->
    <div class="tabs-wrapper">
        <div class="tabs">
            <button class="tab active" data-tab="abrir">
                <span>üìù</span>
                <span>Abrir RNC</span>
            </button>
            <button class="tab" data-tab="editar">
                <span>‚úèÔ∏è</span>
                <span>Editar RNC</span>
            </button>
            <button class="tab" data-tab="kanban">
                <span>üìã</span>
                <span>Kanban</span>
            </button>
            <button class="tab" data-tab="dashboard">
                <span>üìä</span>
                <span>Dashboard</span>
            </button>
            <button class="tab admin-only" data-tab="relatorios" id="relatoriosTab">
                <span>üìà</span>
                <span>Relat√≥rios</span>
            </button>
            <button class="tab admin-only" data-tab="configuracoes" id="configTab">
                <span>‚öôÔ∏è</span>
                <span>Configura√ß√µes</span>
            </button>
            <button class="tab" data-tab="ajuda">
                <span>üìñ</span>
                <span>Ajuda</span>
            </button>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- CONTAINER COM CONTE√öDO (COM PADDING-TOP) -->
    <!-- ========================================== -->
    <div class="container">

        <!-- Abrir RNC -->
        <div class="tab-content active" id="tab-abrir">
            <div class="page-title">
                <span>üìù</span>
                <span>Abertura de Nova RNC</span>
            </div>
            <form id="rncForm" novalidate>
                <div id="abertura-form"></div>
                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-primary" id="submitRnc">
                        <span id="submitText">üíæ Criar RNC</span>
                        <div class="loading hidden" id="submitLoading"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Editar RNC -->
        <div class="tab-content" id="tab-editar">
            <div class="page-title">
                <span>‚úèÔ∏è</span>
                <span>Edi√ß√£o de RNC</span>
            </div>
            <div class="rnc-selector">
                <h3>Selecione a RNC para editar:</h3>

                <!-- FILTROS DUPLOS - EDITAR RNC -->
                <div class="filter-container" style="margin-bottom: 20px;">
                    <label for="tipoSetorEdit">üìä Filtrar por:</label>
                    <select id="tipoSetorEdit" style="max-width: 200px;">
                        <option value="qualidade">üîç Setor da N√£o Conformidade</option>
                        <option value="abertura">üè¢ Setor de Abertura</option>
                    </select>
                    
                    <label for="setorFilterEdit" style="margin-left: 15px;">Setor:</label>
                    <select id="setorFilterEdit" style="max-width: 250px;">
                        <option value="Todos">üìã Todos os Setores</option>
                    </select>
                    
                    <span id="rncCountEdit" style="color: #666; font-size: 0.9em; margin-left: 10px;"></span>
                </div>

                <select id="rncSelect" class="form-control">
                    <option value="">Carregando RNCs...</option>
                </select>
            </div>
            <div id="editForm" class="hidden">
                <form id="rncEditForm" novalidate>
                    <div id="edit-sections"></div>
                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-primary" id="updateRnc">
                            <span id="updateText">üíæ Salvar Altera√ß√µes</span>
                            <div class="loading hidden" id="updateLoading"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Kanban -->
        <div class="tab-content" id="tab-kanban">
            <div class="page-title">
                <span>üìã</span>
                <span>Kanban de RNCs</span>
                <button class="btn btn-secondary" onclick="forceReloadKanban()" style="margin-left: auto;">
                    üîÑ Atualizar
                </button>
            </div>
        
            <!-- FILTROS DUPLOS KANBAN -->
            <div class="filter-container" style="margin-bottom: 20px;">
                <label for="tipoSetorKanban">üìä Filtrar por:</label>
                <select id="tipoSetorKanban" style="max-width: 200px;">
                    <option value="qualidade">üîç Setor da N√£o Conformidade</option>
                    <option value="abertura">üè¢ Setor de Abertura</option>
                </select>
                
                <label for="setorFilterKanban" style="margin-left: 15px;">Setor:</label>
                <select id="setorFilterKanban" style="max-width: 250px;">
                    <option value="Todos">üìã Todos os Setores</option>
                </select>
                
                <span id="rncCountKanban" style="color: #666; font-size: 0.9em; margin-left: 10px;"></span>
            </div>
            
            <div id="kanban-container"></div>
        </div>

        <!-- Dashboard -->
        <div class="tab-content" id="tab-dashboard">
            <div class="page-title">
                <span>üìä</span>
                <span>Dashboard</span>
                <button class="btn btn-secondary" onclick="forceReloadDashboard()" style="margin-left: auto;">
                    üîÑ Atualizar
                </button>
            </div>
            
            <!-- FILTROS -->
            <div class="filter-container" style="margin-bottom: 20px;">
                <label for="tipoSetorDashboard">üìä Filtrar por:</label>
                <select id="tipoSetorDashboard" style="max-width: 200px;">
                    <option value="qualidade">üîç Setor da N√£o Conformidade</option>
                    <option value="abertura">üè¢ Setor de Abertura</option>
                </select>
                
                <label for="setorFilterDashboard" style="margin-left: 15px;">Setor:</label>
                <select id="setorFilterDashboard" style="max-width: 250px;">
                    <option value="Todos">üìã Todos os Setores</option>
                </select>
                
                <span id="rncCountDashboard" style="color: #666; font-size: 0.9em; margin-left: 10px;"></span>
            </div>
            
            <div id="dashboard-content"></div>
        </div>

        <!-- Relat√≥rios -->
        <div class="tab-content" id="tab-relatorios">
            <div class="page-title">
                <span>üìà</span>
                <span>Relat√≥rios Personalizados</span>
            </div>
            
            <div class="filters-container">
                <h3 class="chart-title">üîç Filtros do Relat√≥rio</h3>
                
                <!-- LINHA 1: Data In√≠cio / Data Fim / Status -->
                <div class="filters-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="dataInicio">üìÖ Data In√≠cio</label>
                        <input type="date" id="dataInicio" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="dataFim">üìÖ Data Fim</label>
                        <input type="date" id="dataFim" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="statusFiltro">üìä Status</label>
                        <select id="statusFiltro" class="form-control">
                            <option value="Todos">Todos os Status</option>
                        </select>
                    </div>
                </div>
                
                <!-- LINHA 2: Tipo do Setor / Setor / Tipo RNC -->
                <div class="filters-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="tipoSetorRelatorio">üìä Tipo do Setor</label>
                        <select id="tipoSetorRelatorio" class="form-control">
                            <option value="qualidade">üîç Setor da N√£o Conformidade</option>
                            <option value="abertura">üè¢ Setor de Abertura</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="setorFiltro">üè¢ Setor</label>
                        <select id="setorFiltro" class="form-control">
                            <option value="Todos">Todos os Setores</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoFiltro">üìã Tipo de RNC</label>
                        <select id="tipoFiltro" class="form-control">
                            <option value="Todos">Todos os Tipos</option>
                        </select>
                    </div>
                </div>
                
                <!-- BOT√ïES DE A√á√ÉO -->
                <div class="report-actions">
                    <button class="btn btn-primary" id="generateReport">
                        <span id="reportText">üìä Gerar Relat√≥rio</span>
                        <div class="loading hidden" id="reportLoading"></div>
                    </button>
                    <button class="btn btn-success" id="exportPdf" disabled>üìÑ Exportar PDF Gerencial</button>
                    <button class="btn btn-secondary" id="clearFilters">üßπ Limpar Filtros</button>
                </div>
            </div>

            <div id="report-content"></div>
        </div>

        <!-- === CONFIGURA√á√ïES COM ABAS === -->
        <div class="tab-content" id="tab-configuracoes">
            <div class="page-title">
                <span>‚öôÔ∏è</span>
                <span>Configura√ß√µes do Sistema</span>
            </div>
            
            <div class="config-tabs">
                <button class="config-tab active" data-config-tab="sistema">
                    <span>üîß</span>
                    <span>Sistema</span>
                </button>
                <button class="config-tab" data-config-tab="listas">
                    <span>üìã</span>
                    <span>Listas</span>
                </button>
                <button class="config-tab" data-config-tab="secoes">
                    <span>üìÑ</span>
                    <span>Se√ß√µes</span>
                </button>
                <button class="config-tab" data-config-tab="campos">
                    <span>üè∑Ô∏è</span>
                    <span>Campos</span>
                </button>
                <button class="config-tab" data-config-tab="usuarios">
                    <span>üë•</span>
                    <span>Usu√°rios</span>
                </button>
            </div>
            
            <!-- ABA SISTEMA -->
            <div class="config-tab-content active" id="config-tab-sistema">
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üîß</span>
                            <span>Configura√ß√µes Gerais</span>
                        </div>
                    </div>
                    
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="pastaGID">üìÅ ID da Pasta do Google Drive</label>
                            <input type="text" id="pastaGID" class="form-control" placeholder="ID da pasta para anexos">
                            <small class="text-muted">ID da pasta onde os anexos das RNCs ser√£o salvos</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="renomearArquivos">üè∑Ô∏è Renomear Arquivos</label>
                            <select id="renomearArquivos" class="form-control">
                                <option value="Sim">Sim - RNC_0001_2025 - Imagem 1 de 3</option>
                                <option value="N√£o">N√£o - Manter nome original</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" id="saveSystemConfig">
                            üíæ Salvar Configura√ß√µes
                        </button>
                    </div>
                </div>

                <!-- Deploy 74.5: Gerenciamento de Cache -->
                <div class="config-section" style="margin-top: 2rem;">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üóëÔ∏è</span>
                            <span>Gerenciamento de Cache</span>
                        </div>
                    </div>

                    <div style="padding: 1.5rem;">
                        <div class="alert alert-info" style="margin-bottom: 1rem;">
                            <strong>‚ÑπÔ∏è Sobre o Cache:</strong>
                            <p style="margin: 0.5rem 0 0 0;">O sistema usa cache para melhorar a performance. Em algumas situa√ß√µes (ap√≥s atualiza√ß√µes ou problemas de dados), pode ser necess√°rio limpar o cache para ver as informa√ß√µes mais recentes.</p>
                        </div>

                        <div class="text-center">
                            <button class="btn btn-warning" id="btnLimparCache" style="min-width: 250px;">
                                <span id="btnLimparCacheIcon">üóëÔ∏è</span>
                                <span id="btnLimparCacheText">Limpar Todo o Cache do Sistema</span>
                            </button>
                        </div>

                        <div id="cacheResultMessage" style="margin-top: 1rem; text-align: center;"></div>
                    </div>
                </div>

                <!-- Deploy 74.5.2: Gerenciamento de Logs -->
                <div class="config-section" style="margin-top: 2rem;">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üìã</span>
                            <span>Gerenciamento de Logs</span>
                        </div>
                    </div>

                    <div style="padding: 1.5rem;">
                        <div class="alert alert-warning" style="margin-bottom: 1rem;">
                            <strong>‚ö†Ô∏è Aten√ß√£o:</strong>
                            <p style="margin: 0.5rem 0 0 0;">Esta a√ß√£o ir√° remover TODOS os logs da planilha, mantendo apenas o cabe√ßalho. Esta opera√ß√£o n√£o pode ser desfeita!</p>
                        </div>

                        <div class="text-center">
                            <button class="btn btn-danger" id="btnLimparLogs" style="min-width: 250px;">
                                <span id="btnLimparLogsIcon">üóëÔ∏è</span>
                                <span id="btnLimparLogsText">Limpar Aba de Logs</span>
                            </button>
                        </div>

                        <div id="logsResultMessage" style="margin-top: 1rem; text-align: center;"></div>
                    </div>
                </div>

                <!-- Deploy 76: Sistema de Backup -->
                <div class="config-section" style="margin-top: 2rem;">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üíæ</span>
                            <span>Sistema de Backup</span>
                        </div>
                    </div>

                    <div style="padding: 1.5rem;">
                        <!-- Informa√ß√µes sobre Backup -->
                        <div style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #bee5eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="font-size: 2.5rem;">üì¶</div>
                                <h3 style="margin: 0; font-size: 1.4rem; font-weight: 600; color: #0c5460;">Sobre o Sistema de Backup</h3>
                            </div>

                            <p style="margin: 0 0 1.5rem 0; line-height: 1.6; font-size: 1rem; color: #0c5460;">
                                O sistema de backup exporta todas as tabelas da planilha (RNC, ConfigCampos, ConfigListas, etc.)
                                para um arquivo JSON com timestamp, armazenado em uma pasta do Google Drive configurada por voc√™.
                                Esses backups podem ser usados para:
                            </p>

                            <div style="display: grid; gap: 0.75rem; margin-left: 1rem; color: #0c5460;">
                                <div style="display: flex; align-items: start; gap: 0.75rem;">
                                    <span style="font-size: 1.2rem; line-height: 1.5; color: #17a2b8;">¬∞</span>
                                    <span style="line-height: 1.5;">Manter hist√≥rico completo dos dados</span>
                                </div>
                                <div style="display: flex; align-items: start; gap: 0.75rem;">
                                    <span style="font-size: 1.2rem; line-height: 1.5; color: #17a2b8;">¬∞</span>
                                    <span style="line-height: 1.5;">Recupera√ß√£o em caso de problemas</span>
                                </div>
                                <div style="display: flex; align-items: start; gap: 0.75rem;">
                                    <span style="font-size: 1.2rem; line-height: 1.5; color: #17a2b8;">¬∞</span>
                                    <span style="line-height: 1.5;">Migra√ß√£o futura para banco de dados externo</span>
                                </div>
                                <div style="display: flex; align-items: start; gap: 0.75rem;">
                                    <span style="font-size: 1.2rem; line-height: 1.5; color: #17a2b8;">¬∞</span>
                                    <span style="line-height: 1.5;">Auditoria e compliance</span>
                                </div>
                            </div>
                        </div>

                        <!-- Configura√ß√£o da Pasta de Backup -->
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: var(--primary);">üìÅ Configurar Pasta de Backup</h4>

                            <div style="margin-bottom: 1rem;">
                                <label for="backupFolderIdInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    ID da Pasta do Google Drive:
                                </label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input
                                        type="text"
                                        id="backupFolderIdInput"
                                        placeholder="Cole aqui o ID da pasta (ex: 1ABC...xyz)"
                                        style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"
                                    />
                                    <button class="btn btn-primary" id="btnSaveBackupFolder" style="min-width: 120px;">
                                        üíæ Salvar
                                    </button>
                                </div>
                                <small style="color: #666; display: block; margin-top: 0.5rem;">
                                    üí° <strong>Como obter o ID:</strong> Abra a pasta no Google Drive, copie o ID da URL
                                    (ap√≥s "/folders/" ou entre "folders/" e "?")
                                </small>
                            </div>

                            <div id="backupFolderStatus" style="margin-top: 1rem;"></div>
                        </div>

                        <!-- A√ß√µes de Backup -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <button class="btn btn-success" id="btnCreateBackup" style="padding: 1rem;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì¶</div>
                                <div>Criar Backup Agora</div>
                            </button>

                            <button class="btn btn-primary" id="btnListBackups" style="padding: 1rem;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
                                <div>Listar Backups</div>
                            </button>

                            <button class="btn btn-secondary" id="btnOpenBackupFolder" style="padding: 1rem;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÇ</div>
                                <div>Abrir Pasta</div>
                            </button>
                        </div>

                        <!-- Resultado de A√ß√µes -->
                        <div id="backupActionResult" style="margin-bottom: 1.5rem;"></div>

                        <!-- Lista de Backups -->
                        <div id="backupListContainer" style="display: none;">
                            <div class="config-header" style="margin-bottom: 1rem;">
                                <h4 style="margin: 0; color: var(--primary);">üì¶ Backups Dispon√≠veis</h4>
                            </div>
                            <div id="backupList"></div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ABA LISTAS -->
            <div class="config-tab-content" id="config-tab-listas">
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üìã</span>
                            <span>Gerenciar Listas</span>
                        </div>
                        <button class="btn btn-primary" id="addNewList">‚ûï Nova Lista</button>
                    </div>
                    <div id="lists-container"></div>
                </div>
            </div>
            
            <!-- ABA SE√á√ïES -->
            <div class="config-tab-content" id="config-tab-secoes">
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üìÑ</span>
                            <span>Se√ß√µes do Formul√°rio</span>
                        </div>
                        <button class="btn btn-primary" id="addNewSection">‚ûï Nova Se√ß√£o</button>
                    </div>
                    <div id="sections-container"></div>
                </div>
            </div>
            
            <!-- ABA CAMPOS -->
            <div class="config-tab-content" id="config-tab-campos">
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üè∑Ô∏è</span>
                            <span>Campos dos Formul√°rios</span>
                        </div>
                        <button class="btn btn-primary" id="addNewField">‚ûï Novo Campo</button>
                    </div>
                    <div id="fields-container"></div>
                </div>
            </div>
   
            <!-- ABA USU√ÅRIOS -->
            <div class="config-tab-content" id="config-tab-usuarios">
                
                <!-- LEGENDA DE ROLES -->
                <div class="config-section" style="margin-bottom: 20px;">
                    <div class="config-header" style="padding-bottom: 10px; margin-bottom: 15px;">
                        <div class="config-title">
                            <span>üìñ</span>
                            <span>Legenda de Roles</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff3f3; border-left: 3px solid #F44336; border-radius: 6px;">
                            <span class="role-badge admin" style="font-size: 11px; padding: 2px 6px;">Admin</span>
                            <span style="font-size: 11px; color: #666;">Acesso total</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f0f8ff; border-left: 3px solid #2196F3; border-radius: 6px;">
                            <span class="role-badge abertura" style="font-size: 11px; padding: 2px 6px;">Abertura</span>
                            <span style="font-size: 11px; color: #666;">Cria RNCs</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f0fff4; border-left: 3px solid #4CAF50; border-radius: 6px;">
                            <span class="role-badge qualidade" style="font-size: 11px; padding: 2px 6px;">Qualidade</span>
                            <span style="font-size: 11px; color: #666;">Edita Qualidade</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff8f0; border-left: 3px solid #FF9800; border-radius: 6px;">
                            <span class="role-badge lideranca" style="font-size: 11px; padding: 2px 6px;">Lideran√ßa</span>
                            <span style="font-size: 11px; color: #666;">Edita Lideran√ßa</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f5f5f5; border-left: 3px solid #9E9E9E; border-radius: 6px;">
                            <span class="role-badge espectador" style="font-size: 11px; padding: 2px 6px;">Espectador</span>
                            <span style="font-size: 11px; color: #666;">Visualiza</span>
                        </div>
                    </div>
                </div>
                
                <!-- LISTA DE USU√ÅRIOS -->
                <div class="config-section">
                    <div class="config-header" style="padding-bottom: 10px; margin-bottom: 15px;">
                        <div class="config-title">
                            <span>üë•</span>
                            <span>Usu√°rios Cadastrados</span>
                        </div>
                        <button class="btn btn-primary" id="addNewUser" style="font-size: 13px; padding: 8px 16px;">
                            ‚ûï Novo Usu√°rio
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;" id="users-container">
                        <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: #999;">
                            Carregando usu√°rios...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ajuda -->
        <div class="tab-content" id="tab-ajuda">
            <div class="page-title">
                <span>üìñ</span>
                <span>Manual de Ajuda</span>
            </div>

            <div style="max-width: 1200px; margin: 0 auto;">

                <!-- Badge de N√≠vel de Acesso -->
                <div id="helpAccessBadge" style="text-align: center; margin-bottom: 1.5rem;">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>

                <!-- Introdu√ß√£o -->
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üëã</span>
                            <span>Bem-vindo ao Sistema RNC Neoformula</span>
                        </div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <p style="font-size: 1.1rem; line-height: 1.8; color: #555; margin-bottom: 1rem;">
                            O <strong>Sistema RNC (Registro de N√£o Conformidade)</strong> √© uma plataforma integrada desenvolvida para
                            gerenciar o ciclo completo de n√£o conformidades na Neoformula, desde a abertura at√© o encerramento,
                            incluindo an√°lise de causa raiz, implementa√ß√£o de a√ß√µes corretivas e gera√ß√£o de relat√≥rios anal√≠ticos.
                        </p>
                        <p style="font-size: 1rem; line-height: 1.6; color: #666;">
                            <strong>Vers√£o atual:</strong> <span id="helpVersionInfo">Carregando...</span><br>
                            <strong>√öltima atualiza√ß√£o:</strong> 02/01/2026 - Deploy 122 (Documenta√ß√£o Completa)
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                            <div style="padding: 1.5rem; background: #E3F2FD; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2.5rem;">üìù</div>
                                <div style="font-weight: 600; margin-top: 0.5rem; font-size: 1.1rem;">Registrar RNCs</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Abra e documente n√£o conformidades</div>
                            </div>
                            <div style="padding: 1.5rem; background: #E8F5E9; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2.5rem;">üìã</div>
                                <div style="font-weight: 600; margin-top: 0.5rem; font-size: 1.1rem;">Kanban Visual</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Acompanhe o status em tempo real</div>
                            </div>
                            <div style="padding: 1.5rem; background: #FFF3E0; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2.5rem;">üìä</div>
                                <div style="font-weight: 600; margin-top: 0.5rem; font-size: 1.1rem;">Dashboards</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Visualize m√©tricas e indicadores</div>
                            </div>
                            <div style="padding: 1.5rem; background: #F3E5F5; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2.5rem;">üìà</div>
                                <div style="font-weight: 600; margin-top: 0.5rem; font-size: 1.1rem;">Relat√≥rios</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Exporte e analise dados</div>
                            </div>
                            <div style="padding: 1.5rem; background: #FFEBEE; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2.5rem;">üîî</div>
                                <div style="font-weight: 600; margin-top: 0.5rem; font-size: 1.1rem;">Notifica√ß√µes</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Receba alertas por email</div>
                            </div>
                            <div style="padding: 1.5rem; background: #E0F2F1; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2.5rem;">üìé</div>
                                <div style="font-weight: 600; margin-top: 0.5rem; font-size: 1.1rem;">Anexos</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Anexe evid√™ncias e documentos</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Primeiros Passos -->
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üöÄ</span>
                            <span>Primeiros Passos - Guia Completo</span>
                        </div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: flex; flex-direction: column; gap: 2rem;">

                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <div style="min-width: 45px; height: 45px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;">1</div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.5rem 0; color: var(--primary); font-size: 1.2rem;">üìå Entendendo a Interface</h3>
                                    <p style="margin: 0 0 1rem 0; line-height: 1.8;">
                                        O sistema possui uma barra de navega√ß√£o superior com abas clic√°veis. Cada aba representa uma funcionalidade espec√≠fica:
                                    </p>
                                    <ul style="line-height: 1.8; margin: 0;">
                                        <li><strong>üìù Abrir RNC:</strong> Formul√°rio para registrar novas n√£o conformidades</li>
                                        <li><strong>‚úèÔ∏è Editar RNC:</strong> Buscar e modificar RNCs existentes</li>
                                        <li><strong>üìã Kanban:</strong> Visualiza√ß√£o em quadros por status (Aberta, Em An√°lise, Finalizada)</li>
                                        <li><strong>üìä Dashboard:</strong> Gr√°ficos e m√©tricas de desempenho</li>
                                        <li><strong>üìÑ Relat√≥rios:</strong> Gera√ß√£o e exporta√ß√£o de relat√≥rios personalizados</li>
                                        <li><strong>‚öôÔ∏è Configura√ß√µes:</strong> Gerenciamento do sistema (apenas Admins)</li>
                                        <li><strong>üìñ Ajuda:</strong> Este manual que voc√™ est√° lendo agora</li>
                                    </ul>
                                    <div class="alert alert-info" style="margin-top: 1rem; padding: 1rem; background: #E3F2FD; border-left: 4px solid #2196F3; border-radius: 4px;">
                                        <strong>üí° Dica:</strong> Seu email e permiss√µes aparecem no canto superior direito. Clique no √≠cone de usu√°rio para ver suas roles.
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <div style="min-width: 45px; height: 45px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;">2</div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.5rem 0; color: var(--primary); font-size: 1.2rem;">üìù Como Abrir sua Primeira RNC (Passo a Passo)</h3>
                                    <ol style="line-height: 1.8; margin: 0;">
                                        <li><strong>Navegue at√© a aba "Abrir RNC"</strong> no menu superior</li>
                                        <li><strong>Preencha a se√ß√£o "Abertura":</strong>
                                            <ul style="margin-top: 0.5rem;">
                                                <li><strong>Setor de Abertura:</strong> Selecione o setor que est√° abrindo a RNC</li>
                                                <li><strong>Data de Abertura:</strong> Preenchida automaticamente com a data atual</li>
                                                <li><strong>Aberto Por:</strong> Seu nome (preenchido automaticamente)</li>
                                                <li><strong>Descri√ß√£o da N√£o Conformidade:</strong> Descreva detalhadamente o problema encontrado</li>
                                            </ul>
                                        </li>
                                        <li><strong>Preencha a se√ß√£o "Qualidade":</strong>
                                            <ul style="margin-top: 0.5rem;">
                                                <li><strong>Setor da N√£o Conformidade:</strong> Onde a n√£o conformidade ocorreu</li>
                                                <li><strong>Origem:</strong> Como a n√£o conformidade foi detectada (Cliente, Processo, Auditoria, etc.)</li>
                                                <li><strong>Tipo:</strong> Classifica√ß√£o da n√£o conformidade (Produto, Processo, Sistema, etc.)</li>
                                                <li><strong>Classifica√ß√£o:</strong> Gravidade (Cr√≠tica, Maior, Menor)</li>
                                            </ul>
                                        </li>
                                        <li><strong>Anexe evid√™ncias (opcional mas recomendado):</strong>
                                            <ul style="margin-top: 0.5rem;">
                                                <li>Clique em "üìé Anexar Arquivo"</li>
                                                <li>Selecione fotos, PDFs ou documentos relevantes</li>
                                                <li>Aguarde o upload completar (barra de progresso)</li>
                                            </ul>
                                        </li>
                                        <li><strong>Revise todas as informa√ß√µes</strong> antes de salvar</li>
                                        <li><strong>Clique em "üìã Salvar RNC"</strong></li>
                                        <li><strong>Um n√∫mero ser√° gerado automaticamente</strong> (ex: 0042/2025) e uma notifica√ß√£o por email ser√° enviada</li>
                                    </ol>
                                    <div class="alert alert-warning" style="margin-top: 1rem; padding: 1rem; background: #FFF3E0; border-left: 4px solid #FF9800; border-radius: 4px;">
                                        <strong>‚ö†Ô∏è Importante:</strong> Campos marcados com <strong style="color: red;">*</strong> s√£o obrigat√≥rios. O sistema impedir√° o salvamento se algum estiver vazio.
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <div style="min-width: 45px; height: 45px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;">3</div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.5rem 0; color: var(--primary); font-size: 1.2rem;">üîç Como Acompanhar e Gerenciar RNCs</h3>
                                    <p style="margin: 0 0 1rem 0; line-height: 1.8;">Ap√≥s criar uma RNC, voc√™ pode acompanh√°-la atrav√©s de tr√™s ferramentas principais:</p>

                                    <div style="padding: 1rem; background: #E8F5E9; border-radius: 8px; margin-bottom: 1rem;">
                                        <h4 style="margin: 0 0 0.5rem 0; color: #4CAF50;">üìã Kanban - Vis√£o R√°pida por Status</h4>
                                        <p style="margin: 0; line-height: 1.6;">
                                            O Kanban organiza visualmente todas as RNCs em colunas de acordo com o status atual.
                                            Ideal para ter uma vis√£o geral r√°pida do andamento de todas as n√£o conformidades.
                                            Voc√™ pode filtrar por setor e tipo de setor para focar nas RNCs relevantes.
                                        </p>
                                    </div>

                                    <div style="padding: 1rem; background: #E3F2FD; border-radius: 8px; margin-bottom: 1rem;">
                                        <h4 style="margin: 0 0 0.5rem 0; color: #2196F3;">üìä Dashboard - An√°lises e M√©tricas</h4>
                                        <p style="margin: 0; line-height: 1.6;">
                                            O Dashboard apresenta gr√°ficos interativos e cards com m√©tricas consolidadas.
                                            Use os filtros de per√≠odo para an√°lises temporais (√∫ltimos 7 dias, 30 dias, etc.)
                                            e identifique tend√™ncias, setores com mais ocorr√™ncias e tipos de n√£o conformidade mais frequentes.
                                        </p>
                                    </div>

                                    <div style="padding: 1rem; background: #F3E5F5; border-radius: 8px;">
                                        <h4 style="margin: 0 0 0.5rem 0; color: #9C27B0;">‚úèÔ∏è Editar RNC - Atualizar Informa√ß√µes</h4>
                                        <p style="margin: 0; line-height: 1.6;">
                                            Use a aba "Editar RNC" para buscar uma RNC espec√≠fica e atualizar suas informa√ß√µes.
                                            Voc√™ pode filtrar por setor para facilitar a busca. Todas as edi√ß√µes s√£o registradas
                                            no hist√≥rico da RNC, permitindo rastreabilidade completa.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <div style="min-width: 45px; height: 45px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;">4</div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.5rem 0; color: var(--primary); font-size: 1.2rem;">üéØ Entendendo Permiss√µes e Roles</h3>
                                    <p style="margin: 0 0 1rem 0; line-height: 1.8;">
                                        O sistema trabalha com um modelo de permiss√µes baseado em <strong>roles (fun√ß√µes)</strong>.
                                        Sua permiss√£o determina quais se√ß√µes voc√™ pode visualizar e editar:
                                    </p>
                                    <div style="display: grid; gap: 0.5rem;">
                                        <div style="padding: 0.75rem; background: #FFEBEE; border-left: 4px solid #f44336; border-radius: 4px;">
                                            <strong>üëë Admin:</strong> Acesso total ao sistema, incluindo Configura√ß√µes, gerenciamento de usu√°rios, listas e campos
                                        </div>
                                        <div style="padding: 0.75rem; background: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 4px;">
                                            <strong>‚úÖ Qualidade:</strong> Pode editar se√ß√µes de Qualidade e An√°lise, visualizar outras se√ß√µes
                                        </div>
                                        <div style="padding: 0.75rem; background: #FFF3E0; border-left: 4px solid #FF9800; border-radius: 4px;">
                                            <strong>üë®‚Äçüíº Lideran√ßa:</strong> Pode editar se√ß√£o de Lideran√ßa (aprova√ß√µes e decis√µes), visualizar outras
                                        </div>
                                        <div style="padding: 0.75rem; background: #E3F2FD; border-left: 4px solid #2196F3; border-radius: 4px;">
                                            <strong>üìù Abertura:</strong> Pode criar e editar apenas a se√ß√£o de Abertura de RNCs
                                        </div>
                                        <div style="padding: 0.75rem; background: #F5F5F5; border-left: 4px solid #9E9E9E; border-radius: 4px;">
                                            <strong>üëÅÔ∏è Espectador:</strong> Apenas visualiza RNCs, sem permiss√£o de edi√ß√£o
                                        </div>
                                    </div>
                                    <div class="alert alert-info" style="margin-top: 1rem; padding: 1rem; background: #E3F2FD; border-left: 4px solid #2196F3; border-radius: 4px;">
                                        <strong>üí° Nota:</strong> Voc√™ pode ter m√∫ltiplas roles ao mesmo tempo. Suas permiss√µes s√£o a combina√ß√£o de todas as suas roles.
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Funcionalidades Principais -->
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>‚ö°</span>
                            <span>Funcionalidades Principais</span>
                        </div>
                    </div>
                    <div style="padding: 1.5rem;">

                        <!-- Abrir RNC -->
                        <details style="margin-bottom: 1rem; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--primary); font-size: 1.1rem;">
                                üìù Abrir RNC - Como criar uma nova n√£o conformidade
                            </summary>
                            <div style="margin-top: 1rem; padding-left: 1rem;">
                                <ol style="line-height: 1.8;">
                                    <li>Clique na aba <strong>Abrir RNC</strong></li>
                                    <li>Preencha os campos de <strong>Abertura</strong> (setor, data, descri√ß√£o)</li>
                                    <li>Preencha os campos de <strong>Qualidade</strong> (classifica√ß√£o, origem, tipo)</li>
                                    <li>Se necess√°rio, anexe <strong>evid√™ncias</strong> (fotos, documentos)</li>
                                    <li>Clique em <strong>üìã Salvar RNC</strong></li>
                                    <li>Um n√∫mero de RNC ser√° gerado automaticamente (ex: 0001/2025)</li>
                                </ol>
                                <div class="alert alert-info" style="margin-top: 1rem;">
                                    <strong>üí° Dica:</strong> Campos marcados com <strong style="color: red;">*</strong> s√£o obrigat√≥rios.
                                </div>
                            </div>
                        </details>

                        <!-- Editar RNC -->
                        <details style="margin-bottom: 1rem; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--primary); font-size: 1.1rem;">
                                ‚úèÔ∏è Editar RNC - Como modificar uma RNC existente
                            </summary>
                            <div style="margin-top: 1rem; padding-left: 1rem;">
                                <ol style="line-height: 1.8;">
                                    <li>V√° na aba <strong>Editar RNC</strong></li>
                                    <li>Use os filtros para encontrar a RNC:
                                        <ul>
                                            <li><strong>Tipo de Setor:</strong> Setor de Abertura ou Setor de N√£o Conformidade</li>
                                            <li><strong>Setor:</strong> Filtre por setor espec√≠fico</li>
                                        </ul>
                                    </li>
                                    <li>Selecione a RNC desejada no dropdown</li>
                                    <li>Modifique os campos necess√°rios</li>
                                    <li>Clique em <strong>üíæ Salvar Altera√ß√µes</strong></li>
                                </ol>
                                <div class="alert alert-warning" style="margin-top: 1rem;">
                                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Todas as altera√ß√µes s√£o registradas no hist√≥rico da RNC.
                                </div>
                            </div>
                        </details>

                        <!-- Kanban -->
                        <details style="margin-bottom: 1rem; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--primary); font-size: 1.1rem;">
                                üìã Kanban - Visualiza√ß√£o por status
                            </summary>
                            <div style="margin-top: 1rem; padding-left: 1rem;">
                                <p style="line-height: 1.6;">O Kanban organiza as RNCs em colunas por status:</p>
                                <ul style="line-height: 1.8;">
                                    <li><strong style="color: #2196F3;">üîµ Abertura RNC:</strong> RNCs rec√©m criadas</li>
                                    <li><strong style="color: #FF9800;">üü† An√°lise e A√ß√£o:</strong> Em investiga√ß√£o</li>
                                    <li><strong style="color: #4CAF50;">üü¢ Finalizadas:</strong> RNCs conclu√≠das</li>
                                </ul>
                                <p style="line-height: 1.6; margin-top: 1rem;">
                                    <strong>Filtros dispon√≠veis:</strong> Por tipo de setor e por setor espec√≠fico.
                                </p>
                                <div class="alert alert-info" style="margin-top: 1rem;">
                                    <strong>üí° Dica:</strong> Clique em <strong>üîÑ Atualizar</strong> para recarregar os dados.
                                </div>
                            </div>
                        </details>

                        <!-- Dashboard -->
                        <details style="margin-bottom: 1rem; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--primary); font-size: 1.1rem;">
                                üìä Dashboard - An√°lises e m√©tricas
                            </summary>
                            <div style="margin-top: 1rem; padding-left: 1rem;">
                                <p style="line-height: 1.6;">O Dashboard apresenta:</p>
                                <ul style="line-height: 1.8;">
                                    <li><strong>Cards de m√©tricas:</strong> Total de RNCs, abertas, fechadas, etc.</li>
                                    <li><strong>Gr√°ficos:</strong> Por status, por setor, por tipo, evolu√ß√£o temporal</li>
                                    <li><strong>Filtros:</strong> Por per√≠odo, setor e status</li>
                                </ul>
                                <div class="alert alert-success" style="margin-top: 1rem;">
                                    <strong>‚úÖ Recursos:</strong> Exportar gr√°ficos, filtros din√¢micos, atualiza√ß√£o em tempo real.
                                </div>
                            </div>
                        </details>

                        <!-- Relat√≥rios -->
                        <details style="margin-bottom: 1rem; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--primary); font-size: 1.1rem;">
                                üìà Relat√≥rios - Gera√ß√£o de relat√≥rios personalizados
                            </summary>
                            <div style="margin-top: 1rem; padding-left: 1rem;">
                                <ol style="line-height: 1.8;">
                                    <li>Selecione os <strong>filtros</strong> desejados (per√≠odo, setor, status, tipo)</li>
                                    <li>Clique em <strong>üîç Gerar Relat√≥rio</strong></li>
                                    <li>Visualize os resultados na tabela</li>
                                    <li>Use <strong>üì• Exportar CSV</strong> para baixar os dados</li>
                                </ol>
                                <div class="alert alert-info" style="margin-top: 1rem;">
                                    <strong>üí° Dica:</strong> Utilize filtros combinados para an√°lises mais espec√≠ficas.
                                </div>
                            </div>
                        </details>

                        <!-- Configura√ß√µes -->
                        <details style="margin-bottom: 1rem; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--primary); font-size: 1.1rem;">
                                ‚öôÔ∏è Configura√ß√µes - Personaliza√ß√£o do sistema (Admin)
                            </summary>
                            <div style="margin-top: 1rem; padding-left: 1rem;">
                                <p style="line-height: 1.6;"><strong>Apenas administradores</strong> t√™m acesso a:</p>
                                <ul style="line-height: 1.8;">
                                    <li><strong>Gerenciar Listas:</strong> Criar/editar op√ß√µes de campos select</li>
                                    <li><strong>Gerenciar Campos:</strong> Adicionar campos personalizados ao formul√°rio</li>
                                    <li><strong>Gerenciar Se√ß√µes:</strong> Organizar campos em se√ß√µes</li>
                                    <li><strong>Gerenciar Usu√°rios:</strong> Adicionar/remover usu√°rios e definir permiss√µes</li>
                                    <li><strong>Limpar Cache:</strong> For√ßar atualiza√ß√£o dos dados</li>
                                    <li><strong>Limpar Logs:</strong> Remover registros antigos</li>
                                </ul>
                            </div>
                        </details>

                    </div>
                </div>

                <!-- ========================================== -->
                <!-- SE√á√ïES EXCLUSIVAS PARA ADMINISTRADORES -->
                <!-- ========================================== -->

                <!-- Manual do Administrador -->
                <div class="config-section admin-only-section" style="display: none;">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üëë</span>
                            <span>Manual do Administrador</span>
                        </div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem;">üéì Bem-vindo, Administrador!</h2>
                            <p style="margin: 0; line-height: 1.8; font-size: 1.05rem;">
                                Como <strong>Administrador do Sistema RNC</strong>, voc√™ tem acesso total a todas as funcionalidades e ferramentas de configura√ß√£o.
                                Esta se√ß√£o foi criada especialmente para voc√™, com guias detalhados sobre gerenciamento de listas, campos, se√ß√µes,
                                usu√°rios, permiss√µes e ferramentas avan√ßadas de manuten√ß√£o.
                            </p>
                        </div>

                        <div style="display: grid; gap: 1.5rem;">

                            <!-- Gerenciar Listas -->
                            <details style="border: 2px solid #667eea; border-radius: 12px; padding: 1.5rem; background: #f8f9ff;">
                                <summary style="cursor: pointer; font-weight: 700; color: #667eea; font-size: 1.2rem; margin: -0.5rem;">
                                    üìã Gerenciar Listas - Controle de Op√ß√µes de Campos Select
                                </summary>
                                <div style="margin-top: 1.5rem;">
                                    <p style="line-height: 1.8; color: #555;">
                                        As <strong>Listas</strong> s√£o conjuntos de op√ß√µes que aparecem em campos do tipo "select" (dropdown) no formul√°rio de RNC.
                                        Exemplos: lista de setores, lista de tipos de n√£o conformidade, lista de classifica√ß√µes, etc.
                                    </p>

                                    <h4 style="color: #667eea; margin: 1.5rem 0 1rem 0;">üìå Como Criar uma Nova Lista</h4>
                                    <ol style="line-height: 1.8;">
                                        <li>V√° em <strong>Configura√ß√µes</strong> ‚Üí <strong>Gerenciar Listas</strong></li>
                                        <li>Clique em <strong>‚ûï Nova Lista</strong></li>
                                        <li>Preencha os campos:
                                            <ul style="margin-top: 0.5rem;">
                                                <li><strong>Nome da Lista:</strong> Identificador √∫nico (ex: "ListaTiposRNC")</li>
                                                <li><strong>Descri√ß√£o:</strong> Explica√ß√£o do que a lista cont√©m</li>
                                                <li><strong>Categoria:</strong> Para organiza√ß√£o (opcional)</li>
                                            </ul>
                                        </li>
                                        <li>Clique em <strong>Salvar</strong></li>
                                        <li>Adicione os <strong>Valores</strong> da lista clicando em <strong>‚ûï Adicionar Valor</strong></li>
                                    </ol>

                                    <h4 style="color: #667eea; margin: 1.5rem 0 1rem 0;">‚úèÔ∏è Como Editar Valores de uma Lista Existente</h4>
                                    <ol style="line-height: 1.8;">
                                        <li>Selecione a lista que deseja editar no dropdown</li>
                                        <li>Voc√™ ver√° todos os valores atuais da lista</li>
                                        <li>Para <strong>adicionar</strong> um novo valor: clique em <strong>‚ûï Adicionar Valor</strong></li>
                                        <li>Para <strong>editar</strong> um valor existente: clique no √≠cone de edi√ß√£o ‚úèÔ∏è</li>
                                        <li>Para <strong>excluir</strong> um valor: clique no √≠cone de lixeira üóëÔ∏è</li>
                                        <li>Altera√ß√µes s√£o salvas automaticamente</li>
                                    </ol>

                                    <div class="alert alert-warning" style="margin-top: 1.5rem; padding: 1rem; background: #FFF3E0; border-left: 4px solid #FF9800; border-radius: 4px;">
                                        <strong>‚ö†Ô∏è Cuidado ao Excluir:</strong> Ao remover um valor de uma lista que est√° sendo usado em RNCs existentes,
                                        essas RNCs manter√£o o valor antigo, mas ele n√£o estar√° dispon√≠vel para novas RNCs.
                                    </div>

                                    <div class="alert alert-success" style="margin-top: 1rem; padding: 1rem; background: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 4px;">
                                        <strong>üí° Boas Pr√°ticas:</strong>
                                        <ul style="margin: 0.5rem 0 0 0;">
                                            <li>Use nomes descritivos e padronizados para as listas</li>
                                            <li>Mantenha os valores organizados em ordem l√≥gica (alfab√©tica ou por prioridade)</li>
                                            <li>Documente mudan√ßas importantes nas listas</li>
                                            <li>Evite criar listas duplicadas com nomes similares</li>
                                        </ul>
                                    </div>
                                </div>
                            </details>

                            <!-- Gerenciar Campos -->
                            <details style="border: 2px solid #43a047; border-radius: 12px; padding: 1.5rem; background: #f1f8f4;">
                                <summary style="cursor: pointer; font-weight: 700; color: #43a047; font-size: 1.2rem; margin: -0.5rem;">
                                    üîß Gerenciar Campos - Personaliza√ß√£o do Formul√°rio de RNC
                                </summary>
                                <div style="margin-top: 1.5rem;">
                                    <p style="line-height: 1.8; color: #555;">
                                        Os <strong>Campos</strong> s√£o os elementos do formul√°rio de RNC (inputs, selects, textareas, datas, etc.).
                                        Voc√™ pode criar campos personalizados para capturar informa√ß√µes espec√≠ficas das suas n√£o conformidades.
                                    </p>

                                    <h4 style="color: #43a047; margin: 1.5rem 0 1rem 0;">üìå Tipos de Campos Dispon√≠veis</h4>
                                    <div style="display: grid; gap: 0.75rem;">
                                        <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #2196F3;">
                                            <strong>üìù text:</strong> Campo de texto curto (uma linha) - Ex: Nome, C√≥digo
                                        </div>
                                        <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                            <strong>üìÑ textarea:</strong> Campo de texto longo (m√∫ltiplas linhas) - Ex: Descri√ß√£o, Observa√ß√µes
                                        </div>
                                        <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #FF9800;">
                                            <strong>üìÖ date:</strong> Seletor de data - Ex: Data de Abertura, Prazo
                                        </div>
                                        <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #9C27B0;">
                                            <strong>üî¢ number:</strong> Campo num√©rico - Ex: Quantidade, Custo
                                        </div>
                                        <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #F44336;">
                                            <strong>üìã select:</strong> Lista suspensa (dropdown) - Ex: Setor, Status, Tipo
                                        </div>
                                        <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #00BCD4;">
                                            <strong>‚òëÔ∏è checkbox:</strong> Caixa de sele√ß√£o (sim/n√£o) - Ex: Urgente, Aprovado
                                        </div>
                                    </div>

                                    <h4 style="color: #43a047; margin: 1.5rem 0 1rem 0;">‚ûï Como Criar um Novo Campo</h4>
                                    <ol style="line-height: 1.8;">
                                        <li>V√° em <strong>Configura√ß√µes</strong> ‚Üí <strong>Gerenciar Campos</strong></li>
                                        <li>Clique em <strong>‚ûï Novo Campo</strong></li>
                                        <li>Preencha as informa√ß√µes:
                                            <ul style="margin-top: 0.5rem;">
                                                <li><strong>Nome do Campo:</strong> Identificador interno (sem espa√ßos, ex: "custoDaNaoConformidade")</li>
                                                <li><strong>Label:</strong> Nome que aparece no formul√°rio (ex: "Custo da N√£o Conformidade")</li>
                                                <li><strong>Tipo:</strong> Selecione o tipo de campo (text, select, date, etc.)</li>
                                                <li><strong>Se√ß√£o:</strong> Em qual se√ß√£o do formul√°rio o campo aparecer√° (Abertura, Qualidade, An√°lise, etc.)</li>
                                                <li><strong>Obrigat√≥rio:</strong> Se o campo √© obrigat√≥rio ou opcional</li>
                                                <li><strong>Ordem:</strong> Posi√ß√£o do campo dentro da se√ß√£o (campos com ordem menor aparecem primeiro)</li>
                                                <li><strong>Placeholder:</strong> Texto de ajuda que aparece dentro do campo vazio</li>
                                                <li><strong>Lista:</strong> (Apenas para campos do tipo "select") Selecione qual lista de op√ß√µes usar</li>
                                            </ul>
                                        </li>
                                        <li>Clique em <strong>Salvar Campo</strong></li>
                                        <li>O campo aparecer√° automaticamente no formul√°rio na pr√≥xima vez que for carregado</li>
                                    </ol>

                                    <h4 style="color: #43a047; margin: 1.5rem 0 1rem 0;">‚úèÔ∏è Como Editar ou Remover Campos</h4>
                                    <ol style="line-height: 1.8;">
                                        <li>Na tela de <strong>Gerenciar Campos</strong>, voc√™ ver√° uma tabela com todos os campos</li>
                                        <li>Para <strong>editar</strong>: clique no √≠cone de edi√ß√£o ‚úèÔ∏è ao lado do campo</li>
                                        <li>Para <strong>remover</strong>: clique no √≠cone de lixeira üóëÔ∏è (cuidado: dados existentes podem ser perdidos)</li>
                                        <li>Para <strong>reordenar</strong>: altere o valor da coluna "Ordem"</li>
                                    </ol>

                                    <div class="alert alert-danger" style="margin-top: 1.5rem; padding: 1rem; background: #FFEBEE; border-left: 4px solid #F44336; border-radius: 4px;">
                                        <strong>üö® ATEN√á√ÉO:</strong> Excluir um campo remove permanentemente todos os dados desse campo de todas as RNCs.
                                        Fa√ßa backup antes de excluir campos importantes!
                                    </div>

                                    <div class="alert alert-success" style="margin-top: 1rem; padding: 1rem; background: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 4px;">
                                        <strong>üí° Exemplo Pr√°tico:</strong>
                                        <p style="margin: 0.5rem 0 0 0;">Criar campo "Custo Estimado":</p>
                                        <ul style="margin: 0.5rem 0 0 0;">
                                            <li>Nome: custoEstimado</li>
                                            <li>Label: Custo Estimado (R$)</li>
                                            <li>Tipo: number</li>
                                            <li>Se√ß√£o: Qualidade</li>
                                            <li>Obrigat√≥rio: N√£o</li>
                                            <li>Placeholder: Digite o valor em reais</li>
                                        </ul>
                                    </div>
                                </div>
                            </details>

                            <!-- Gerenciar Se√ß√µes -->
                            <details style="border: 2px solid #FF9800; border-radius: 12px; padding: 1.5rem; background: #fff8f0;">
                                <summary style="cursor: pointer; font-weight: 700; color: #FF9800; font-size: 1.2rem; margin: -0.5rem;">
                                    üìë Gerenciar Se√ß√µes - Organiza√ß√£o do Formul√°rio
                                </summary>
                                <div style="margin-top: 1.5rem;">
                                    <p style="line-height: 1.8; color: #555;">
                                        As <strong>Se√ß√µes</strong> s√£o agrupamentos l√≥gicos de campos no formul√°rio de RNC.
                                        Elas organizam o formul√°rio em blocos tem√°ticos (ex: Abertura, Qualidade, An√°lise, A√ß√£o Corretiva, Encerramento).
                                    </p>

                                    <h4 style="color: #FF9800; margin: 1.5rem 0 1rem 0;">üìå Se√ß√µes Padr√£o do Sistema</h4>
                                    <ul style="line-height: 1.8;">
                                        <li><strong>Abertura:</strong> Dados iniciais da RNC (quem abriu, quando, descri√ß√£o)</li>
                                        <li><strong>Qualidade:</strong> Classifica√ß√£o e categoriza√ß√£o da n√£o conformidade</li>
                                        <li><strong>An√°lise:</strong> Investiga√ß√£o de causa raiz (5 Porqu√™s, Ishikawa, etc.)</li>
                                        <li><strong>A√ß√£o Imediata:</strong> A√ß√µes de conten√ß√£o do problema</li>
                                        <li><strong>A√ß√£o Corretiva:</strong> Plano de a√ß√£o para eliminar a causa raiz</li>
                                        <li><strong>Lideran√ßa:</strong> Aprova√ß√µes e decis√µes gerenciais</li>
                                        <li><strong>Encerramento:</strong> Valida√ß√£o de efic√°cia e fechamento da RNC</li>
                                    </ul>

                                    <h4 style="color: #FF9800; margin: 1.5rem 0 1rem 0;">‚ûï Como Criar uma Nova Se√ß√£o</h4>
                                    <ol style="line-height: 1.8;">
                                        <li>V√° em <strong>Configura√ß√µes</strong> ‚Üí <strong>Gerenciar Se√ß√µes</strong></li>
                                        <li>Clique em <strong>‚ûï Nova Se√ß√£o</strong></li>
                                        <li>Preencha:
                                            <ul style="margin-top: 0.5rem;">
                                                <li><strong>Nome:</strong> Identificador da se√ß√£o (ex: "Custo e Impacto")</li>
                                                <li><strong>Descri√ß√£o:</strong> Explica√ß√£o do que a se√ß√£o cont√©m</li>
                                                <li><strong>Ordem:</strong> Posi√ß√£o da se√ß√£o no formul√°rio (menor = aparece primeiro)</li>
                                                <li><strong>√çcone:</strong> Emoji ou √≠cone para representar a se√ß√£o</li>
                                                <li><strong>Cor:</strong> Cor de destaque para o cabe√ßalho da se√ß√£o</li>
                                            </ul>
                                        </li>
                                        <li>Salve a se√ß√£o</li>
                                        <li>Adicione campos a essa se√ß√£o atrav√©s de <strong>Gerenciar Campos</strong></li>
                                    </ol>

                                    <div class="alert alert-info" style="margin-top: 1.5rem; padding: 1rem; background: #E3F2FD; border-left: 4px solid #2196F3; border-radius: 4px;">
                                        <strong>üí° Dica:</strong> Use se√ß√µes para organizar logicamente o fluxo de preenchimento da RNC.
                                        Campos relacionados devem estar na mesma se√ß√£o.
                                    </div>
                                </div>
                            </details>

                            <!-- Gerenciar Usu√°rios e Permiss√µes -->
                            <details style="border: 2px solid #9C27B0; border-radius: 12px; padding: 1.5rem; background: #f9f0ff;">
                                <summary style="cursor: pointer; font-weight: 700; color: #9C27B0; font-size: 1.2rem; margin: -0.5rem;">
                                    üë• Gerenciar Usu√°rios e Permiss√µes - Controle de Acesso
                                </summary>
                                <div style="margin-top: 1.5rem;">
                                    <p style="line-height: 1.8; color: #555;">
                                        O sistema de permiss√µes controla quem pode ver e editar cada se√ß√£o do formul√°rio de RNC.
                                        Voc√™ pode conceder diferentes n√≠veis de acesso a cada usu√°rio baseado em sua fun√ß√£o (role).
                                    </p>

                                    <h4 style="color: #9C27B0; margin: 1.5rem 0 1rem 0;">üìå Estrutura de Permiss√µes</h4>
                                    <p style="line-height: 1.8; margin-bottom: 1rem;">Cada usu√°rio possui:</p>
                                    <ul style="line-height: 1.8;">
                                        <li><strong>Email:</strong> Identifica√ß√£o √∫nica do usu√°rio (email corporativo)</li>
                                        <li><strong>Role:</strong> Fun√ß√£o do usu√°rio (Admin, Qualidade, Lideran√ßa, Abertura, Espectador)</li>
                                        <li><strong>Setor:</strong> Departamento ao qual o usu√°rio pertence</li>
                                        <li><strong>Status:</strong> Ativo ou Inativo (controla se o usu√°rio pode acessar o sistema)</li>
                                    </ul>

                                    <h4 style="color: #9C27B0; margin: 1.5rem 0 1rem 0;">‚ûï Como Adicionar um Novo Usu√°rio</h4>
                                    <ol style="line-height: 1.8;">
                                        <li>V√° em <strong>Configura√ß√µes</strong> ‚Üí <strong>Gerenciar Usu√°rios</strong></li>
                                        <li>Clique em <strong>‚ûï Adicionar Usu√°rio</strong></li>
                                        <li>Preencha os dados:
                                            <ul style="margin-top: 0.5rem;">
                                                <li><strong>Email:</strong> Email corporativo do usu√°rio (ex: joao.silva@neoformula.com.br)</li>
                                                <li><strong>Nome:</strong> Nome completo do usu√°rio</li>
                                                <li><strong>Role:</strong> Selecione a fun√ß√£o (Admin, Qualidade, Lideran√ßa, etc.)</li>
                                                <li><strong>Setor:</strong> Departamento do usu√°rio</li>
                                                <li><strong>Ativo:</strong> Marque "Sim" para permitir acesso</li>
                                            </ul>
                                        </li>
                                        <li>Clique em <strong>Salvar</strong></li>
                                        <li>O usu√°rio poder√° acessar o sistema imediatamente com as permiss√µes definidas</li>
                                    </ol>

                                    <h4 style="color: #9C27B0; margin: 1.5rem 0 1rem 0;">üîÑ Como Alterar Permiss√µes de um Usu√°rio</h4>
                                    <ol style="line-height: 1.8;">
                                        <li>Encontre o usu√°rio na lista de usu√°rios</li>
                                        <li>Clique no √≠cone de edi√ß√£o ‚úèÔ∏è</li>
                                        <li>Modifique a <strong>Role</strong> para alterar as permiss√µes</li>
                                        <li>Para <strong>m√∫ltiplas roles</strong>, adicione o mesmo usu√°rio com roles diferentes</li>
                                        <li>Para <strong>desativar</strong> acesso: mude "Ativo" para "N√£o"</li>
                                    </ol>

                                    <h4 style="color: #9C27B0; margin: 1.5rem 0 1rem 0;">üîê Matriz de Permiss√µes por Role</h4>
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; border-radius: 8px; overflow: hidden;">
                                            <thead>
                                                <tr style="background: #9C27B0; color: white;">
                                                    <th style="padding: 0.75rem; text-align: left; border: 1px solid #ddd;">Role</th>
                                                    <th style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">Abertura</th>
                                                    <th style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">Qualidade</th>
                                                    <th style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">An√°lise</th>
                                                    <th style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">Lideran√ßa</th>
                                                    <th style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">Config</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-weight: 600;">Admin</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E8F5E9;">‚úèÔ∏è Editar</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E8F5E9;">‚úèÔ∏è Editar</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E8F5E9;">‚úèÔ∏è Editar</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E8F5E9;">‚úèÔ∏è Editar</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E8F5E9;">‚úÖ Sim</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-weight: 600;">Qualidade</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E8F5E9;">‚úèÔ∏è Editar</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E8F5E9;">‚úèÔ∏è Editar</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #FFEBEE;">‚ùå N√£o</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-weight: 600;">Lideran√ßa</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E8F5E9;">‚úèÔ∏è Editar</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #FFEBEE;">‚ùå N√£o</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-weight: 600;">Abertura</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E8F5E9;">‚úèÔ∏è Editar</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #FFEBEE;">‚ùå N√£o</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-weight: 600;">Espectador</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #E3F2FD;">üëÅÔ∏è Ver</td>
                                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; background: #FFEBEE;">‚ùå N√£o</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <div class="alert alert-warning" style="margin-top: 1.5rem; padding: 1rem; background: #FFF3E0; border-left: 4px solid #FF9800; border-radius: 4px;">
                                        <strong>‚ö†Ô∏è Importante:</strong> Apenas usu√°rios com role <strong>Admin</strong> podem acessar a aba Configura√ß√µes
                                        e gerenciar listas, campos, se√ß√µes e usu√°rios.
                                    </div>

                                    <div class="alert alert-success" style="margin-top: 1rem; padding: 1rem; background: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 4px;">
                                        <strong>üí° Boas Pr√°ticas de Seguran√ßa:</strong>
                                        <ul style="margin: 0.5rem 0 0 0;">
                                            <li>Conceda role Admin apenas para pessoas de confian√ßa</li>
                                            <li>Revise periodicamente a lista de usu√°rios ativos</li>
                                            <li>Desative (n√£o delete) usu√°rios que sa√≠ram da empresa</li>
                                            <li>Use emails corporativos para autentica√ß√£o</li>
                                            <li>Documente mudan√ßas de permiss√µes importantes</li>
                                        </ul>
                                    </div>
                                </div>
                            </details>

                            <!-- Ferramentas de Manuten√ß√£o -->
                            <details style="border: 2px solid #00BCD4; border-radius: 12px; padding: 1.5rem; background: #f0fbff;">
                                <summary style="cursor: pointer; font-weight: 700; color: #00BCD4; font-size: 1.2rem; margin: -0.5rem;">
                                    üõ†Ô∏è Ferramentas de Manuten√ß√£o e Diagn√≥stico
                                </summary>
                                <div style="margin-top: 1.5rem;">
                                    <p style="line-height: 1.8; color: #555;">
                                        Como administrador, voc√™ tem acesso a ferramentas avan√ßadas de manuten√ß√£o para otimizar o desempenho,
                                        solucionar problemas e manter a integridade do sistema.
                                    </p>

                                    <h4 style="color: #00BCD4; margin: 1.5rem 0 1rem 0;">üßπ Gerenciamento de Cache</h4>
                                    <p style="line-height: 1.8;">
                                        O sistema usa cache para melhorar a performance. Quando dados parecem desatualizados, limpe o cache:
                                    </p>
                                    <ol style="line-height: 1.8;">
                                        <li>V√° em <strong>Configura√ß√µes</strong> ‚Üí <strong>Gerenciamento de Cache</strong></li>
                                        <li>Op√ß√µes dispon√≠veis:
                                            <ul style="margin-top: 0.5rem;">
                                                <li><strong>Limpar Todo o Cache:</strong> Remove todos os dados cacheados (recomendado ap√≥s mudan√ßas grandes)</li>
                                                <li><strong>Limpar Cache de RNCs:</strong> Remove apenas cache de n√£o conformidades</li>
                                                <li><strong>Limpar Cache de Configura√ß√µes:</strong> Remove cache de listas, campos e se√ß√µes</li>
                                            </ul>
                                        </li>
                                        <li>Ap√≥s limpar, pressione <strong>F5</strong> para recarregar a p√°gina</li>
                                    </ol>

                                    <h4 style="color: #00BCD4; margin: 1.5rem 0 1rem 0;">üìã Gerenciamento de Logs</h4>
                                    <p style="line-height: 1.8;">
                                        O sistema registra todas as opera√ß√µes em logs para auditoria e diagn√≥stico:
                                    </p>
                                    <ul style="line-height: 1.8;">
                                        <li><strong>Visualizar Logs:</strong> Configura√ß√µes ‚Üí Gerenciamento de Logs ‚Üí Ver Logs Recentes</li>
                                        <li><strong>Limpar Logs Antigos:</strong> Remove logs com mais de X dias (libera espa√ßo)</li>
                                        <li><strong>Filtrar Logs:</strong> Por tipo (erro, info, warning), data ou a√ß√£o</li>
                                    </ul>

                                    <h4 style="color: #00BCD4; margin: 1.5rem 0 1rem 0;">üó∫Ô∏è Ferramentas de Organiza√ß√£o da Aba RNC</h4>
                                    <p style="line-height: 1.8;">
                                        Ferramentas espec√≠ficas para manuten√ß√£o da planilha base (aba RNC no Google Sheets):
                                    </p>
                                    <div style="background: white; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                        <strong>üó∫Ô∏è Mapear Colunas da Aba RNC:</strong>
                                        <p style="margin: 0.5rem 0 0 0; line-height: 1.6;">
                                            Atualiza automaticamente a coluna "OrdemRNC" na aba ConfigCampos com a posi√ß√£o f√≠sica de cada campo na aba RNC.
                                            Use ap√≥s adicionar ou remover colunas manualmente na planilha.
                                        </p>
                                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">
                                            üìç Localiza√ß√£o: Google Sheets ‚Üí Menu "üìã RNC" ‚Üí "üîß Manuten√ß√£o" ‚Üí "üó∫Ô∏è Mapear Colunas da Aba RNC"
                                        </p>
                                    </div>
                                    <div style="background: white; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                        <strong>üé® Pintar Colunas por Se√ß√£o:</strong>
                                        <p style="margin: 0.5rem 0 0 0; line-height: 1.6;">
                                            Aplica cores past√©is aos cabe√ßalhos das colunas da aba RNC de acordo com a se√ß√£o a que cada campo pertence.
                                            Facilita a identifica√ß√£o visual de campos relacionados.
                                        </p>
                                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">
                                            üìç Localiza√ß√£o: Google Sheets ‚Üí Menu "üìã RNC" ‚Üí "üîß Manuten√ß√£o" ‚Üí "üé® Pintar Colunas por Se√ß√£o"
                                        </p>
                                    </div>
                                    <div style="background: white; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                        <strong>üìê Formatar Aba RNC:</strong>
                                        <p style="margin: 0.5rem 0 0 0; line-height: 1.6;">
                                            Aplica formata√ß√£o completa √† aba RNC: centraliza cabe√ßalhos, alinha dados, adiciona bordas,
                                            ajusta largura de colunas e altura de linhas, e congela a primeira linha.
                                        </p>
                                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">
                                            üìç Localiza√ß√£o: Google Sheets ‚Üí Menu "üìã RNC" ‚Üí "üîß Manuten√ß√£o" ‚Üí "üìê Formatar Aba RNC"
                                        </p>
                                    </div>

                                    <div class="alert alert-info" style="margin-top: 1.5rem; padding: 1rem; background: #E3F2FD; border-left: 4px solid #2196F3; border-radius: 4px;">
                                        <strong>üí° Quando Usar Cada Ferramenta:</strong>
                                        <ul style="margin: 0.5rem 0 0 0;">
                                            <li><strong>Mapear Colunas:</strong> Depois de adicionar/remover campos ou reorganizar colunas manualmente</li>
                                            <li><strong>Pintar Colunas:</strong> Para melhorar organiza√ß√£o visual da planilha</li>
                                            <li><strong>Formatar Aba:</strong> Ap√≥s importar dados ou quando a formata√ß√£o estiver inconsistente</li>
                                        </ul>
                                    </div>
                                </div>
                            </details>

                            <!-- Sistema de Notifica√ß√µes -->
                            <details style="border: 2px solid #F44336; border-radius: 12px; padding: 1.5rem; background: #fff5f5;">
                                <summary style="cursor: pointer; font-weight: 700; color: #F44336; font-size: 1.2rem; margin: -0.5rem;">
                                    üîî Sistema de Notifica√ß√µes por Email
                                </summary>
                                <div style="margin-top: 1.5rem;">
                                    <p style="line-height: 1.8; color: #555;">
                                        O sistema envia notifica√ß√µes autom√°ticas por email em eventos importantes do ciclo de vida das RNCs.
                                    </p>

                                    <h4 style="color: #F44336; margin: 1.5rem 0 1rem 0;">üìß Eventos que Disparam Notifica√ß√µes</h4>
                                    <ul style="line-height: 1.8;">
                                        <li><strong>Cria√ß√£o de RNC:</strong> Email enviado ao setor da n√£o conformidade informando a abertura</li>
                                        <li><strong>Atualiza√ß√£o de RNC:</strong> Email para stakeholders quando campos importantes s√£o modificados</li>
                                        <li><strong>Mudan√ßa de Status:</strong> Notifica√ß√£o quando a RNC muda de fase (Abertura ‚Üí An√°lise ‚Üí Finalizada)</li>
                                        <li><strong>Atribui√ß√£o de Respons√°vel:</strong> Email para o usu√°rio designado como respons√°vel pela a√ß√£o</li>
                                    </ul>

                                    <h4 style="color: #F44336; margin: 1.5rem 0 1rem 0;">üìù Conte√∫do dos Emails</h4>
                                    <p style="line-height: 1.8;">Os emails de notifica√ß√£o incluem:</p>
                                    <ul style="line-height: 1.8;">
                                        <li>Logo da Neoformula</li>
                                        <li>N√∫mero da RNC (ex: 0042/2025)</li>
                                        <li>Status atual</li>
                                        <li>Setor da n√£o conformidade</li>
                                        <li>Descri√ß√£o resumida</li>
                                        <li>Data de abertura</li>
                                        <li>Respons√°vel</li>
                                        <li>Link direto para visualizar/editar a RNC no sistema</li>
                                    </ul>

                                    <div class="alert alert-success" style="margin-top: 1.5rem; padding: 1rem; background: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 4px;">
                                        <strong>‚úÖ Benef√≠cios:</strong>
                                        <ul style="margin: 0.5rem 0 0 0;">
                                            <li>Comunica√ß√£o proativa com os envolvidos</li>
                                            <li>Redu√ß√£o de tempo de resposta</li>
                                            <li>Rastreabilidade de comunica√ß√µes</li>
                                            <li>Transpar√™ncia no processo</li>
                                        </ul>
                                    </div>
                                </div>
                            </details>

                            <!-- Sistema de Backup -->
                            <details style="border: 2px solid #FF6F00; border-radius: 12px; padding: 1.5rem; background: #fff3e0;">
                                <summary style="cursor: pointer; font-weight: 700; color: #FF6F00; font-size: 1.2rem; margin: -0.5rem;">
                                    üíæ Sistema de Backup - Exporta√ß√£o e Hist√≥rico de Dados
                                </summary>
                                <div style="margin-top: 1.5rem;">
                                    <p style="line-height: 1.8; color: #555;">
                                        O <strong>Sistema de Backup</strong> permite exportar todos os dados da planilha para arquivos JSON com timestamp,
                                        armazenados em uma pasta do Google Drive. Esses backups s√£o essenciais para hist√≥rico, recupera√ß√£o de dados
                                        e futura migra√ß√£o para banco de dados externo.
                                    </p>

                                    <h4 style="color: #FF6F00; margin: 1.5rem 0 1rem 0;">üì¶ O que √© Exportado no Backup?</h4>
                                    <p style="line-height: 1.8;">Cada backup cont√©m todas as tabelas do sistema:</p>
                                    <ul style="line-height: 1.8;">
                                        <li><strong>RNC:</strong> Todos os dados das n√£o conformidades</li>
                                        <li><strong>ConfigCampos:</strong> Configura√ß√£o dos campos do formul√°rio</li>
                                        <li><strong>ConfigListas:</strong> Todas as listas de op√ß√µes (dropdowns)</li>
                                        <li><strong>ConfigSecoes:</strong> Configura√ß√£o das se√ß√µes do formul√°rio</li>
                                        <li><strong>Permissoes:</strong> Usu√°rios, roles e permiss√µes</li>
                                        <li><strong>Logs:</strong> Hist√≥rico de todas as opera√ß√µes</li>
                                        <li><strong>Historico:</strong> Registro de altera√ß√µes em RNCs</li>
                                        <li><strong>ConfigSistema:</strong> Configura√ß√µes gerais do sistema</li>
                                    </ul>

                                    <h4 style="color: #FF6F00; margin: 1.5rem 0 1rem 0;">üöÄ Como Configurar e Usar</h4>

                                    <div style="background: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #FF6F00;">
                                        <h5 style="margin: 0 0 0.5rem 0; color: #FF6F00;">Passo 1: Configurar Pasta de Destino</h5>
                                        <ol style="line-height: 1.8; margin: 0.5rem 0 0 1rem;">
                                            <li>Crie uma pasta no seu Google Drive (ex: "Backups Sistema RNC")</li>
                                            <li>Abra a pasta e copie o <strong>ID</strong> da URL:<br>
                                                <code style="background: #f5f5f5; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;">
                                                    https://drive.google.com/drive/folders/<span style="color: #FF6F00; font-weight: bold;">1ABC...xyz</span>
                                                </code>
                                            </li>
                                            <li>V√° em <strong>Configura√ß√µes</strong> ‚Üí <strong>Sistema de Backup</strong></li>
                                            <li>Cole o ID no campo <strong>"ID da Pasta do Google Drive"</strong></li>
                                            <li>Clique em <strong>üíæ Salvar</strong></li>
                                        </ol>
                                    </div>

                                    <div style="background: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #4CAF50;">
                                        <h5 style="margin: 0 0 0.5rem 0; color: #4CAF50;">Passo 2: Criar Backup</h5>
                                        <ol style="line-height: 1.8; margin: 0.5rem 0 0 1rem;">
                                            <li>Na mesma tela, clique no bot√£o <strong>üì¶ Criar Backup Agora</strong></li>
                                            <li>Aguarde alguns segundos enquanto o sistema exporta os dados</li>
                                            <li>Voc√™ ver√° uma mensagem de sucesso com:
                                                <ul style="margin-top: 0.5rem;">
                                                    <li>Nome do arquivo gerado (ex: <code>Backup_RNC_20251222_143000.json</code>)</li>
                                                    <li>Data e hora do backup</li>
                                                    <li>N√∫mero de tabelas exportadas</li>
                                                    <li>Total de linhas</li>
                                                    <li>Tamanho do arquivo</li>
                                                </ul>
                                            </li>
                                            <li>Clique em <strong>üîó Abrir Arquivo no Drive</strong> para visualizar</li>
                                        </ol>
                                    </div>

                                    <div style="background: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #2196F3;">
                                        <h5 style="margin: 0 0 0.5rem 0; color: #2196F3;">Passo 3: Gerenciar Backups</h5>
                                        <ul style="line-height: 1.8; margin: 0.5rem 0 0 1rem;">
                                            <li>Clique em <strong>üìã Listar Backups</strong> para ver todos os backups criados</li>
                                            <li>Para cada backup voc√™ pode:
                                                <ul style="margin-top: 0.5rem;">
                                                    <li><strong>üîó Abrir:</strong> Visualizar o arquivo no Google Drive</li>
                                                    <li><strong>üóëÔ∏è Deletar:</strong> Remover backup antigo (com confirma√ß√£o)</li>
                                                </ul>
                                            </li>
                                            <li>Use <strong>üìÇ Abrir Pasta</strong> para acessar a pasta de backups no Drive</li>
                                        </ul>
                                    </div>

                                    <h4 style="color: #FF6F00; margin: 1.5rem 0 1rem 0;">üìÑ Formato do Arquivo JSON</h4>
                                    <p style="line-height: 1.8;">
                                        O backup √© salvo em formato JSON estruturado, facilitando importa√ß√£o em bancos de dados.
                                        Cada arquivo cont√©m:
                                    </p>
                                    <div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem; overflow-x: auto;">
{
  "metadata": {
    "backupDate": "2025-12-22T14:30:00.000Z",
    "backupDateBrazil": "22/12/2025 14:30:00",
    "spreadsheetId": "...",
    "version": "Sistema RNC v2.4 - Deploy 123",
    "totalSheets": 8
  },
  "sheets": {
    "RNC": {
      "sheetName": "RNC",
      "headers": ["NumeroRNC", "DataAbertura", ...],
      "rows": [[...], [...], ...],
      "totalRows": 150,
      "exportDate": "2025-12-22T14:30:00.000Z"
    },
    ...
  }
}
                                    </div>

                                    <h4 style="color: #FF6F00; margin: 1.5rem 0 1rem 0;">üí° Casos de Uso</h4>
                                    <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                                        <div style="padding: 1rem; background: #E8F5E9; border-radius: 8px;">
                                            <strong style="color: #4CAF50;">üìä Hist√≥rico Completo</strong>
                                            <p style="margin: 0.5rem 0 0 0; line-height: 1.6;">
                                                Mantenha snapshots regulares (di√°rios, semanais) para hist√≥rico completo de todas as mudan√ßas.
                                            </p>
                                        </div>
                                        <div style="padding: 1rem; background: #FFEBEE; border-radius: 8px;">
                                            <strong style="color: #F44336;">üîÑ Recupera√ß√£o de Desastres</strong>
                                            <p style="margin: 0.5rem 0 0 0; line-height: 1.6;">
                                                Em caso de exclus√£o acidental ou corrup√ß√£o de dados, restaure de um backup anterior.
                                            </p>
                                        </div>
                                        <div style="padding: 1rem; background: #E3F2FD; border-radius: 8px;">
                                            <strong style="color: #2196F3;">üóÑÔ∏è Migra√ß√£o para Banco de Dados</strong>
                                            <p style="margin: 0.5rem 0 0 0; line-height: 1.6;">
                                                Use os arquivos JSON para importar dados em PostgreSQL, MySQL, MongoDB ou outro BD.
                                            </p>
                                        </div>
                                        <div style="padding: 1rem; background: #FFF3E0; border-radius: 8px;">
                                            <strong style="color: #FF9800;">üìà An√°lise de Dados</strong>
                                            <p style="margin: 0.5rem 0 0 0; line-height: 1.6;">
                                                Importe backups em ferramentas de BI (Power BI, Tableau) para an√°lises avan√ßadas.
                                            </p>
                                        </div>
                                        <div style="padding: 1rem; background: #F3E5F5; border-radius: 8px;">
                                            <strong style="color: #9C27B0;">üìã Auditoria e Compliance</strong>
                                            <p style="margin: 0.5rem 0 0 0; line-height: 1.6;">
                                                Mantenha registros hist√≥ricos para atender requisitos de auditoria e compliance.
                                            </p>
                                        </div>
                                    </div>

                                    <div class="alert alert-info" style="margin-top: 1.5rem; padding: 1rem; background: #E3F2FD; border-left: 4px solid #2196F3; border-radius: 4px;">
                                        <strong>üí° Boas Pr√°ticas:</strong>
                                        <ul style="margin: 0.5rem 0 0 0;">
                                            <li>Crie backups <strong>antes</strong> de realizar grandes mudan√ßas no sistema</li>
                                            <li>Mantenha backups <strong>regulares</strong> (recomendado: semanal ou quinzenal)</li>
                                            <li>Organize backups em <strong>subpastas por m√™s/ano</strong> no Drive</li>
                                            <li>Baixe backups cr√≠ticos para <strong>armazenamento local</strong> tamb√©m</li>
                                            <li>Documente a <strong>periodicidade</strong> e mantenha um calend√°rio de backups</li>
                                            <li>Teste periodicamente a <strong>integridade</strong> dos arquivos JSON</li>
                                        </ul>
                                    </div>

                                    <div class="alert alert-warning" style="margin-top: 1rem; padding: 1rem; background: #FFF3E0; border-left: 4px solid #FF9800; border-radius: 4px;">
                                        <strong>‚ö†Ô∏è Importante:</strong>
                                        <ul style="margin: 0.5rem 0 0 0;">
                                            <li>Backups <strong>n√£o s√£o restaurados automaticamente</strong> - s√£o apenas exporta√ß√µes</li>
                                            <li>Mantenha a <strong>pasta de backup segura</strong> com permiss√µes adequadas</li>
                                            <li>Backups de sistemas com <strong>muitos dados</strong> podem demorar alguns minutos</li>
                                            <li>Arquivos JSON podem ser <strong>grandes</strong> - monitore espa√ßo no Drive</li>
                                        </ul>
                                    </div>

                                    <h4 style="color: #FF6F00; margin: 1.5rem 0 1rem 0;">üîÆ Pr√≥ximos Passos (Futuro)</h4>
                                    <p style="line-height: 1.8;">Recursos que podem ser implementados:</p>
                                    <ul style="line-height: 1.8;">
                                        <li><strong>Backup Autom√°tico:</strong> Agendamento com Google Apps Script triggers</li>
                                        <li><strong>Compress√£o:</strong> Arquivos ZIP para economizar espa√ßo</li>
                                        <li><strong>Restaura√ß√£o:</strong> Fun√ß√£o para restaurar dados de um backup</li>
                                        <li><strong>Versionamento:</strong> Manter apenas N backups mais recentes automaticamente</li>
                                        <li><strong>Notifica√ß√µes:</strong> Email quando backup √© criado ou falha</li>
                                    </ul>

                                </div>
                            </details>

                        </div>
                    </div>
                </div>

                <!-- FAQ -->
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>‚ùì</span>
                            <span>Perguntas Frequentes (FAQ)</span>
                        </div>
                    </div>
                    <div style="padding: 1.5rem;">

                        <details style="margin-bottom: 1rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: #555;">
                                Como alterar o status de uma RNC?
                            </summary>
                            <div style="margin-top: 0.5rem; padding-left: 1rem; color: #666;">
                                O status √© atualizado automaticamente conforme voc√™ preenche os campos de cada se√ß√£o
                                (Abertura, An√°lise, A√ß√£o Corretiva, Encerramento).
                            </div>
                        </details>

                        <details style="margin-bottom: 1rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: #555;">
                                Como anexar arquivos a uma RNC?
                            </summary>
                            <div style="margin-top: 0.5rem; padding-left: 1rem; color: #666;">
                                Em qualquer se√ß√£o do formul√°rio, clique no bot√£o <strong>üìé Anexar Arquivo</strong>,
                                selecione o arquivo desejado e clique em <strong>Upload</strong>.
                            </div>
                        </details>

                        <details style="margin-bottom: 1rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: #555;">
                                O que fazer se os dados n√£o aparecem ou est√£o desatualizados?
                            </summary>
                            <div style="margin-top: 0.5rem; padding-left: 1rem; color: #666;">
                                V√° em <strong>Configura√ß√µes</strong> ‚Üí <strong>Gerenciamento de Cache</strong> ‚Üí
                                <strong>Limpar Todo o Cache do Sistema</strong>. Depois atualize a p√°gina (F5).
                            </div>
                        </details>

                        <details style="margin-bottom: 1rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: #555;">
                                Como imprimir uma RNC?
                            </summary>
                            <div style="margin-top: 0.5rem; padding-left: 1rem; color: #666;">
                                Abra a planilha Google Sheets, v√° no menu <strong>üìã RNC</strong> ‚Üí
                                <strong>üñ®Ô∏è Imprimir RNC</strong> e selecione o n√∫mero da RNC desejada.
                            </div>
                        </details>

                        <details style="margin-bottom: 1rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: #555;">
                                Quais s√£o os diferentes n√≠veis de permiss√£o?
                            </summary>
                            <div style="margin-top: 0.5rem; padding-left: 1rem; color: #666;">
                                <ul style="margin: 0.5rem 0;">
                                    <li><strong>Admin:</strong> Acesso total ao sistema</li>
                                    <li><strong>Qualidade:</strong> Edita se√ß√µes de Qualidade e An√°lise</li>
                                    <li><strong>Lideran√ßa:</strong> Edita se√ß√£o de Lideran√ßa</li>
                                    <li><strong>Espectador:</strong> Apenas visualiza</li>
                                </ul>
                            </div>
                        </details>

                    </div>
                </div>

                <!-- Dicas e Truques -->
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üí°</span>
                            <span>Dicas e Truques</span>
                        </div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: grid; gap: 1rem;">

                            <div style="display: flex; gap: 1rem; padding: 1rem; background: #E8F5E9; border-radius: 8px;">
                                <div style="font-size: 1.5rem;">‚å®Ô∏è</div>
                                <div>
                                    <strong>Atalhos:</strong> Use <kbd style="padding: 2px 6px; background: white; border: 1px solid #ccc; border-radius: 3px;">F5</kbd>
                                    para recarregar a p√°gina e atualizar dados.
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; padding: 1rem; background: #E3F2FD; border-radius: 8px;">
                                <div style="font-size: 1.5rem;">üîç</div>
                                <div>
                                    <strong>Filtros:</strong> Use filtros combinados (setor + per√≠odo + status) para an√°lises mais precisas.
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; padding: 1rem; background: #FFF3E0; border-radius: 8px;">
                                <div style="font-size: 1.5rem;">üìä</div>
                                <div>
                                    <strong>Performance:</strong> Se o sistema estiver lento, limpe o cache em Configura√ß√µes.
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; padding: 1rem; background: #F3E5F5; border-radius: 8px;">
                                <div style="font-size: 1.5rem;">üìã</div>
                                <div>
                                    <strong>Organiza√ß√£o:</strong> Use campos descritivos ao criar RNCs para facilitar buscas futuras.
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Contato/Suporte -->
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üìû</span>
                            <span>Suporte</span>
                        </div>
                    </div>
                    <div style="padding: 1.5rem; text-align: center;">
                        <p style="font-size: 1.1rem; line-height: 1.6; color: #555;">
                            Em caso de d√∫vidas, problemas t√©cnicos ou sugest√µes, entre em contato com:
                        </p>
                        <div style="margin-top: 1.5rem; padding: 1.5rem; background: #E8F5E9; border-radius: 8px; display: inline-block;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üíª</div>
                            <div style="font-weight: 600; font-size: 1.2rem; color: var(--primary);">TI Neoformula</div>
                            <div style="margin-top: 0.5rem; color: #666;">Equipe de Tecnologia da Informa√ß√£o</div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #C8E6C9;">
                                <div style="margin: 0.5rem 0;">
                                    <strong style="color: var(--primary);">üìß Email:</strong>
                                    <a href="mailto:ti.neoformula@neoformula.com.br" style="color: #009688;">ti.neoformula@neoformula.com.br</a>
                                </div>
                                <div style="margin: 0.5rem 0;">
                                    <strong style="color: var(--primary);">üìû Ramal:</strong>
                                    <span style="color: #666;">9929</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div id="loadingMessage">Carregando...</div>
        </div>
    </div>

    <!-- Deploy 74.5.2: Rodap√© -->
    <footer class="app-footer">
        <div class="footer-content">
            <span>Sistema RNC Neoformula - Elaborado por: TI Neoformula</span>
        </div>
    </footer>

    <!-- Debug Panel -->
    <button class="debug-toggle" id="debugToggle" title="Debug">üêõ</button>
    <div class="debug-panel" id="debugPanel">
        <div class="debug-header">
            <div class="debug-title">üêõ SISTEMA RNC DEBUG</div>
            <button class="debug-clear" onclick="clearDebugLog()">Clear</button>
        </div>
        <div class="debug-section">
            <div>systemReady: <span id="debugSystemReady">false</span></div>
            <div>currentRnc: <span id="debugCurrentRnc">null</span></div>
            <div>availableRncs: <span id="debugAvailableRncs">0</span></div>
            <div>reportData: <span id="debugReportData">null</span></div>
        </div>
        <div class="debug-section">
            <h4>üìã √öLTIMOS LOGS:</h4>
            <div class="debug-log" id="debugLogs"></div>
        </div>
    </div>

    <script>

// ==========================================
// TASK-001: FUN√á√ÉO DE SANITIZA√á√ÉO HTML
// SEGURAN√áA: Previne XSS (Cross-Site Scripting)
// ==========================================

/**
 * Sanitiza HTML removendo tags e atributos perigosos
 * @param {string} html - HTML a ser sanitizado
 * @returns {string} HTML sanitizado e seguro
 */
function sanitizeHTML(html) {
    if (!html) return '';

    // Criar elemento tempor√°rio para parsing
    const temp = document.createElement('div');
    temp.textContent = html; // textContent automaticamente escapa HTML

    // Lista de tags permitidas (whitelist)
    const allowedTags = ['b', 'i', 'u', 'strong', 'em', 'br', 'p', 'span', 'div'];

    // Lista de atributos perigosos (blacklist)
    const dangerousAttributes = [
        'onclick', 'onload', 'onerror', 'onmouseover', 'onmouseout',
        'onfocus', 'onblur', 'onchange', 'onsubmit', 'onkeydown',
        'onkeyup', 'onkeypress', 'javascript:', 'data:', 'vbscript:'
    ];

    let sanitized = temp.innerHTML;

    // Remover scripts
    sanitized = sanitized.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');

    // Remover iframes
    sanitized = sanitized.replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '');

    // Remover event handlers
    dangerousAttributes.forEach(attr => {
        const regex = new RegExp(`\\s*${attr}\\s*=\\s*["'][^"']*["']`, 'gi');
        sanitized = sanitized.replace(regex, '');
    });

    return sanitized;
}

// ==========================================
// FASE 2.6: FUN√á√ÉO DE DEBOUNCE
// PERFORMANCE: Reduz chamadas excessivas em filtros/busca
// ==========================================

/**
 * Cria uma fun√ß√£o com debounce (atraso)
 * FASE 2.6: Previne execu√ß√£o excessiva de fun√ß√µes em eventos r√°pidos
 * @param {Function} func - Fun√ß√£o a ser executada
 * @param {number} wait - Tempo de espera em ms
 * @returns {Function} Fun√ß√£o com debounce aplicado
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Define conte√∫do HTML de forma segura, sempre sanitizando
 * @param {HTMLElement} element - Elemento DOM
 * @param {string} html - Conte√∫do HTML a ser sanitizado
 */
function safeSetHTML(element, html) {
    if (!element) return;
    element.innerHTML = sanitizeHTML(html);
}

// ==========================================
// TASK-006: FUN√á√ïES DE VALIDA√á√ÉO DE INPUT
// SEGURAN√áA: Previne dados inv√°lidos e ataques de inje√ß√£o
// ==========================================

/**
 * Valida um campo de email
 * @param {string} email - Email a ser validado
 * @returns {boolean} True se v√°lido
 */
function validateEmail(email) {
    if (!email || typeof email !== 'string') return false;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email) && email.length <= 255;
}

/**
 * Valida um campo de texto geral
 * @param {string} text - Texto a ser validado
 * @param {number} maxLength - Tamanho m√°ximo permitido
 * @returns {boolean} True se v√°lido
 */
function validateText(text, maxLength = 5000) {
    if (text === null || text === undefined) return false;
    if (typeof text !== 'string') return false;
    return text.length <= maxLength;
}

/**
 * Valida um campo num√©rico
 * @param {*} value - Valor a ser validado
 * @param {number} min - Valor m√≠nimo (opcional)
 * @param {number} max - Valor m√°ximo (opcional)
 * @returns {boolean} True se v√°lido
 */
function validateNumber(value, min = null, max = null) {
    const num = Number(value);
    if (isNaN(num)) return false;
    if (min !== null && num < min) return false;
    if (max !== null && num > max) return false;
    return true;
}

/**
 * Valida um campo de data
 * @param {*} date - Data a ser validada
 * @returns {boolean} True se v√°lido
 */
function validateDate(date) {
    if (!date) return false;
    const dateObj = new Date(date);
    return dateObj instanceof Date && !isNaN(dateObj.getTime());
}

/**
 * Valida dados de um formul√°rio antes de enviar
 * @param {Object} formData - Dados do formul√°rio
 * @returns {Object} {valid: boolean, errors: Array}
 */
function validateFormData(formData) {
    const errors = [];

    // Validar campos obrigat√≥rios
    const requiredFields = ['Descri√ß√£o Detalhada da RNC/Reclama√ß√£o'];
    requiredFields.forEach(field => {
        if (!formData[field] || formData[field].trim() === '') {
            errors.push(`Campo obrigat√≥rio: ${field}`);
        }
    });

    // Validar tamanhos m√°ximos
    for (const key in formData) {
        if (formData.hasOwnProperty(key) && typeof formData[key] === 'string') {
            if (!validateText(formData[key], 10000)) {
                errors.push(`Campo ${key} excede tamanho m√°ximo permitido`);
            }
        }
    }

    return {
        valid: errors.length === 0,
        errors: errors
    };
}

// ==========================================
        // INICIALIZAR SISTEMA DE TABS
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando sistema de tabs...');
            
            // Selecionar todas as tabs principais
            const tabs = document.querySelectorAll('.tab[data-tab]');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('üìã Total de tabs encontradas:', tabs.length);
            console.log('üìÑ Total de conte√∫dos encontrados:', tabContents.length);
            
            // Adicionar evento de clique em cada tab
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    console.log('üëÜ Clicou na tab:', targetTab);
                    switchTab(targetTab);
                });
            });
            
            // Inicializar tabs de configura√ß√£o
            initConfigTabs();
            
            console.log('‚úÖ Sistema de tabs inicializado com sucesso!');
        });

        // ==========================================
        // FUN√á√ÉO PARA TROCAR DE TAB PRINCIPAL
        // ==========================================
        function switchTab(tabName) {
    // Remover classe ativa de todas as abas
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Ativar aba selecionada
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    debugLog('info', 'üîÑ Mudando para aba', { tab: tabName, alreadyLoaded: loadedTabs[tabName] });
    
    // ‚úÖ SEMPRE re-renderizar abas Abrir e Editar (mesmo se j√° carregadas)
    if (tabName === 'abrir') {
        console.log('üìù Renderizando formul√°rio de Abertura');
        renderAberturaForm();
        loadedTabs[tabName] = true;
        return;
    }
    
    if (tabName === 'editar') {
        console.log('‚úèÔ∏è Preparando aba de Edi√ß√£o');
        if (!loadedTabs[tabName]) {
            Promise.all([
                loadSetoresFilter(),
                loadAvailableRncs()
            ]).then(() => {
                debugLog('success', '‚úÖ Aba Editar carregada');
                loadedTabs[tabName] = true;
            });
        }
        return;
    }
    
    // === LAZY LOADING para outras abas ===
    if (!loadedTabs[tabName]) {
        loadedTabs[tabName] = true;
        
        switch (tabName) {
            case 'kanban':
                loadKanban();
                break;
            case 'dashboard':
                loadDashboard();
                break;
            case 'relatorios':
                loadReportFilters();
                break;
            case 'configuracoes':
                loadConfigurations();
                break;
        }
    } else {
        debugLog('info', '‚ö° Aba j√° carregada, pulando');
    }
}

/**
 * For√ßa re-renderiza√ß√£o da aba ativa
 */
function forceRefreshActiveTab() {
    console.log('üîÑ For√ßando refresh da aba ativa');
    
    var abrirContent = document.getElementById('tab-abrir');
    var editarContent = document.getElementById('tab-editar');
    
    if (abrirContent && abrirContent.classList.contains('active')) {
        console.log('  ‚úÖ Re-renderizando Abrir RNC');
        renderAberturaForm();
    }
    
    if (editarContent && editarContent.classList.contains('active')) {
        console.log('  ‚úÖ Verificando Editar RNC');
        if (typeof window.currentRnc !== 'undefined' && window.currentRnc && window.currentRnc['N¬∫ RNC']) {
            loadRncForEdit(window.currentRnc['N¬∫ RNC']);
        }
    }
}


        // ==========================================
        // FUN√á√ÉO PARA TABS DE CONFIGURA√á√ÉO
        // ==========================================
        function initConfigTabs() {
            const configTabs = document.querySelectorAll('.config-tab[data-config-tab]');
            
            console.log('‚öôÔ∏è Inicializando', configTabs.length, 'config-tabs');
            
            configTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-config-tab');
                    console.log('üëÜ Clicou na config-tab:', targetTab);
                    
                    try {
                        // Remover active de todas as config-tabs
                        configTabs.forEach(t => t.classList.remove('active'));
                        
                        // Adicionar active na tab clicada
                        this.classList.add('active');
                        
                        // Remover active de todos os conte√∫dos de config
                        const contents = document.querySelectorAll('.config-tab-content');
                        contents.forEach(c => c.classList.remove('active'));
                        
                        // Adicionar active no conte√∫do correspondente
                        const activeContent = document.getElementById('config-tab-' + targetTab);
                        if (activeContent) {
                            activeContent.classList.add('active');
                            console.log('‚úÖ Config-tab ativada:', targetTab);
                        } else {
                            console.error('‚ùå Config-tab n√£o encontrada:', targetTab);
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao trocar config-tab:', error);
                    }
                });
            });
        }

        // ==========================================
        // EXPOR FUN√á√ÉO GLOBALMENTE (para debug)
        // ==========================================
        window.switchTab = switchTab;
        
        console.log('üì¶ Script de navega√ß√£o carregado!');

// === M√âDIA-02: NAMESPACE GLOBAL PARA EVITAR COLIS√ïES ===
// Encapsular vari√°veis globais em um √∫nico namespace
window.NeoRNC = window.NeoRNC || {};

// === M√âDIA-06: CONSTANTES PARA MAGIC NUMBERS ===
window.NeoRNC.constants = {
    // Timeouts e delays
    ANIMATION_DELAY: 300,           // Delay para anima√ß√µes e transi√ß√µes
    MULTISELECT_INIT_DELAY: 100,    // Delay para inicializar multiselect
    RELOAD_DELAY: 2000,             // Delay antes de recarregar p√°gina
    APP_INIT_DELAY: 500,            // Delay para inicializar app

    // Limites de arquivo
    MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB default

    // PDF Generation
    PDF_MARGIN: 20,                 // Margem do PDF
    PDF_LINE_HEIGHT: 8,             // Altura da linha no PDF
    PDF_PAGE_HEIGHT: 297,           // Altura da p√°gina A4 (mm)
    PDF_FOOTER_MARGIN: 80,          // Margem do rodap√©

    // ‚úÖ DEPLOY 116 - FASE 5: Cache TTL (estrat√©gia unificada - 5 minutos)
    CACHE_TTL: 5 * 60 * 1000        // 5 minutos (CONFIG.CACHE.MEDIUM em ms)
};

// Estado global da aplica√ß√£o
window.NeoRNC.state = {
    debugLogs: [],
    appContext: null,  // Ser√° preenchido ap√≥s carregar
    currentRnc: null,
    availableRncs: [],
    reportData: null,
    selectedFiles: [],
    loadedTabs: {}
};

// Aliases para compatibilidade com c√≥digo existente (DEPRECATED - usar NeoRNC.state.*)
let debugLogs = window.NeoRNC.state.debugLogs;
let appContext = null;  // Ser√° sincronizado via getter/setter
let currentRnc = null;
let availableRncs = window.NeoRNC.state.availableRncs;
let reportData = null;
let dashboardRncs = [];  // ‚úÖ DEPLOY 101: Raw RNCs para regroupamento do Timeline
let selectedFiles = window.NeoRNC.state.selectedFiles;

// === INICIALIZA√á√ÉO SEGURA ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, iniciando sistema...');
    
    // Garantir que elementos existem antes de acessar
    var userEmailEl = document.getElementById('userEmail');
    var userRoleEl = document.getElementById('userRole');
    
    // Definir valores tempor√°rios enquanto carrega
    if (userEmailEl) userEmailEl.textContent = 'Carregando...';
    if (userRoleEl) userRoleEl.textContent = 'Carregando...';
    
    // Inicializar aplica√ß√£o
    setTimeout(function() {
        if (typeof initializeApp === 'function') {
            initializeApp();
        }
    }, window.NeoRNC.constants.APP_INIT_DELAY);
});

// === TRATAMENTO DE ERROS GLOBAL ===
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('Erro JavaScript:', {
        message: msg,
        line: lineNo,
        column: columnNo
    });
    
    // CR√çTICO: Bloquear acesso se contexto n√£o carregar
    if (msg.includes('appContext') && !appContext) {
        console.error('‚ùå ERRO CR√çTICO: Falha ao carregar contexto de autentica√ß√£o');
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #f5f5f5;">
                <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 600px; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üîí</div>
                    <h2 style="color: #F44336; margin-bottom: 20px;">Erro de Autentica√ß√£o</h2>
                    <p style="margin-bottom: 20px; color: #666;">N√£o foi poss√≠vel carregar suas informa√ß√µes de acesso.</p>
                    <button onclick="location.reload()" style="background: #009688; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                        üîÑ Recarregar P√°gina
                    </button>
                </div>
            </div>
        `;
        return true; // Impedir carregamento do resto da aplica√ß√£o
    }

    return true; // Previne o erro padr√£o do navegador
};


        // === SISTEMA DE DEBUG E LOGGING ===

        /**
         * Sanitiza dados sens√≠veis antes de logar
         * @param {Object} data - Dados a serem sanitizados
         * @returns {Object} Dados sanitizados
         */
        function sanitizeLogData(data) {
            if (!data || typeof data !== 'object') return data;

            const sanitized = {};
            const sensitiveKeys = ['password', 'token', 'apikey', 'email', 'cpf', 'cnpj', 'csrf'];

            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const lowerKey = key.toLowerCase();

                    // Se √© chave sens√≠vel, mascarar
                    if (sensitiveKeys.some(sk => lowerKey.includes(sk))) {
                        sanitized[key] = '***REDACTED***';
                    } else if (typeof data[key] === 'object' && data[key] !== null) {
                        sanitized[key] = sanitizeLogData(data[key]); // Recursivo
                    } else {
                        sanitized[key] = data[key];
                    }
                }
            }

            return sanitized;
        }

        function debugLog(level, message, data = {}) {
            const timestamp = new Date().toLocaleTimeString();

            // SEGURAN√áA: Sanitizar dados antes de logar
            const sanitizedData = sanitizeLogData(data);

            const logEntry = {
                timestamp,
                level,
                message,
                data: sanitizedData
            };

            debugLogs.unshift(logEntry);
            if (debugLogs.length > 100) debugLogs.pop();

            console.log(`[${timestamp}] [${level.toUpperCase()}] ${message}`, sanitizedData);

            updateDebugPanel();
        }
        
        function updateDebugPanel() {
            try {
                document.getElementById('debugSystemReady').textContent = !!appContext;
                document.getElementById('debugCurrentRnc').textContent = currentRnc || 'null';
                document.getElementById('debugAvailableRncs').textContent = availableRncs.length;
                document.getElementById('debugReportData').textContent = reportData ? `${reportData.rncs ? reportData.rncs.length : 0} RNCs` : 'null';
                
                const levelColors = {
                    'info': '#10B981',
                    'error': '#EF4444', 
                    'warning': '#F59E0B',
                    'success': '#10B981'
                };
                
                const logsHtml = debugLogs.slice(0, 15).map(log => {
                    return `<div style="color: ${levelColors[log.level] || '#10B981'}; margin-bottom: 0.25rem; font-size: 0.6875rem;">[${log.timestamp}] [${log.level.toUpperCase()}] ${sanitizeHTML(log.message)}</div>`;
                }).join('');

                document.getElementById('debugLogs').innerHTML = logsHtml;
            } catch(e) {
                console.error('Erro ao atualizar debug panel:', e);
            }
        }
        
        function clearDebugLog() {
            debugLogs = [];
            updateDebugPanel();
        }
        
        // === SISTEMA DE COMUNICA√á√ÉO COM BACKEND ===
        async function apiCall(funcName, params = [], maxRetries = 1, timeout = 90000) {
            debugLog('info', `üì° API Call Deploy 113: ${funcName}`, { params, maxRetries });
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    debugLog('info', `üîÑ Tentativa ${attempt}/${maxRetries}: ${funcName}`);
                    
                    const result = await new Promise((resolve, reject) => {
                        const timer = setTimeout(() => {
                            reject(new Error(`Timeout de ${timeout}ms excedido`));
                        }, timeout);
                        
                        google.script.run
                            .withSuccessHandler(response => {
                                clearTimeout(timer);
                                resolve(response);
                            })
                            .withFailureHandler(error => {
                                clearTimeout(timer);
                                reject(error);
                            })
                            [funcName](...params);
                    });
                    
                    debugLog('success', `‚úÖ Sucesso: ${funcName}`, { hasResult: !!result });
                    return result;
                    
                } catch (error) {
                    debugLog('error', `‚ùå Tentativa ${attempt} falhou: ${funcName}`, { error: error.message });
                    
                    if (attempt === maxRetries) {
                        debugLog('error', `üí• Todas as tentativas falharam: ${funcName}`, { error: error.message });
                        throw error;
                    }
                    
                    const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // === INICIALIZA√á√ÉO ===
        // No topo do arquivo, adicione:
        var appInitialized = false;

       async function initializeApp() {

         if (appInitialized) {
        console.log('‚ö†Ô∏è [INIT] App j√° inicializado, ignorando chamada duplicada');
        return;
    }
    
    appInitialized = true; 

    try {

        console.log('üöÄ [INIT] Iniciando aplica√ß√£o RNC - Deploy 41');
        console.log('üöÄ [INIT] URL:', window.location.href);
        console.log('üöÄ [INIT] Timestamp:', new Date().toISOString());

        debugLog('info', 'üöÄ Iniciando aplica√ß√£o RNC DEPLOY 33 (Corre√ß√£o Final)');
        showLoading('Carregando configura√ß√µes...');
        
        // === CARREGAR CONTEXTO (J√Å COM DIAGN√ìSTICO INTEGRADO) ===
        appContext = await apiCall('getUserContextOptimized');

        // ‚ú® DEBUG TEMPOR√ÅRIO - REMOVER DEPOIS
        console.log('=== DEBUG: LISTAS CARREGADAS ===');
        console.log('appContext.lists:', appContext.lists);
        console.log('Total de listas:', Object.keys(appContext.lists || {}).length);
        Object.keys(appContext.lists || {}).forEach(listName => {
            console.log(`  - ${listName}:`, appContext.lists[listName]);
        });
        console.log('=== FIM DEBUG ===');
        
        console.log('üì¶ Contexto recebido:', appContext);
        
        // === VERIFICAR SE TEM PERMISS√ïES ===
        if (!appContext || appContext.error || !appContext.hasPermissions) {
            hideLoading();
            
            const errorMessage = appContext ? (appContext.error || 'Sem permiss√µes ativas') : 'Erro ao carregar';
            
            document.body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #f5f5f5; font-family: Inter, sans-serif;">
                    <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 600px; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üîí</div>
                        <h2 style="color: #F44336; margin-bottom: 20px;">Acesso Negado</h2>
                        <p style="margin-bottom: 15px; color: #666;">Seu email <strong>${sanitizeHTML(appContext.email) || 'desconhecido'}</strong> n√£o possui permiss√µes cadastradas.</p>
                        <p style="margin-bottom: 20px; color: #666;">Entre em contato com o administrador e informe:</p>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; margin-bottom: 20px; text-align: left;">
                            <strong>Email:</strong> ${sanitizeHTML(appContext.email) || 'N/A'}<br>
                            <strong>Status:</strong> ${sanitizeHTML(errorMessage)}<br>
                            <strong>Total de usu√°rios na planilha:</strong> ${appContext.totalLinhasPlanilha || 'N/A'}
                        </div>
                        <button onclick="location.reload()" style="background: #009688; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                </div>
            `;
            return;
        }
        
        // === USU√ÅRIO TEM PERMISS√ïES - CONTINUAR ===
        debugLog('success', '‚úÖ Contexto carregado', {
            email: appContext.email,
            roles: appContext.roles.join(', '),
            isAdmin: appContext.isAdmin,
            fieldsCount: Object.keys(appContext.fieldsConfig).length
        });
        
        // Atualizar interface
        var userEmailEl = document.getElementById('userEmail');
        if (userEmailEl) userEmailEl.textContent = appContext.email || 'An√¥nimo';

        var userRoleEl = document.getElementById('userRole');
        if (userRoleEl) userRoleEl.textContent = appContext.role || 'Usuario';

        var userSetorEl = document.getElementById('userSetor');
        if (userSetorEl) {
            // Deploy 124: Suporte para m√∫ltiplos setores
            var setorText = 'Sem setor';
            if (appContext.setor) {
                if (Array.isArray(appContext.setor)) {
                    setorText = appContext.setor.length > 0 ? appContext.setor.join(', ') : 'Sem setor';
                } else {
                    setorText = appContext.setor; // Retrocompatibilidade
                }
            }
            userSetorEl.innerHTML = '<span>üè¢</span><span>' + sanitizeHTML(setorText) + '</span>';
        }

        // Deploy 69: Mostrar abas apenas para admins (usando classes CSS)
        console.log('=== DEBUG DEPLOY 69: VERIFICA√á√ÉO DE TABS ===');
        console.log('appContext.isAdmin:', appContext.isAdmin);
        console.log('appContext.canConfig:', appContext.canConfig);
        console.log('appContext.roles:', appContext.roles);
        console.log('appContext.email:', appContext.email);
        console.log('===========================================');

        // Se for admin, remover classe admin-only das tabs
        if (appContext.isAdmin) {
            console.log('‚úÖ Usu√°rio √© ADMIN - Mostrando todas as tabs');
            var adminTabs = document.querySelectorAll('.tab.admin-only');
            adminTabs.forEach(function(tab) {
                tab.classList.remove('admin-only');
                console.log('  ‚úÖ Tab liberada:', tab.getAttribute('data-tab'));
            });
        } else {
            console.log('‚ùå Usu√°rio N√ÉO √© admin - Tabs restritas permanecem ocultas');
            var adminTabs = document.querySelectorAll('.tab.admin-only');
            console.log('  ‚ùå Total de tabs ocultas:', adminTabs.length);
            adminTabs.forEach(function(tab) {
                console.log('    - Tab oculta:', tab.getAttribute('data-tab'));
            });
        }
        
        // Renderizar formul√°rio de abertura
        renderAberturaForm();

        // Renderizar roles do usu√°rio
        renderUserRoles();

        // Inicializar se√ß√£o de ajuda com conte√∫do personalizado
        initializeHelpSection();

        hideLoading();
        debugLog('success', 'üéâ Aplica√ß√£o inicializada');
        
    } catch (error) {
        debugLog('error', 'üí• Erro na inicializa√ß√£o', { error: error.message });
        console.error('Erro completo:', error);
        hideLoading();
        
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #f5f5f5; font-family: Inter, sans-serif;">
                <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 600px; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h2 style="color: #F44336; margin-bottom: 20px;">Erro ao Carregar</h2>
                    <p style="margin-bottom: 20px; color: #666;">${sanitizeHTML(error.message)}</p>
                    <button onclick="location.reload()" style="background: #009688; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                        üîÑ Recarregar P√°gina
                    </button>
                </div>
            </div>
        `;
    }
}

// ADICIONE ESTA NOVA FUN√á√ÉO
function continueInitialization() {
    debugLog('success', '‚úÖ Contexto carregado Deploy 72.3', {
        email: appContext.email || 'n√£o definido',
        role: appContext.role || 'n√£o definido',
        fieldsCount: appContext.fieldsConfig ? Object.keys(appContext.fieldsConfig).length : 0,
        statusPipeline: appContext.statusPipeline
    });
    
 // Verifica√ß√£o completa antes de acessar
if (typeof appContext !== 'undefined' && appContext && appContext.email) {
    if (document.getElementById('userEmail')) {
        document.getElementById('userEmail').textContent = appContext.email;
    }
} else {
    console.log('appContext ainda n√£o carregado na linha 143');
    if (document.getElementById('userEmail')) {
        document.getElementById('userEmail').textContent = 'Carregando...';
    }
}
    document.getElementById('userRole').textContent = appContext.role || 'Usuario';

    // Deploy 74.5.2: Rodap√© simplificado (vers√£o removida conforme solicita√ß√£o)

    // Deploy 68: Mostrar abas apenas para admins
    if (appContext.canConfig) {
        document.getElementById('configTab').style.display = 'flex';
    }

    if (appContext.isAdmin) {
        document.getElementById('relatoriosTab').style.display = 'flex';
    }
    
    // Renderizar formul√°rio de abertura
    renderAberturaForm();
    
    // Carregar RNCs dispon√≠veis para edi√ß√£o
    loadAvailableRncs().then(() => {
        hideLoading();
        debugLog('success', 'üéâ Aplica√ß√£o inicializada Deploy 72.3');
    });
}
        
// === RENDERIZA√á√ÉO DE FORMUL√ÅRIO DE ABERTURA ===
function renderAberturaForm() {
    try {
        console.log('üîµ [RENDER] Iniciando renderAberturaForm()');
        console.log('üîµ [RENDER] appContext existe:', !!appContext);
        console.log('üîµ [RENDER] appContext.fieldsConfig existe:', !!appContext.fieldsConfig);
        console.log('üîµ [RENDER] appContext.fieldsConfig.Abertura existe:', !!appContext.fieldsConfig.Abertura);
        
        debugLog('info', 'üèóÔ∏è Renderizando formul√°rio de abertura Deploy 32');
        
        const permission = appContext.permissions['Abertura'] || 'visualizar';
        console.log('üîµ [RENDER] Permiss√£o para Abertura:', permission);
        
        if (permission === 'negar') {
            const container = document.getElementById('abertura-form');
            container.innerHTML = `
                <div class="alert alert-error">
                    <h3>üîí Acesso Negado</h3>
                    <p>Voc√™ n√£o tem permiss√£o para abrir novas RNCs.</p>
                    <p>Entre em contato com o administrador do sistema.</p>
                </div>
            `;
            document.getElementById('submitRnc').style.display = 'none';
            return;
        }
        
        const container = document.getElementById('abertura-form');
        const aberturaFields = appContext.fieldsConfig.Abertura || [];
        
        console.log('üîµ [RENDER] Total de campos de Abertura:', aberturaFields.length);
        console.log('üîµ [RENDER] Campos:', aberturaFields.map(f => f.name));
        
        debugLog('info', 'üìã Campos de abertura encontrados', { 
            count: aberturaFields.length,
            fields: aberturaFields.map(f => f.name)
        });
        
        if (aberturaFields.length === 0) {
            container.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Nenhum campo de abertura configurado. Configure os campos na aba "Configura√ß√µes".</div>';
            console.log('‚ö†Ô∏è [RENDER] Nenhum campo encontrado, abortando');
            return;
        }
        
        console.log('üîµ [RENDER] Gerando HTML dos campos...');
        
        const sectionHtml = `
            <div class="form-section">
                <h3>üìù Dados da Abertura</h3>
                <div class="form-grid">
                    ${aberturaFields.map(field => {
                        let defaultValue = '';
                        
                        if (field.name === 'N¬∫ RNC') {
                            defaultValue = 'Gerado automaticamente';
                        } else if (field.name === 'Status') {
                            defaultValue = 'Abertura RNC';
                        } else if (field.name === 'Data Abertura' || field.name === 'Data') {
                            defaultValue = formatDateForInput(new Date());
                        }
                        
                        return renderField(field, defaultValue, 'Abertura');
                    }).join('')}
                </div>
            </div>
        `;
        
        console.log('üîµ [RENDER] HTML gerado, atualizando container');
        container.innerHTML = sectionHtml;
        
        console.log('üîµ [RENDER] Configurando upload de arquivos');
        setupFileUpload();
        
        console.log('‚úÖ [RENDER] renderAberturaForm() conclu√≠da com sucesso');
        
        debugLog('success', '‚úÖ Formul√°rio de abertura renderizado com valores autom√°ticos', { 
            fieldsCount: aberturaFields.length 
        });
        
    } catch (error) {
        console.error('‚ùå [RENDER] Erro em renderAberturaForm():', error);
        console.error('‚ùå [RENDER] Stack:', error.stack);
        debugLog('error', '‚ùå Erro ao renderizar formul√°rio', { error: error.message });
        showError('Erro ao renderizar formul√°rio: ' + error.message);
    }
}
        
        // === RENDERIZA√á√ÉO DE CAMPOS CORRIGIDA (Deploy 72.3) ===
        /**
 * Renderiza campo individual COM PERMISS√ïES
 * Deploy 32 - Sistema de Permiss√µes
 */
/**
 * Renderiza campo individual COM PERMISS√ïES
 * Deploy 32 - Sistema de Permiss√µes
 */
function renderField(field, value, secao, isEditContext = false) {
    const fieldName = field.name;
    const fieldType = field.type;
    const isRequired = field.required;
    const placeholder = field.placeholder || '';
    
    // ‚ú® NOVO: Verificar permiss√£o para a se√ß√£o
    const permission = appContext.permissions[secao] || 'visualizar';
    
    // ‚ú® NOVO: Se permiss√£o √© "negar", n√£o renderizar
    if (permission === 'negar') {
        return '';
    }
    
    // ‚ú® NOVO: Se permiss√£o √© "visualizar", desabilitar campo
    const isReadOnly = (permission === 'visualizar');
    const disabledAttr = isReadOnly ? 'disabled' : '';
    const readonlyClass = isReadOnly ? 'field-readonly' : '';
    
    let fieldHtml = `
        <div class="form-group ${readonlyClass}">
            <label for="${fieldName}">
                ${fieldName}
                ${isRequired ? '<span style="color: red;">*</span>' : ''}
                ${isReadOnly ? '<span class="badge-readonly">üîí Somente Leitura</span>' : ''}
            </label>
    `;
    
    switch (fieldType) {
        case 'input':
            fieldHtml += `<input 
                type="text" 
                id="${fieldName}" 
                name="${fieldName}" 
                class="form-control" 
                placeholder="${placeholder}"
                value="${value || ''}"
                ${disabledAttr}
                ${isRequired ? 'required' : ''}>`;
            break;
            
        case 'textarea':
            fieldHtml += `<textarea 
                id="${fieldName}" 
                name="${fieldName}" 
                class="form-control" 
                rows="4" 
                placeholder="${placeholder}"
                ${disabledAttr}
                ${isRequired ? 'required' : ''}>${value || ''}</textarea>`;
            break;
            
        case 'select':
    console.log('=== DEBUG SELECT ===');
    console.log('Campo:', field.name);
    console.log('field.list:', field.list);
    console.log('Valor recebido:', value);
    console.log('Tipo do valor:', typeof value);
    console.log('appContext.lists:', appContext.lists);
    console.log('Lista encontrada:', appContext.lists[field.list]);
    console.log('==================');
    
    const listItems = appContext.lists[field.list] || [];
    
    fieldHtml += `<select 
        id="${fieldName}" 
        name="${fieldName}" 
        class="form-control"
        ${disabledAttr}
        ${isRequired ? 'required' : ''}>
        <option value="">${placeholder}</option>`;
    
    if (listItems.length === 0) {
        console.warn(`‚ö†Ô∏è Lista vazia para campo "${field.name}" (lista: "${field.list}")`);
    }
    
    // ‚úÖ CORRE√á√ÉO: Converter valor para string para compara√ß√£o
    const valueStr = value !== null && value !== undefined ? String(value).trim() : '';
    
    listItems.forEach(item => {
        const itemStr = String(item).trim();
        const selected = (valueStr === itemStr) ? 'selected' : '';
        fieldHtml += `<option value="${item}" ${selected}>${item}</option>`;
        
        // Debug detalhado
        if (field.name === 'Filial de Origem') {
            console.log('Comparando:', {
                value: valueStr,
                item: itemStr,
                match: valueStr === itemStr,
                selected: selected
            });
        }
    });
    
    fieldHtml += `</select>`;
    break;

            case 'multiselect':
    // Gerar op√ß√µes da lista
    let multiselectOptions = '';
    if (field.list && appContext.lists[field.list]) {
        multiselectOptions = appContext.lists[field.list]
            .map(option => `<option value="${option}">${option}</option>`)
            .join('');
    }
    
    // Gerar IDs √∫nicos
    const multiselectId = `multiselect_${fieldName.replace(/\s+/g, '_')}`;
    const chipsContainerId = `chips_${fieldName.replace(/\s+/g, '_')}`;
    const selectId = `select_${fieldName.replace(/\s+/g, '_')}`;
    
    // Construir HTML SEM BOT√ÉO
    fieldHtml += `
        <div class="multiselect-wrapper ${isRequired ? 'required' : ''}" data-field="${fieldName}">
            <div class="chips-container ${value ? '' : 'empty'}" 
                 id="${chipsContainerId}" 
                 data-field-name="${fieldName}">
            </div>
            
            <select id="${selectId}" 
                    class="multiselect-select" 
                    ${disabledAttr}
                    onchange="addChipOnSelect(this, '${chipsContainerId}', '${fieldName}')">
                <option value="">-- Selecione para adicionar --</option>
                ${multiselectOptions}
            </select>
            
            <input type="hidden" 
                   name="${fieldName}" 
                   id="${multiselectId}" 
                   value="${value || ''}"
                   ${isRequired ? 'required' : ''}>
            
            <small class="multiselect-hint">
                üí° Clique em uma op√ß√£o para adicionar como tag
            </small>
        </div>
    `;
    
    // Inicializar chips ap√≥s renderiza√ß√£o
    setTimeout(() => initializeMultiselectChips(chipsContainerId, value, fieldName, isReadOnly), window.NeoRNC.constants.MULTISELECT_INIT_DELAY);
    break;

            
            case 'date':
        // ‚úÖ CORRE√á√ÉO: Formatar data para yyyy-MM-dd
        const formattedDate = formatDateForInput(value);
        
        fieldHtml += `<input 
            type="date" 
            id="${fieldName}" 
            name="${fieldName}" 
            class="form-control"
            value="${formattedDate}"
            ${disabledAttr}
            ${isRequired ? 'required' : ''}>`;
        break;

        
            
        case 'number':
            fieldHtml += `<input 
                type="number" 
                id="${fieldName}" 
                name="${fieldName}" 
                class="form-control"
                placeholder="${placeholder}"
                value="${value || ''}"
                ${disabledAttr}
                ${isRequired ? 'required' : ''}>`;
            break;
            
        case 'file':
    if (isReadOnly) {
        fieldHtml += `<div class="alert alert-info">
            üìé Voc√™ n√£o pode fazer upload de arquivos nesta se√ß√£o (somente leitura)
        </div>`;
    } else {
        // ‚úÖ CORRE√á√ÉO: IDs din√¢micos baseados no contexto (Abrir ou Editar)
        const inputId = isEditContext ? 'fileInputEdit' : fieldName;
        const uploadDivId = isEditContext ? 'fileUploadEdit' : 'fileUpload';
        const listDivId = isEditContext ? 'fileListEdit' : 'fileList';
        
        fieldHtml += `
            <input 
                type="file" 
                id="${inputId}" 
                name="${inputId}" 
                style="display: none;"
                multiple
                accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
            
            <!-- Bot√£o customizado -->
            <div id="${uploadDivId}" class="file-upload" onclick="document.getElementById('${inputId}').click()">
                <div class="file-upload-icon">üìé</div>
                <p>Clique ou arraste arquivos aqui</p>
                <small>PDF, DOC, XLS, JPG, PNG (M√°x. 10MB)</small>
            </div>
            
            <!-- Lista de arquivos selecionados -->
            <div id="${listDivId}" class="file-list"></div>
        `;
    }
    break;
            
        case 'label':
            fieldHtml += `<div class="form-control-static">${value || '-'}</div>`;
            break;
            
        default:
            fieldHtml += `<input 
                type="text" 
                id="${fieldName}" 
                name="${fieldName}" 
                class="form-control"
                value="${value || ''}"
                ${disabledAttr}>`;
    }
    
    fieldHtml += `</div>`;
    return fieldHtml;
}
        
        // === SISTEMA DE UPLOAD DE ARQUIVOS ===
        function setupFileUpload(isEdit = false) {
    // ‚úÖ IDs corretos
    const fileInputId = isEdit ? 'fileInputEdit' : 'Anexo de Documentos';
    const fileUploadId = isEdit ? 'fileUploadEdit' : 'fileUpload';
    const fileListId = isEdit ? 'fileListEdit' : 'fileList';
    
    const fileInput = document.getElementById(fileInputId);
    const fileUpload = document.getElementById(fileUploadId);
    const fileList = document.getElementById(fileListId);
    
    // ‚úÖ Se algum elemento n√£o existir, retornar silenciosamente
    if (!fileInput || !fileUpload || !fileList) {
        console.log('‚ö†Ô∏è [UPLOAD] Elementos n√£o encontrados (normal se n√£o houver campo de arquivo)');
        return;
    }
    
    debugLog('info', 'üìé Configurando sistema de upload', { isEdit });
    
    fileInput.addEventListener('change', (e) => handleFileSelect(e, isEdit));
    
    // Drag & Drop
    fileUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUpload.classList.add('dragover');
    });
    
    fileUpload.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUpload.classList.remove('dragover');
    });
    
    fileUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUpload.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files, isEdit);
    });
}

        
        function handleFileSelect(e, isEdit = false) {
            const files = Array.from(e.target.files);
            handleFiles(files, isEdit);
        }
        
        function handleFiles(files, isEdit = false) {
            debugLog('info', 'üìÇ Processando arquivos Deploy 72.3', { count: files.length, isEdit });

            // M√âDIA-11: Obter limite de tamanho do contexto (configur√°vel)
            const maxFileSize = (appContext && appContext.systemConfig && appContext.systemConfig.maxFileSize)
                ? appContext.systemConfig.maxFileSize
                : 10 * 1024 * 1024; // 10MB padr√£o

            files.forEach(file => {
                // M√âDIA-11: Valida√ß√£o robusta de tamanho de arquivo
                if (!file || typeof file.size !== 'number') {
                    showErrorModal('‚ùå Arquivo Inv√°lido', 'Arquivo selecionado √© inv√°lido.');
                    return;
                }

                if (file.size === 0) {
                    showErrorModal(
                        '‚ùå Arquivo Vazio',
                        `<strong>Arquivo:</strong> ${sanitizeHTML(file.name)}<br><br>` +
                        `O arquivo est√° vazio. Por favor, selecione um arquivo v√°lido.`
                    );
                    return;
                }

                if (file.size > maxFileSize) {
                    const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                    const limitInMB = (maxFileSize / (1024 * 1024)).toFixed(0);
                    showErrorModal(
                        '‚ùå Arquivo Muito Grande',
                        `<strong>Arquivo:</strong> ${sanitizeHTML(file.name)}<br>` +
                        `<strong>Tamanho:</strong> ${sizeInMB} MB<br><br>` +
                        `<strong>Tamanho m√°ximo permitido:</strong> ${limitInMB} MB<br><br>` +
                        `Por favor, reduza o tamanho do arquivo ou divida-o em partes menores.`
                    );
                    debugLog('error', `‚ùå Arquivo rejeitado (muito grande): ${file.name}`, { size: sizeInMB + ' MB', limit: limitInMB + ' MB' });
                    return;
                }

                // ‚úÖ DEPLOY 33 FIX: Validar tipo com modal vis√≠vel
                const allowedTypes = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.jpg', '.jpeg', '.png'];
                const extension = '.' + file.name.split('.').pop().toLowerCase();

                if (!allowedTypes.includes(extension)) {
                    showErrorModal(
                        '‚ùå Tipo de Arquivo N√£o Permitido',
                        `<strong>Arquivo:</strong> ${file.name}<br>` +
                        `<strong>Tipo:</strong> ${extension}<br><br>` +
                        `<strong>Tipos permitidos:</strong><br>` +
                        `‚Ä¢ Documentos: .pdf, .doc, .docx<br>` +
                        `‚Ä¢ Planilhas: .xls, .xlsx<br>` +
                        `‚Ä¢ Imagens: .jpg, .jpeg, .png`
                    );
                    debugLog('error', `‚ùå Arquivo rejeitado (tipo n√£o permitido): ${file.name}`, { extension });
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileData = {
                        name: file.name,
                        size: file.size,
                        mimeType: file.type,
                        content: e.target.result.split(',')[1] // Remove data:type;base64,
                    };

                    selectedFiles.push(fileData);
                    updateFileList(isEdit);

                    debugLog('success', `‚úÖ Arquivo carregado Deploy 72.3: ${file.name}`, {
                        size: formatFileSize(file.size)
                    });
                };
                reader.readAsDataURL(file);
            });
        }
        
        /**
 * Atualiza lista de arquivos selecionados COM CONTADOR
 * Deploy 37 - Adicionar contador visual de arquivos
 */
function updateFileList(isEdit = false) {
    const fileListId = isEdit ? 'fileListEdit' : 'fileList';
    const fileList = document.getElementById(fileListId);
    
    if (!fileList) return;
    
    // ‚úÖ NOVO: Atualizar contador na interface de upload
    updateFileUploadCounter(selectedFiles.length, isEdit);
    
    if (selectedFiles.length === 0) {
        fileList.innerHTML = '';
        return;
    }
    
    // TASK-004: Sanitizar file.name para prevenir XSS
    fileList.innerHTML = selectedFiles.map((file, index) => `
        <div class="file-item">
            <div class="file-info">
                <div class="file-icon">üìÑ</div>
                <div class="file-details">
                    <div class="file-name">${sanitizeHTML(file.name)}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                </div>
            </div>
            <button type="button" onclick="removeFile(${index}, ${isEdit})">üóëÔ∏è Remover</button>
        </div>
    `).join('');
    
    debugLog('info', `üìé Lista de arquivos atualizada: ${selectedFiles.length} arquivo(s)`);
}
        
/**
 * Atualiza contador visual de arquivos na interface de upload
 * Deploy 37 - Contador de arquivos anexados
 */
function updateFileUploadCounter(count, isEdit = false) {
    const fileUploadId = isEdit ? 'fileUploadEdit' : 'fileUpload';
    const fileUpload = document.getElementById(fileUploadId);
    
    if (!fileUpload) return;
    
    // Remover contador anterior se existir
    const oldCounter = fileUpload.querySelector('.file-upload-counter');
    if (oldCounter) {
        oldCounter.remove();
    }
    
    // Se h√° arquivos, adicionar contador
    if (count > 0) {
        const counter = document.createElement('div');
        counter.className = 'file-upload-counter';
        counter.innerHTML = `
            <span class="counter-badge">üìé ${count}</span>
            <span class="counter-text">${count === 1 ? 'arquivo selecionado' : 'arquivos selecionados'}</span>
        `;
        fileUpload.appendChild(counter);
        
        debugLog('info', `‚úÖ Contador atualizado: ${count} arquivo(s)`);
    }
}


        /**
         * Remove arquivo da lista de selecionados
         * Deploy 37 - Suporte para edi√ß√£o
         */
        function removeFile(index, isEdit = false) {
            selectedFiles.splice(index, 1);
            updateFileList(isEdit);
            
            debugLog('info', `üóëÔ∏è Arquivo removido: index ${index}`);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
/**
 * Valida permiss√µes antes de salvar
 * Deploy 32
 */
async function validatePermissionsBeforeSave() {
    const permission = appContext.permissions['Abertura'];
    
    if (permission !== 'editar') {
        await showErrorModal('Permiss√£o Negada', 'Voc√™ n√£o tem permiss√£o para criar RNCs.');
        return false;
    }
    
    return true;
}

/**
 * Modal de ERRO customizado - Deploy 33 Fix v3
 * Mostra erros de valida√ß√£o de forma MUITO vis√≠vel
 * COM FALLBACK para alert()
 */
function showErrorModal(title, message) {
    console.log('üî¥ showErrorModal chamado:', title, message);

    try {
        return new Promise((resolve) => {
            // Remover modais anteriores
            const oldModal = document.getElementById('errorModal');
            if (oldModal) oldModal.remove();

            const modalHtml = `
                <div id="errorModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
                    <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 600px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: slideUp 0.3s;">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                        <h2 style="color: #f44336; margin-bottom: 15px; font-size: 24px; font-weight: 700;">${title}</h2>
                        <div style="color: #666; font-size: 15px; line-height: 1.8; margin-bottom: 30px; text-align: left; max-height: 300px; overflow-y: auto; padding: 15px; background: #fff3cd; border-left: 4px solid #f44336; border-radius: 8px;">${message}</div>
                        <button id="errorModalOk" style="
                            background: #f44336;
                            color: white;
                            border: none;
                            padding: 14px 40px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.2s;
                            min-width: 150px;
                            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
                        " onmouseover="this.style.background='#d32f2f'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='#f44336'; this.style.transform='scale(1)';">
                            ENTENDI
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                </style>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            console.log('‚úÖ Modal inserido no DOM');

            const modal = document.getElementById('errorModal');
            const btnOk = document.getElementById('errorModalOk');

            if (!modal || !btnOk) {
                console.error('‚ùå Modal ou bot√£o n√£o encontrado!');
                // Fallback para alert
                alert(title + '\n\n' + message.replace(/<br>/g, '\n').replace(/<[^>]*>/g, ''));
                resolve(true);
                return;
            }

            // Fun√ß√£o para remover modal
            const removeModal = () => {
                if (modal && modal.parentNode) {
                    modal.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => modal.remove(), window.NeoRNC.constants.ANIMATION_DELAY);
                }
            };

            // Evento de clique no OK
            btnOk.addEventListener('click', () => {
                console.log('‚úÖ Bot√£o OK clicado');
                removeModal();
                resolve(true);
            });

            // Fechar ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    console.log('‚úÖ Clicado fora do modal');
                    removeModal();
                    resolve(true);
                }
            });
        });
    } catch (error) {
        console.error('‚ùå Erro ao mostrar modal:', error);
        // Fallback definitivo para alert
        alert(title + '\n\n' + message.replace(/<br>/g, '\n').replace(/<[^>]*>/g, ''));
        return Promise.resolve(true);
    }
}

/**
 * Modal de sucesso para configura√ß√µes
 * Deploy 124 - Feedback visual para todas as opera√ß√µes de configura√ß√£o
 */
function showConfigSuccessModal(title, message) {
    console.log('‚úÖ showConfigSuccessModal chamado:', title, message);

    try {
        return new Promise((resolve) => {
            // Remover modais anteriores
            const oldModal = document.getElementById('configSuccessModal');
            if (oldModal) oldModal.remove();

            const modalHtml = `
                <div id="configSuccessModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
                    <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 600px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: slideUp 0.3s;">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                        <h2 style="color: #10B981; margin-bottom: 15px; font-size: 24px; font-weight: 700;">${title}</h2>
                        <div style="color: #666; font-size: 15px; line-height: 1.8; margin-bottom: 30px; text-align: left; max-height: 300px; overflow-y: auto; padding: 15px; background: #F0FDF4; border-left: 4px solid #10B981; border-radius: 8px;">${message}</div>
                        <button id="configSuccessModalOk" style="
                            background: linear-gradient(135deg, #10B981, #059669);
                            color: white;
                            border: none;
                            padding: 14px 40px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.2s;
                            min-width: 150px;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                        " onmouseover="this.style.transform='scale(1.05)';" onmouseout="this.style.transform='scale(1)';">
                            OK, ENTENDI
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                </style>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            console.log('‚úÖ Modal de sucesso inserido no DOM');

            const modal = document.getElementById('configSuccessModal');
            const btnOk = document.getElementById('configSuccessModalOk');

            if (!modal || !btnOk) {
                console.error('‚ùå Modal ou bot√£o n√£o encontrado!');
                resolve(true);
                return;
            }

            // Fun√ß√£o para remover modal
            const removeModal = () => {
                if (modal && modal.parentNode) {
                    modal.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => modal.remove(), 300);
                }
            };

            // Evento de clique no OK
            btnOk.addEventListener('click', () => {
                console.log('‚úÖ Bot√£o OK clicado');
                removeModal();
                resolve(true);
            });

            // Fechar ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    console.log('‚úÖ Clicado fora do modal');
                    removeModal();
                    resolve(true);
                }
            });
        });
    } catch (error) {
        console.error('‚ùå Erro ao mostrar modal de sucesso:', error);
        return Promise.resolve(true);
    }
}

/**
 * Modal de confirma√ß√£o customizado
 * Deploy 35 - Padroniza√ß√£o de UI
 */
function showConfirmModal(title, message) {
    return new Promise((resolve) => {
        const modalHtml = `
            <div id="confirmModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
                <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùì</div>
                    <h2 style="color: #009688; margin-bottom: 15px; font-size: 22px; font-weight: 600;">${title}</h2>
                    <p style="color: #666; font-size: 15px; line-height: 1.6; margin-bottom: 30px;">${message}</p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="confirmCancel" style="
                            background: white;
                            color: #666;
                            border: 2px solid #E5E7EB;
                            padding: 12px 32px;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            min-width: 120px;
                        " onmouseover="this.style.background='#F9FAFB'; this.style.borderColor='#D1D5DB';" onmouseout="this.style.background='white'; this.style.borderColor='#E5E7EB';">
                            Cancelar
                        </button>
                        <button id="confirmOk" style="
                            background: #009688;
                            color: white;
                            border: none;
                            padding: 12px 32px;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            min-width: 120px;
                        " onmouseover="this.style.background='#00796B';" onmouseout="this.style.background='#009688';">
                            OK
                        </button>
                    </div>
                </div>
            </div>
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            </style>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const modal = document.getElementById('confirmModal');
        const btnOk = document.getElementById('confirmOk');
        const btnCancel = document.getElementById('confirmCancel');

        // Fun√ß√£o para remover modal
        const removeModal = () => {
            if (modal && modal.parentNode) {
                modal.remove();
            }
        };

        // Evento de clique no OK
        btnOk.addEventListener('click', () => {
            removeModal();
            resolve(true);
        });

        // Evento de clique no Cancelar
        btnCancel.addEventListener('click', () => {
            removeModal();
            resolve(false);
        });
        
        // Pressionar ESC cancela
        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                removeModal();
                resolve(false);
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
    });
}

/**
 * Exibe modal informativo (sem altera√ß√µes detectadas)
 * Deploy 42 - Modal visual para feedback ao usu√°rio
 */
function showInfoModal(title, message, icon) {
    return new Promise((resolve) => {
        // Remover modais antigos
        const oldModal = document.getElementById('infoModal');
        if (oldModal) oldModal.remove();
        
        const iconEmoji = icon || '‚ÑπÔ∏è';
        
        const modalHtml = `
            <div id="infoModal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            ">
                <div style="
                    background: white;
                    padding: 0;
                    border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    max-width: 500px;
                    width: 90%;
                    animation: slideUp 0.3s ease-out;
                ">
                    <!-- Cabe√ßalho -->
                    <div style="
                        background: linear-gradient(135deg, #2196F3 0%, #009688 100%);
                        padding: 24px;
                        border-radius: 12px 12px 0 0;
                        text-align: center;
                    ">
                        <div style="font-size: 48px; margin-bottom: 12px;">
                            ${iconEmoji}
                        </div>
                        <h3 style="
                            margin: 0;
                            color: white;
                            font-size: 20px;
                            font-weight: 600;
                        ">${title}</h3>
                    </div>
                    
                    <!-- Conte√∫do -->
                    <div style="padding: 24px; text-align: center;">
                        <p style="
                            margin: 0 0 24px 0;
                            color: #555;
                            font-size: 16px;
                            line-height: 1.5;
                        ">${message}</p>
                        
                        <!-- Bot√£o -->
                        <button onclick="closeInfoModal()" style="
                            background: linear-gradient(135deg, #009688 0%, #00796b 100%);
                            color: white;
                            border: none;
                            padding: 12px 32px;
                            border-radius: 6px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            box-shadow: 0 2px 8px rgba(0, 150, 136, 0.3);
                            transition: all 0.2s;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 150, 136, 0.4)';"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 150, 136, 0.3)';">
                            OK, Entendi
                        </button>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes slideUp {
                    from {
                        transform: translateY(50px);
                        opacity: 0;
                    }
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
            </style>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Salvar resolve para uso posterior
        window._infoModalResolve = resolve;
        
        console.log('‚úÖ Modal informativo exibido:', title);
    });
}

/**
 * Fecha modal informativo
 */
function closeInfoModal() {
    const modal = document.getElementById('infoModal');
    if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease-in';
        setTimeout(() => {
            modal.remove();
            if (window._infoModalResolve) {
                window._infoModalResolve();
                delete window._infoModalResolve;
            }
        }, 300);
    }
}

// Adicionar anima√ß√£o de fadeOut
if (!document.getElementById('modal-animations')) {
    const style = document.createElement('style');
    style.id = 'modal-animations';
    style.textContent = `
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}


       /**
 * Salva nova RNC - Deploy 40 com suporte a Multiselect
 */
async function saveRnc() {
    console.log('üü¢üü¢üü¢ saveRnc() CHAMADA! üü¢üü¢üü¢');
    try {
        // Validar permiss√µes primeiro
        console.log('üü¢ Validando permiss√µes...');
        if (!validatePermissionsBeforeSave()) {
            console.log('üî¥ Permiss√µes falharam!');
            return;
        }
        console.log('‚úÖ Permiss√µes OK');

        debugLog('info', 'üíæ Iniciando salvamento da RNC');
        
        const form = document.getElementById('rncForm');
        const formData = new FormData(form);
        const data = {};
        
        // ‚úÖ COLETAR DADOS DO FORMUL√ÅRIO (incluindo multiselect)
        for (let [key, value] of formData.entries()) {
            // Ignorar campos de arquivo
            if (key !== 'Anexo de Documentos' && 
                key !== 'fileInput' && 
                key !== 'fileUpload') {
                data[key] = value;
            }
        }
        
        // ‚úÖ ADICIONAR: Capturar valores de campos multiselect dos inputs hidden
        const multiselectInputs = document.querySelectorAll('.multiselect-wrapper input[type="hidden"]');
        multiselectInputs.forEach(input => {
            const fieldName = input.name;
            const fieldValue = input.value;
            
            if (fieldName && fieldValue) {
                data[fieldName] = fieldValue;
                debugLog('debug', `üìã Multiselect capturado: ${fieldName}`, { value: fieldValue });
            }
        });
        
        debugLog('info', 'üìã Dados coletados do formul√°rio', {
            fields: Object.keys(data),
            hasFiles: selectedFiles.length > 0,
            multiselectCount: multiselectInputs.length
        });

        console.log('üîç DEBUG: Iniciando valida√ß√£o de campos obrigat√≥rios');
        console.log('üîç DEBUG: appContext.fieldsConfig:', appContext.fieldsConfig);

        // ‚úÖ DEPLOY 33 FIX: Validar campos obrigat√≥rios com modal vis√≠vel
        const aberturaFields = appContext.fieldsConfig.Abertura || [];
        console.log('üîç DEBUG: aberturaFields:', aberturaFields);

        const requiredFields = aberturaFields.filter(f => f.required);
        console.log('üîç DEBUG: requiredFields:', requiredFields);

        const missingFields = [];

        requiredFields.forEach(field => {
            // Ignorar campo de arquivo na valida√ß√£o
            const fieldValue = data[field.name];
            console.log(`üîç DEBUG: Verificando campo "${field.name}": valor = "${fieldValue}"`);

            if (field.type !== 'file' && (!fieldValue || fieldValue.trim() === '')) {
                console.log(`‚ùå Campo obrigat√≥rio vazio: ${field.name}`);
                missingFields.push(field.name);
            }
        });

        console.log('üîç DEBUG: missingFields:', missingFields);

        if (missingFields.length > 0) {
            console.log('üö® VALIDA√á√ÉO FALHOU! Chamando showErrorModal...');
            const fieldsList = missingFields.map(f => `‚Ä¢ ${f}`).join('<br>');

            await showErrorModal(
                '‚ö†Ô∏è Campos Obrigat√≥rios N√£o Preenchidos',
                `<strong>Voc√™ precisa preencher os seguintes campos antes de salvar a RNC:</strong><br><br>` +
                fieldsList +
                `<br><br>Por favor, volte e preencha todos os campos obrigat√≥rios (marcados com <span style="color: red;">*</span>).`
            );
            debugLog('warning', '‚ö†Ô∏è Valida√ß√£o falhou - campos obrigat√≥rios', { missingFields });
            return;
        }

        console.log('‚úÖ Valida√ß√£o passou! Continuando com save...');
        
        // Confirma√ß√£o antes de salvar
        const confirmed = await showConfirmModal(
            'Deseja realmente criar esta RNC?',
            'Ap√≥s confirmar, os dados ser√£o salvos permanentemente.'
        );
        
        if (!confirmed) {
            debugLog('info', '‚ùå Usu√°rio cancelou o salvamento');
            return;
        }
        
        showLoading('Salvando RNC...');
        
        debugLog('info', 'üöÄ Enviando dados para o backend', { 
            dataKeys: Object.keys(data),
            filesCount: selectedFiles.length 
        });
        
        // Chamar backend
        const result = await apiCall('saveRnc', [data, selectedFiles]);
        
        if (result.success) {
            debugLog('success', '‚úÖ RNC salva com sucesso', { 
                rncNumber: result.rncNumber 
            });
            
            // Limpar formul√°rio e arquivos
            form.reset();
            selectedFiles = [];
            updateFileList();
            
            // Limpar containers de chips
            document.querySelectorAll('.chips-container').forEach(container => {
                container.innerHTML = '';
                container.classList.add('empty');
            });
            
            // Limpar inputs hidden de multiselect
            document.querySelectorAll('.multiselect-wrapper input[type="hidden"]').forEach(input => {
                input.value = '';
            });
            
            // Esconder loading
            hideLoading();
            
            // Mostrar modal de sucesso
            showSuccessModal(result.rncNumber);
            
            debugLog('info', '‚úÖ Formul√°rio resetado e pronto para nova RNC');
            
        } else {
            hideLoading();

            // ‚úÖ DEPLOY 33 FIX: Mostrar erros de valida√ß√£o do backend com modal
            if (result.validationErrors && result.validationErrors.length > 0) {
                const errorsList = result.validationErrors.map(e => `‚Ä¢ ${e}`).join('<br>');
                await showErrorModal(
                    '‚ö†Ô∏è Erro de Valida√ß√£o',
                    `<strong>Os seguintes erros foram encontrados:</strong><br><br>` +
                    errorsList
                );
            } else {
                throw new Error(result.error || 'Erro desconhecido ao salvar RNC');
            }
        }

    } catch (error) {
        debugLog('error', '‚ùå Erro ao salvar RNC', { error: error.message });
        hideLoading();

        // ‚úÖ DEPLOY 33 FIX: Modal de erro para exce√ß√µes
        await showErrorModal(
            '‚ùå Erro ao Salvar RNC',
            `<strong>Ocorreu um erro ao tentar salvar a RNC:</strong><br><br>` +
            `${error.message}<br><br>` +
            `Por favor, tente novamente. Se o erro persistir, entre em contato com o suporte.`
        );
    }
}


        
        // === CARREGAR RNCS DISPON√çVEIS ===
        async function loadAvailableRncs(setor) {
    try {
        const select = document.getElementById('rncSelect');
        const tipoSetorSelect = document.getElementById('tipoSetorEdit');
        const setorFilter = document.getElementById('setorFilterEdit');
        const countSpan = document.getElementById('rncCountEdit');
        
        if (!select) return;
        
        showLoading('Carregando RNCs...');
        
        const tipoSetor = tipoSetorSelect ? tipoSetorSelect.value : 'qualidade';
        const setorAtual = setor || (setorFilter ? setorFilter.value : 'Todos');
        
        debugLog('info', 'üìã Carregando RNCs', { tipoSetor, setor: setorAtual });

        let numbers = await apiCall('getRncNumbersBySetor', [tipoSetor, setorAtual]);

        // Deploy 124 PARTE 7: Log detalhado da resposta do backend
        console.log('üîç [DEBUG] getRncNumbersBySetor - RESPOSTA:', {
            tipoSetor: tipoSetor,
            setorEnviado: setorAtual,
            respostaRecebida: numbers,
            tipoResposta: typeof numbers,
            isArray: Array.isArray(numbers),
            tamanho: numbers ? numbers.length : 0,
            primeiros3: numbers && numbers.length > 0 ? numbers.slice(0, 3) : 'vazio'
        });

        availableRncs = numbers || [];
        
        select.innerHTML = '<option value="">Selecione uma RNC</option>';
        
        if (availableRncs.length > 0) {
            availableRncs.forEach(num => {
                const option = document.createElement('option');
                option.value = num;
                option.textContent = `RNC ${num}`;
                select.appendChild(option);
            });
            
            if (countSpan) {
                countSpan.textContent = `${availableRncs.length} RNC(s) encontrada(s)`;
                countSpan.style.color = '#4CAF50';
                countSpan.style.fontWeight = '600';
            }
            
            debugLog('success', `‚úÖ ${availableRncs.length} RNCs carregadas`);
        } else {
            if (countSpan) {
                countSpan.textContent = 'Nenhuma RNC encontrada';
                countSpan.style.color = '#999';
            }
            debugLog('warning', '‚ö†Ô∏è Nenhuma RNC encontrada para o filtro');
        }
        
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar RNCs', { error: error.message });
        showError('Erro ao carregar lista de RNCs: ' + error.message);
        hideLoading();
    }
}

async function loadSetoresFilter() {
    try {
        const tipoSetorSelect = document.getElementById('tipoSetorEdit');
        const setorFilterSelect = document.getElementById('setorFilterEdit');

        if (!tipoSetorSelect || !setorFilterSelect) return;

        debugLog('info', 'üè¢ Carregando filtros de setores - Editar RNC');

        // Deploy 124: Verificar se √© admin e suporte para m√∫ltiplos setores
        const isAdmin = appContext && appContext.isAdmin;
        const userSetor = appContext && appContext.setor;

        let setores;
        if (isAdmin) {
            // Admin v√™ todos os setores
            setores = await apiCall('getSetoresDuplos', []);
        } else {
            // Deploy 124: N√£o-admin v√™ TODOS os seus setores (array)
            var userSetores = userSetor ? (Array.isArray(userSetor) ? userSetor : [userSetor]) : [];
            setores = {
                setoresAbertura: userSetores,
                setoresQualidade: userSetores
            };
        }

        // Fun√ß√£o para atualizar lista de setores
        function atualizarListaSetores() {
            const tipoSetor = tipoSetorSelect.value;
            const listaSetores = tipoSetor === 'abertura'
                ? setores.setoresAbertura
                : setores.setoresQualidade;

            // Deploy 124 PARTE 6: Admins E n√£o-admins veem "Todos os Setores"
            if (isAdmin) {
                setorFilterSelect.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
            } else if (listaSetores.length > 1) {
                // Deploy 124 PARTE 6: N√£o-admin com m√∫ltiplos setores tamb√©m v√™ "Todos os Setores"
                setorFilterSelect.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
            } else {
                setorFilterSelect.innerHTML = '';
            }

            listaSetores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = `üè¢ ${setor}`;
                setorFilterSelect.appendChild(option);
            });

            debugLog('success', `‚úÖ ${listaSetores.length} setores carregados (${tipoSetor}) - Editar`, {
                isAdmin: isAdmin,
                userSetor: userSetor
            });
        }

        // Event listeners
        tipoSetorSelect.addEventListener('change', function() {
            debugLog('info', 'üîÑ Tipo de setor alterado - Editar', { tipo: this.value });
            atualizarListaSetores();
            loadAvailableRncs(); // Recarregar RNCs com novo tipo
        });

        setorFilterSelect.addEventListener('change', function() {
            const setorSelecionado = this.value;
            debugLog('info', 'üîÑ Setor alterado - Editar', { setor: setorSelecionado });
            loadAvailableRncs(setorSelecionado);
        });

        // Carregar lista inicial
        atualizarListaSetores();

    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar filtros - Editar RNC', { error: error.message });
        showError('Erro ao carregar filtro de setores');
    }
}

// Fun√ß√£o auxiliar para atualizar o select
function updateRncSelect() {
    const select = document.getElementById('rncSelect');
    if (select) {
        if (availableRncs.length === 0) {
            select.innerHTML = '<option value="">Nenhuma RNC encontrada</option>';
        } else {
            const options = availableRncs.map(num => 
                `<option value="${num}">${num}</option>`
            ).join('');
            select.innerHTML = '<option value="">Selecione uma RNC...</option>' + options;
        }
    }
}
        
        /**
 * Carrega RNC para edi√ß√£o + GUARDA valores originais
 * Deploy 38 - Rastreamento de altera√ß√µes
 */
async function loadRncForEdit(rncNumber) {
    try {
        debugLog('info', 'üîç Carregando RNC para edi√ß√£o', { rncNumber });

        showLoading('Carregando dados da RNC...');

        const rncData = await apiCall('getRncByNumber', [rncNumber]);

        // üîç DEBUG: Ver EXATAMENTE o que foi retornado
        debugLog('info', 'üîç DADOS RECEBIDOS', {
            rncData: rncData,
            type: typeof rncData,
            isNull: rncData === null,
            isUndefined: rncData === undefined,
            isFalsy: !rncData,
            keys: rncData ? Object.keys(rncData).length : 0,
            firstKeys: rncData ? Object.keys(rncData).slice(0, 5) : []
        });

        if (!rncData) {
            showError(`RNC ${rncNumber} n√£o encontrada`);
            debugLog('error', '‚ùå RNC n√£o encontrada', { rncNumber });
            return;
        }
        
        currentRnc = rncNumber;
        
        // ‚úÖ NOVO: Guardar valores originais para compara√ß√£o
        window.originalRncData = JSON.parse(JSON.stringify(rncData));
        
        debugLog('success', '‚úÖ RNC carregada para edi√ß√£o', { 
            rncNumber, 
            cliente: rncData['Nome do Cliente'],
            status: rncData['Status Geral']
        });
        
        // Renderizar formul√°rio de edi√ß√£o
        renderEditForm(rncData);
        
        // ‚úÖ ADICIONAR BOT√ïES AQUI
        addPrintButtonToEditForm(rncNumber);
        addHistoricoButtonToEditForm(rncNumber); // ‚úÖ Deploy 34: Bot√£o de hist√≥rico

        document.getElementById('editForm').classList.remove('hidden');
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar RNC', { rncNumber, error: error.message });
        showError('Erro ao carregar RNC: ' + error.message);
        hideLoading();
    }
}

// ‚úÖ NOVA FUN√á√ÉO: Adicionar bot√£o de impress√£o no formul√°rio de edi√ß√£o
function addPrintButtonToEditForm(rncNumber) {
    // ‚úÖ VERIFICAR SE √â ADMIN ANTES DE ADICIONAR BOT√ÉO
    if (!appContext || !appContext.isAdmin) {
        debugLog('info', '‚ÑπÔ∏è Bot√£o de impress√£o oculto (usu√°rio n√£o √© admin)');
        return; // N√£o adiciona o bot√£o se n√£o for admin
    }
    
    const editForm = document.getElementById('editForm');
    
    if (!editForm) return;
    
    // ‚úÖ CORRE√á√ÉO 1: Remover TODOS os bot√µes de impress√£o existentes ANTES de procurar container
    const allExistingButtons = editForm.querySelectorAll('[onclick*="printRnc"], .btn-print-rnc');
    allExistingButtons.forEach(btn => {
        debugLog('info', 'üóëÔ∏è Removendo bot√£o de impress√£o duplicado');
        btn.remove();
    });
    
    let buttonContainer = editForm.querySelector('.form-actions, .modal-footer, .edit-actions');
    
    if (!buttonContainer) {
        const saveButton = editForm.querySelector('button[onclick*="saveEdit"], button[onclick*="save"]');
        if (saveButton && saveButton.parentElement) {
            buttonContainer = saveButton.parentElement;
        }
    }
    
    if (!buttonContainer) {
        buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;';
        editForm.appendChild(buttonContainer);
    }
    
    // ‚úÖ CORRE√á√ÉO 2: Criar bot√£o com classe √∫nica para identifica√ß√£o
    const printButton = document.createElement('button');
    printButton.type = 'button';
    printButton.className = 'btn btn-secondary btn-print-rnc'; // ‚úÖ Classe √∫nica adicionada
    printButton.id = 'printRncBtn_' + rncNumber.replace('/', '_'); // ‚úÖ ID √∫nico
    printButton.onclick = function() { printRnc(rncNumber); };
    printButton.style.cssText = 'display: flex; align-items: center; gap: 8px;';
    printButton.innerHTML = `
        <span>üñ®Ô∏è</span>
        <span>Imprimir RNC</span>
    `;
    
    buttonContainer.appendChild(printButton);

    debugLog('info', '‚úÖ Bot√£o de impress√£o adicionado', {
        rncNumber,
        buttonId: printButton.id
    });
}

// ‚úÖ Deploy 34: Adicionar bot√£o de hist√≥rico no formul√°rio de edi√ß√£o
function addHistoricoButtonToEditForm(rncNumber) {
    const editForm = document.getElementById('editForm');

    if (!editForm) return;

    // Remover bot√µes de hist√≥rico existentes
    const existingButtons = editForm.querySelectorAll('.btn-historico-rnc');
    existingButtons.forEach(btn => btn.remove());

    let buttonContainer = editForm.querySelector('.form-actions, .modal-footer, .edit-actions');

    if (!buttonContainer) {
        const saveButton = editForm.querySelector('button[onclick*="saveEdit"], button[onclick*="save"]');
        if (saveButton && saveButton.parentElement) {
            buttonContainer = saveButton.parentElement;
        }
    }

    if (!buttonContainer) {
        buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;';
        editForm.appendChild(buttonContainer);
    }

    const historicoButton = document.createElement('button');
    historicoButton.type = 'button';
    historicoButton.className = 'btn btn-secondary btn-historico-rnc';
    historicoButton.id = 'historicoRncBtn_' + rncNumber.replace('/', '_');
    historicoButton.onclick = function() { showHistoricoModal(rncNumber); };
    historicoButton.style.cssText = 'display: flex; align-items: center; gap: 8px;';
    historicoButton.innerHTML = `
        <span>üìú</span>
        <span>Ver Hist√≥rico</span>
    `;

    buttonContainer.appendChild(historicoButton);

    debugLog('info', '‚úÖ Bot√£o de hist√≥rico adicionado', {
        rncNumber,
        buttonId: historicoButton.id
    });
}

// ‚úÖ Deploy 34: Mostrar modal com hist√≥rico de altera√ß√µes
async function showHistoricoModal(rncNumber) {
    try {
        showLoading('Carregando hist√≥rico...');

        const historico = await apiCall('getHistoricoRnc', [rncNumber]);

        hideLoading();

        // ‚úÖ Debug: Ver o que est√° sendo retornado
        console.log('üîç DEBUG historico:', historico);
        console.log('üîç DEBUG historico type:', typeof historico);
        console.log('üîç DEBUG historico.length:', historico?.length);
        console.log('üîç DEBUG Array.isArray:', Array.isArray(historico));

        if (!historico || historico.length === 0) {
            showErrorModal(
                'Sem Hist√≥rico',
                'N√£o h√° altera√ß√µes registradas para esta RNC ainda.'
            );
            return;
        }

        // Criar modal HTML
        const modalHtml = `
            <div id="historicoModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
                <div style="background: white; padding: 0; border-radius: 16px; max-width: 900px; width: 90%; max-height: 80vh; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: slideUp 0.3s; overflow: hidden; display: flex; flex-direction: column;">
                    <!-- Header -->
                    <div style="padding: 25px 30px; background: linear-gradient(135deg, #009688 0%, #00796B 100%); color: white;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <span>üìú</span>
                            <span>Hist√≥rico de Altera√ß√µes - RNC ${rncNumber}</span>
                        </h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">${historico.length} altera√ß√µes registradas</p>
                    </div>

                    <!-- Timeline -->
                    <div style="flex: 1; overflow-y: auto; padding: 30px;">
                        <div class="timeline">
                            ${historico.map((item, index) => `
                                <div class="timeline-item" style="position: relative; padding-left: 40px; padding-bottom: ${index === historico.length - 1 ? '0' : '30px'}; border-left: ${index === historico.length - 1 ? 'none' : '3px solid #e0e0e0'}; margin-left: 10px;">
                                    <div class="timeline-marker" style="position: absolute; left: -11px; top: 0; width: 20px; height: 20px; border-radius: 50%; background: ${getTimelineColor(item.tipo)}; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>

                                    <div style="background: #f8f9fa; padding: 18px; border-radius: 12px; border-left: 4px solid ${getTimelineColor(item.tipo)};">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <div>
                                                <div style="font-weight: 700; font-size: 15px; color: #333; margin-bottom: 4px;">
                                                    ${getTimelineIcon(item.tipo)} ${item.campo}
                                                </div>
                                                <div style="font-size: 13px; color: #666;">
                                                    ${item.secao} ‚Ä¢ ${item.tipo}
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 12px; color: #666; font-weight: 500;">
                                                    ${formatarDataHora(item.timestamp)}
                                                </div>
                                                <div style="font-size: 12px; color: #999;">
                                                    ${item.usuario}
                                                </div>
                                            </div>
                                        </div>

                                        ${item.tipo !== 'Cria√ß√£o' ? `
                                            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; margin-top: 12px;">
                                                <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107;">
                                                    <div style="font-size: 11px; color: #856404; font-weight: 600; margin-bottom: 4px;">ANTERIOR</div>
                                                    <div style="font-size: 13px; color: #333; word-break: break-word;">${item.valorAnterior}</div>
                                                </div>
                                                <div style="color: #999;">‚Üí</div>
                                                <div style="background: #d4edda; padding: 10px; border-radius: 6px; border-left: 3px solid #28a745;">
                                                    <div style="font-size: 11px; color: #155724; font-weight: 600; margin-bottom: 4px;">NOVO</div>
                                                    <div style="font-size: 13px; color: #333; word-break: break-word;">${item.valorNovo}</div>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="padding: 20px 30px; background: #f5f5f5; border-top: 1px solid #ddd; text-align: right;">
                        <button id="historicoModalClose" style="
                            background: #009688;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#00796B'" onmouseout="this.style.background='#009688'">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            </style>
        `;

        // Remover modal anterior
        const oldModal = document.getElementById('historicoModal');
        if (oldModal) oldModal.remove();

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const modal = document.getElementById('historicoModal');
        const btnClose = document.getElementById('historicoModalClose');

        const closeModal = () => {
            if (modal && modal.parentNode) {
                modal.remove();
            }
        };

        btnClose.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

    } catch (error) {
        hideLoading();
        console.error('Erro ao carregar hist√≥rico:', error);
        showErrorModal('Erro', 'N√£o foi poss√≠vel carregar o hist√≥rico: ' + error.message);
    }
}

// Helper: Cor da timeline por tipo
function getTimelineColor(tipo) {
    const cores = {
        'Cria√ß√£o': '#4CAF50',
        'Edi√ß√£o': '#2196F3',
        'Mudan√ßa Status': '#FF9800',
        'Arquivo': '#9C27B0',
        'Remo√ß√£o': '#F44336'
    };
    return cores[tipo] || '#757575';
}

// Helper: √çcone da timeline por tipo
function getTimelineIcon(tipo) {
    const icones = {
        'Cria√ß√£o': '‚ú®',
        'Edi√ß√£o': '‚úèÔ∏è',
        'Mudan√ßa Status': 'üîÑ',
        'Arquivo': 'üìé',
        'Remo√ß√£o': 'üóëÔ∏è'
    };
    return icones[tipo] || 'üìù';
}

// Helper: Formatar data/hora
function formatarDataHora(timestamp) {
    const date = new Date(timestamp);
    const dia = String(date.getDate()).padStart(2, '0');
    const mes = String(date.getMonth() + 1).padStart(2, '0');
    const ano = date.getFullYear();
    const hora = String(date.getHours()).padStart(2, '0');
    const minuto = String(date.getMinutes()).padStart(2, '0');
    return `${dia}/${mes}/${ano} ${hora}:${minuto}`;
}

       /**
 * Renderiza formul√°rio de edi√ß√£o COM ANEXOS NA SE√á√ÉO ABERTURA
 * Deploy 36.1 - Reposicionamento de Anexos
 */
function renderEditForm(rncData) {
    try {
        debugLog('info', 'üèóÔ∏è Renderizando formul√°rio de edi√ß√£o Deploy 36.1', { 
            rncNumber: rncData['N¬∫ RNC'],
            status: rncData['Status Geral'],
            totalFields: Object.keys(rncData).length
        });
        
        // ‚úÖ ADICIONAR ESTA LINHA NO IN√çCIO:
        window.originalRncData = JSON.parse(JSON.stringify(rncData));

        const container = document.getElementById('edit-sections');
        let sectionsHtml = '';
        
        const sections = appContext.sections.filter(s => s.ativo === 'Sim');
        
        sections.forEach(section => {
            const sectionFields = appContext.fieldsConfig[section.nome] || [];
            const permission = appContext.permissions[section.nome] || 'visualizar';
            
            if (permission === 'negar') {
                return;
            }
            
            let permissionBadge = '';
            if (permission === 'visualizar') {
                permissionBadge = '<span class="badge-readonly">üîí Somente Leitura</span>';
            } else if (permission === 'editar') {
                permissionBadge = '<span style="background: #4CAF50; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">‚úèÔ∏è Edit√°vel</span>';
            }
            
            if (sectionFields.length > 0) {
                sectionsHtml += `
                    <div class="form-section">
                        <h3>
                            ${getSectionIcon(section.nome)} ${section.nome}
                            ${permissionBadge}
                        </h3>
                        <div class="form-grid">
                            ${sectionFields.map(field => {
                                let value = '';
                                
                                if (field.name === 'Status' || field.name === 'Status Geral') {
                                    value = rncData['Status Geral'] || '';
                                    return renderField(field, value, section.nome, true);
                                } else if (field.name === 'N¬∫ RNC') {
                                    value = rncData['N¬∫ RNC'] || '';
                                    return renderField(field, value, section.nome, true);
                                }
                                
                                var possibleKeys = [
                                    field.name,
                                    field.name.replace(/\s+/g, ''),
                                    field.name.toLowerCase(),
                                    field.name.replace(/\s+/g, '').toLowerCase()
                                ];
                                
                                if (appContext.fieldMapping && appContext.fieldMapping[field.name]) {
                                    var mappedName = appContext.fieldMapping[field.name];
                                    possibleKeys.push(mappedName);
                                    possibleKeys.push(mappedName.replace(/\s+/g, ''));
                                    possibleKeys.push(mappedName.toLowerCase());
                                }
                                
                                for (var i = 0; i < possibleKeys.length; i++) {
                                    var key = possibleKeys[i];
                                    if (rncData[key] !== undefined && rncData[key] !== null && rncData[key] !== '') {
                                        value = rncData[key];
                                        break;
                                    }
                                }
                                
                                return renderField(field, value, section.nome, true);
                            }).join('')}
                        </div>
                        
                        ${section.nome === 'Abertura' ? `
                            <!-- ‚úÖ ANEXOS DENTRO DA SE√á√ÉO ABERTURA -->
                            <div id="attachments-container" style="margin-top: 2rem;">
                                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                                    Carregando anexos...
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        });
        
        container.innerHTML = sectionsHtml;
        setupFileUpload(true);

        // ‚úÖ CARREGAR ANEXOS (agora dentro da se√ß√£o Abertura)
        loadAttachments(rncData['N¬∫ RNC']);
        
        debugLog('success', '‚úÖ Formul√°rio renderizado com anexos na se√ß√£o Abertura');
        
    } catch (error) {
        console.error('ERRO renderEditForm:', error);
        debugLog('error', '‚ùå Erro ao renderizar formul√°rio', { error: error.message });
        showError('Erro ao renderizar formul√°rio: ' + error.message);
    }
}

/**
 * Carrega anexos da RNC
 * Deploy 36.3
 */
async function loadAttachments(rncNumber) {
    try {
        debugLog('info', 'üìé Carregando anexos', { rncNumber });
        
        const attachments = await apiCall('getAttachments', [rncNumber]);
        
        renderAttachments(attachments || [], rncNumber);
        
        debugLog('success', '‚úÖ Anexos carregados', { count: attachments.length });
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar anexos', { error: error.message });
        renderAttachments([], rncNumber);
    }
}


/**
 * Renderiza lista de anexos COM EVENT LISTENERS (sem onclick inline)
 * Deploy 36.3 - Corre√ß√£o de erro de sintaxe
 */
/**
 * Renderiza lista de anexos COM EVENT LISTENERS (sem onclick inline)
 * Deploy 36.4 - CORRE√á√ÉO: Adicionar type="button" para evitar submit
 */
function renderAttachments(attachments, rncNumber) {
    const container = document.getElementById('attachments-container');
    
    if (!container) {
        debugLog('warning', '‚ö†Ô∏è Container de anexos n√£o encontrado');
        return;
    }
    
    if (!attachments || attachments.length === 0) {
        container.innerHTML = `
            <div class="no-attachments">
                <div class="no-attachments-icon">üìé</div>
                <p>Nenhum arquivo anexado a esta RNC</p>
            </div>
        `;
        return;
    }
    
    // ‚úÖ GERAR HTML SEM ONCLICK (mais seguro)
    const attachmentsHtml = attachments.map((file, index) => {
        const icon = getFileIcon(file.name);
        const size = formatFileSize(file.size || 0);
        
        return `
            <div class="attachment-item" data-file-id="${file.id}" data-file-name="${file.name}" data-rnc-number="${rncNumber}">
                <div class="attachment-info">
                    <div class="attachment-icon">${icon}</div>
                    <div class="attachment-details">
                        <span class="attachment-name">${file.name}</span>
                        <div class="attachment-meta">
                            <span>üìä ${size}</span>
                            ${file.uploadDate ? `<span>üìÖ ${formatDate(file.uploadDate)}</span>` : ''}
                            ${file.uploadedBy ? `<span>üë§ ${file.uploadedBy}</span>` : ''}
                        </div>
                    </div>
                </div>
                <div class="attachment-actions">
                    <button type="button" class="btn-download" data-action="download" title="Baixar arquivo">
                        ‚¨áÔ∏è Baixar
                    </button>
                    <button type="button" class="btn-delete-attachment" data-action="delete" title="Excluir arquivo">
                        üóëÔ∏è Excluir
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="attachments-header">
            <div class="attachments-title">
                üìé Anexos da RNC
                <span class="attachments-count">${attachments.length}</span>
            </div>
        </div>
        <div class="attachments-list">
            ${attachmentsHtml}
        </div>
    `;
    
    // ‚úÖ ADICIONAR EVENT LISTENERS ap√≥s renderizar HTML
    setupAttachmentListeners();
}

/**
 * Configura event listeners dos anexos (seguro)
 * Deploy 36.3
 */
function setupAttachmentListeners() {
    try {
        debugLog('info', 'üîó Configurando listeners de anexos');
        
        const attachmentItems = document.querySelectorAll('.attachment-item');
        
        attachmentItems.forEach(item => {
            const fileId = item.dataset.fileId;
            const fileName = item.dataset.fileName;
            const rncNumber = item.dataset.rncNumber;
            
            // Bot√£o DOWNLOAD
            const btnDownload = item.querySelector('[data-action="download"]');
            if (btnDownload) {
                btnDownload.addEventListener('click', function() {
                    downloadAttachment(fileId, fileName);
                });
            }
            
            // Bot√£o DELETE
            const btnDelete = item.querySelector('[data-action="delete"]');
            if (btnDelete) {
                btnDelete.addEventListener('click', function() {
                    confirmDeleteAttachment(rncNumber, fileId, fileName);
                });
            }
        });
        
        debugLog('success', '‚úÖ Listeners configurados', { 
            total: attachmentItems.length 
        });
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao configurar listeners', { 
            error: error.message 
        });
    }
}

/**
 * Retorna √≠cone baseado no tipo de arquivo
 * Deploy 36.5 - Corre√ß√£o de regex
 */
function getFileIcon(fileName) {
    if (!fileName) return 'üìé';
    
    try {
        // Pegar extens√£o do arquivo
        const parts = fileName.split('.');
        const extension = parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';
        
        const icons = {
            'pdf': 'üìÑ',
            'doc': 'üìù',
            'docx': 'üìù',
            'xls': 'üìä',
            'xlsx': 'üìä',
            'jpg': 'üñºÔ∏è',
            'jpeg': 'üñºÔ∏è',
            'png': 'üñºÔ∏è',
            'gif': 'üñºÔ∏è',
            'zip': 'üì¶',
            'rar': 'üì¶',
            'txt': 'üìù',
            'csv': 'üìä'
        };
        
        return icons[extension] || 'üìé';
        
    } catch (error) {
        debugLog('error', 'Erro em getFileIcon', { fileName, error: error.message });
        return 'üìé';
    }
}

/**
 * Faz download de anexo (SEM confirma√ß√£o)
 * Deploy 36 - Corre√ß√£o
 */
/**
 * Download DIRETO de anexo (SEM popup)
 * Deploy 36.2 - Corre√ß√£o Final
 */
/**
 * Download DIRETO de anexo
 * Deploy 36.3
 */
async function downloadAttachment(fileId, fileName) {
    try {
        debugLog('info', 'üì• Download direto', { fileId, fileName });
        
        showLoading('Preparando download...');
        
        const result = await apiCall('downloadAnexo', [fileId]);
        
        if (result && result.success) {
            debugLog('success', '‚úÖ Download preparado', { fileName });
            
            const downloadUrl = result.downloadUrl || result.url;
            
            if (downloadUrl) {
                window.open(downloadUrl, '_blank');
                showSuccess(`üì• Download de "${fileName}" iniciado!`);
            } else {
                throw new Error('URL de download n√£o dispon√≠vel');
            }
        } else {
            throw new Error(result.error || 'Falha ao preparar download');
        }
        
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro no download', { error: error.message });
        showError('Erro ao baixar: ' + error.message);
        hideLoading();
    }
}

/**
 * Confirma exclus√£o de anexo + AUTO-SALVA RNC
 * Deploy 37 - Auto-salvar ao excluir anexo
 */
async function confirmDeleteAttachment(rncNumber, fileId, fileName) {
    try {
        debugLog('info', 'üóëÔ∏è Confirma√ß√£o de exclus√£o + auto-salvar', { 
            rncNumber, 
            fileId, 
            fileName 
        });
        
        const modalHtml = `
            <div id="deleteAttachmentModal" class="modal-overlay">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>üóëÔ∏è Excluir Anexo</h3>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 15px; font-size: 15px;">
                            Tem certeza que deseja <strong>excluir permanentemente</strong> o anexo:
                        </p>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #009688;">
                            <div style="font-weight: 600; color: #009688; margin-bottom: 5px;">
                                üìé ${fileName}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                RNC: ${rncNumber}
                            </div>
                        </div>
                        <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107; font-size: 13px; color: #856404; margin-bottom: 15px;">
                            <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita!
                        </div>
                        <div style="background: #e7f5ff; padding: 12px; border-radius: 6px; border-left: 4px solid #2196F3; font-size: 13px; color: #0d47a1;">
                            <strong>‚ÑπÔ∏è Ap√≥s confirmar:</strong> O anexo ser√° exclu√≠do e a RNC ser√° salva automaticamente.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" id="btnCancelarExclusao">
                            ‚ùå Cancelar
                        </button>
                        <button class="btn-danger" id="btnConfirmarExclusao">
                            üóëÔ∏è Confirmar Exclus√£o
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Remover modal anterior se existir
        const oldModal = document.getElementById('deleteAttachmentModal');
        if (oldModal) {
            oldModal.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        const modal = document.getElementById('deleteAttachmentModal');
        const btnCancel = document.getElementById('btnCancelarExclusao');
        const btnConfirm = document.getElementById('btnConfirmarExclusao');
        
        function closeModal() {
            if (modal && modal.parentNode) {
                modal.remove();
            }
        }
        
        // Bot√£o CANCELAR
        btnCancel.addEventListener('click', function() {
            debugLog('info', '‚ùå Exclus√£o cancelada');
            closeModal();
        });
        
        // Bot√£o CONFIRMAR
        btnConfirm.addEventListener('click', async function() {
            debugLog('info', 'üîÑ Executando exclus√£o + auto-salvar', { fileId });
            
            btnCancel.disabled = true;
            btnConfirm.disabled = true;
            btnConfirm.innerHTML = '‚è≥ Excluindo...';
            
            showLoading('Excluindo arquivo e salvando RNC...');
            
            try {
                // 1Ô∏è‚É£ EXCLUIR ANEXO
                const deleteResult = await apiCall('deleteAnexo', [rncNumber, fileId]);
                
                if (!deleteResult || !deleteResult.success) {
                    throw new Error(deleteResult?.error || 'Falha ao excluir anexo');
                }
                
                debugLog('success', '‚úÖ Anexo exclu√≠do', { fileId });
                
                // 2Ô∏è‚É£ AUTO-SALVAR RNC (apenas os dados do formul√°rio)
                const form = document.getElementById('rncEditForm');
                const formData = new FormData(form);
                const data = {};
                
                // Filtrar campos de arquivo
                for (let [key, value] of formData.entries()) {
                    if (key !== 'Anexo de Documentos' && 
                        key !== 'fileInput' && 
                        key !== 'fileUpload' &&
                        !key.toLowerCase().includes('anexo')) {
                        data[key] = value;
                    }
                }
                
                // Salvar sem anexos novos (selectedFiles vazio)
                const updateResult = await apiCall('updateRnc', [rncNumber, data, []]);
                
                if (!updateResult || !updateResult.success) {
                    throw new Error(updateResult?.error || 'Falha ao salvar RNC');
                }
                
                debugLog('success', '‚úÖ RNC salva automaticamente', { rncNumber });
                
                // 3Ô∏è‚É£ MOSTRAR MENSAGEM DE SUCESSO
                showSuccess(`‚úÖ Anexo "${fileName}" exclu√≠do e RNC atualizada com sucesso!`);
                
                // 4Ô∏è‚É£ FECHAR MODAL
                closeModal();
                
                // 5Ô∏è‚É£ RECARREGAR ANEXOS
                await loadAttachments(rncNumber);
                
                // 6Ô∏è‚É£ INVALIDAR CACHE
                invalidateCache(['dashboard', 'kanban']);
                
                hideLoading();
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao excluir/salvar', { error: error.message });
                showError('Erro: ' + error.message);
                
                btnCancel.disabled = false;
                btnConfirm.disabled = false;
                btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
                
                hideLoading();
            }
        });
        
        // Fechar ao clicar fora
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // Fechar com ESC
        function handleEsc(e) {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', handleEsc);
            }
        }
        document.addEventListener('keydown', handleEsc);
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao criar modal', { error: error.message });
        showError('Erro: ' + error.message);
    }
}

/**
 * Exclui anexo (COM confirma√ß√£o corrigida)
 * Deploy 36 - Corre√ß√£o do popup
 */
async function deleteAttachment(rncNumber, fileId, fileName) {
  try {
    debugLog('info', 'üóëÔ∏è Solicitando exclus√£o', { rncNumber, fileId, fileName });
    
    // Criar e mostrar popup de confirma√ß√£o CORRETAMENTE
    const confirmDialog = document.createElement('div');
    confirmDialog.className = 'modal-overlay';
    confirmDialog.innerHTML = `
      <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
          <h3>üóëÔ∏è Excluir Anexo</h3>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 15px;">
            Tem certeza que deseja excluir o anexo:
          </p>
          <p style="font-weight: 600; color: #009688;">
            ${fileName}
          </p>
          <p style="margin-top: 15px; color: #F44336; font-size: 13px;">
            ‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" id="btnCancelarExclusao">
            ‚ùå Cancelar
          </button>
          <button class="btn-danger" id="btnConfirmarExclusao">
            üóëÔ∏è Confirmar Exclus√£o
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(confirmDialog);
    
    // Fun√ß√£o para fechar o popup
    function closeDialog() {
      confirmDialog.remove();
    }
    
    // Bot√£o CANCELAR - Apenas fecha o popup
    document.getElementById('btnCancelarExclusao').addEventListener('click', function() {
      debugLog('info', '‚ùå Exclus√£o cancelada pelo usu√°rio');
      closeDialog();
    });
    
    // Bot√£o CONFIRMAR - Executa a exclus√£o
    document.getElementById('btnConfirmarExclusao').addEventListener('click', async function() {
      try {
        debugLog('info', 'üîÑ Executando exclus√£o', { fileId });
        
        // Desabilitar bot√µes durante processamento
        document.getElementById('btnCancelarExclusao').disabled = true;
        document.getElementById('btnConfirmarExclusao').disabled = true;
        document.getElementById('btnConfirmarExclusao').textContent = '‚è≥ Excluindo...';
        
        showLoading('Excluindo arquivo...');
        
        // Chamar backend para excluir
        const result = await apiCall('deleteAnexo', [rncNumber, fileId]);
        
        if (result && result.success) {
          debugLog('success', '‚úÖ Anexo exclu√≠do', { fileId });
          showSuccess('Anexo exclu√≠do com sucesso!');
          
          // Fechar popup
          closeDialog();
          
          // Recarregar lista de anexos
          await loadAttachments(rncNumber);
          
        } else {
          throw new Error('Falha ao excluir anexo');
        }
        
        hideLoading();
        
      } catch (error) {
        debugLog('error', '‚ùå Erro ao excluir', { error: error.message });

        // Reabilitar bot√µes
        document.getElementById('btnCancelarExclusao').disabled = false;
        document.getElementById('btnConfirmarExclusao').disabled = false;
        document.getElementById('btnConfirmarExclusao').textContent = 'üóëÔ∏è Confirmar Exclus√£o';

        hideLoading();
        await showErrorModal('Erro ao Excluir Arquivo', error.message);
      }
    });
    
    // Fechar ao clicar fora do popup
    confirmDialog.addEventListener('click', function(e) {
      if (e.target === confirmDialog) {
        closeDialog();
      }
    });
    
  } catch (error) {
    debugLog('error', '‚ùå Erro cr√≠tico na exclus√£o', { error: error.message });
    await showErrorModal('Erro ao Preparar Exclus√£o', error.message);
  }
}


// === FUN√á√ÉO DE DEBUG TEMPOR√ÅRIA ===
function debugRncData(rncNumber) {
    google.script.run
        .withSuccessHandler(function(rnc) {
            console.log('=== DEBUG RNC DATA ===');
            console.log('N¬∫ RNC:', rncNumber);
            console.log('Todas as chaves:', Object.keys(rnc));
            console.log('Filial de Origem:', rnc['Filial de Origem']);
            console.log('Tipo RNC:', rnc['Tipo RNC']);
            console.log('Tipo da RNC:', rnc['Tipo da RNC']);
            console.log('RNC completa:', rnc);
        })
        .getRncByNumber(rncNumber);
}

// Chamar no console: debugRncData('0001/2025')
        
        function getSectionIcon(sectionName) {
            const icons = {
                'Abertura': 'üìù',
                'Qualidade': 'üîç',
                'Lideran√ßa': 'üëî'
            };
            return icons[sectionName] || 'üìã';
        }
        
/**
 * Detecta e retorna altera√ß√µes feitas na RNC
 * Deploy 38 - Resumo de altera√ß√µes
 */
function getChangedFields(originalData, newData) {
    const changes = [];
    
    // Campos relevantes para rastrear (excluir campos t√©cnicos)
    const fieldsToTrack = Object.keys(newData).filter(key => {
        return !key.toLowerCase().includes('anexo') && 
               !key.toLowerCase().includes('file') &&
               key !== 'N¬∫ RNC' &&
               key !== 'Data Abertura' &&
               key !== 'timestamp';
    });
    
    fieldsToTrack.forEach(fieldName => {
        const oldValue = originalData[fieldName] || '';
        const newValue = newData[fieldName] || '';
        
        // Se os valores s√£o diferentes
        if (String(oldValue).trim() !== String(newValue).trim()) {
            changes.push({
                field: fieldName,
                oldValue: oldValue || '(vazio)',
                newValue: newValue || '(vazio)'
            });
        }
    });
    
    debugLog('info', 'üìù Altera√ß√µes detectadas', { 
        total: changes.length,
        fields: changes.map(c => c.field)
    });
    
    return changes;
}

/**
 * Exibe modal de sucesso ap√≥s edi√ß√£o com suporte a multiselect
 * Deploy 40 - Atualizado
 */
function showEditSuccessModal(rncNumber, changes, newStatus) {
    // Gerar HTML das altera√ß√µes
    let changesHtml = '';
    
    if (changes.length === 0) {
        changesHtml = `
            <div style="background: #e7f5ff; padding: 12px; border-radius: 6px; border-left: 4px solid #2196F3; font-size: 13px; color: #0d47a1;">
                <strong>‚ÑπÔ∏è Nenhuma altera√ß√£o de campo detectada</strong>
                <p style="margin: 5px 0 0 0; font-size: 12px;">
                    Possivelmente foram adicionados/removidos apenas anexos.
                </p>
            </div>
        `;
    } else {
        changesHtml = `
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; margin: 15px 0;">
                <div style="font-weight: 600; color: #009688; margin-bottom: 10px; font-size: 14px;">
                    üìù ${changes.length} ${changes.length === 1 ? 'campo alterado' : 'campos alterados'}:
                </div>
                ${changes.map(change => {
    // ‚úÖ DETECTAR SE √â MULTISELECT - COM PROTE√á√ÉO
    const isMultiselect = (change.oldValue && typeof change.oldValue === 'string' && change.oldValue.includes(';')) || 
                         (change.newValue && typeof change.newValue === 'string' && change.newValue.includes(';'));
    
    if (isMultiselect) {
        // Processar tags antigas e novas
        const oldTags = change.oldValue && typeof change.oldValue === 'string' ? 
            change.oldValue.split(';').map(v => v.trim()).filter(v => v) : [];
        const newTags = change.newValue && typeof change.newValue === 'string' ? 
            change.newValue.split(';').map(v => v.trim()).filter(v => v) : [];
        
        return `
            <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid #009688;">
                <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 8px;">
                    üè∑Ô∏è ${change.field}
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; font-size: 12px;">
                    <div style="padding: 8px; background: #ffebee; border-radius: 4px;">
                        <div style="font-size: 10px; opacity: 0.8; margin-bottom: 4px; text-align: center; color: #c62828;">ANTES</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;">
                            ${oldTags.length > 0 ? 
                                oldTags.map(tag => `
                                    <span style="display: inline-block; background: #f44336; color: white; padding: 3px 8px; border-radius: 10px; font-size: 11px;">
                                        ${tag}
                                    </span>
                                `).join('') : 
                                '<span style="color: #999; font-style: italic; font-size: 11px;">(vazio)</span>'
                            }
                        </div>
                    </div>
                    <div style="font-size: 16px; color: #009688; display: flex; align-items: center;">‚Üí</div>
                    <div style="padding: 8px; background: #e8f5e9; border-radius: 4px;">
                        <div style="font-size: 10px; opacity: 0.8; margin-bottom: 4px; text-align: center; color: #2e7d32;">DEPOIS</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;">
                            ${newTags.length > 0 ? 
                                newTags.map(tag => `
                                    <span style="display: inline-block; background: #4CAF50; color: white; padding: 3px 8px; border-radius: 10px; font-size: 11px;">
                                        ${tag}
                                    </span>
                                `).join('') : 
                                '<span style="color: #999; font-style: italic; font-size: 11px;">(vazio)</span>'
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Campo normal (sem multiselect) - COM FORMATA√á√ÉO DE DATA
        let oldValueDisplay = change.oldValue !== null && change.oldValue !== undefined ? String(change.oldValue) : '(vazio)';
        let newValueDisplay = change.newValue !== null && change.newValue !== undefined ? String(change.newValue) : '(vazio)';
        
        // Tentar formatar datas
        if (typeof oldValueDisplay === 'string' && 
            (oldValueDisplay.includes('T') || oldValueDisplay.match(/^\d{4}-\d{2}-\d{2}/))) {
            const formatted = formatDate(oldValueDisplay);
            if (formatted) oldValueDisplay = formatted;
        }
        
        if (typeof newValueDisplay === 'string' && 
            (newValueDisplay.includes('T') || newValueDisplay.match(/^\d{4}-\d{2}-\d{2}/))) {
            const formatted = formatDate(newValueDisplay);
            if (formatted) newValueDisplay = formatted;
        }
        
        return `
            <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid #009688;">
                <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 5px;">
                    üè∑Ô∏è ${change.field}
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; font-size: 12px;">
                    <div style="padding: 6px; background: #ffebee; border-radius: 4px; color: #c62828; text-align: center;">
                        <div style="font-size: 10px; opacity: 0.8; margin-bottom: 2px;">ANTES</div>
                        <div style="font-weight: 500;">${oldValueDisplay}</div>
                    </div>
                    <div style="font-size: 16px; color: #009688;">‚Üí</div>
                    <div style="padding: 6px; background: #e8f5e9; border-radius: 4px; color: #2e7d32; text-align: center;">
                        <div style="font-size: 10px; opacity: 0.8; margin-bottom: 2px;">DEPOIS</div>
                        <div style="font-weight: 500;">${newValueDisplay}</div>
                    </div>
                </div>
            </div>
        `;
    }
}).join('')}
            </div>
        `;
    }
    
    const modalHtml = `
        <div id="editSuccessModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
            <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s;">
                
                <!-- √çcone de Sucesso -->
                <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                
                <!-- T√≠tulo -->
                <h2 style="color: #10B981; margin-bottom: 15px; font-size: 24px;">RNC Atualizada com Sucesso!</h2>
                
                <!-- N√∫mero da RNC -->
                <div style="background: #F0FDF4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10B981;">
                    <p style="font-size: 14px; color: #666; margin-bottom: 10px;">N√∫mero da RNC:</p>
                    <p style="font-size: 28px; font-weight: bold; color: #009688; margin: 0;">${rncNumber}</p>
                </div>
                
                <!-- Status (se mudou) -->
                ${newStatus ? `
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <p style="color: #856404; font-size: 14px; margin: 0;">
                            <strong>üìä Novo Status:</strong> ${newStatus}
                        </p>
                    </div>
                ` : ''}
                
                <!-- Resumo de Altera√ß√µes -->
                ${changesHtml}
                
                <!-- Timestamp -->
                <p style="color: #999; font-size: 12px; margin-top: 20px; margin-bottom: 25px;">
                    üïê Salvo em ${new Date().toLocaleString('pt-BR')}
                </p>
                
                <!-- Bot√£o OK -->
                <button onclick="closeEditSuccessModal()" style="
                    background: #009688; 
                    color: white; 
                    border: none; 
                    padding: 14px 40px; 
                    border-radius: 8px; 
                    font-size: 16px; 
                    font-weight: 600; 
                    cursor: pointer; 
                    transition: all 0.2s;
                    box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);
                " onmouseover="this.style.background='#00796B'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0, 150, 136, 0.4)';" onmouseout="this.style.background='#009688'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 150, 136, 0.3)';">
                    OK, Entendi
                </button>
            </div>
        </div>
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translateY(50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        </style>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    debugLog('success', '‚úÖ Modal de sucesso exibido', { 
        rncNumber, 
        changesCount: changes.length 
    });
}

/**
 * Fecha modal de sucesso de edi√ß√£o
 */
function closeEditSuccessModal() {
    const modal = document.getElementById('editSuccessModal');
    if (modal) {
        modal.remove();
    }
}



/**
 * FUN√á√ÉO 1: Normaliza valores para compara√ß√£o
 * Trata null, undefined, n√∫meros e strings
 */
function normalizeValue(value) {
    // Valores vazios = string vazia
    if (value === null || value === undefined || value === '') {
        return '';
    }
    
    // Converter para string e limpar espa√ßos
    const strValue = String(value).trim();
    
    // Valores especiais
    if (strValue === 'null' || strValue === 'undefined' || strValue === '(vazio)') {
        return '';
    }
    
    return strValue;
}

/**
 * FUN√á√ÉO 2: Normaliza datas para formato consistente
 * Converte DD/MM/YYYY e YYYY-MM-DD para formato padr√£o
 */
function normalizeDateValue(value) {
    if (!value) return '';
    
    const strValue = String(value).trim();
    if (!strValue) return '';
    
    // Formato DD/MM/YYYY (brasileiro)
    const brMatch = strValue.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (brMatch) {
        const [_, day, month, year] = brMatch;
        return `${year}-${month}-${day}`;
    }
    
    // Formato YYYY-MM-DD (ISO)
    const isoMatch = strValue.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (isoMatch) {
        const [_, year, month, day] = isoMatch;
        return `${year}-${month}-${day}`;
    }
    
    return strValue;
}

/**
 * FUN√á√ÉO 3: Verifica se campo √© de data pelo nome
 */
function isDateField(fieldName) {
    const lowerField = fieldName.toLowerCase();
    return lowerField.includes('data') || lowerField.includes('date');
}

/**
 * FUN√á√ÉO 4: Compara valores com normaliza√ß√£o inteligente
 * Retorna true se os valores s√£o DIFERENTES
 */
function valuesAreDifferent(oldValue, newValue, fieldName) {
    // Se √© campo de data, usar normaliza√ß√£o de data
    if (isDateField(fieldName)) {
        const oldNormalized = normalizeDateValue(oldValue);
        const newNormalized = normalizeDateValue(newValue);
        
        // Debug de datas (pode remover depois)
        if (oldNormalized !== newNormalized) {
            console.log(`üìÖ Data realmente diferente: ${fieldName}`, {
                old: oldValue,
                new: newValue,
                oldNorm: oldNormalized,
                newNorm: newNormalized
            });
        }
        
        return oldNormalized !== newNormalized;
    }
    
    // Para outros campos, usar normaliza√ß√£o padr√£o
    const oldNormalized = normalizeValue(oldValue);
    const newNormalized = normalizeValue(newValue);
    
    return oldNormalized !== newNormalized;
}


/**
 * Atualiza RNC existente - Deploy 40 com suporte a Multiselect
 */
async function updateRnc() {
    try {
        debugLog('info', 'üíæ Atualizando RNC', { currentRnc });
        
        const form = document.getElementById('rncEditForm');
        const formData = new FormData(form);
        const data = {};

        // ‚úÖ FILTRAR campos de arquivo
        for (let [key, value] of formData.entries()) {
            if (key !== 'Anexo de Documentos' && 
                key !== 'fileInput' && 
                key !== 'fileInputEdit' &&
                key !== 'fileUpload' &&
                !key.toLowerCase().includes('anexo')) {
                data[key] = value;
            }
        }
        
        // ‚úÖ ADICIONAR: Capturar valores de campos multiselect dos inputs hidden
        const multiselectInputs = document.querySelectorAll('.multiselect-wrapper input[type="hidden"]');
        multiselectInputs.forEach(input => {
            const fieldName = input.name;
            const fieldValue = input.value;
            
            if (fieldName) {
                data[fieldName] = fieldValue || '';
                debugLog('debug', `üìã Multiselect capturado na edi√ß√£o: ${fieldName}`, { value: fieldValue });
            }
        });
        
        debugLog('info', 'üìã Dados coletados para atualiza√ß√£o', { 
            fields: Object.keys(data),
            hasNewFiles: selectedFiles.length > 0,
            multiselectCount: multiselectInputs.length
        });
        
        // ‚úÖ COMPARA√á√ÉO CORRIGIDA COM NORMALIZA√á√ÉO
const changes = [];
const originalData = window.originalRncData || {};

// Lista de campos t√©cnicos que devem ser ignorados
const fieldsToIgnore = [
    'Anexo de Documentos',
    'fileInput',
    'fileInputEdit',
    'fileUpload',
    'N¬∫ RNC',
    'Data Abertura',
    'timestamp',
    'Data Cria√ß√£o',
    'Usu√°rio Cria√ß√£o',
    '√öltima Edi√ß√£o',
    'Editado Por'
];

// Comparar apenas campos relevantes
for (let key in data) {
    // Ignorar campos t√©cnicos
    if (fieldsToIgnore.includes(key)) {
        console.log(`‚è≠Ô∏è Ignorando campo t√©cnico: ${key}`);
        continue;
    }
    
    // Ignorar campos de arquivo
    const lowerKey = key.toLowerCase();
    if (lowerKey.includes('file') || lowerKey.includes('anexo')) {
        console.log(`‚è≠Ô∏è Ignorando campo de arquivo: ${key}`);
        continue;
    }
    
    const oldValue = originalData[key];
    const newValue = data[key];
    
    // Usar compara√ß√£o inteligente com normaliza√ß√£o
    if (valuesAreDifferent(oldValue, newValue, key)) {
        console.log(`‚úèÔ∏è Campo realmente alterado: ${key}`, {
            old: oldValue,
            new: newValue
        });
        
        changes.push({
            field: key,
            oldValue: oldValue || '(vazio)',
            newValue: newValue || '(vazio)'
        });
    } else {
        console.log(`‚úÖ Campo sem altera√ß√£o: ${key} (${normalizeValue(oldValue)} === ${normalizeValue(newValue)})`);
    }
}

// Log consolidado
console.log('üîç RESULTADO DA COMPARA√á√ÉO:', {
    totalCamposVerificados: Object.keys(data).length,
    camposIgnorados: fieldsToIgnore.length,
    alteracoesREAIS: changes.length,
    camposAlterados: changes.map(c => c.field)
});
        
        debugLog('info', `üîç ${changes.length} altera√ß√µes detectadas`, { changes });
        
        if (changes.length === 0 && selectedFiles.length === 0) {
        debugLog('info', '‚ÑπÔ∏è Nenhuma altera√ß√£o detectada');
        
        // Exibir modal informativo
        await showInfoModal(
            'Nenhuma Altera√ß√£o Detectada',
            'Voc√™ n√£o modificou nenhum campo desta RNC.<br><br>Para salvar altera√ß√µes, voc√™ precisa editar pelo menos um campo.',
            '‚ÑπÔ∏è'
        );
        
        hideLoading();
        return;
    }
        
        // Confirma√ß√£o
        const confirmed = await showConfirmModal(
            'Deseja salvar as altera√ß√µes?',
            `${changes.length} campo(s) modificado(s)`
        );
        
        if (!confirmed) {
            debugLog('info', '‚ùå Usu√°rio cancelou a atualiza√ß√£o');
            return;
        }
        
        showLoading('Salvando altera√ß√µes...');
        
        // Chamar backend
        const result = await apiCall('updateRnc', [currentRnc, data, selectedFiles]);
        
        if (result.success) {
            debugLog('success', '‚úÖ RNC atualizada', { 
                rncNumber: currentRnc,
                changesCount: changes.length
            });
            
            // Exibir modal de sucesso com resumo
            showEditSuccessModal(currentRnc, changes);
            
            // Limpar arquivos selecionados
            selectedFiles = [];
            updateFileList();
            
            // Recarregar RNC atualizada
            setTimeout(() => {
                loadRncForEdit(currentRnc);
            }, 2000);
            
        } else {
            throw new Error(result.error || 'Erro ao atualizar RNC');
        }
        
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao atualizar RNC', { error: error.message });
        hideLoading();
        await showErrorModal('Erro ao Atualizar RNC', error.message);
    }
}
        
        // === KANBAN CORRIGIDO COM FINALIZADAS (Deploy 72.3) ===
        async function loadKanban() {
    try {
        debugLog('info', 'üìã Carregando Kanban');
        
        showLoading('Carregando kanban...');
        
        // Carregar filtros de setores
        await loadSetoresKanban();
        
        // Carregar dados do kanban (sem filtro inicialmente)
        await refreshKanban();
        
        hideLoading();
        
        debugLog('success', '‚úÖ Kanban carregado');
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar kanban', { error: error.message });
        showError('Erro ao carregar kanban: ' + error.message);
        hideLoading();
    }
}
        
async function loadSetoresKanban() {
    try {
        const tipoSetorSelect = document.getElementById('tipoSetorKanban');
        const setorFilterSelect = document.getElementById('setorFilterKanban');

        if (!tipoSetorSelect || !setorFilterSelect) return;

        debugLog('info', 'üè¢ Carregando filtros de setores - Kanban');

        // Deploy 124: Verificar se √© admin e suporte para m√∫ltiplos setores
        const isAdmin = appContext && appContext.isAdmin;
        const userSetor = appContext && appContext.setor;

        let setores;
        if (isAdmin) {
            // Admin v√™ todos os setores
            setores = await apiCall('getSetoresDuplos', []);
        } else {
            // Deploy 124: N√£o-admin v√™ TODOS os seus setores (array)
            var userSetores = userSetor ? (Array.isArray(userSetor) ? userSetor : [userSetor]) : [];
            setores = {
                setoresAbertura: userSetores,
                setoresQualidade: userSetores
            };
        }

        // Fun√ß√£o para atualizar lista de setores
        function atualizarListaSetores() {
            const tipoSetor = tipoSetorSelect.value;
            const listaSetores = tipoSetor === 'abertura'
                ? setores.setoresAbertura
                : setores.setoresQualidade;

            // Deploy 124 PARTE 6: Admins E n√£o-admins veem "Todos os Setores"
            if (isAdmin) {
                setorFilterSelect.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
            } else if (listaSetores.length > 1) {
                // Deploy 124 PARTE 6: N√£o-admin com m√∫ltiplos setores tamb√©m v√™ "Todos os Setores"
                setorFilterSelect.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
            } else {
                setorFilterSelect.innerHTML = '';
            }

            listaSetores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = `üè¢ ${setor}`;
                setorFilterSelect.appendChild(option);
            });

            debugLog('success', `‚úÖ ${listaSetores.length} setores carregados (${tipoSetor}) - Kanban`, {
                isAdmin: isAdmin,
                userSetor: userSetor
            });
        }

        // Event listeners
        tipoSetorSelect.addEventListener('change', function() {
            atualizarListaSetores();
            refreshKanban();
        });

        setorFilterSelect.addEventListener('change', function() {
            refreshKanban();
        });

        // Carregar lista inicial
        atualizarListaSetores();

    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar filtros Kanban', { error: error.message });
    }
}

async function refreshKanban() {
    try {
        const tipoSetor = document.getElementById('tipoSetorKanban')?.value || 'qualidade';
        const setor = document.getElementById('setorFilterKanban')?.value || 'Todos';
        const countSpan = document.getElementById('rncCountKanban');
        
        debugLog('info', 'üîÑ Atualizando Kanban', { tipoSetor, setor });
        
        showLoading('Carregando Kanban...');
        
        const data = await apiCall('getKanbanDataFiltered', [tipoSetor, setor]);
        
        if (!data) {
            throw new Error('Nenhum dado retornado');
        }
        
        renderKanban(data);
        
        // Atualizar contador
        if (countSpan) {
            let total = 0;
            Object.keys(data).forEach(status => {
                total += data[status].length;
            });
            countSpan.textContent = `${total} RNC(s) exibida(s)`;
            countSpan.style.color = total > 0 ? '#4CAF50' : '#999';
            countSpan.style.fontWeight = '600';
        }
        
        hideLoading();
        
        debugLog('success', '‚úÖ Kanban atualizado');
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao atualizar Kanban', { error: error.message });
        showError('Erro ao carregar Kanban');
        hideLoading();
    }
}


        function renderKanban(kanbanData) {
            try {
                const container = document.getElementById('kanban-container');
                
                // === TODAS AS COLUNAS INCLUINDO FINALIZADAS (Deploy 72.3) ===
                const columns = ['Abertura RNC', 'An√°lise Qualidade', 'An√°lise do problema e A√ß√£o Corretiva', 'Finalizada'];
                const columnClasses = ['abertura', 'analise-qualidade', 'analise-acao', 'finalizada'];
                const columnTitles = ['üìù Abertura RNC', 'üîç An√°lise Qualidade', '‚ö° An√°lise e A√ß√£o', '‚úÖ Finalizadas'];
                
                debugLog('info', 'üé® Renderizando Kanban Deploy 72.3 COM FINALIZADAS', {
                    columns: columns,
                    itemCounts: columns.map(col => kanbanData[col] ? kanbanData[col].length : 0)
                });
                
                let kanbanHtml = '<div class="kanban-container">';
                
                columns.forEach((column, index) => {
                    const items = kanbanData[column] || [];
                    const columnClass = columnClasses[index];
                    const columnTitle = columnTitles[index];
                    
                    kanbanHtml += `
                        <div class="kanban-column">
                            <div class="kanban-header ${columnClass}">
                                ${columnTitle} (${items.length})
                            </div>
                            <div class="kanban-cards">
                    `;
                    
                    items.forEach(item => {
                        // Deploy 125: Atualizado valores de risco (Menor/Maior/Cr√≠tico)
                        const risco = item.risco || 'N√£o Informado';
                        const riscoClass = risco.toLowerCase().includes('cr√≠tico') ? 'risco-critico' :
                                         risco.toLowerCase().includes('maior') ? 'risco-maior' :
                                         risco.toLowerCase().includes('menor') ? 'risco-menor' : 'risco-nao-informado';
                        
                        const priorityClass = item.prioridade === 'Alta' ? 'priority-alta' :
                                            item.prioridade === 'M√©dia' ? 'priority-media' : 'priority-normal';
                        
                        kanbanHtml += `
                            <div class="kanban-card" onclick="editRncFromKanban('${item.numero}')">
                                <div class="card-header">
                                    <div class="card-number">üìÑ ${item.numero}</div>
                                    <div class="card-priority ${priorityClass}">${item.prioridade}</div>
                                </div>
                                <div class="card-cliente">üë§ ${item.cliente}</div>
                                <div class="card-descricao">${item.descricao || 'Sem descri√ß√£o'}</div>
                                <div class="card-meta">
                                    <div class="card-responsavel">üë®‚Äçüíº ${item.responsavel}</div>
                                    <div class="card-dias">${item.diasAberto || 0} dias</div>
                                </div>
                                ${risco ? `<div class="card-risco ${riscoClass}">${risco}</div>` : ''}
                                <div class="card-tags">
                                    <div class="card-tag">üè¢ ${item.setor || 'N/A'}</div>
                                    <div class="card-tag">üìã ${item.tipo || 'N/A'}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    kanbanHtml += `
                            </div>
                        </div>
                    `;
                });
                
                kanbanHtml += '</div>';
                container.innerHTML = kanbanHtml;
                
                debugLog('success', '‚úÖ Kanban renderizado Deploy 72.3 COM FINALIZADAS', {
                    totalItems: columns.reduce((sum, col) => sum + (kanbanData[col] ? kanbanData[col].length : 0), 0)
                });
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao renderizar kanban Deploy 72.3', { error: error.message });
                showError('Erro ao renderizar kanban: ' + error.message);
            }
        }
        
        function editRncFromKanban(rncNumber) {
            debugLog('info', 'üéØ Editando RNC do kanban Deploy 72.3', { rncNumber });
            switchTab('editar');
            document.getElementById('rncSelect').value = rncNumber;
            loadRncForEdit(rncNumber);
        }
        
        // === DASHBOARD ===
        async function loadDashboard() {
    try {
        debugLog('info', 'üìä Carregando Dashboard');
        
        showLoading('Carregando dashboard...');
        
        // Carregar filtros de setores
        await loadSetoresDashboard();
        
        // Carregar dados do dashboard
        await refreshDashboard();
        
        hideLoading();
        
        debugLog('success', '‚úÖ Dashboard carregado');
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar dashboard', { error: error.message });
        showError('Erro ao carregar dashboard: ' + error.message);
        hideLoading();
    }
}

   async function loadSetoresDashboard() {
    try {
        const tipoSetorSelect = document.getElementById('tipoSetorDashboard');
        const setorFilterSelect = document.getElementById('setorFilterDashboard');

        if (!tipoSetorSelect || !setorFilterSelect) return;

        debugLog('info', 'üè¢ Carregando filtros de setores - Dashboard');

        // Deploy 124: Verificar se √© admin e suporte para m√∫ltiplos setores
        const isAdmin = appContext && appContext.isAdmin;
        const userSetor = appContext && appContext.setor;

        let setores;
        if (isAdmin) {
            // Admin v√™ todos os setores
            setores = await apiCall('getSetoresDuplos', []);
        } else {
            // Deploy 124: N√£o-admin v√™ TODOS os seus setores (array)
            var userSetores = userSetor ? (Array.isArray(userSetor) ? userSetor : [userSetor]) : [];
            setores = {
                setoresAbertura: userSetores,
                setoresQualidade: userSetores
            };
        }

        function atualizarListaSetores() {
            const tipoSetor = tipoSetorSelect.value;
            const listaSetores = tipoSetor === 'abertura'
                ? setores.setoresAbertura
                : setores.setoresQualidade;

            // Deploy 124 PARTE 6: Admins E n√£o-admins veem "Todos os Setores"
            if (isAdmin) {
                setorFilterSelect.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
            } else if (listaSetores.length > 1) {
                // Deploy 124 PARTE 6: N√£o-admin com m√∫ltiplos setores tamb√©m v√™ "Todos os Setores"
                setorFilterSelect.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
            } else {
                setorFilterSelect.innerHTML = '';
            }

            listaSetores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = `üè¢ ${setor}`;
                setorFilterSelect.appendChild(option);
            });

            debugLog('success', `‚úÖ ${listaSetores.length} setores carregados (${tipoSetor}) - Dashboard`, {
                isAdmin: isAdmin,
                userSetor: userSetor
            });
        }

        tipoSetorSelect.addEventListener('change', function() {
            atualizarListaSetores();
            // Deploy 72: Limpar cache ao mudar filtros
            dashboardCache = null;
            dashboardCacheTime = null;
            refreshDashboard();
        });

        setorFilterSelect.addEventListener('change', function() {
            // Deploy 72: Limpar cache ao mudar filtros
            dashboardCache = null;
            dashboardCacheTime = null;
            refreshDashboard();
        });

        atualizarListaSetores();

    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar filtros Dashboard');
    }
}     

// === GR√ÅFICO DE PIZZA MODERNO COM APEXCHARTS ===
function renderPieChart(containerId, data) {
    const container = document.getElementById(containerId);
    if (!container || !data) return;

    const entries = Object.entries(data);
    if (entries.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">üìä Sem dados</div>';
        return;
    }

    const total = entries.reduce((sum, [, value]) => sum + value, 0);
    if (total === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">üìä Sem dados</div>';
        return;
    }

    // Cores vibrantes com gradiente
    const colors = [
        '#009688', '#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336',
        '#FFB300', '#00BCD4', '#8BC34A', '#E91E63', '#3F51B5', '#FF5722'
    ];

    // Limpar container
    container.innerHTML = '';

    // Destruir gr√°fico anterior se existir
    if (window[containerId + '_chart']) {
        window[containerId + '_chart'].destroy();
    }

    // Configura√ß√£o ApexCharts (muito mais bonito!)
    const options = {
        series: entries.map(([, value]) => value),
        chart: {
            type: 'donut',
            height: 350,
            fontFamily: 'Inter, sans-serif',
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800,
                animateGradually: {
                    enabled: true,
                    delay: 150
                },
                dynamicAnimation: {
                    enabled: true,
                    speed: 350
                }
            },
            dropShadow: {
                enabled: true,
                top: 2,
                left: 2,
                blur: 4,
                opacity: 0.15
            }
        },
        labels: entries.map(([label]) => label),
        colors: colors.slice(0, entries.length),
        fill: {
            type: 'gradient',
            gradient: {
                shade: 'dark',
                type: 'vertical',
                shadeIntensity: 0.5,
                gradientToColors: colors.map(c => c + 'CC'),
                inverseColors: false,
                opacityFrom: 1,
                opacityTo: 0.9,
                stops: [0, 100]
            }
        },
        dataLabels: {
            enabled: true,
            style: {
                fontSize: '13px',
                fontWeight: '600',
                colors: ['#fff']
            },
            dropShadow: {
                enabled: true,
                top: 1,
                left: 1,
                blur: 2,
                opacity: 0.6
            },
            formatter: function(val, opts) {
                const value = opts.w.config.series[opts.seriesIndex];
                return value + '\n(' + val.toFixed(0) + '%)';
            }
        },
        plotOptions: {
            pie: {
                donut: {
                    size: '65%',
                    labels: {
                        show: true,
                        name: {
                            show: true,
                            fontSize: '18px',
                            fontWeight: 600,
                            color: '#333'
                        },
                        value: {
                            show: true,
                            fontSize: '24px',
                            fontWeight: 'bold',
                            color: '#009688',
                            formatter: function(val) {
                                return val;
                            }
                        },
                        total: {
                            show: true,
                            label: 'Total',
                            fontSize: '16px',
                            fontWeight: 600,
                            color: '#666',
                            formatter: function(w) {
                                return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                            }
                        }
                    }
                },
                expandOnClick: true
            }
        },
        legend: {
            show: false
        },
        tooltip: {
            enabled: true,
            theme: 'dark',
            style: {
                fontSize: '13px'
            },
            y: {
                formatter: function(val, opts) {
                    const total = opts.globals.seriesTotals.reduce((a, b) => a + b, 0);
                    const percentage = ((val / total) * 100).toFixed(1);
                    return val + ' (' + percentage + '%)';
                }
            }
        },
        states: {
            hover: {
                filter: {
                    type: 'darken',
                    value: 0.15
                }
            },
            active: {
                filter: {
                    type: 'darken',
                    value: 0.25
                }
            }
        }
    };

    // Criar e renderizar gr√°fico ApexCharts
    window[containerId + '_chart'] = new ApexCharts(container, options);
    window[containerId + '_chart'].render();

    debugLog('success', `‚ú® Gr√°fico de pizza ApexCharts: ${containerId}`);
}
function renderDashboard(stats) {
    const container = document.getElementById('dashboard-content');
    
    const dashboardHtml = `
        <!-- ========================================== -->
        <!-- LINHA 1: KPIs DE PIPELINE (5 CARDS) -->
        <!-- ========================================== -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px;">
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üìä</div>
                <div class="dashboard-number">${stats.total || 0}</div>
                <div class="dashboard-label">Total de RNCs</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üìù</div>
                <div class="dashboard-number">${stats.aberturaRnc || 0}</div>
                <div class="dashboard-label">Abertura RNC</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üîç</div>
                <div class="dashboard-number">${stats.analiseQualidade || 0}</div>
                <div class="dashboard-label">An√°lise Qualidade</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">‚ö°</div>
                <div class="dashboard-number">${stats.analiseAcao || 0}</div>
                <div class="dashboard-label">An√°lise e A√ß√£o</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">‚úÖ</div>
                <div class="dashboard-number">${stats.finalizadas || 0}</div>
                <div class="dashboard-label">Finalizadas</div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- LINHA 2: KPIs OPERACIONAIS B√ÅSICOS (5 CARDS) -->
        <!-- ========================================== -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px;">
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üí∞</div>
                <div class="dashboard-number">R$ ${(stats.custoTotal || 0).toFixed(2)}</div>
                <div class="dashboard-label">Custo Total</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">‚è±Ô∏è</div>
                <div class="dashboard-number">${stats.tempoMedioResolucao || 0}</div>
                <div class="dashboard-label">Dias M√©dio Resolu√ß√£o</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: ${stats.rncsVencidas > 0 ? '#F44336' : '#009688'};">
                <div class="dashboard-icon">‚ö†Ô∏è</div>
                <div class="dashboard-number">${stats.rncsVencidas || 0}</div>
                <div class="dashboard-label">RNCs Vencidas</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: ${stats.rncsProximasVencer > 0 ? '#FFC107' : '#009688'};">
                <div class="dashboard-icon">üïê</div>
                <div class="dashboard-number">${stats.rncsProximasVencer || 0}</div>
                <div class="dashboard-label">Pr√≥ximas Vencer</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üéØ</div>
                <div class="dashboard-number">${stats.acoesCorretivaTomadas || 0}</div>
                <div class="dashboard-label">A√ß√µes Corretivas Tomadas</div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- ‚ú® LINHA 3: NOVOS KPIs ESTRAT√âGICOS (5 CARDS) -->
        <!-- ========================================== -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px;">
            
            <!-- KPI 1: % Impacto ao Cliente -->
            <div class="dashboard-card" style="border-top-color: ${stats.impactoClientePercentual > 30 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">üë•</div>
                <div class="dashboard-number">${stats.impactoClientePercentual || 0}%</div>
                <div class="dashboard-label">Impacto ao Cliente</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.impactoClienteTotal || 0} de ${stats.total || 0} RNCs
                </div>
            </div>
            
            <!-- KPI 2: Taxa Detec√ß√£o Interna -->
            <div class="dashboard-card" style="border-top-color: ${stats.deteccaoInternaPercentual >= 70 ? '#4CAF50' : '#FFC107'};">
                <div class="dashboard-icon">üîç</div>
                <div class="dashboard-number">${stats.deteccaoInternaPercentual || 0}%</div>
                <div class="dashboard-label">Detec√ß√£o Interna</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.deteccaoInternaTotal || 0} detectadas internamente
                </div>
            </div>
            
            <!-- KPI 3: Taxa N√£o Procede -->
            <div class="dashboard-card" style="border-top-color: ${stats.naoProcedeTaxa > 10 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">‚ùå</div>
                <div class="dashboard-number">${stats.naoProcedeTaxa || 0}%</div>
                <div class="dashboard-label">Taxa N√£o Procede</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.naoProcede || 0} RNCs n√£o procederam
                </div>
            </div>
            
            <!-- KPI 6: √çndice de Severidade -->
            <div class="dashboard-card" style="border-top-color: ${stats.indiceSeveridadePonderado > 50 ? '#F44336' : stats.indiceSeveridadePonderado > 30 ? '#FFC107' : '#4CAF50'};">
                <div class="dashboard-icon">üìà</div>
                <div class="dashboard-number">${stats.indiceSeveridadePonderado || 0}</div>
                <div class="dashboard-label">√çndice de Severidade</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ISP Ponderado
                </div>
            </div>
            
            <!-- KPI 7: Taxa Cumprimento Prazo + Tempo M√©dio - Deploy 125 -->
            <div class="dashboard-card" style="border-top-color: ${stats.taxaCumprimentoPrazo >= 80 ? '#4CAF50' : stats.taxaCumprimentoPrazo >= 60 ? '#FFC107' : '#F44336'};">
                <div class="dashboard-icon">‚è∞</div>
                <div class="dashboard-number">${stats.taxaCumprimentoPrazo || 0}%</div>
                <div class="dashboard-label">Cumprimento de Prazo</div>
                <div style="font-size: 12px; color: #333; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                    <span style="color: ${stats.tempoMedioResolucao > 30 ? '#F44336' : stats.tempoMedioResolucao > 15 ? '#FF9800' : '#4CAF50'}; font-weight: 600;">
                        ‚è±Ô∏è ${stats.tempoMedioResolucao || 0} dias
                    </span>
                    <span style="color: #666; font-size: 10px;"> tempo m√©dio</span>
                </div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- GR√ÅFICOS DE PIZZA (mantidos) -->
        <!-- ========================================== -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            
            <div class="chart-container">
                <h3 class="chart-title">üìã RNCs por Tipo</h3>
                <div id="chartPorTipo"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">‚ö†Ô∏è RNCs por Risco</h3>
                <div id="chartPorRisco"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üîß RNCs por Tipo de Falha</h3>
                <div id="chartPorTipoFalha"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üè¢ Setor de Abertura</h3>
                <div id="chartSetorAbertura"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üîç Setor N√£o Conformidade</h3>
                <div id="chartSetorNaoConf"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üéØ Status A√ß√£o Corretiva</h3>
                <div id="chartStatusAcao"></div>
            </div>
        </div>
        
        <!-- Timeline (mantido) -->
        <div class="chart-container" style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 class="chart-title" style="margin: 0;">üìà Timeline de RNCs</h3>
                <div style="display: flex; gap: 8px;">
                    <button onclick="changeTimelineGranularity('dia', this)" style="padding: 6px 12px; border: 1px solid #009688; background: white; color: #009688; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s;">Dia</button>
                    <button onclick="changeTimelineGranularity('semana', this)" style="padding: 6px 12px; border: 1px solid #009688; background: white; color: #009688; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s;">Semana</button>
                    <button onclick="changeTimelineGranularity('mes', this)" class="timeline-btn-active" style="padding: 6px 12px; border: 1px solid #009688; background: #009688; color: white; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s;">M√™s</button>
                    <button onclick="changeTimelineGranularity('ano', this)" style="padding: 6px 12px; border: 1px solid #009688; background: white; color: #009688; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s;">Ano</button>
                </div>
            </div>
            <div id="timelineChart"></div>
        </div>
        
        <!-- ========================================== -->
        <!-- ‚ú® NOVO: TABELA DE CUSTO M√âDIO POR TIPO (KPI 5) -->
        <!-- ========================================== -->
        ${Object.keys(stats.custoMedioPorTipo || {}).length > 0 ? `
        <div class="chart-container">
            <h3 class="chart-title">üí∞ Custo M√©dio por Tipo de RNC</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Tipo de RNC</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Quantidade</th>
                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Custo Total</th>
                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Custo M√©dio</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(stats.custoMedioPorTipo).map(tipo => {
                        const dados = stats.custoMedioPorTipo[tipo];
                        return `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;">${tipo}</td>
                                <td style="padding: 10px; text-align: center;">${dados.count}</td>
                                <td style="padding: 10px; text-align: right;">R$ ${dados.soma.toFixed(2)}</td>
                                <td style="padding: 10px; text-align: right; font-weight: bold;">R$ ${dados.media.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        ` : ''}
        
        <!-- Resumo Executivo (mantido) -->
        <div class="chart-container">
            <h3 class="chart-title">üìã Resumo Executivo</h3>
            <div style="padding: 15px; line-height: 1.8;">
                ${stats.total ? `
                    <p>üìä <strong>${stats.total}</strong> RNC(s) registrada(s) no sistema.</p>
                    <p>üìù <strong>${stats.aberturaRnc || 0}</strong> em fase de abertura.</p>
                    <p>üîç <strong>${stats.analiseQualidade || 0}</strong> em an√°lise de qualidade.</p>
                    <p>‚ö° <strong>${stats.analiseAcao || 0}</strong> em an√°lise e a√ß√£o corretiva.</p>
                    <p>‚úÖ <strong>${stats.finalizadas || 0}</strong> finalizadas.</p>
                    <p>üí∞ Custo total: <strong>R$ ${(stats.custoTotal || 0).toFixed(2)}</strong></p>
                    <p>‚è±Ô∏è Tempo m√©dio de resolu√ß√£o: <strong>${stats.tempoMedioResolucao || 0} dias</strong>.</p>
                    ${stats.rncsVencidas > 0 ? `<p style="color: #F44336;">‚ö†Ô∏è <strong>${stats.rncsVencidas}</strong> RNC(s) vencida(s) requerem aten√ß√£o!</p>` : ''}
                    ${stats.rncsProximasVencer > 0 ? `<p style="color: #FFC107;">üïê <strong>${stats.rncsProximasVencer}</strong> RNC(s) pr√≥ximas de vencer.</p>` : ''}
                    <p>üéØ <strong>${stats.acoesCorretivaTomadas || 0}</strong> a√ß√£o(√µes) corretiva(s) tomada(s).</p>
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
                    <h4 style="color: #009688; margin-bottom: 10px;">üìä KPIs Estrat√©gicos</h4>
                    <p>üë• Impacto ao Cliente: <strong>${stats.impactoClientePercentual}%</strong> (${stats.impactoClienteTotal} RNCs)</p>
                    <p>üîç Detec√ß√£o Interna: <strong>${stats.deteccaoInternaPercentual}%</strong> ${stats.deteccaoInternaPercentual >= 70 ? '‚úÖ' : '‚ö†Ô∏è'}</p>
                    <p>‚ùå Taxa N√£o Procede: <strong>${stats.naoProcedeTaxa}%</strong> ${stats.naoProcedeTaxa <= 10 ? '‚úÖ' : '‚ö†Ô∏è'}</p>
                    <p>üìà √çndice de Severidade: <strong>${stats.indiceSeveridadePonderado}</strong> pontos</p>
                    <p>‚è∞ Cumprimento de Prazo: <strong>${stats.taxaCumprimentoPrazo}%</strong> ${stats.taxaCumprimentoPrazo >= 80 ? '‚úÖ' : '‚ö†Ô∏è'}</p>
                ` : '<p>üì≠ Nenhuma RNC encontrada.</p>'}
            </div>
        </div>

        <!-- ========================================== -->
        <!-- ‚ú® DEPLOY 36: COMPARATIVO MENSAL -->
        <!-- ========================================== -->
        ${stats.total > 0 ? `
        <div class="chart-container" style="margin-top: 30px;">
            <h3 class="chart-title">üìä Comparativo Mensal</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px;">
                <div style="text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">M√™s Atual</div>
                    <div style="font-size: 32px; font-weight: bold; color: #009688;">${stats.esteMes || 0}</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">RNCs criadas</div>
                </div>
                <div style="text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">M√™s Anterior</div>
                    <div style="font-size: 32px; font-weight: bold; color: #666;">${stats.mesAnterior || 0}</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">RNCs criadas</div>
                </div>
                <div style="text-align: center; padding: 20px; background: ${(stats.esteMes || 0) > (stats.mesAnterior || 0) ? '#ffebee' : '#e8f5e9'}; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">Tend√™ncia</div>
                    <div style="font-size: 32px; font-weight: bold; color: ${(stats.esteMes || 0) > (stats.mesAnterior || 0) ? '#F44336' : '#4CAF50'};">
                        ${(stats.esteMes || 0) > (stats.mesAnterior || 0) ? '‚Üë' : '‚Üì'}
                        ${stats.mesAnterior > 0 ? Math.abs(Math.round((((stats.esteMes || 0) - (stats.mesAnterior || 0)) / (stats.mesAnterior || 1)) * 100)) + '%' : '0%'}
                    </div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        ${(stats.esteMes || 0) > (stats.mesAnterior || 0) ? 'Aumento' : 'Redu√ß√£o'}
                    </div>
                </div>
            </div>
        </div>
        ` : ''}

        <!-- ========================================== -->
        <!-- ‚ú® DEPLOY 36: EVOLU√á√ÉO SEMANAL -->
        <!-- ========================================== -->
        ${stats.porSemana && Object.keys(stats.porSemana).length > 0 ? `
        <div class="chart-container" style="margin-top: 30px;">
            <h3 class="chart-title">üìà Evolu√ß√£o nas √öltimas 4 Semanas</h3>
            <div style="display: flex; gap: 15px; padding: 20px; justify-content: center; align-items: flex-end; height: 200px;">
                ${['Semana -3', 'Semana -2', 'Semana -1', 'Semana -0'].map(semana => {
                    const valor = stats.porSemana[semana] || 0;
                    const maxValue = Math.max(...Object.values(stats.porSemana));
                    const altura = maxValue > 0 ? (valor / maxValue) * 150 : 10;
                    return `
                        <div style="flex: 1; text-align: center;">
                            <div style="background: linear-gradient(to top, #009688, #4CAF50);
                                        height: ${altura}px;
                                        border-radius: 8px 8px 0 0;
                                        margin-bottom: 10px;
                                        display: flex;
                                        align-items: flex-start;
                                        justify-content: center;
                                        padding-top: 10px;
                                        color: white;
                                        font-weight: bold;
                                        font-size: 16px;">
                                ${valor}
                            </div>
                            <div style="font-size: 12px; color: #666;">${semana.replace('-', ' ')}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        ` : ''}

        <!-- ========================================== -->
        <!-- ‚ú® DEPLOY 36: TOP 5 RANKINGS -->
        <!-- ========================================== -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">

            ${stats.top5Setores && stats.top5Setores.length > 0 ? `
            <div class="chart-container">
                <h3 class="chart-title">üèÜ Top 5 Setores com Mais RNCs</h3>
                <div style="padding: 20px;">
                    ${stats.top5Setores.map((setor, index) => {
                        const maxValue = stats.top5Setores[0].total;
                        const largura = (setor.total / maxValue) * 100;
                        const cores = ['#F44336', '#FF9800', '#FFC107', '#4CAF50', '#2196F3'];
                        return `
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-size: 13px; font-weight: 500;">${index + 1}. ${setor.nome}</span>
                                    <span style="font-weight: bold; color: ${cores[index]};">${setor.total}</span>
                                </div>
                                <div style="background: #f5f5f5; height: 24px; border-radius: 12px; overflow: hidden;">
                                    <div style="background: ${cores[index]};
                                                width: ${largura}%;
                                                height: 100%;
                                                border-radius: 12px;
                                                transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            ` : ''}

            ${stats.top5TiposFalha && stats.top5TiposFalha.length > 0 ? `
            <div class="chart-container">
                <h3 class="chart-title">üîß Top 5 Tipos de Falha</h3>
                <div style="padding: 20px;">
                    ${stats.top5TiposFalha.map((tipo, index) => {
                        const maxValue = stats.top5TiposFalha[0].total;
                        const largura = (tipo.total / maxValue) * 100;
                        const cores = ['#F44336', '#FF9800', '#FFC107', '#4CAF50', '#2196F3'];
                        return `
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-size: 13px; font-weight: 500;">${index + 1}. ${tipo.nome}</span>
                                    <span style="font-weight: bold; color: ${cores[index]};">${tipo.total}</span>
                                </div>
                                <div style="background: #f5f5f5; height: 24px; border-radius: 12px; overflow: hidden;">
                                    <div style="background: ${cores[index]};
                                                width: ${largura}%;
                                                height: 100%;
                                                border-radius: 12px;
                                                transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            ` : ''}

        </div>

        <!-- ========================================== -->
        <!-- ‚ú® DEPLOY 36: A√á√ïES RECOMENDADAS -->
        <!-- ========================================== -->
        ${stats.acoesRecomendadas && stats.acoesRecomendadas.length > 0 ? `
        <div class="chart-container" style="margin-top: 30px;">
            <h3 class="chart-title">üí° A√ß√µes Recomendadas</h3>
            <div style="padding: 20px;">
                ${stats.acoesRecomendadas.map(acao => {
                    const corBorda = acao.prioridade === 'Alta' ? '#F44336' :
                                     acao.prioridade === 'M√©dia' ? '#FFC107' : '#4CAF50';
                    const corFundo = acao.prioridade === 'Alta' ? '#ffebee' :
                                     acao.prioridade === 'M√©dia' ? '#fff8e1' : '#e8f5e9';
                    return `
                        <div style="border-left: 4px solid ${corBorda};
                                    background: ${corFundo};
                                    padding: 15px;
                                    margin-bottom: 15px;
                                    border-radius: 4px;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="font-size: 28px;">${acao.icone}</div>
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-weight: bold; font-size: 15px; color: #333;">${acao.titulo}</span>
                                        <span style="background: ${corBorda};
                                                     color: white;
                                                     padding: 4px 12px;
                                                     border-radius: 12px;
                                                     font-size: 11px;
                                                     font-weight: bold;">
                                            ${acao.prioridade.toUpperCase()}
                                        </span>
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 8px;">${acao.descricao}</div>
                                    <div style="font-size: 12px; color: ${corBorda}; font-weight: 500;">
                                        ‚Üí ${acao.acao}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        ` : ''}
    `;

    container.innerHTML = dashboardHtml;
    
    // Renderizar gr√°ficos
    renderPieChart('chartPorTipo', stats.porTipo || {});
    renderPieChart('chartPorRisco', stats.porRisco || {});
    renderPieChart('chartPorTipoFalha', stats.porTipoFalha || {});
    renderPieChart('chartSetorAbertura', stats.porSetorAbertura || {});
    renderPieChart('chartSetorNaoConf', stats.porSetorNaoConformidade || {});
    renderPieChart('chartStatusAcao', stats.porStatusAcaoCorretiva || {});
    renderLineChart('timelineChart', stats.porMes || {});
    
    debugLog('success', '‚úÖ Dashboard renderizado com 15 cards + 8 KPIs avan√ßados');
}
        
var dashboardCache = null;
var dashboardCacheTime = null;
// ‚úÖ DEPLOY 116 - FASE 5: Cache Duration (estrat√©gia unificada - 5 minutos)
var CACHE_DURATION = 5 * 60 * 1000; // 5 minutos (CONFIG.CACHE.MEDIUM em ms)

async function refreshDashboard(retryCount = 0, forceRefresh = false) {
    try {
        // ‚úÖ Verificar cache (SKIP se forceRefresh = true)
        if (!forceRefresh && dashboardCache && dashboardCacheTime && (Date.now() - dashboardCacheTime < CACHE_DURATION)) {
            debugLog('info', '‚ö° Usando cache do Dashboard');
            dashboardRncs = dashboardCache.rncs || [];  // ‚úÖ DEPLOY 101: Carregar RNCs do cache
            console.log('üì¶ Cache usado - RNCs:', dashboardRncs.length, 'hasRncs:', !!dashboardCache.rncs);

            // ‚úÖ DEPLOY 104: Se cache est√° vazio E n√£o tentou recarregar ainda, force refresh
            if (dashboardRncs.length === 0 && retryCount === 0) {
                console.warn('‚ö†Ô∏è Cache vazio detectado, for√ßando refresh...');
                dashboardCache = null;
                dashboardCacheTime = null;
                return await refreshDashboard(1);  // Tentar novamente
            }

            renderDashboard(dashboardCache);
            hideLoading();
            return;
        }

        const tipoSetor = document.getElementById('tipoSetorDashboard')?.value || 'qualidade';
        const setor = document.getElementById('setorFilterDashboard')?.value || 'Todos';

        showLoading('Carregando Dashboard...');

        const stats = await apiCall('getDashboardDataFiltered', [tipoSetor, setor]);

        // ‚úÖ DEPLOY 104: Valida√ß√£o melhorada do resultado
        if (!stats || typeof stats !== 'object') {
            console.error('‚ùå Stats inv√°lido retornado:', stats);
            throw new Error('Dados inv√°lidos retornados do servidor');
        }

        // ‚úÖ DEPLOY 103: DEBUG Timeline - Verificar estrutura retornada
        console.log('üìä Stats retornado do servidor:', {
            hasRncs: !!stats.rncs,
            rncsLength: stats.rncs ? stats.rncs.length : 0,
            statsKeys: Object.keys(stats).slice(0, 10),
            statsTotal: stats.total
        });

        // ‚úÖ DEPLOY 101: Armazenar raw RNCs para Timeline regrouping
        dashboardRncs = stats.rncs || [];
        console.log('‚úÖ Dashboard RNCs armazenadas:', dashboardRncs.length);

        // ‚úÖ DEPLOY 104: Se ainda est√° vazio ap√≥s chamada API E n√£o tentou muito, retry
        if (dashboardRncs.length === 0 && retryCount < 2) {
            console.warn(`‚ö†Ô∏è AVISO: dashboardRncs est√° vazio! (tentativa ${retryCount + 1}/3)`);
            console.log('üîÑ Aguardando 1 segundo antes de tentar novamente...');
            hideLoading();
            await new Promise(resolve => setTimeout(resolve, 1000));
            return await refreshDashboard(retryCount + 1);
        }

        // Verificar se tem dados reais
        if (dashboardRncs.length > 0) {
            console.log('üìù Primeira RNC:', dashboardRncs[0]);
        } else {
            console.warn('‚ö†Ô∏è AVISO FINAL: dashboardRncs est√° vazio ap√≥s todas as tentativas!');
            // Mesmo vazio, continuar para mostrar dashboard sem dados
        }

        // ‚úÖ Salvar no cache (mesmo se vazio, para evitar loops infinitos)
        dashboardCache = stats;
        dashboardCacheTime = Date.now();

        renderDashboard(stats);
        hideLoading();

    } catch (error) {
        debugLog('error', '‚ùå Erro ao atualizar Dashboard', { error: error.message, retryCount });

        // ‚úÖ DEPLOY 104: Se falhou e n√£o tentou muito, retry ap√≥s delay
        if (retryCount < 2) {
            console.log(`üîÑ Tentando novamente ap√≥s erro... (tentativa ${retryCount + 1}/3)`);
            hideLoading();
            await new Promise(resolve => setTimeout(resolve, 1500));
            return await refreshDashboard(retryCount + 1);
        }

        showError('Erro ao carregar dashboard: ' + error.message);
        hideLoading();
    }
}

        function renderSimpleChart(containerId, data) {
            const container = document.getElementById(containerId);
            if (!container || !data) return;
            
            const entries = Object.entries(data);
            if (entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted);">üìä Sem dados para exibir</div>';
                return;
            }
            
            const total = entries.reduce((sum, [, value]) => sum + value, 0);
            const colors = ['var(--primary)', 'var(--warning)', 'var(--accent)', 'var(--success)', 'var(--error)'];
            
            let chartHtml = '<div style="display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: center;">';
            
            entries.forEach(([label, value], index) => {
                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                const color = colors[index % colors.length];
                
                chartHtml += `
                    <div style="text-align: center; min-width: 100px;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: ${color}; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.125rem; box-shadow: var(--shadow-md);">
                            ${value}
                        </div>
                        <div style="margin-top: 0.75rem; font-size: 0.875rem; font-weight: 500; color: var(--text);">${label}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${percentage}%</div>
                    </div>
                `;
            });
            
            chartHtml += '</div>';
            container.innerHTML = chartHtml;
        }
        
// === ALTERNAR GRANULARIDADE DO TIMELINE ===
let currentGranularity = 'mes';

function changeTimelineGranularity(granularity, buttonElement) {
    currentGranularity = granularity;

    // Atualizar estilos dos bot√µes
    document.querySelectorAll('[onclick^="changeTimelineGranularity"]').forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#009688';
    });

    // Destacar bot√£o clicado
    if (buttonElement) {
        buttonElement.style.background = '#009688';
        buttonElement.style.color = 'white';
    }

    // ‚úÖ DEPLOY 101: Usar dashboardRncs (Dashboard) ou reportData.rncs (Relat√≥rio)
    const rncsToUse = dashboardRncs.length > 0 ? dashboardRncs : (reportData && reportData.rncs ? reportData.rncs : []);

    console.log('changeTimelineGranularity:', {
        granularity: granularity,
        dashboardRncsCount: dashboardRncs.length,
        reportDataRncsCount: reportData && reportData.rncs ? reportData.rncs.length : 0,
        usingSource: dashboardRncs.length > 0 ? 'Dashboard' : 'Report'
    });

    if (rncsToUse.length > 0) {
        const newData = groupRncsByGranularity(rncsToUse, granularity);
        renderLineChart('timelineChart', newData);
        debugLog('info', `Timeline alterado para: ${granularity}`);
    } else {
        console.warn('Nenhuma RNC dispon√≠vel para regroupamento do Timeline');
    }
}

function groupRncsByGranularity(rncs, granularity) {
    const grouped = {};

    rncs.forEach(rnc => {
        // ‚úÖ DEPLOY 112: Tentar m√∫ltiplos campos de data (incluindo campo simplificado 'data')
        const dataAbertura = rnc.data ||  // <- RNCs simplificadas do backend
                            rnc['data'] ||
                            rnc['Data de Abertura'] ||
                            rnc['Data Abertura'] ||
                            rnc['Data Cria√ß√£o'] ||
                            rnc['Data de Cria√ß√£o'];

        if (!dataAbertura) {
            console.log('RNC sem data:', rnc);
            return;
        }

        let key;
        const date = new Date(dataAbertura);

        // Validar data
        if (isNaN(date.getTime())) {
            console.log('Data inv√°lida:', dataAbertura);
            return;
        }

        switch (granularity) {
            case 'dia':
                key = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
                break;
            case 'semana':
                const weekNum = Math.ceil((date.getDate() + 6 - date.getDay()) / 7);
                key = `Sem ${weekNum}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
                break;
            case 'ano':
                key = `${date.getFullYear()}`;
                break;
            case 'mes':
            default:
                key = `${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        }

        grouped[key] = (grouped[key] || 0) + 1;
    });

    console.log(`Agrupado por ${granularity}:`, grouped);
    return grouped;
}

// === GR√ÅFICO DE LINHA MODERNO COM APEXCHARTS ===
function renderLineChart(containerId, data) {
    const container = document.getElementById(containerId);
    if (!container || !data) return;

    // Ordena√ß√£o inteligente que funciona com dia/semana/mes/ano
    const entries = Object.entries(data).sort((a, b) => {
        const keyA = a[0];
        const keyB = b[0];

        // Detectar formato e criar timestamp para ordena√ß√£o
        function parseToTimestamp(key) {
            // Formato: dd/mm/aaaa (dia)
            if (key.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const [dia, mes, ano] = key.split('/').map(Number);
                return new Date(ano, mes - 1, dia).getTime();
            }
            // Formato: Sem N/mm/aaaa (semana)
            else if (key.startsWith('Sem ')) {
                const parts = key.replace('Sem ', '').split('/');
                const semana = parseInt(parts[0]);
                const mes = parseInt(parts[1]);
                const ano = parseInt(parts[2]);
                return new Date(ano, mes - 1, semana).getTime();
            }
            // Formato: mm/aaaa (mes)
            else if (key.match(/^\d{2}\/\d{4}$/)) {
                const [mes, ano] = key.split('/').map(Number);
                return new Date(ano, mes - 1, 1).getTime();
            }
            // Formato: aaaa (ano)
            else if (key.match(/^\d{4}$/)) {
                return new Date(parseInt(key), 0, 1).getTime();
            }
            return 0;
        }

        return parseToTimestamp(keyA) - parseToTimestamp(keyB);
    });

    if (entries.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">üìà Sem dados temporais</div>';
        return;
    }

    // Limpar container
    container.innerHTML = '';

    // Destruir gr√°fico anterior se existir
    if (window[containerId + '_chart']) {
        window[containerId + '_chart'].destroy();
    }

    // Configura√ß√£o ApexCharts
    const options = {
        series: [{
            name: 'RNCs por Per√≠odo',
            data: entries.map(([, value]) => value)
        }],
        chart: {
            type: 'area',
            height: 400,
            fontFamily: 'Inter, sans-serif',
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    zoom: true,
                    zoomin: true,
                    zoomout: true,
                    pan: true,
                    reset: true
                }
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800,
                animateGradually: {
                    enabled: true,
                    delay: 150
                },
                dynamicAnimation: {
                    enabled: true,
                    speed: 350
                }
            },
            dropShadow: {
                enabled: true,
                top: 3,
                left: 0,
                blur: 6,
                opacity: 0.15
            }
        },
        colors: ['#009688'],
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.6,
                opacityTo: 0.1,
                stops: [0, 90, 100]
            }
        },
        xaxis: {
            categories: entries.map(([period]) => period),
            labels: {
                style: {
                    colors: '#666',
                    fontSize: '12px',
                    fontWeight: 500
                }
            },
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: '#666',
                    fontSize: '12px'
                },
                formatter: function(val) {
                    return Math.floor(val);
                }
            }
        },
        grid: {
            borderColor: 'rgba(0, 0, 0, 0.05)',
            strokeDashArray: 4,
            xaxis: {
                lines: {
                    show: false
                }
            },
            yaxis: {
                lines: {
                    show: true
                }
            }
        },
        tooltip: {
            theme: 'dark',
            x: {
                show: true
            },
            y: {
                formatter: function(val) {
                    return val + ' RNC(s)';
                },
                title: {
                    formatter: function() {
                        return '';
                    }
                }
            },
            marker: {
                show: true
            }
        },
        markers: {
            size: 5,
            colors: ['#009688'],
            strokeColors: '#fff',
            strokeWidth: 3,
            hover: {
                size: 8,
                sizeOffset: 2
            }
        },
        legend: {
            show: true,
            position: 'top',
            horizontalAlign: 'left',
            fontSize: '13px',
            fontWeight: 600,
            markers: {
                width: 12,
                height: 12,
                radius: 12
            }
        }
    };

    // Criar e renderizar gr√°fico ApexCharts
    window[containerId + '_chart'] = new ApexCharts(container, options);
    window[containerId + '_chart'].render();

    debugLog('success', `‚ú® Gr√°fico de linha ApexCharts criado: ${containerId}`);
}
        
        // === RELAT√ìRIOS ===
        async function loadReportFilters() {
    try {
        debugLog('info', 'üìä Carregando filtros de relat√≥rio');
        
        const setores = await apiCall('getSetoresDuplos', []);
        const tipoSetorSelect = document.getElementById('tipoSetorRelatorio');
        const setorSelect = document.getElementById('setorFiltro');
        
        // Definir datas padr√£o
        const hoje = new Date();
        const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        
        document.getElementById('dataInicio').value = primeiroDia.toISOString().split('T')[0];
        document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
        
        // Fun√ß√£o para atualizar lista de setores
        function atualizarListaSetores() {
            const tipoSetor = tipoSetorSelect.value;
            const listaSetores = tipoSetor === 'abertura' 
                ? setores.setoresAbertura 
                : setores.setoresQualidade;
            
            setorSelect.innerHTML = '<option value="Todos">Todos os Setores</option>';
            
            listaSetores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = setor;
                setorSelect.appendChild(option);
            });
        }
        
        // Event listener
        tipoSetorSelect.addEventListener('change', atualizarListaSetores);
        
        // Carregar lista inicial
        atualizarListaSetores();
        
        // Popular outros filtros
        const options = await apiCall('getReportFilterOptions');
        populateFilterOptions('tipoFiltro', options.tipos || []);
        populateFilterOptions('statusFiltro', options.status || []);
        
        debugLog('success', '‚úÖ Filtros de relat√≥rio carregados');
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar filtros', { error: error.message });
    }
}
        
        function populateFilterOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Manter primeira op√ß√£o (Todos)
            const firstOption = select.children[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }
        
        async function generateReport() {
    try {
        debugLog('info', 'üìä Gerando relat√≥rio');
        
        const filters = {
            dataInicio: document.getElementById('dataInicio').value,
            dataFim: document.getElementById('dataFim').value,
            status: document.getElementById('statusFiltro').value,
            tipoSetor: document.getElementById('tipoSetorRelatorio').value,
            setor: document.getElementById('setorFiltro').value,
            tipo: document.getElementById('tipoFiltro').value
        };
        
        if (!filters.dataInicio || !filters.dataFim) {
            showError('Por favor, preencha as datas de in√≠cio e fim');
            return;
        }
        
        // Modal de confirma√ß√£o HTML
        const confirmModal = document.createElement('div');
        confirmModal.className = 'modal-overlay';
        confirmModal.innerHTML = `
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h3>üìä Gerar Relat√≥rio</h3>
                    <button class="close-modal" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 15px; color: #555;">Confirme os filtros selecionados:</p>
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="margin-bottom: 10px;">
                            <strong>üìÖ Per√≠odo:</strong> ${formatDate(filters.dataInicio)} at√© ${formatDate(filters.dataFim)}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>üìä Status:</strong> ${filters.status}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>üìä Tipo de Setor:</strong> ${filters.tipoSetor === 'qualidade' ? 'N√£o Conformidade' : 'Abertura'}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>üè¢ Setor:</strong> ${filters.setor}
                        </div>
                        <div>
                            <strong>üìã Tipo RNC:</strong> ${filters.tipo}
                        </div>
                    </div>
                    <p style="color: #666; font-size: 13px;">
                        ‚ö†Ô∏è Esta opera√ß√£o pode levar alguns segundos.
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" id="confirmGenerateReport">
                        üìä Gerar Relat√≥rio
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(confirmModal);

        // Retornar Promise para aguardar confirma√ß√£o
        const userConfirmed = await new Promise((resolve) => {
            const confirmBtn = document.getElementById('confirmGenerateReport');
            confirmBtn.onclick = () => {
                confirmModal.remove();
                resolve(true);
            };
            // Se fechar o modal, resolve como false
            confirmModal.querySelector('.close-modal').onclick = () => {
                confirmModal.remove();
                resolve(false);
            };
            confirmModal.querySelector('.btn-secondary').onclick = () => {
                confirmModal.remove();
                resolve(false);
            };
        });

        if (!userConfirmed) {
            debugLog('info', 'Usuario cancelou geracao de relatorio');
            return;
        }
        
        showLoading('Gerando relat√≥rio...');
        
        const result = await apiCall('generateReport', [filters]);

        if (!result) {
            throw new Error('Nenhum dado retornado do servidor');
        }

        // Verificar se h√° mensagem de aviso (nenhum resultado encontrado)
        if (result.message && result.totalFiltrado === 0) {
            hideLoading();
            showWarning(result.message + `<br><br><strong>Total de RNCs no sistema:</strong> ${result.totalOriginal}`);
            document.getElementById('report-content').innerHTML = `
                <div class="alert alert-warning" style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üîç</div>
                    <h3>Nenhuma RNC encontrada</h3>
                    <p style="margin-top: 15px; color: #666;">
                        ${result.message}
                    </p>
                    <p style="margin-top: 10px; color: #999; font-size: 14px;">
                        Total de RNCs no sistema: <strong>${result.totalOriginal}</strong>
                    </p>
                    <div style="margin-top: 25px;">
                        <button class="btn btn-primary" onclick="clearFilters()">
                            üîÑ Limpar Filtros
                        </button>
                    </div>
                </div>
            `;
            debugLog('warning', '‚ö†Ô∏è Nenhuma RNC encontrada com os filtros', {
                totalOriginal: result.totalOriginal,
                filters: filters
            });
            return;
        }

        reportData = result;
        renderReport(result);

        document.getElementById('exportPdf').disabled = false;
        hideLoading();

        showSuccess(`Relat√≥rio gerado: ${result.rncs ? result.rncs.length : 0} RNC(s) encontrada(s)`);

        debugLog('success', '‚úÖ Relat√≥rio gerado', {
            totalRncs: result.rncs ? result.rncs.length : 0
        });
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao gerar relat√≥rio', { error: error.message });
        showError('Erro ao gerar relat√≥rio: ' + error.message);
        hideLoading();
    }
}
        

// Fun√ß√£o auxiliar para editar RNC pelo relat√≥rio
function editRncFromReport(rncNumber) {
    if (!rncNumber) return;
    
    // Mudar para aba Editar
    showTab('tab-editar');
    
    // Preencher n√∫mero e buscar
    document.getElementById('searchRncNumber').value = rncNumber;
    loadRncForEdit();
}


        function renderReport(data) {
    const container = document.getElementById('report-content');
    const rncs = data.rncs || [];
    const stats = data.stats || {};
    
    const reportHtml = `
        <!-- ========================================== -->
        <!-- CABE√áALHO DO RELAT√ìRIO -->
        <!-- ========================================== -->
        <div class="report-summary" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h3 class="chart-title">üìã Informa√ß√µes do Relat√≥rio</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                <div>
                    <p><strong>üìä Total de RNC(s):</strong> ${rncs.length}</p>
                    <p><strong>üìÖ Per√≠odo:</strong> ${formatDate(data.filters.dataInicio)} at√© ${formatDate(data.filters.dataFim)}</p>
                    <p><strong>‚è∞ Gerado em:</strong> ${new Date(data.dataGeracao).toLocaleString('pt-BR')}</p>
                </div>
                <div>
                    <p><strong>üè¢ Setor:</strong> ${data.filters.setor}</p>
                    <p><strong>üìã Tipo:</strong> ${data.filters.tipo}</p>
                    <p><strong>üéØ Status:</strong> ${data.filters.status}</p>
                </div>
            </div>
        </div>
        
        ${rncs.length > 0 ? `
        
        <!-- ========================================== -->
        <!-- SE√á√ÉO 1: KPIs ESTRAT√âGICOS (CARDS) -->
        <!-- ========================================== -->
        <h3 class="chart-title" style="margin-top: 30px; margin-bottom: 20px;">üìä KPIs Estrat√©gicos</h3>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
            
            <!-- KPI: Impacto Cliente -->
            <div class="dashboard-card" style="border-top-color: ${stats.impactoClientePercentual > 30 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">üë•</div>
                <div class="dashboard-number">${stats.impactoClientePercentual || 0}%</div>
                <div class="dashboard-label">Impacto Cliente</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.impactoClienteTotal || 0} RNCs
                </div>
            </div>
            
            <!-- KPI: Detec√ß√£o Interna -->
            <div class="dashboard-card" style="border-top-color: ${stats.deteccaoInternaPercentual >= 70 ? '#4CAF50' : '#FFC107'};">
                <div class="dashboard-icon">üîç</div>
                <div class="dashboard-number">${stats.deteccaoInternaPercentual || 0}%</div>
                <div class="dashboard-label">Detec√ß√£o Interna</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.deteccaoInternaTotal || 0} RNCs
                </div>
            </div>
            
            <!-- KPI: N√£o Procede -->
            <div class="dashboard-card" style="border-top-color: ${stats.naoProcedeTaxa > 10 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">‚ùå</div>
                <div class="dashboard-number">${stats.naoProcedeTaxa || 0}%</div>
                <div class="dashboard-label">N√£o Procede</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.naoProcede || 0} RNCs
                </div>
            </div>
            
            <!-- KPI: ISP -->
            <div class="dashboard-card" style="border-top-color: ${stats.indiceSeveridadePonderado > 50 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">üìà</div>
                <div class="dashboard-number">${stats.indiceSeveridadePonderado || 0}</div>
                <div class="dashboard-label">√çndice Severidade</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ISP Ponderado
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
            
            <!-- KPI: Custo Total -->
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üí∞</div>
                <div class="dashboard-number">R$ ${(stats.custoTotal || 0).toFixed(2)}</div>
                <div class="dashboard-label">Custo Total</div>
            </div>
            
            <!-- KPI: Tempo M√©dio -->
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">‚è±Ô∏è</div>
                <div class="dashboard-number">${stats.tempoMedioResolucao || 0} dias</div>
                <div class="dashboard-label">Tempo M√©dio</div>
            </div>
            
            <!-- KPI: Cumprimento Prazo -->
            <div class="dashboard-card" style="border-top-color: ${stats.taxaCumprimentoPrazo >= 80 ? '#4CAF50' : '#F44336'};">
                <div class="dashboard-icon">‚è∞</div>
                <div class="dashboard-number">${stats.taxaCumprimentoPrazo || 0}%</div>
                <div class="dashboard-label">Prazo Cumprido</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.finalizadasNoPrazo || 0} de ${stats.finalizadasTotal || 0}
                </div>
            </div>
            
            <!-- KPI: Atrasadas -->
            <div class="dashboard-card" style="border-top-color: ${stats.rncsComAtraso > 0 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">‚ö†Ô∏è</div>
                <div class="dashboard-number">${stats.rncsComAtraso || 0}</div>
                <div class="dashboard-label">RNCs Atrasadas</div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- SE√á√ÉO 2: GR√ÅFICOS DE DISTRIBUI√á√ÉO -->
        <!-- ========================================== -->
        <h3 class="chart-title" style="margin-top: 30px; margin-bottom: 20px;">üìä Distribui√ß√£o das RNCs</h3>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            
            <div class="chart-container">
                <h3 class="chart-title">üìã Por Tipo</h3>
                <div id="reportChartTipo"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">‚ö†Ô∏è Por Risco</h3>
                <div id="reportChartRisco"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üè¢ Por Setor</h3>
                <div id="reportChartSetor"></div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- SE√á√ÉO 3: TABELA DE CUSTO M√âDIO -->
        <!-- ========================================== -->
        ${Object.keys(stats.custoMedioPorTipo || {}).length > 0 ? `
        <h3 class="chart-title" style="margin-top: 30px; margin-bottom: 20px;">üí∞ An√°lise de Custos por Tipo</h3>
        
        <div class="chart-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #009688; color: white;">
                        <th style="padding: 12px; text-align: left;">Tipo de RNC</th>
                        <th style="padding: 12px; text-align: center;">Quantidade</th>
                        <th style="padding: 12px; text-align: right;">Custo Total</th>
                        <th style="padding: 12px; text-align: right;">Custo M√©dio</th>
                        <th style="padding: 12px; text-align: center;">% do Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(stats.custoMedioPorTipo)
                        .sort((a, b) => stats.custoMedioPorTipo[b].soma - stats.custoMedioPorTipo[a].soma)
                        .map(tipo => {
                            const dados = stats.custoMedioPorTipo[tipo];
                            const percentual = ((dados.soma / stats.custoTotal) * 100).toFixed(1);
                            return `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px;">${tipo}</td>
                                    <td style="padding: 10px; text-align: center;">${dados.count}</td>
                                    <td style="padding: 10px; text-align: right;">R$ ${dados.soma.toFixed(2)}</td>
                                    <td style="padding: 10px; text-align: right; font-weight: bold; color: #009688;">R$ ${dados.media.toFixed(2)}</td>
                                    <td style="padding: 10px; text-align: center;">
                                        <div style="background: #e0f2f1; padding: 4px 8px; border-radius: 4px; display: inline-block;">
                                            ${percentual}%
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    <tr style="background: #f5f5f5; font-weight: bold;">
                        <td style="padding: 12px;">TOTAL</td>
                        <td style="padding: 12px; text-align: center;">${stats.total}</td>
                        <td style="padding: 12px; text-align: right;">R$ ${stats.custoTotal.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: right;">-</td>
                        <td style="padding: 12px; text-align: center;">100%</td>
                    </tr>
                </tbody>
            </table>
        </div>
        ` : ''}
        
        <!-- ========================================== -->
        <!-- SE√á√ÉO 4: LISTA DETALHADA DE RNCs -->
        <!-- ========================================== -->
        <h3 class="chart-title" style="margin-top: 30px; margin-bottom: 20px;">üìã Lista Detalhada de RNCs</h3>
        
        <div class="chart-container">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: #009688; color: white;">
                        <th style="padding: 10px; text-align: left;">N¬∫ RNC</th>
                        <th style="padding: 10px; text-align: left;">Cliente</th>
                        <th style="padding: 10px; text-align: center;">Status</th>
                        <th style="padding: 10px; text-align: center;">Tipo</th>
                        <th style="padding: 10px; text-align: center;">Risco</th>
                        <th style="padding: 10px; text-align: right;">Custo</th>
                        <th style="padding: 10px; text-align: center;">Respons√°vel</th>
                    </tr>
                </thead>
                <tbody>
                    ${rncs.map(rnc => `
                        <tr style="border-bottom: 1px solid #eee; cursor: pointer;" onclick="editRncFromReport('${rnc['N¬∫ RNC']}')">
                            <td style="padding: 8px; font-weight: bold;">${rnc['N¬∫ RNC']}</td>
                            <td style="padding: 8px;">${rnc['Nome do Cliente'] || '-'}</td>
                            <td style="padding: 8px; text-align: center;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; 
                                    background: ${rnc['Status Geral'] === 'Finalizada' ? '#4CAF50' : 
                                               rnc['Status Geral'] === 'Abertura RNC' ? '#2196F3' : '#FFC107'}; 
                                    color: white;">
                                    ${rnc['Status Geral'] || 'N/A'}
                                </span>
                            </td>
                            <td style="padding: 8px; text-align: center; font-size: 11px;">${rnc['Tipo RNC'] || '-'}</td>
                            <td style="padding: 8px; text-align: center;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px;
                                    background: ${(rnc['Risco'] || '').toLowerCase().includes('cr√≠tico') ? '#F44336' :
                                               (rnc['Risco'] || '').toLowerCase().includes('maior') ? '#FF9800' :
                                               (rnc['Risco'] || '').toLowerCase().includes('menor') ? '#4CAF50' : '#9CA3AF'};
                                    color: white;">
                                    ${rnc['Risco'] || 'N√£o Informado'}
                                </span>
                            </td>
                            <td style="padding: 8px; text-align: right;">R$ ${(parseFloat(rnc['Valor']) || 0).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: center; font-size: 11px;">${rnc['Respons√°vel pela abertura da RNC'] || '-'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        ` : `
            <div class="chart-container" style="text-align: center; padding: 40px;">
                <h3>üì≠ Nenhuma RNC encontrada</h3>
                <p style="color: #666; margin-top: 10px;">
                    Tente ajustar os filtros para visualizar resultados diferentes.
                </p>
            </div>
        `}
    `;
    
    container.innerHTML = reportHtml;
    
    // Renderizar gr√°ficos se houver dados
    if (rncs.length > 0) {
        renderPieChart('reportChartTipo', stats.porTipo || {});
        renderPieChart('reportChartRisco', stats.porRisco || {});
        renderPieChart('reportChartSetor', stats.porSetor || {});
    }
    
    debugLog('success', '‚úÖ Relat√≥rio renderizado com 8 KPIs + gr√°ficos + tabelas');
}
        
/**
 * ============================================
 * DEPLOY 104: HELPER - Renderizar gr√°fico para PDF (CORRIGIDO)
 * ‚úÖ FIX: Tipos donut/pie/line/bar configurados corretamente
 * ‚úÖ FIX: Resolu√ß√£o aumentada para 800x500 (melhor qualidade)
 * ‚úÖ FIX: Legendas e labels vis√≠veis em todos os gr√°ficos
 * ============================================
 */
async function renderChartForPdf(type, data, title) {
    console.log(`üé® renderChartForPdf iniciado - type: ${type}, title: ${title}, entries: ${Object.keys(data).length}`);

    return new Promise((resolve) => {
        // Criar container invis√≠vel tempor√°rio com MAIOR RESOLU√á√ÉO
        const container = document.createElement('div');
        container.id = 'temp_chart_' + Date.now();
        container.style.width = '800px';  // ‚úÖ Aumentado de 500px
        container.style.height = '500px'; // ‚úÖ Aumentado de 300px
        container.style.position = 'absolute';
        container.style.left = '-9999px';
        container.style.top = '-9999px';
        document.body.appendChild(container);

        // ‚úÖ DEPLOY 105: Filtrar e validar dados antes de criar gr√°fico
        const entries = Object.entries(data)
            .filter(([label, value]) => {
                // Filtrar labels vazias e valores inv√°lidos
                const isValidLabel = label && label.trim() !== '';
                const numValue = parseFloat(value);
                const isValidValue = !isNaN(numValue) && isFinite(numValue);
                return isValidLabel && isValidValue;
            })
            .map(([label, value]) => [label, parseFloat(value)]); // Garantir que valores s√£o n√∫meros

        if (entries.length === 0) {
            console.warn(`‚ö†Ô∏è Sem dados v√°lidos para ${title} - abortando`);
            container.remove();
            resolve(null);
            return;
        }

        console.log(`üìä Criando gr√°fico ${title} com ${entries.length} itens v√°lidos`);

        // ‚úÖ Definir se √© gr√°fico de pizza/donut ou n√£o
        const isPieDonut = (type === 'pie' || type === 'donut');
        const isLine = (type === 'line');
        const isBar = (type === 'bar');

        // ‚úÖ DEPLOY 106: Debug detalhado antes de criar gr√°fico
        console.log(`üìä DEBUG ${title}:`, {
            type,
            isPieDonut,
            isLine,
            isBar,
            entries: entries.slice(0, 3), // Primeiras 3 entradas
            entriesCount: entries.length
        });

        // ‚úÖ Paleta de cores mais rica
        const colors = isPieDonut ?
            ['#284179', '#009688', '#FF9800', '#F44336', '#4CAF50', '#9C27B0', '#FFC107', '#00BCD4', '#E91E63', '#3F51B5'] :
            ['#009688', '#284179', '#FF9800', '#F44336', '#4CAF50'];

        // ‚úÖ DEPLOY 106: Preparar dados com valida√ß√£o extra
        const seriesData = entries.map(([, value]) => value);
        const categories = entries.map(([label]) => String(label).trim()); // Garantir string limpa

        console.log(`üìä Series/Categories preparadas:`, {
            seriesData,
            categories,
            seriesDataTypes: seriesData.map(v => typeof v),
            categoriesTypes: categories.map(v => typeof v)
        });

        // ‚úÖ Configura√ß√£o correta por tipo
        const options = {
            series: isPieDonut ?
                seriesData :  // Donut/Pie: array simples
                [{
                    name: String(title).substring(0, 50), // Limitar tamanho do nome
                    data: seriesData
                }],
            chart: {
                type: type === 'donut' ? 'donut' : type,  // ‚úÖ Manter 'donut' como donut
                height: 500,
                width: 800,
                fontFamily: 'Inter, sans-serif',
                toolbar: { show: false },
                animations: { enabled: false }
            },
            labels: isPieDonut ? categories : undefined,  // ‚úÖ Labels para donut/pie
            xaxis: !isPieDonut ? {
                categories: categories,
                labels: {
                    style: {
                        fontSize: '12px',
                        fontWeight: 600
                    },
                    rotate: isBar ? -45 : 0,  // ‚úÖ Rotacionar labels em gr√°ficos de barra
                    trim: true,
                    hideOverlappingLabels: false
                }
            } : undefined,
            yaxis: !isPieDonut ? {
                labels: {
                    style: { fontSize: '12px' },
                    formatter: function(val) {
                        return Math.round(val);  // ‚úÖ Valores inteiros no eixo Y
                    }
                }
            } : undefined,
            colors: colors,
            dataLabels: {
                enabled: true,
                style: {
                    fontSize: isPieDonut ? '14px' : '12px',
                    fontWeight: 'bold',
                    colors: [isPieDonut ? '#fff' : '#000']
                },
                formatter: function(val, opts) {
                    if (isPieDonut) {
                        // ‚úÖ Mostrar porcentagem em pizza/donut
                        return Math.round(val) + ' (' + Math.round(opts.w.globals.seriesPercent[opts.seriesIndex]) + '%)';
                    }
                    return Math.round(val);
                }
            },
            legend: {
                show: true,  // ‚úÖ SEMPRE mostrar legenda
                position: isPieDonut ? 'bottom' : 'top',
                fontSize: '13px',
                fontWeight: 600,
                markers: {
                    width: 12,
                    height: 12
                },
                itemMargin: {
                    horizontal: 10,
                    vertical: 5
                }
            },
            plotOptions: isPieDonut ? {
                pie: {
                    donut: {
                        size: '65%',
                        labels: {
                            show: true,
                            name: {
                                show: true,
                                fontSize: '16px',
                                fontWeight: 700
                            },
                            value: {
                                show: true,
                                fontSize: '20px',
                                fontWeight: 700
                            },
                            total: {
                                show: true,
                                label: 'Total',
                                fontSize: '14px',
                                fontWeight: 600
                            }
                        }
                    }
                }
            } : isBar ? {
                bar: {
                    horizontal: false,
                    columnWidth: '60%',
                    dataLabels: {
                        position: 'top'
                    }
                }
            } : {},
            stroke: isLine ? {
                curve: 'smooth',
                width: 3
            } : {},
            markers: isLine ? {
                size: 5,
                strokeWidth: 2,
                hover: {
                    size: 7
                }
            } : {},
            title: {
                text: title,
                align: 'center',
                style: {
                    fontSize: '16px',
                    fontWeight: 'bold',
                    color: '#284179'
                }
            }
        };

        const chart = new ApexCharts(container, options);

        chart.render().then(() => {
            console.log(`‚úÖ Gr√°fico ${title} renderizado, aguardando export...`);
            // Aguardar renderiza√ß√£o completa (aumentado para 800ms para garantir)
            setTimeout(() => {
                chart.dataURI({ scale: 2 }).then(({ imgURI }) => {  // ‚úÖ scale: 2 para dobrar resolu√ß√£o
                    console.log(`‚úÖ ${title} exportado como Base64:`, imgURI ? `${imgURI.substring(0, 50)}...` : 'null');
                    chart.destroy();
                    container.remove();
                    resolve(imgURI);
                }).catch((err) => {
                    console.error(`‚ùå Erro ao exportar ${title}:`, err);
                    chart.destroy();
                    container.remove();
                    resolve(null);
                });
            }, 800);
        }).catch((err) => {
            console.error(`‚ùå Erro ao renderizar ${title}:`, err);
            container.remove();
            resolve(null);
        });
    });
}

/**
 * ============================================
 * DEPLOY 95: RELAT√ìRIO PDF EXECUTIVO COM PDFMAKE
 * Ultra-Professional Report - Board Ready
 * ============================================
 */
async function exportToPdf() {
    if (!reportData || !reportData.rncs || reportData.rncs.length === 0) {
        showError('Nenhum dado para exportar');
        return;
    }

    try {
        showLoading('Gerando PDF Executivo...');

        const stats = reportData.stats;
        const rncs = reportData.rncs;

        // === DEPLOY 103: Renderizar gr√°ficos para PDF com error handling ===
        console.log('üìä INICIANDO renderiza√ß√£o de gr√°ficos para PDF...');
        console.log('üìä Dados dispon√≠veis:', {
            porTipo: Object.keys(stats.porTipo || {}).length,
            porRisco: Object.keys(stats.porRisco || {}).length,
            porSetorAbertura: Object.keys(stats.porSetorAbertura || {}).length
        });

        let chartTipo, chartRisco, chartSetorAbertura;

        try {
            chartTipo = await renderChartForPdf('donut', stats.porTipo || {}, 'Por Tipo de RNC');
            console.log('‚úÖ chartTipo renderizado:', !!chartTipo, chartTipo ? `${chartTipo.substring(0, 50)}...` : 'null');
        } catch (e) {
            console.error('‚ùå Erro ao renderizar chartTipo:', e);
            chartTipo = null;
        }

        try {
            chartRisco = await renderChartForPdf('donut', stats.porRisco || {}, 'Por N√≠vel de Risco');
            console.log('‚úÖ chartRisco renderizado:', !!chartRisco, chartRisco ? `${chartRisco.substring(0, 50)}...` : 'null');
        } catch (e) {
            console.error('‚ùå Erro ao renderizar chartRisco:', e);
            chartRisco = null;
        }

        try {
            chartSetorAbertura = await renderChartForPdf('bar', stats.porSetorAbertura || {}, 'Por Setor de Abertura');
            console.log('‚úÖ chartSetorAbertura renderizado:', !!chartSetorAbertura, chartSetorAbertura ? `${chartSetorAbertura.substring(0, 50)}...` : 'null');
        } catch (e) {
            console.error('‚ùå Erro ao renderizar chartSetorAbertura:', e);
            chartSetorAbertura = null;
        }

        // ‚úÖ DEPLOY 103 - OP√á√ÉO A: Mais gr√°ficos
        let chartTimeline, chartTop5, chartImpactoFinanceiro;

        try {
            chartTimeline = await renderChartForPdf('line', stats.porMes || {}, 'Timeline de Tend√™ncias');
            console.log('‚úÖ chartTimeline renderizado:', !!chartTimeline);
        } catch (e) {
            console.error('‚ùå Erro ao renderizar chartTimeline:', e);
            chartTimeline = null;
        }

        try {
            // TOP 5 Mais Custosas - pegar as 5 primeiras do top5MaisCustosas
            const top5Data = {};
            (stats.top5MaisCustosas || []).forEach((rnc, i) => {
                const numero = rnc['N√∫mero da RNC'] || rnc['N√∫mero RNC'] || `RNC ${i+1}`;
                const custo = parseFloat(rnc['Valor'] || 0);
                top5Data[numero] = custo;
            });
            chartTop5 = await renderChartForPdf('bar', top5Data, 'TOP 5 Mais Custosas');
            console.log('‚úÖ chartTop5 renderizado:', !!chartTop5);
        } catch (e) {
            console.error('‚ùå Erro ao renderizar chartTop5:', e);
            chartTop5 = null;
        }

        try {
            // ‚úÖ DEPLOY 105: Impacto Financeiro por Tipo (FIX valida√ß√£o)
            const impactoData = {};
            const custoTotal = parseFloat(stats.custoTotal) || 0;
            const total = parseInt(stats.total) || 1; // Evitar divis√£o por zero

            Object.entries(stats.porTipo || {}).forEach(([tipo, qtd]) => {
                const quantidade = parseInt(qtd) || 0;
                const custoMedio = custoTotal > 0 ? (custoTotal / total) : 0;
                const valorImpacto = custoMedio * quantidade;
                // ‚úÖ Validar que √© um n√∫mero v√°lido
                impactoData[tipo] = isFinite(valorImpacto) ? Math.round(valorImpacto * 100) / 100 : 0;
            });

            console.log('üìä ImpactoData preparado:', impactoData);
            // ‚úÖ DEPLOY 106: Mudar para 'donut' temporariamente (bar tem problemas com labels)
            chartImpactoFinanceiro = await renderChartForPdf('donut', impactoData, 'Impacto Financeiro por Tipo');
            console.log('‚úÖ chartImpactoFinanceiro renderizado:', !!chartImpactoFinanceiro);
        } catch (e) {
            console.error('‚ùå Erro ao renderizar chartImpactoFinanceiro:', e);
            chartImpactoFinanceiro = null;
        }

        console.log('üìä RESUMO TODOS os gr√°ficos:', {
            chartTipo: !!chartTipo,
            chartRisco: !!chartRisco,
            chartSetorAbertura: !!chartSetorAbertura,
            chartTimeline: !!chartTimeline,
            chartTop5: !!chartTop5,
            chartImpactoFinanceiro: !!chartImpactoFinanceiro
        });

        // === DEFINI√á√ÉO DO DOCUMENTO PDF COM PDFMAKE ===
        const docDefinition = {
            pageSize: 'A4',
            pageMargins: [40, 60, 40, 60],

            // === HEADER ===
            header: function(currentPage, pageCount) {
                return {
                    columns: [
                        { text: 'NEOFORMULA', style: 'headerLeft' },
                        { text: `P√°gina ${currentPage} de ${pageCount}`, style: 'headerRight' }
                    ],
                    margin: [40, 20, 40, 0]
                };
            },

            // === FOOTER ===
            footer: function(currentPage, pageCount) {
                return {
                    text: `Relat√≥rio Gerencial de RNCs | Gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`,
                    alignment: 'center',
                    style: 'footer',
                    margin: [0, 0, 0, 40]
                };
            },

            // === CONTE√öDO ===
            content: [
                // CAPA EXECUTIVA
                { text: 'RELAT√ìRIO GERENCIAL', style: 'coverTitle', margin: [0, 100, 0, 10] },
                { text: 'Sistema de Gest√£o de N√£o Conformidades', style: 'coverSubtitle', margin: [0, 0, 0, 20] },
                { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 2, lineColor: '#284179' }], margin: [0, 0, 0, 30] },

                // Informa√ß√µes do Per√≠odo
                {
                    columns: [
                        { text: 'PER√çODO:', style: 'infoLabel', width: 100 },
                        { text: `${stats.periodo || 'Todos os registros'}`, style: 'infoValue' }
                    ],
                    margin: [0, 0, 0, 10]
                },
                {
                    columns: [
                        { text: 'TOTAL DE RNCs:', style: 'infoLabel', width: 100 },
                        { text: `${stats.total || 0}`, style: 'infoValue' }
                    ],
                    margin: [0, 0, 0, 10]
                },
                {
                    columns: [
                        { text: 'GERADO EM:', style: 'infoLabel', width: 100 },
                        { text: new Date().toLocaleString('pt-BR'), style: 'infoValue' }
                    ],
                    margin: [0, 0, 0, 40]
                },

                { text: '', pageBreak: 'after' },

                // === √çNDICE ===
                { text: '√çNDICE', style: 'sectionTitle', margin: [0, 0, 0, 20] },
                {
                    table: {
                        widths: ['*', 40],
                        body: [
                            [
                                { text: '1. KPIs Estrat√©gicos', style: 'indexItem', border: [false, false, false, false] },
                                { text: '3', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '2. Distribui√ß√£o das RNCs', style: 'indexItem', border: [false, false, false, false] },
                                { text: '4', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '   2.1. Por N√≠vel de Risco', style: 'indexSubItem', border: [false, false, false, false] },
                                { text: '4', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '   2.2. Por Setor', style: 'indexSubItem', border: [false, false, false, false] },
                                { text: '4', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '3. TOP 5 RNCs Mais Custosas', style: 'indexItem', border: [false, false, false, false] },
                                { text: '5', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '4. An√°lise de Tend√™ncias Temporais', style: 'indexItem', border: [false, false, false, false] },
                                { text: '5', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '5. An√°lise de Impacto Financeiro', style: 'indexItem', border: [false, false, false, false] },
                                { text: '6', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '6. An√°lise por N√≠vel de Criticidade', style: 'indexItem', border: [false, false, false, false] },
                                { text: '7', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '7. Conclus√£o Preditiva', style: 'indexItem', border: [false, false, false, false] },
                                { text: '7', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '8. Recomenda√ß√µes Estrat√©gicas para a Diretoria', style: 'indexItem', border: [false, false, false, false] },
                                { text: '8', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '9. Investimentos Sugeridos', style: 'indexItem', border: [false, false, false, false] },
                                { text: '9', style: 'indexPage', border: [false, false, false, false] }
                            ],
                            [
                                { text: '10. Detalhamento Completo das RNCs', style: 'indexItem', border: [false, false, false, false] },
                                { text: '10', style: 'indexPage', border: [false, false, false, false] }
                            ]
                        ]
                    },
                    layout: 'noBorders',
                    margin: [0, 0, 0, 30]
                },

                { text: '', pageBreak: 'after' },

                // === KPIs EXECUTIVOS (LINHA 1) ===
                { text: '1. KPIs ESTRAT√âGICOS', style: 'sectionTitle', margin: [0, 0, 0, 20] },

                {
                    columns: [
                        {
                            stack: [
                                { text: 'Total de RNCs', style: 'kpiLabel' },
                                { text: `${stats.total || 0}`, style: 'kpiValue' }
                            ],
                            width: '25%'
                        },
                        {
                            stack: [
                                { text: 'Custo Total', style: 'kpiLabel' },
                                { text: `R$ ${(stats.custoTotal || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, style: 'kpiValue' }
                            ],
                            width: '25%'
                        },
                        {
                            stack: [
                                { text: 'Custo M√©dio/RNC', style: 'kpiLabel' },
                                { text: `R$ ${(stats.custoMedioPorRnc || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, style: 'kpiValue' }
                            ],
                            width: '25%'
                        },
                        {
                            stack: [
                                { text: 'Taxa Efetividade', style: 'kpiLabel' },
                                { text: `${stats.taxaEfetividade || 0}%`, style: 'kpiValue' }
                            ],
                            width: '25%'
                        }
                    ],
                    margin: [0, 0, 0, 15]
                },

                // === KPIs EXECUTIVOS (LINHA 2) ===
                {
                    columns: [
                        {
                            stack: [
                                { text: 'Cumprimento Prazo', style: 'kpiLabel' },
                                { text: `${stats.taxaCumprimentoPrazo || 0}%`, style: 'kpiValue' }
                            ],
                            width: '25%'
                        },
                        {
                            stack: [
                                { text: 'Tempo M√©dio Resolu√ß√£o', style: 'kpiLabel' },
                                { text: `${stats.tempoMedioResolucao || 0} dias`, style: 'kpiValue' }
                            ],
                            width: '25%'
                        },
                        {
                            stack: [
                                { text: 'RNCs Vencidas', style: 'kpiLabel' },
                                { text: `${stats.rncsVencidas || 0}`, style: 'kpiValue' }
                            ],
                            width: '25%'
                        },
                        {
                            stack: [
                                { text: 'Tend√™ncia Mensal', style: 'kpiLabel' },
                                { text: `${stats.tendenciaCrescimento >= 0 ? '+' : ''}${stats.tendenciaCrescimento || 0}%`, style: 'kpiValue', color: stats.tendenciaCrescimento >= 0 ? '#F44336' : '#4CAF50' }
                            ],
                            width: '25%'
                        }
                    ],
                    margin: [0, 0, 0, 30]
                },

                // === DISTRIBUI√á√ÉO POR TIPO ===
                { text: '2. DISTRIBUI√á√ÉO DAS RNCs', style: 'sectionTitle', margin: [0, 20, 0, 15] },

                {
                    table: {
                        headerRows: 1,
                        widths: ['*', 100, 80],
                        body: [
                            [
                                { text: 'Tipo de RNC', style: 'tableHeader' },
                                { text: 'Quantidade', style: 'tableHeader', alignment: 'center' },
                                { text: 'Percentual', style: 'tableHeader', alignment: 'center' }
                            ],
                            ...Object.entries(stats.porTipo || {}).map(([tipo, qtd]) => [
                                tipo,
                                { text: qtd, alignment: 'center' },
                                { text: `${((qtd / stats.total) * 100).toFixed(1)}%`, alignment: 'center' }
                            ])
                        ]
                    },
                    layout: {
                        fillColor: function(rowIndex) {
                            return rowIndex === 0 ? '#284179' : (rowIndex % 2 === 0 ? '#f5f5f5' : null);
                        },
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; },
                        hLineColor: function() { return '#ddd'; },
                        vLineColor: function() { return '#ddd'; }
                    },
                    margin: [0, 0, 0, 20]
                },

                // ‚úÖ DEPLOY 102: Gr√°fico de Distribui√ß√£o por Tipo
                ...(chartTipo ? [{
                    image: chartTipo,
                    width: 450,
                    alignment: 'center',
                    margin: [0, 10, 0, 30]
                }] : []),

                // === AN√ÅLISE POR RISCO ===
                { text: '2.1. AN√ÅLISE POR N√çVEL DE RISCO', style: 'sectionTitle', margin: [0, 20, 0, 15] },

                {
                    table: {
                        headerRows: 1,
                        widths: ['*', 100, 80],
                        body: [
                            [
                                { text: 'N√≠vel de Risco', style: 'tableHeader' },
                                { text: 'Quantidade', style: 'tableHeader', alignment: 'center' },
                                { text: 'Percentual', style: 'tableHeader', alignment: 'center' }
                            ],
                            ...Object.entries(stats.porRisco || {}).map(([risco, qtd]) => [
                                risco,
                                { text: qtd, alignment: 'center' },
                                { text: `${((qtd / stats.total) * 100).toFixed(1)}%`, alignment: 'center' }
                            ])
                        ]
                    },
                    layout: {
                        fillColor: function(rowIndex) {
                            return rowIndex === 0 ? '#284179' : (rowIndex % 2 === 0 ? '#f5f5f5' : null);
                        },
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; },
                        hLineColor: function() { return '#ddd'; },
                        vLineColor: function() { return '#ddd'; }
                    },
                    margin: [0, 0, 0, 30]
                },

                // ‚úÖ DEPLOY 102: Gr√°fico de An√°lise por Risco
                ...(chartRisco ? [{
                    image: chartRisco,
                    width: 450,
                    alignment: 'center',
                    margin: [0, 10, 0, 30]
                }] : []),

                // === AN√ÅLISE POR SETOR ===
                { text: '2.2. DISTRIBUI√á√ÉO POR SETOR', style: 'sectionTitle', margin: [0, 30, 0, 15] },

                {
                    table: {
                        headerRows: 1,
                        widths: ['*', 100, 80],
                        body: [
                            [
                                { text: 'Setor', style: 'tableHeader' },
                                { text: 'Quantidade', style: 'tableHeader', alignment: 'center' },
                                { text: 'Percentual', style: 'tableHeader', alignment: 'center' }
                            ],
                            ...Object.entries(stats.porSetor || stats.porSetorAbertura || {}).slice(0, 10).map(([setor, qtd]) => [
                                setor,
                                { text: qtd, alignment: 'center' },
                                { text: `${((qtd / stats.total) * 100).toFixed(1)}%`, alignment: 'center' }
                            ])
                        ]
                    },
                    layout: {
                        fillColor: function(rowIndex) {
                            return rowIndex === 0 ? '#284179' : (rowIndex % 2 === 0 ? '#f5f5f5' : null);
                        },
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; },
                        hLineColor: function() { return '#ddd'; },
                        vLineColor: function() { return '#ddd'; }
                    },
                    margin: [0, 0, 0, 30]
                },

                // ‚úÖ DEPLOY 102: Gr√°fico de Barras - Distribui√ß√£o por Setor
                ...(chartSetorAbertura ? [{
                    image: chartSetorAbertura,
                    width: 480,
                    alignment: 'center',
                    margin: [0, 10, 0, 20]
                }] : []),

                { text: '', pageBreak: 'after' },

                // === TOP 5 RNCs MAIS CUSTOSAS ===
                { text: '3. TOP 5 RNCs MAIS CUSTOSAS', style: 'sectionTitle', margin: [0, 0, 0, 15] },

                {
                    table: {
                        headerRows: 1,
                        widths: [60, '*', '*', 80],
                        body: [
                            [
                                { text: 'N¬∫ RNC', style: 'tableHeader' },
                                { text: 'Setor Abertura', style: 'tableHeader' },
                                { text: 'Setor RNC', style: 'tableHeader' },
                                { text: 'Valor (R$)', style: 'tableHeader', alignment: 'right' }
                            ],
                            ...rncs
                                .sort((a, b) => (parseFloat(b['Valor'] || 0)) - (parseFloat(a['Valor'] || 0)))
                                .slice(0, 5)
                                .map((rnc, index) => {
                                    const setorAbertura = rnc['Setor onde foi feita abertura'] ||
                                                         rnc['Setor onde foi feita abertura\n'] ||
                                                         rnc['Setor Abertura'] ||
                                                         rnc['Setor de Abertura'] ||
                                                         'N√£o informado';
                                    const setorRnc = rnc['Setor onde ocorreu a n√£o conformidade'] ||
                                                    rnc['Setor RNC'] ||
                                                    rnc['Setor'] ||
                                                    'N√£o informado';
                                    const numeroRaw = rnc['N√∫mero da RNC'] || rnc['N√∫mero RNC'] || rnc['N¬∫ RNC'] || rnc['ID'] || (index + 1);
                                    const numero = numeroRaw.toString().includes('/') ? numeroRaw : `${numeroRaw}/${new Date().getFullYear()}`;
                                    const valor = parseFloat(rnc['Valor'] || 0);
                                    return [
                                        { text: numero, fontSize: 9 },
                                        { text: setorAbertura, fontSize: 9 },
                                        { text: setorRnc, fontSize: 9 },
                                        { text: valor.toFixed(2), alignment: 'right', fontSize: 10, bold: true, color: '#F44336' }
                                    ];
                                })
                        ]
                    },
                    layout: {
                        fillColor: function(rowIndex) {
                            return rowIndex === 0 ? '#284179' : (rowIndex % 2 === 0 ? '#f5f5f5' : null);
                        },
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; },
                        hLineColor: function() { return '#ddd'; },
                        vLineColor: function() { return '#ddd'; }
                    },
                    margin: [0, 0, 0, 30]
                },

                // ‚úÖ DEPLOY 103 - OP√á√ÉO A: Gr√°fico TOP 5 Mais Custosas
                ...(chartTop5 ? [{
                    image: chartTop5,
                    width: 480,
                    alignment: 'center',
                    margin: [0, 10, 0, 30]
                }] : []),

                // === AN√ÅLISE DE TEND√äNCIAS TEMPORAIS ===
                { text: '4. AN√ÅLISE DE TEND√äNCIAS TEMPORAIS', style: 'sectionTitle', margin: [0, 20, 0, 15] },

                {
                    table: {
                        widths: ['*'],
                        body: [
                            [
                                {
                                    stack: [
                                        { text: 'Evolu√ß√£o Mensal', bold: true, fontSize: 11, margin: [0, 5, 0, 5] },
                                        {
                                            text: stats.tendenciaCrescimento >= 0
                                                ? `As RNCs apresentam tend√™ncia de CRESCIMENTO de ${stats.tendenciaCrescimento}% em rela√ß√£o ao per√≠odo anterior. Este aumento requer aten√ß√£o imediata da gest√£o.`
                                                : `As RNCs apresentam tend√™ncia de REDU√á√ÉO de ${Math.abs(stats.tendenciaCrescimento)}% em rela√ß√£o ao per√≠odo anterior. As a√ß√µes implementadas est√£o surtindo efeito positivo.`,
                                            fontSize: 9,
                                            color: stats.tendenciaCrescimento >= 0 ? '#F44336' : '#4CAF50',
                                            margin: [0, 0, 0, 10]
                                        },
                                        { text: 'Sazonalidade', bold: true, fontSize: 11, margin: [0, 10, 0, 5] },
                                        {
                                            text: stats.esteMes > stats.mesAnterior
                                                ? `M√™s atual (${stats.esteMes} RNCs) apresenta volume ${Math.round(((stats.esteMes - stats.mesAnterior) / stats.mesAnterior) * 100)}% superior ao m√™s anterior (${stats.mesAnterior} RNCs). Investigar causas do aumento.`
                                                : `M√™s atual (${stats.esteMes} RNCs) apresenta redu√ß√£o em rela√ß√£o ao m√™s anterior (${stats.mesAnterior} RNCs). Tend√™ncia positiva.`,
                                            fontSize: 9,
                                            color: '#666',
                                            margin: [0, 0, 0, 10]
                                        },
                                        { text: 'Velocidade de Resolu√ß√£o', bold: true, fontSize: 11, margin: [0, 10, 0, 5] },
                                        {
                                            text: `O tempo m√©dio de resolu√ß√£o √© de ${stats.tempoMedioResolucao || 0} dias. ${
                                                stats.tempoMedioResolucao > 30
                                                    ? 'ALERTA: Tempo acima do ideal (30 dias). Reavaliar processos e recursos alocados.'
                                                    : stats.tempoMedioResolucao > 15
                                                        ? 'Tempo dentro da m√©dia aceit√°vel, mas h√° margem para otimiza√ß√£o.'
                                                        : 'Excelente performance. Processos eficientes de tratativa.'
                                            }`,
                                            fontSize: 9,
                                            color: stats.tempoMedioResolucao > 30 ? '#F44336' : (stats.tempoMedioResolucao > 15 ? '#FF9800' : '#4CAF50')
                                        }
                                    ],
                                    margin: [10, 10, 10, 10]
                                }
                            ]
                        ]
                    },
                    layout: {
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; },
                        hLineColor: function() { return '#284179'; },
                        vLineColor: function() { return '#284179'; }
                    },
                    margin: [0, 0, 0, 20]
                },

                // ‚úÖ DEPLOY 103 - OP√á√ÉO A: Gr√°fico de Linha - Timeline
                ...(chartTimeline ? [{
                    image: chartTimeline,
                    width: 500,
                    alignment: 'center',
                    margin: [0, 10, 0, 30]
                }] : []),

                // === AN√ÅLISE DE IMPACTO FINANCEIRO ===
                { text: '5. AN√ÅLISE DE IMPACTO FINANCEIRO', style: 'sectionTitle', margin: [0, 20, 0, 15] },

                {
                    table: {
                        widths: ['*'],
                        body: [
                            [
                                {
                                    stack: [
                                        { text: 'Custo Total Acumulado', bold: true, fontSize: 11, margin: [0, 5, 0, 5] },
                                        {
                                            text: `R$ ${(stats.custoTotal || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})} em n√£o conformidades no per√≠odo analisado. ${
                                                stats.custoTotal > 100000
                                                    ? 'CR√çTICO: Impacto financeiro elevado. Priorizar a√ß√µes preventivas e corretivas.'
                                                    : stats.custoTotal > 50000
                                                        ? 'MODERADO: Monitorar evolu√ß√£o e implementar melhorias de processo.'
                                                        : 'CONTROLADO: Custos dentro da faixa aceit√°vel.'
                                            }`,
                                            fontSize: 9,
                                            color: stats.custoTotal > 100000 ? '#F44336' : (stats.custoTotal > 50000 ? '#FF9800' : '#4CAF50'),
                                            margin: [0, 0, 0, 10]
                                        },
                                        { text: 'Custo M√©dio por RNC', bold: true, fontSize: 11, margin: [0, 10, 0, 5] },
                                        {
                                            text: `R$ ${(stats.custoMedioPorRnc || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})} por n√£o conformidade. ${
                                                stats.custoMedioPorRnc > 5000
                                                    ? 'ALTO: RNCs com impacto financeiro significativo. Revisar processos cr√≠ticos.'
                                                    : stats.custoMedioPorRnc > 1000
                                                        ? 'M√âDIO: Custos relevantes que justificam investimento em preven√ß√£o.'
                                                        : 'BAIXO: Custos unit√°rios controlados.'
                                            }`,
                                            fontSize: 9,
                                            color: stats.custoMedioPorRnc > 5000 ? '#F44336' : (stats.custoMedioPorRnc > 1000 ? '#FF9800' : '#4CAF50'),
                                            margin: [0, 0, 0, 10]
                                        },
                                        { text: 'ROI de A√ß√µes Preventivas', bold: true, fontSize: 11, margin: [0, 10, 0, 5] },
                                        {
                                            text: `Investir em preven√ß√£o pode reduzir custos em at√© 70%. Com o custo m√©dio de R$ ${(stats.custoMedioPorRnc || 0).toFixed(2)}, cada RNC evitada gera economia significativa.`,
                                            fontSize: 9,
                                            color: '#666'
                                        }
                                    ],
                                    margin: [10, 10, 10, 10]
                                }
                            ]
                        ]
                    },
                    layout: {
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; },
                        hLineColor: function() { return '#284179'; },
                        vLineColor: function() { return '#284179'; }
                    },
                    margin: [0, 0, 0, 20]
                },

                // ‚úÖ DEPLOY 103 - OP√á√ÉO A: Gr√°fico Impacto Financeiro
                ...(chartImpactoFinanceiro ? [{
                    image: chartImpactoFinanceiro,
                    width: 480,
                    alignment: 'center',
                    margin: [0, 10, 0, 20]
                }] : []),

                // ‚úÖ DEPLOY 101: Page break antes da se√ß√£o de Criticidade
                { text: '', pageBreak: 'after' },

                // === AN√ÅLISE POR CRITICIDADE ===
                { text: '6. AN√ÅLISE POR N√çVEL DE CRITICIDADE', style: 'sectionTitle', margin: [0, 20, 0, 15] },

                {
                    table: {
                        widths: ['*'],
                        body: [
                            [
                                {
                                    stack: [
                                        { text: 'Setor Mais Cr√≠tico', bold: true, fontSize: 11, margin: [0, 5, 0, 5] },
                                        {
                                            text: `${stats.setorMaisCritico || 'N/A'} - Setor identificado com maior volume ou impacto de n√£o conformidades. Requer plano de a√ß√£o imediato com an√°lise de causa raiz.`,
                                            fontSize: 9,
                                            color: '#F44336',
                                            margin: [0, 0, 0, 10]
                                        },
                                        { text: 'Distribui√ß√£o de Riscos', bold: true, fontSize: 11, margin: [0, 10, 0, 5] },
                                        {
                                            ul: Object.entries(stats.porRisco || {}).map(([risco, qtd]) =>
                                                `${risco}: ${qtd} RNCs (${((qtd / stats.total) * 100).toFixed(1)}%)`
                                            ),
                                            fontSize: 9,
                                            color: '#666',
                                            margin: [0, 0, 0, 10]
                                        },
                                        { text: 'Taxa de Efetividade', bold: true, fontSize: 11, margin: [0, 10, 0, 5] },
                                        {
                                            text: `${stats.taxaEfetividade || 0}% das RNCs foram finalizadas com a√ß√µes efetivas. ${
                                                stats.taxaEfetividade < 70
                                                    ? 'CR√çTICO: Taxa abaixo do ideal (>80%). Revisar qualidade das a√ß√µes corretivas.'
                                                    : stats.taxaEfetividade < 90
                                                        ? 'ATEN√á√ÉO: Performance aceit√°vel, mas h√° espa√ßo para melhorias.'
                                                        : 'EXCELENTE: Alta efetividade das a√ß√µes implementadas.'
                                            }`,
                                            fontSize: 9,
                                            color: stats.taxaEfetividade < 70 ? '#F44336' : (stats.taxaEfetividade < 90 ? '#FF9800' : '#4CAF50')
                                        }
                                    ],
                                    margin: [10, 10, 10, 10]
                                }
                            ]
                        ]
                    },
                    layout: {
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; },
                        hLineColor: function() { return '#284179'; },
                        vLineColor: function() { return '#284179'; }
                    },
                    margin: [0, 0, 0, 20]
                },

                { text: '', pageBreak: 'after' },

                // === CONCLUS√ÉO PREDITIVA ===
                { text: '7. CONCLUS√ÉO PREDITIVA', style: 'sectionTitle', margin: [0, 0, 0, 15] },

                {
                    table: {
                        widths: ['*'],
                        body: [
                            [
                                {
                                    stack: [
                                        { text: 'Proje√ß√£o para Pr√≥ximos 3 Meses', bold: true, fontSize: 12, margin: [0, 5, 0, 10] },
                                        {
                                            text: stats.tendenciaCrescimento >= 0
                                                ? `Baseado na tend√™ncia atual de +${stats.tendenciaCrescimento}% ao m√™s, estima-se um acr√©scimo de ${Math.round(stats.esteMes * (1 + stats.tendenciaCrescimento/100) * 3)} RNCs nos pr√≥ximos 3 meses, com custo projetado de R$ ${(stats.custoMedioPorRnc * stats.esteMes * (1 + stats.tendenciaCrescimento/100) * 3).toLocaleString('pt-BR', {minimumFractionDigits: 2})}.`
                                                : `Com a tend√™ncia de redu√ß√£o de ${Math.abs(stats.tendenciaCrescimento)}% ao m√™s, projeta-se uma diminui√ß√£o sustent√°vel se as a√ß√µes preventivas forem mantidas.`,
                                            fontSize: 10,
                                            color: stats.tendenciaCrescimento >= 0 ? '#F44336' : '#4CAF50',
                                            margin: [0, 0, 0, 15]
                                        },
                                        { text: 'Padr√µes Identificados', bold: true, fontSize: 12, margin: [0, 10, 0, 10] },
                                        {
                                            ul: [
                                                `Setor ${stats.setorMaisCritico || 'N/A'} concentra maior volume de RNCs - requer capacita√ß√£o espec√≠fica`,
                                                `Tipo de RNC predominante: ${Object.entries(stats.porTipo || {}).sort((a,b) => b[1] - a[1])[0]?.[0] || 'N/A'} - investigar causa raiz sist√™mica`,
                                                `${stats.rncsVencidas || 0} RNCs vencidas pendentes - risco de reincid√™ncia e agravamento`,
                                                `Tempo m√©dio de ${stats.tempoMedioResolucao || 0} dias indica ${stats.tempoMedioResolucao > 30 ? 'sobrecarga operacional' : 'processo adequado'}`,
                                                `Taxa de cumprimento de ${stats.taxaCumprimentoPrazo || 0}% ${stats.taxaCumprimentoPrazo < 80 ? 'requer aten√ß√£o urgente' : 'dentro do esperado'}`
                                            ],
                                            fontSize: 10,
                                            color: '#333',
                                            margin: [0, 0, 0, 15]
                                        },
                                        { text: 'Alertas Estrat√©gicos', bold: true, fontSize: 12, margin: [0, 10, 0, 10] },
                                        {
                                            ul: [
                                                stats.custoTotal > 100000 ? 'üî¥ CR√çTICO: Impacto financeiro >R$ 100k - Reuni√£o emergencial recomendada' : null,
                                                stats.tendenciaCrescimento > 20 ? 'üî¥ CR√çTICO: Crescimento >20% - Interven√ß√£o imediata necess√°ria' : null,
                                                stats.rncsVencidas > 5 ? `‚ö†Ô∏è ATEN√á√ÉO: ${stats.rncsVencidas} RNCs vencidas podem gerar passivos` : null,
                                                stats.taxaCumprimentoPrazo < 70 ? '‚ö†Ô∏è ATEN√á√ÉO: Baixa taxa de cumprimento - revisar capacidade da equipe' : null,
                                                stats.tempoMedioResolucao > 45 ? '‚ö†Ô∏è ATEN√á√ÉO: Tempo m√©dio >45 dias - processo ineficiente' : null,
                                                '‚úÖ Oportunidade: Implementar sistema de automa√ß√£o para reduzir tempo de tratativa em 40%',
                                                '‚úÖ Oportunidade: Treinamento preventivo pode reduzir incid√™ncia em at√© 60%'
                                            ].filter(Boolean),
                                            fontSize: 10,
                                            color: '#333'
                                        }
                                    ],
                                    margin: [10, 10, 10, 10]
                                }
                            ]
                        ]
                    },
                    layout: {
                        fillColor: '#FFF8E1',
                        hLineWidth: function() { return 1; },
                        vLineWidth: function() { return 1; },
                        hLineColor: function() { return '#FF9800'; },
                        vLineColor: function() { return '#FF9800'; }
                    },
                    margin: [0, 0, 0, 25]
                },

                // ‚úÖ DEPLOY 101: Page break antes das Recomenda√ß√µes Estrat√©gicas
                { text: '', pageBreak: 'after' },

                // === RECOMENDA√á√ïES ESTRAT√âGICAS ===
                { text: '8. RECOMENDA√á√ïES ESTRAT√âGICAS PARA A DIRETORIA', style: 'sectionTitle', margin: [0, 20, 0, 15] },

                {
                    table: {
                        headerRows: 1,
                        widths: [60, 120, '*', 80],
                        body: [
                            [
                                { text: 'Prioridade', style: 'tableHeader' },
                                { text: '√Årea de Atua√ß√£o', style: 'tableHeader' },
                                { text: 'Recomenda√ß√£o', style: 'tableHeader' },
                                { text: 'Impacto Esperado', style: 'tableHeader' }
                            ],
                            [
                                { text: 'CR√çTICA', fontSize: 10, bold: true, color: '#F44336' },
                                { text: 'Preven√ß√£o', fontSize: 9 },
                                { text: `Implementar programa de treinamento mensal no setor ${stats.setorMaisCritico || 'cr√≠tico'} sobre boas pr√°ticas e qualidade`, fontSize: 9 },
                                { text: 'Redu√ß√£o de 40-60% em 6 meses', fontSize: 9, color: '#4CAF50' }
                            ],
                            [
                                { text: 'CR√çTICA', fontSize: 10, bold: true, color: '#F44336' },
                                { text: 'Processos', fontSize: 9 },
                                { text: 'Revisar e documentar processos cr√≠ticos que geram maior volume de RNCs. Criar checklists preventivos.', fontSize: 9 },
                                { text: 'Redu√ß√£o de 30-50% em 3-4 meses', fontSize: 9, color: '#4CAF50' }
                            ],
                            [
                                { text: 'ALTA', fontSize: 10, bold: true, color: '#FF9800' },
                                { text: 'Gest√£o Financeira', fontSize: 9 },
                                { text: `Criar provis√£o or√ßament√°ria para custos de n√£o conformidade: R$ ${(stats.custoMedioPorRnc * stats.esteMes * 12).toLocaleString('pt-BR', {minimumFractionDigits: 2})}/ano`, fontSize: 9 },
                                { text: 'Controle financeiro proativo', fontSize: 9, color: '#284179' }
                            ],
                            [
                                { text: 'ALTA', fontSize: 10, bold: true, color: '#FF9800' },
                                { text: 'Tecnologia', fontSize: 9 },
                                { text: 'Investir em sistema de automa√ß√£o e workflows para agilizar tratativas e reduzir tempo m√©dio', fontSize: 9 },
                                { text: 'Redu√ß√£o de 40% no tempo de resolu√ß√£o', fontSize: 9, color: '#4CAF50' }
                            ],
                            [
                                { text: 'M√âDIA', fontSize: 10, bold: true, color: '#284179' },
                                { text: 'Indicadores', fontSize: 9 },
                                { text: 'Estabelecer metas trimestrais: Taxa efetividade >90%, Cumprimento prazo >85%, Custo m√©dio <R$ 1.000', fontSize: 9 },
                                { text: 'Melhoria cont√≠nua mensur√°vel', fontSize: 9, color: '#284179' }
                            ],
                            [
                                { text: 'M√âDIA', fontSize: 10, bold: true, color: '#284179' },
                                { text: 'Cultura', fontSize: 9 },
                                { text: 'Implementar programa de reconhecimento para setores com redu√ß√£o significativa de RNCs', fontSize: 9 },
                                { text: 'Engajamento e motiva√ß√£o', fontSize: 9, color: '#4CAF50' }
                            ]
                        ]
                    },
                    layout: {
                        fillColor: function(rowIndex) {
                            return rowIndex === 0 ? '#284179' : (rowIndex % 2 === 0 ? '#f5f5f5' : null);
                        },
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; },
                        hLineColor: function() { return '#ddd'; },
                        vLineColor: function() { return '#ddd'; }
                    },
                    margin: [0, 0, 0, 25]
                },

                // ‚úÖ DEPLOY 101: Page break antes dos Investimentos Sugeridos
                { text: '', pageBreak: 'after' },

                // === INVESTIMENTOS SUGERIDOS ===
                { text: '9. INVESTIMENTOS SUGERIDOS', style: 'sectionTitle', margin: [0, 15, 0, 15] },

                {
                    table: {
                        headerRows: 1,
                        widths: ['*', 100, 100],
                        body: [
                            [
                                { text: 'Investimento', style: 'tableHeader' },
                                { text: 'Valor Estimado', style: 'tableHeader', alignment: 'right' },
                                { text: 'ROI Esperado', style: 'tableHeader', alignment: 'center' }
                            ],
                            [
                                { text: 'Sistema de Gest√£o de Qualidade (Software)', fontSize: 9 },
                                { text: 'R$ 15.000', fontSize: 9, alignment: 'right' },
                                { text: '300% em 12 meses', fontSize: 9, alignment: 'center', color: '#4CAF50', bold: true }
                            ],
                            [
                                { text: 'Programa de Treinamento Anual (Equipe completa)', fontSize: 9 },
                                { text: 'R$ 8.000', fontSize: 9, alignment: 'right' },
                                { text: '250% em 6 meses', fontSize: 9, alignment: 'center', color: '#4CAF50', bold: true }
                            ],
                            [
                                { text: 'Consultoria em Processos (3 meses)', fontSize: 9 },
                                { text: 'R$ 12.000', fontSize: 9, alignment: 'right' },
                                { text: '200% em 9 meses', fontSize: 9, alignment: 'center', color: '#4CAF50', bold: true }
                            ],
                            [
                                { text: 'Auditoria Externa de Qualidade', fontSize: 9 },
                                { text: 'R$ 5.000', fontSize: 9, alignment: 'right' },
                                { text: 'Redu√ß√£o de riscos', fontSize: 9, alignment: 'center', color: '#284179' }
                            ],
                            [
                                { text: 'TOTAL INVESTIMENTO', fontSize: 10, bold: true },
                                { text: 'R$ 40.000', fontSize: 10, alignment: 'right', bold: true },
                                { text: `Economia: R$ ${(stats.custoTotal * 0.6).toLocaleString('pt-BR', {minimumFractionDigits: 2})}/ano`, fontSize: 9, alignment: 'center', color: '#4CAF50', bold: true }
                            ]
                        ]
                    },
                    layout: {
                        fillColor: function(rowIndex, node) {
                            if (rowIndex === 0) return '#009688';
                            if (rowIndex === node.table.body.length - 1) return '#E3F2FD';
                            return rowIndex % 2 === 0 ? '#f5f5f5' : null;
                        },
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; },
                        hLineColor: function() { return '#ddd'; },
                        vLineColor: function() { return '#ddd'; }
                    },
                    margin: [0, 0, 0, 20]
                },

                { text: '', pageBreak: 'after' },

                // === LISTAGEM DETALHADA ===
                { text: '10. DETALHAMENTO COMPLETO DAS RNCs', style: 'sectionTitle', margin: [0, 0, 0, 15] },

                {
                    table: {
                        headerRows: 1,
                        widths: [50, 85, 85, 60, 45, 55],
                        body: [
                            [
                                { text: 'N¬∫ RNC', style: 'tableHeader' },
                                { text: 'Setor Abertura', style: 'tableHeader' },
                                { text: 'Setor RNC', style: 'tableHeader' },
                                { text: 'Tipo', style: 'tableHeader' },
                                { text: 'Risco', style: 'tableHeader' },
                                { text: 'Valor (R$)', style: 'tableHeader', alignment: 'right' }
                            ],
                            ...rncs.slice(0, 50).map((rnc, index) => {
                                const setorAbertura = rnc['Setor onde foi feita abertura'] ||
                                                     rnc['Setor onde foi feita abertura\n'] ||
                                                     rnc['Setor Abertura'] ||
                                                     rnc['Setor de Abertura'] ||
                                                     'N√£o informado';
                                const setorRnc = rnc['Setor onde ocorreu a n√£o conformidade'] ||
                                                rnc['Setor RNC'] ||
                                                rnc['Setor'] ||
                                                'N√£o informado';
                                const numeroRaw = rnc['N√∫mero da RNC'] || rnc['N√∫mero RNC'] || rnc['N¬∫ RNC'] || rnc['ID'] || (index + 1);
                                const numero = numeroRaw.toString().includes('/') ? numeroRaw : `${numeroRaw}/${new Date().getFullYear()}`;
                                const tipo = rnc['Tipo da RNC'] || rnc['Tipo RNC'] || rnc['Tipo'] || 'N√£o informado';
                                const risco = rnc['Risco'] || rnc['N√≠vel de Risco'] || 'Baixo';
                                const valor = parseFloat(rnc['Valor'] || rnc['Custo'] || rnc['Valor (R$)'] || 0);

                                return [
                                    { text: numero, fontSize: 8 },
                                    { text: setorAbertura, fontSize: 8 },
                                    { text: setorRnc, fontSize: 8 },
                                    { text: tipo, fontSize: 8 },
                                    { text: risco, fontSize: 8 },
                                    { text: valor.toFixed(2), alignment: 'right', fontSize: 8 }
                                ];
                            })
                        ]
                    },
                    layout: {
                        fillColor: function(rowIndex) {
                            return rowIndex === 0 ? '#284179' : (rowIndex % 2 === 0 ? '#f5f5f5' : null);
                        },
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; },
                        hLineColor: function() { return '#ddd'; },
                        vLineColor: function() { return '#ddd'; }
                    },
                    fontSize: 9
                }
            ],

            // === ESTILOS ===
            styles: {
                // Header/Footer
                headerLeft: {
                    fontSize: 10,
                    bold: true,
                    color: '#284179'
                },
                headerRight: {
                    fontSize: 9,
                    alignment: 'right',
                    color: '#666'
                },
                footer: {
                    fontSize: 8,
                    color: '#666'
                },

                // Capa
                coverTitle: {
                    fontSize: 32,
                    bold: true,
                    color: '#284179',
                    alignment: 'center'
                },
                coverSubtitle: {
                    fontSize: 16,
                    color: '#666',
                    alignment: 'center'
                },

                // Informa√ß√µes
                infoLabel: {
                    fontSize: 11,
                    bold: true,
                    color: '#333'
                },
                infoValue: {
                    fontSize: 11,
                    color: '#666'
                },

                // Se√ß√µes
                sectionTitle: {
                    fontSize: 16,
                    bold: true,
                    color: '#284179'
                },

                // √çndice
                indexItem: {
                    fontSize: 11,
                    color: '#333',
                    lineHeight: 1.6,
                    margin: [0, 3, 0, 3]
                },
                indexSubItem: {
                    fontSize: 10,
                    color: '#666',
                    lineHeight: 1.5,
                    margin: [0, 2, 0, 2]
                },
                indexPage: {
                    fontSize: 11,
                    color: '#284179',
                    bold: true,
                    alignment: 'right',
                    margin: [0, 3, 0, 3]
                },

                // KPIs
                kpiLabel: {
                    fontSize: 10,
                    color: '#666',
                    margin: [0, 0, 0, 5]
                },
                kpiValue: {
                    fontSize: 24,
                    bold: true,
                    color: '#284179'
                },

                // Tabelas
                tableHeader: {
                    fontSize: 11,
                    bold: true,
                    color: '#ffffff',
                    fillColor: '#284179'
                }
            },

            defaultStyle: {
                font: 'Roboto',
                fontSize: 10,
                color: '#333'
            }
        };

        // === GERAR E BAIXAR PDF COM PDFMAKE ===
        const filename = `relatorio_gerencial_rnc_${new Date().toISOString().split('T')[0]}.pdf`;
        pdfMake.createPdf(docDefinition).download(filename);

        hideLoading();
        showSuccess(`PDF Executivo exportado com sucesso!`);
        debugLog('success', `PDF Executivo gerado com pdfmake - ${rncs.length} RNCs`);
    } catch (error) {
        hideLoading();
        debugLog('error', 'Erro ao exportar PDF v2.3', { error: error.message });
        showError('Erro ao exportar PDF: ' + error.message);
    }
}

function clearFilters() {
            document.getElementById('dataInicio').value = '';
            document.getElementById('dataFim').value = '';
            document.getElementById('setorFiltro').value = 'Todos';
            document.getElementById('tipoFiltro').value = 'Todos';
            document.getElementById('statusFiltro').value = 'Todos';

            document.getElementById('report-content').innerHTML = '';
            document.getElementById('exportPdf').disabled = true;
            reportData = null;

            debugLog('info', 'üßπ Filtros limpos Deploy 72.3');
        }
        
        // === CONFIGURA√á√ïES RESTAURADAS COM ABAS (Deploy 72.3) ===
        async function loadConfigurations() {
    try {
        debugLog('info', '‚öôÔ∏è Carregando configura√ß√µes Deploy 32');
        
        // Carregar configura√ß√µes do sistema
        if (appContext && appContext.systemConfig) {
            document.getElementById('pastaGID').value = appContext.systemConfig.pastaGID || '';
            document.getElementById('renomearArquivos').value = appContext.systemConfig.renomearArquivos ? 'Sim' : 'N√£o';
        }
        
        // Carregar listas, se√ß√µes, campos e ‚ú® USU√ÅRIOS
        await loadLists();
        await loadSections();
        await loadFields();
        await loadUsers(); // ‚ú® NOVO
        
        debugLog('success', '‚úÖ Configura√ß√µes carregadas Deploy 32');
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar configura√ß√µes', { error: error.message });
        showError('Erro ao carregar configura√ß√µes: ' + error.message);
    }
}
        
        async function saveSystemConfig() {
            try {
                debugLog('info', 'üíæ Salvando configura√ß√µes do sistema Deploy 72.3');
                
                const pastaGID = document.getElementById('pastaGID').value;
                const renomearArquivos = document.getElementById('renomearArquivos').value;
                
                showLoading('Salvando configura√ß√µes...');
                
                await apiCall('setSystemConfig', ['PastaGID', pastaGID, 'ID da pasta do Google Drive para anexos']);
                await apiCall('setSystemConfig', ['RenomearArquivos', renomearArquivos, 'Renomear arquivos anexados']);

                hideLoading();

                // Deploy 124: Modal de sucesso
                await showConfigSuccessModal(
                    'Configura√ß√µes Salvas',
                    `<strong>Pasta GID:</strong> ${pastaGID}<br>
                     <strong>Renomear Arquivos:</strong> ${renomearArquivos}`
                );

                debugLog('success', '‚úÖ Configura√ß√µes do sistema salvas Deploy 72.3');

            } catch (error) {
                debugLog('error', '‚ùå Erro ao salvar configura√ß√µes Deploy 72.3', { error: error.message });
                hideLoading();
                await showErrorModal('Erro ao Salvar Configura√ß√µes', error.message);
            }
        }
        
        async function loadLists() {
            try {
                const lists = await apiCall('getLists');
                const container = document.getElementById('lists-container');
                
                let listsHtml = '';
                Object.keys(lists).forEach(listName => {
                    const items = lists[listName] || [];
                    listsHtml += `
                        <div class="config-item">
                            <div class="config-item-header">
                                <div class="config-item-title">üìã ${listName}</div>
                                <div class="config-item-actions">
                                    <button class="btn-edit" onclick="editList('${listName}')">‚úèÔ∏è Editar</button>
                                    <button class="btn-delete" onclick="deleteListConfirm('${listName}')">üóëÔ∏è Deletar</button>
                                </div>
                            </div>
                            <div class="config-item-meta">${items.length} itens</div>
                        </div>
                    `;
                });
                
                container.innerHTML = listsHtml;
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao carregar listas Deploy 72.3', { error: error.message });
            }
        }
        
        async function loadSections() {
            try {
                const sections = await apiCall('getSections');
                const container = document.getElementById('sections-container');
                
                let sectionsHtml = '';
                sections.forEach(section => {
                    sectionsHtml += `
                        <div class="config-item">
                            <div class="config-item-header">
                                <div class="config-item-title">üìÑ ${section.nome}</div>
                                <div class="config-item-actions">
                                    <button class="btn-edit" onclick="editSection('${section.nome}')">‚úèÔ∏è Editar</button>
                                    <button class="btn-delete" onclick="deleteSectionConfirm('${section.nome}')">üóëÔ∏è Deletar</button>
                                </div>
                            </div>
                            <div class="config-item-meta">Ordem: ${section.ordem}, Status: ${section.ativo}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = sectionsHtml;
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao carregar se√ß√µes Deploy 72.3', { error: error.message });
            }
        }
        
        async function loadFields() {
            try {
                const fields = await apiCall('getAllFieldsFromConfig');
                const container = document.getElementById('fields-container');
                
                let fieldsHtml = '';
                fields.forEach(field => {
                    fieldsHtml += `
                        <div class="config-item">
                            <div class="config-item-header">
                                <div class="config-item-title">üè∑Ô∏è ${field.campo}</div>
                                <div class="config-item-actions">
                                    <button class="btn-edit" onclick="editField('${field.secao}', '${field.campo}')">‚úèÔ∏è Editar</button>
                                    <button class="btn-delete" onclick="deleteFieldConfirm('${field.secao}', '${field.campo}')">üóëÔ∏è Deletar</button>
                                </div>
                            </div>
                            <div class="config-item-meta">${field.secao} ‚Ä¢ ${field.tipo} ‚Ä¢ ${field.obrigatorio}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = fieldsHtml;
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao carregar campos Deploy 72.3', { error: error.message });
            }
        }
        
        // Fun√ß√µes placeholder para configura√ß√µes (ser√£o implementadas em vers√£o futura)
function editList(listName) {
    debugLog('info', 'Editando lista', { listName: listName });
    
    // Obter valores atuais da lista
    var currentValues = appContext.lists[listName] || [];
    
    // Criar modal de edi√ß√£o de lista
    var modalHtml = `
        <div id="editListModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 1rem; color: #009688;">‚úèÔ∏è Editar Lista: ${listName}</h3>
                
                <div class="form-group">
                    <label>Itens da Lista:</label>
                    <div id="listItemsContainer" style="margin-top: 10px;">
                        ${currentValues.map(value => `
                            <div class="list-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="text" value="${value}" class="form-control list-value">
                                <button onclick="removeListItem(this)" class="btn btn-error" style="padding: 0.5rem;">üóëÔ∏è</button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addListItem()" class="btn btn-secondary" style="margin-top: 10px;">‚ûï Adicionar Item</button>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 20px;">
                    <button onclick="closeEditListModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="saveListChanges('${listName}')" class="btn btn-primary">üíæ Salvar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function addListItem() {
    var container = document.getElementById('listItemsContainer');
    var newItem = `
        <div class="list-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <input type="text" value="" class="form-control list-value" placeholder="Novo item">
            <button onclick="removeListItem(this)" class="btn btn-error" style="padding: 0.5rem;">üóëÔ∏è</button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', newItem);
}

function removeListItem(button) {
    button.parentElement.remove();
}

function closeEditListModal() {
    var modal = document.getElementById('editListModal');
    if (modal) modal.remove();
}

function saveListChanges(listName) {
    var newValues = [];
    document.querySelectorAll('.list-value').forEach(function(input) {
        if (input.value.trim()) {
            newValues.push(input.value.trim());
        }
    });
    
    showLoading('Salvando lista...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeEditListModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('updated', result.listName || listName, 2000);
                } else {
                    showSuccess('Lista atualizada com sucesso!');
                }
            } else {
                showError('Erro ao salvar lista');
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao salvar lista: ' + error);
            hideLoading();
        })
        .saveList(listName, newValues);
}

function deleteListConfirm(listName) {
    // Criar modal de confirma√ß√£o HTML customizado
    var modalHtml = `
        <div id="deleteListModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-bottom: 1.5rem; color: #F44336;">üóëÔ∏è Excluir Lista</h3>
                <div style="margin-bottom: 1.5rem;">
                    <p style="margin-bottom: 1rem;">
                        Tem certeza que deseja deletar a lista:
                    </p>
                    <p style="font-weight: 600; color: #009688; font-size: 16px;">
                        "${listName}"
                    </p>
                    <p style="margin-top: 1rem; color: #F44336; font-size: 14px;">
                        ‚ö†Ô∏è ATEN√á√ÉO: Isso pode afetar campos que usam esta lista!
                    </p>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeDeleteListModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="executeDeleteList('${listName}')" class="btn btn-danger">üóëÔ∏è Confirmar Exclus√£o</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Fun√ß√£o para fechar modal de deletar lista
function closeDeleteListModal() {
    var modal = document.getElementById('deleteListModal');
    if (modal) modal.remove();
}

// Fun√ß√£o para executar exclus√£o da lista
function executeDeleteList(listName) {
    var btnCancel = document.querySelector('#deleteListModal .btn-secondary');
    var btnConfirm = document.querySelector('#deleteListModal .btn-danger');
    btnCancel.disabled = true;
    btnConfirm.disabled = true;
    btnConfirm.innerHTML = '‚è≥ Excluindo...';
    
    showLoading('Deletando lista...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeDeleteListModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('deleted', result.listName || listName, 2000);
                } else {
                    showSuccess('Lista deletada com sucesso!');
                }
            } else {
                showError('Erro ao deletar lista');
                btnCancel.disabled = false;
                btnConfirm.disabled = false;
                btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao deletar lista: ' + error);
            btnCancel.disabled = false;
            btnConfirm.disabled = false;
            btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
            hideLoading();
        })
        .deleteList(listName);
}

// Adicionar nova lista
document.getElementById('addNewList').addEventListener('click', function() {
    // Criar modal HTML customizado
    var modalHtml = `
        <div id="newListModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-bottom: 1.5rem; color: #009688;">üìã Nova Lista</h3>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nome da nova lista:</label>
                    <input type="text" id="newListName" class="form-control" placeholder="Digite o nome da lista" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeNewListModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="createNewList()" class="btn btn-primary">‚úÖ Criar Lista</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Focar no campo de input
    setTimeout(() => {
        document.getElementById('newListName').focus();
    }, 100);
    
    // Permitir criar com Enter
    document.getElementById('newListName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            createNewList();
        }
    });
});

// Fun√ß√£o para fechar modal de nova lista
function closeNewListModal() {
    var modal = document.getElementById('newListModal');
    if (modal) modal.remove();
}

// Fun√ß√£o para criar nova lista
function createNewList() {
    var listName = document.getElementById('newListName').value.trim();
    
    if (!listName) {
        showError('Por favor, digite um nome para a lista!');
        return;
    }
    
    if (appContext.lists[listName]) {
        showError('Esta lista j√° existe!');
        return;
    }
    
    var btnCreate = document.querySelector('#newListModal .btn-primary');
    btnCreate.disabled = true;
    btnCreate.innerHTML = '‚è≥ Criando...';
    
    showLoading('Criando lista...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeNewListModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('created', result.listName || listName, 2000);
                } else {
                    showSuccess('Lista criada com sucesso!');
                }
            } else {
                showError('Erro ao criar lista');
                btnCreate.disabled = false;
                btnCreate.innerHTML = '‚úÖ Criar Lista';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao criar lista: ' + error);
            btnCreate.disabled = false;
            btnCreate.innerHTML = '‚úÖ Criar Lista';
            hideLoading();
        })
        .saveList(listName, []);
}

// SE√á√ïES
function editSection(sectionName) {
    debugLog('info', 'Editando se√ß√£o', { sectionName: sectionName });
    
    var section = appContext.sections.find(s => s.nome === sectionName);
    if (!section) return;
    
    var modalHtml = `
        <div id="editSectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                <h3 style="margin-bottom: 1rem;">Editar Se√ß√£o: ${sectionName}</h3>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="sectionDesc" value="${section.descricao}" class="form-control">
                </div>
                <div class="form-group">
                    <label>Ordem</label>
                    <input type="number" id="sectionOrder" value="${section.ordem}" class="form-control">
                </div>
                <div class="form-group">
                    <label>Ativo</label>
                    <select id="sectionActive" class="form-control">
                        <option value="Sim" ${section.ativo === 'Sim' ? 'selected' : ''}>Sim</option>
                        <option value="N√£o" ${section.ativo === 'N√£o' ? 'selected' : ''}>N√£o</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeSectionModal()" class="btn btn-secondary">Cancelar</button>
                    <button onclick="saveSectionChanges('${sectionName}')" class="btn btn-primary">üíæ Salvar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeSectionModal() {
    var modal = document.getElementById('editSectionModal');
    if (modal) modal.remove();
}

function saveSectionChanges(sectionName) {
    var sectionData = {
        nome: sectionName,
        descricao: document.getElementById('sectionDesc').value,
        ordem: parseInt(document.getElementById('sectionOrder').value),
        ativo: document.getElementById('sectionActive').value
    };
    
    showLoading('Salvando se√ß√£o...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeSectionModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('updated', result.sectionName || sectionName, 2000);
                } else {
                    showSuccess('Se√ß√£o atualizada com sucesso!');
                }
            } else {
                showError('Erro ao salvar se√ß√£o');
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao salvar se√ß√£o: ' + error);
            hideLoading();
        })
        .saveSection(sectionData);
}

function deleteSectionConfirm(sectionName) {
    // Criar modal de confirma√ß√£o HTML customizado
    var modalHtml = `
        <div id="deleteSectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-bottom: 1.5rem; color: #F44336;">üóëÔ∏è Excluir Se√ß√£o</h3>
                <div style="margin-bottom: 1.5rem;">
                    <p style="margin-bottom: 1rem;">
                        Tem certeza que deseja deletar a se√ß√£o:
                    </p>
                    <p style="font-weight: 600; color: #009688; font-size: 16px;">
                        "${sectionName}"
                    </p>
                    <p style="margin-top: 1rem; color: #F44336; font-size: 14px;">
                        ‚ö†Ô∏è ATEN√á√ÉO: Todos os campos desta se√ß√£o ser√£o removidos!
                    </p>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeDeleteSectionModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="executeDeleteSection('${sectionName}')" class="btn btn-danger">üóëÔ∏è Confirmar Exclus√£o</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Fun√ß√£o para fechar modal de deletar se√ß√£o
function closeDeleteSectionModal() {
    var modal = document.getElementById('deleteSectionModal');
    if (modal) modal.remove();
}

// Fun√ß√£o para executar exclus√£o da se√ß√£o
function executeDeleteSection(sectionName) {
    var btnCancel = document.querySelector('#deleteSectionModal .btn-secondary');
    var btnConfirm = document.querySelector('#deleteSectionModal .btn-danger');
    btnCancel.disabled = true;
    btnConfirm.disabled = true;
    btnConfirm.innerHTML = '‚è≥ Excluindo...';
    
    showLoading('Deletando se√ß√£o...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeDeleteSectionModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('deleted', result.sectionName || sectionName, 2000);
                } else {
                    showSuccess('Se√ß√£o deletada com sucesso!');
                }
            } else {
                showError('Erro ao deletar se√ß√£o');
                btnCancel.disabled = false;
                btnConfirm.disabled = false;
                btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao deletar se√ß√£o: ' + error);
            btnCancel.disabled = false;
            btnConfirm.disabled = false;
            btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
            hideLoading();
        })
        .deleteSection(sectionName);
}

// Adicionar nova se√ß√£o
document.getElementById('addNewSection').addEventListener('click', function() {
    // Criar modal HTML customizado
    var modalHtml = `
        <div id="newSectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-bottom: 1.5rem; color: #009688;">üìÑ Nova Se√ß√£o</h3>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nome da nova se√ß√£o:</label>
                    <input type="text" id="newSectionName" class="form-control" placeholder="Digite o nome da se√ß√£o" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeNewSectionModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="createNewSection()" class="btn btn-primary">‚úÖ Criar Se√ß√£o</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Focar no campo de input
    setTimeout(() => {
        document.getElementById('newSectionName').focus();
    }, 100);
    
    // Permitir criar com Enter
    document.getElementById('newSectionName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            createNewSection();
        }
    });
});

// Fun√ß√£o para fechar modal de nova se√ß√£o
function closeNewSectionModal() {
    var modal = document.getElementById('newSectionModal');
    if (modal) modal.remove();
}

// Fun√ß√£o para criar nova se√ß√£o
function createNewSection() {
    var sectionName = document.getElementById('newSectionName').value.trim();
    
    if (!sectionName) {
        showError('Por favor, digite um nome para a se√ß√£o!');
        return;
    }
    
    var existingSection = appContext.sections.find(s => s.nome === sectionName);
    if (existingSection) {
        showError('Esta se√ß√£o j√° existe!');
        return;
    }
    
    var btnCreate = document.querySelector('#newSectionModal .btn-primary');
    btnCreate.disabled = true;
    btnCreate.innerHTML = '‚è≥ Criando...';
    
    showLoading('Criando se√ß√£o...');
    
    var sectionData = {
        nome: sectionName,
        descricao: '',
        ordem: 999,
        ativo: 'Sim'
    };
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeNewSectionModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('created', result.sectionName || sectionName, 2000);
                } else {
                    showSuccess('Se√ß√£o criada com sucesso!');
                }
            } else {
                showError('Erro ao criar se√ß√£o');
                btnCreate.disabled = false;
                btnCreate.innerHTML = '‚úÖ Criar Se√ß√£o';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao criar se√ß√£o: ' + error);
            btnCreate.disabled = false;
            btnCreate.innerHTML = '‚úÖ Criar Se√ß√£o';
            hideLoading();
        })
        .saveSection(sectionData);
}

// CAMPOS
function editField(secao, campo) {
    debugLog('info', 'Editando campo', { secao: secao, campo: campo });
    
    // Buscar campo atual
    var allFields = [];
    google.script.run
        .withSuccessHandler(function(fields) {
            var field = fields.find(f => f.secao === secao && f.campo === campo);
            if (!field) return;
            
            var modalHtml = `
                <div id="editFieldModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 1rem;">Editar Campo: ${campo}</h3>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="fieldType" class="form-control">
                                <option value="input" ${field.tipo === 'input' ? 'selected' : ''}>Texto</option>
                                <option value="textarea" ${field.tipo === 'textarea' ? 'selected' : ''}>Texto Longo</option>
                                <option value="select" ${field.tipo === 'select' ? 'selected' : ''}>Lista Suspensa</option>
                                <option value="date" ${field.tipo === 'date' ? 'selected' : ''}>Data</option>
                                <option value="number" ${field.tipo === 'number' ? 'selected' : ''}>N√∫mero</option>
                                <option value="file" ${field.tipo === 'file' ? 'selected' : ''}>Arquivo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Obrigat√≥rio</label>
                            <select id="fieldRequired" class="form-control">
                                <option value="Sim" ${field.obrigatorio === 'Sim' ? 'selected' : ''}>Sim</option>
                                <option value="N√£o" ${field.obrigatorio === 'N√£o' ? 'selected' : ''}>N√£o</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Placeholder</label>
                            <input type="text" id="fieldPlaceholder" value="${field.placeholder || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Lista (para campos select)</label>
                            <select id="fieldList" class="form-control">
                                <option value="">Nenhuma</option>
                                ${Object.keys(appContext.lists).map(list => 
                                    `<option value="${list}" ${field.lista === list ? 'selected' : ''}>${list}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ordem</label>
                            <input type="number" id="fieldOrder" value="${field.ordem}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Ativo</label>
                            <select id="fieldActive" class="form-control">
                                <option value="Sim" ${field.ativo === 'Sim' ? 'selected' : ''}>Sim</option>
                                <option value="N√£o" ${field.ativo === 'N√£o' ? 'selected' : ''}>N√£o</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="closeFieldModal()" class="btn btn-secondary">Cancelar</button>
                            <button onclick="saveFieldChanges('${secao}', '${campo}')" class="btn btn-primary">üíæ Salvar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        })
        .withFailureHandler(function(error) {
            showError('Erro ao carregar campo: ' + error);
        })
        .getAllFieldsFromConfig();
}

function closeFieldModal() {
    var modal = document.getElementById('editFieldModal');
    if (modal) modal.remove();
}

function saveFieldChanges(secao, campo) {
    var fieldData = {
        secao: secao,
        campo: campo,
        tipo: document.getElementById('fieldType').value,
        obrigatorio: document.getElementById('fieldRequired').value,
        placeholder: document.getElementById('fieldPlaceholder').value,
        lista: document.getElementById('fieldList').value,
        ordem: parseInt(document.getElementById('fieldOrder').value),
        ativo: document.getElementById('fieldActive').value
    };
    
    showLoading('Salvando campo...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeFieldModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('updated', result.fieldName || campo, 2000);
                } else {
                    showSuccess('Campo salvo com sucesso!');
                }
            } else {
                showError('Erro ao salvar campo');
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao salvar campo: ' + error);
            hideLoading();
        })
        .saveFieldConfiguration(fieldData);
}
console.log('‚úÖ Todas as fun√ß√µes de configura√ß√£o carregadas!');



function deleteFieldConfirm(secao, campo) {
    // Criar modal de confirma√ß√£o HTML
    var modalHtml = `
        <div id="deleteFieldModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                <h3 style="margin-bottom: 1.5rem; color: #F44336;">Excluir Campo</h3>
                <p>Tem certeza que deseja deletar o campo:</p>
                <p style="font-weight: 600; color: #009688;">"${campo}"</p>
                <p>da se√ß√£o: <strong>"${secao}"</strong></p>
                <p style="color: #F44336;">Esta a√ß√£o n√£o pode ser desfeita!</p>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button onclick="closeDeleteFieldModal()" class="btn btn-secondary">Cancelar</button>
                    <button onclick="executeDeleteField('${secao}', '${campo}')" class="btn btn-danger">Confirmar Exclus√£o</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeDeleteFieldModal() {
    var modal = document.getElementById('deleteFieldModal');
    if (modal) modal.remove();
}

function executeDeleteField(secao, campo) {
    var btnCancel = document.querySelector('#deleteFieldModal .btn-secondary');
    var btnConfirm = document.querySelector('#deleteFieldModal .btn-danger');
    btnCancel.disabled = true;
    btnConfirm.disabled = true;
    btnConfirm.innerHTML = '‚è≥ Excluindo...';
    
    showLoading('Deletando campo...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeDeleteFieldModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('deleted', result.fieldName || campo, 2000);
                } else {
                    showSuccess('Campo deletado com sucesso!');
                }
            } else {
                showError('Erro ao deletar campo');
                btnCancel.disabled = false;
                btnConfirm.disabled = false;
                btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao deletar campo: ' + error);
            btnCancel.disabled = false;
            btnConfirm.disabled = false;
            btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
            hideLoading();
        })
        .deleteFieldConfiguration(secao, campo);
}





// ========================================
// EVENT LISTENER: ADICIONAR NOVO CAMPO COMPLETO
// ========================================
document.getElementById('addNewField').addEventListener('click', function() {
    debugLog('info', '‚ûï Abrindo modal de novo campo completo');
    
    // Verificar se existem se√ß√µes dispon√≠veis
    if (!appContext.sections || appContext.sections.length === 0) {
        showError('Nenhuma se√ß√£o dispon√≠vel! Crie uma se√ß√£o primeiro.');
        return;
    }
    
    // Criar options para se√ß√µes
    var sectionsOptions = appContext.sections.map(section => 
        `<option value="${section.nome}">${section.nome}</option>`
    ).join('');
    
    // Criar options para listas dispon√≠veis
    var listsOptions = '<option value="">Nenhuma</option>';
    if (appContext.lists) {
        listsOptions += Object.keys(appContext.lists).map(listName => 
            `<option value="${listName}">${listName}</option>`
        ).join('');
    }
    
    // Criar modal HTML completo (baseado no editField)
    var modalHtml = `
        <div id="newFieldModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-bottom: 1.5rem; color: #009688;">üè∑Ô∏è Novo Campo</h3>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Se√ß√£o:</label>
                    <select id="newFieldSection" class="form-control" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        ${sectionsOptions}
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nome do Campo:</label>
                    <input type="text" id="newFieldName" class="form-control" placeholder="Digite o nome do campo" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tipo:</label>
                    <select id="newFieldType" class="form-control" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="input">üìù Texto</option>
                        <option value="textarea">üìÑ Texto Longo</option>
                        <option value="select">üìã Lista Suspensa</option>
                        <option value="date">üìÖ Data</option>
                        <option value="number">üî¢ N√∫mero</option>
                        <option value="file">üìé Arquivo</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Obrigat√≥rio:</label>
                    <select id="newFieldRequired" class="form-control" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="N√£o">‚ùå N√£o</option>
                        <option value="Sim">‚úÖ Sim</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Placeholder:</label>
                    <input type="text" id="newFieldPlaceholder" class="form-control" placeholder="Texto de ajuda (opcional)" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Lista (para campos select):</label>
                    <select id="newFieldList" class="form-control" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        ${listsOptions}
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Ordem:</label>
                    <input type="number" id="newFieldOrder" class="form-control" value="999" min="1" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeNewFieldModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="createNewFieldComplete()" class="btn btn-primary">‚úÖ Criar Campo</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Focar no campo nome
    setTimeout(() => {
        document.getElementById('newFieldName').focus();
    }, 100);
    
    // Permitir criar com Enter
    document.getElementById('newFieldName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            createNewFieldComplete();
        }
    });
});



// ========================================
// EVENT LISTENER: ADICIONAR NOVO USU√ÅRIO
// ========================================
document.getElementById('addNewUser').addEventListener('click', function() {
    debugLog('info', '‚ûï Abrindo modal de novo usu√°rio');
    
    const modalHtml = `
        <div id="addUserModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 1rem; color: #009688;">‚ûï Adicionar Novo Usu√°rio</h3>
                
                <div class="form-group">
                    <label>üìß Email do Usu√°rio</label>
                    <input type="email" id="newUserEmail" class="form-control" placeholder="usuario@exemplo.com">
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>üè¢ Setor(es) do Usu√°rio</label>
                    <div class="multiselect-wrapper">
                        <!-- Container de chips selecionados -->
                        <div class="chips-container" id="newUserSetorChips" style="min-height: 50px; background: #ffffff; border: 1px solid #ddd; border-radius: 4px; padding: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="color: #999; font-size: 13px; font-style: italic;">Nenhum setor selecionado</span>
                        </div>
                        <!-- Dropdown de sele√ß√£o -->
                        <select id="newUserSetor" class="form-control" style="margin-top: 8px;" onchange="addSetorChipToNew(this)">
                            <option value="">‚ûï Adicionar setor...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>üé≠ Roles do Usu√°rio</label>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                        
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="role_admin" value="Admin">
                            <span class="role-badge admin">Admin</span>
                            <span style="font-size: 13px; color: #666;">Acesso total ao sistema</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="role_abertura" value="Abertura" checked>
                            <span class="role-badge abertura">Abertura</span>
                            <span style="font-size: 13px; color: #666;">Criar RNCs</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="role_qualidade" value="Qualidade">
                            <span class="role-badge qualidade">Qualidade</span>
                            <span style="font-size: 13px; color: #666;">Editar se√ß√£o Qualidade</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="role_lideranca" value="Lideran√ßa">
                            <span class="role-badge lideranca">Lideran√ßa</span>
                            <span style="font-size: 13px; color: #666;">Editar se√ß√£o Lideran√ßa</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="role_espectador" value="Espectador">
                            <span class="role-badge espectador">Espectador</span>
                            <span style="font-size: 13px; color: #666;">Apenas visualizar</span>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 30px;">
                    <button onclick="closeAddUserModal()" class="btn btn-secondary">Cancelar</button>
                    <button onclick="saveNewUser()" class="btn btn-primary">‚ûï Adicionar Usu√°rio</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Deploy 124: Carregar setores da planilha Listas
    (async function loadSetoresForNewUser() {
        try {
            const response = await apiCall('getSetoresFromListas', []);
            const setores = response && response.data ? response.data : response;
            const setorSelect = document.getElementById('newUserSetor');

            if (setorSelect && setores && setores.length > 0) {
                // Deploy 124: Usar placeholder para adicionar setores (multiselect)
                setorSelect.innerHTML = '<option value="">‚ûï Adicionar setor...</option>';
                setores.forEach(function(setor) {
                    const option = document.createElement('option');
                    option.value = setor;
                    option.textContent = setor;
                    setorSelect.appendChild(option);
                });

                debugLog('info', '‚úÖ Setores carregados para novo usu√°rio', { total: setores.length });
            } else if (setorSelect) {
                setorSelect.innerHTML = '<option value="">Nenhum setor dispon√≠vel</option>';
            }
        } catch (error) {
            debugLog('error', 'Erro ao carregar setores', { error: error.message });
            const setorSelect = document.getElementById('newUserSetor');
            if (setorSelect) {
                setorSelect.innerHTML = '<option value="">Erro ao carregar setores</option>';
            }
        }
    })();
});

// Fun√ß√£o para fechar modal de novo campo
function closeNewFieldModal() {
    var modal = document.getElementById('newFieldModal');
    if (modal) modal.remove();
}

// Fun√ß√£o COMPLETA para criar novo campo (VERS√ÉO FINAL CORRIGIDA)
function createNewFieldComplete() {
    var fieldData = {
        secao: document.getElementById('newFieldSection').value,
        campo: document.getElementById('newFieldName').value.trim(),
        tipo: document.getElementById('newFieldType').value,
        obrigatorio: document.getElementById('newFieldRequired').value,
        placeholder: document.getElementById('newFieldPlaceholder').value.trim(),
        lista: document.getElementById('newFieldList').value,
        ordem: parseInt(document.getElementById('newFieldOrder').value) || 999,
        ativo: 'Sim'
    };
    
    if (!fieldData.campo) {
        showError('Por favor, digite o nome do campo!');
        document.getElementById('newFieldName').focus();
        return;
    }
    
    var btnCreate = document.querySelector('#newFieldModal .btn-primary');
    var btnCancel = document.querySelector('#newFieldModal .btn-secondary');
    btnCreate.disabled = true;
    btnCancel.disabled = true;
    btnCreate.innerHTML = '‚è≥ Criando...';
    
    showLoading('Criando campo...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeNewFieldModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('created', result.fieldName || fieldData.campo, 2000);
                } else {
                    showSuccess('Campo criado com sucesso!');
                }
            } else {
                showError('Erro ao criar campo');
                btnCreate.disabled = false;
                btnCancel.disabled = false;
                btnCreate.innerHTML = '‚úÖ Criar Campo';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao criar campo: ' + error);
            btnCreate.disabled = false;
            btnCancel.disabled = false;
            btnCreate.innerHTML = '‚úÖ Criar Campo';
            hideLoading();
        })
        .saveFieldConfiguration(fieldData);
}     



/**
 * Formata data para input type="date" (YYYY-MM-DD)
 * Deploy 37 - Aceita DD/MM/YYYY do backend
 */
function formatDateForInput(dateValue) {
    if (!dateValue) return '';
    
    try {
        // Se recebeu DD/MM/YYYY do backend
        if (typeof dateValue === 'string' && dateValue.includes('/')) {
            var parts = dateValue.split('/');
            if (parts.length === 3) {
                var day = parts[0].padStart(2, '0');
                var month = parts[1].padStart(2, '0');
                var year = parts[2];
                return year + '-' + month + '-' + day;
            }
        }
        
        // Se recebeu YYYY-MM-DD ou ISO
        if (typeof dateValue === 'string' && dateValue.includes('-')) {
            return dateValue.split('T')[0]; // Remove hora se tiver
        }
        
        // Se recebeu objeto Date
        if (dateValue instanceof Date) {
            const year = dateValue.getFullYear();
            const month = String(dateValue.getMonth() + 1).padStart(2, '0');
            const day = String(dateValue.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        return '';
        
    } catch (error) {
        debugLog('error', 'Erro ao formatar data para input', { dateValue, error: error.message });
        return '';
    }
}


        /**
 * Formata data para exibi√ß√£o (DD/MM/YYYY)
 * Deploy 37 - Padronizado com backend
 */

 
function formatDate(dateStr) {
    if (!dateStr) return '';
    
    try {
        // Se j√° est√° em DD/MM/YYYY, retornar
        if (typeof dateStr === 'string' && dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            return dateStr;
        }
        
        // Se est√° em YYYY-MM-DD ou ISO (2025-10-16 ou 2025-10-16T03:00:00.000Z)
        if (typeof dateStr === 'string' && dateStr.includes('-')) {
            const parts = dateStr.split('T')[0].split('-');
            if (parts.length === 3) {
                return parts[2] + '/' + parts[1] + '/' + parts[0];
            }
        }
        
        // Se for Date object
        if (dateStr instanceof Date) {
            return dateStr.toLocaleDateString('pt-BR');
        }
        
        return dateStr;
    } catch (error) {
        console.error('Erro ao formatar data:', error);
        return dateStr;
    }
}
        
        function showLoading(message = 'Carregando...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            messageEl.textContent = message;
            overlay.classList.remove('hidden');
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
        }
        
        // === SISTEMA DE ALERTAS MELHORADO (Deploy 30) ===
var activeAlerts = []; // Rastrear alertas ativos

function showAlert(message, type = 'info', duration = 5000) {
    // === PREVENIR DUPLICATAS ===
    var alertKey = type + ':' + message;
    if (activeAlerts.indexOf(alertKey) !== -1) {
        debugLog('warning', '‚ö†Ô∏è Alerta duplicado bloqueado', { message: message });
        return;
    }
    
    activeAlerts.push(alertKey);
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.dataset.alertKey = alertKey;
    
    const icon = {
        'success': '‚úÖ',
        'error': '‚ùå', 
        'warning': '‚ö†Ô∏è',
        'info': '‚ÑπÔ∏è'
    };
    
    alert.innerHTML = `
        <span>${icon[type] || '‚ÑπÔ∏è'}</span>
        <span>${message}</span>
    `;
    
    // Inserir no topo da p√°gina
    const container = document.querySelector('.container');
    container.insertBefore(alert, container.firstChild);
    
    // Auto remover
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
            // Remover do rastreamento
            var index = activeAlerts.indexOf(alertKey);
            if (index > -1) {
                activeAlerts.splice(index, 1);
            }
        }
    }, duration);
    
    debugLog(type, message);
}
        
        function showSuccess(message) { showAlert(message, 'success'); }
        function showError(message) { showAlert(message, 'error', 8000); }
        function showInfo(message) { showAlert(message, 'info'); }
        function showWarning(message) { showAlert(message, 'warning'); }
       /**
 * Exibe notifica√ß√£o gen√©rica GARANTIDA
 * Deploy 42 - Notifica√ß√£o que sempre aparece
 */
function showNotification(message, type) {
    type = type || 'info';
    
    // Tentar usar showAlert primeiro
    try {
        if (typeof showAlert === 'function') {
            showAlert(message, type);
            return;
        }
    } catch(e) {
        console.warn('‚ö†Ô∏è showAlert falhou, usando fallback', e);
    }
    
    // FALLBACK: Criar notifica√ß√£o diretamente
    createDirectNotification(message, type);
}

/**
 * Cria notifica√ß√£o direto no body (fallback garantido)
 */
function createDirectNotification(message, type) {
    // Remover notifica√ß√µes antigas
    const oldNotifications = document.querySelectorAll('.direct-notification');
    oldNotifications.forEach(n => n.remove());
    
    // Criar notifica√ß√£o
    const notification = document.createElement('div');
    notification.className = `direct-notification notification-${type}`;
    
    const icons = {
        'success': '‚úÖ',
        'error': '‚ùå',
        'warning': '‚ö†Ô∏è',
        'info': '‚ÑπÔ∏è'
    };
    
    const colors = {
        'success': '#4caf50',
        'error': '#f44336',
        'warning': '#ff9800',
        'info': '#2196F3'
    };
    
    notification.innerHTML = `
        <span style="margin-right: 10px; font-size: 18px;">${icons[type] || '‚ÑπÔ∏è'}</span>
        <span style="flex: 1;">${message}</span>
    `;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 99999;
        display: flex;
        align-items: center;
        min-width: 300px;
        max-width: 500px;
        font-size: 14px;
        font-weight: 500;
        animation: slideInRight 0.3s ease-out;
    `;
    
    // Adicionar ao body
    document.body.appendChild(notification);
    
    // Auto remover ap√≥s 5 segundos
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => notification.remove(), window.NeoRNC.constants.ANIMATION_DELAY);
    }, 5000);
    
    console.log(`üì¢ Notifica√ß√£o [${type}]: ${message}`);
}

// Adicionar anima√ß√µes CSS se n√£o existirem
if (!document.getElementById('notification-animations')) {
    const style = document.createElement('style');
    style.id = 'notification-animations';
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

 /**
 * Exibe notifica√ß√£o de mudan√ßa na configura√ß√£o
 * Deploy 30 - Feedback visual para altera√ß√µes
 */
function showConfigChangeNotification(action, fieldOrSectionName) {
    var actionText = {
        'created': '‚úÖ Criado',
        'updated': '‚úèÔ∏è Atualizado',
        'deleted': 'üóëÔ∏è Removido'
    };
    
    var actionEmoji = {
        'created': '‚ú®',
        'updated': 'üîÑ',
        'deleted': 'üóëÔ∏è'
    };
    
    var message = (actionEmoji[action] || '‚úÖ') + ' ' + 
                  (actionText[action] || 'Atualizado') + 
                  ': "' + fieldOrSectionName + '"';
    
    debugLog('success', 'Configura√ß√£o alterada', {
        action: action,
        item: fieldOrSectionName,
        timestamp: new Date().toISOString()
    });
    
    console.log('üì¢ ' + message);
}
        
        // === NAVEGA√á√ÉO ===
        // === CONTROLE DE ABAS CARREGADAS ===
// M√âDIA-02: Usando namespace global
window.NeoRNC.state.loadedTabs = {
    abrir: true,  // J√° carregado na inicializa√ß√£o
    editar: false,
    kanban: false,
    dashboard: false,
    relatorios: false,
    configuracoes: false
};

// Alias para compatibilidade
var loadedTabs = window.NeoRNC.state.loadedTabs;


        
        // === NAVEGA√á√ÉO DAS ABAS DE CONFIGURA√á√ÉO (Deploy 72.3) ===
        function switchConfigTab(configTabName) {
            // Remover classe ativa de todas as abas de config
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.config-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ativar aba selecionada
            document.querySelector(`[data-config-tab="${configTabName}"]`).classList.add('active');
            document.getElementById(`config-tab-${configTabName}`).classList.add('active');
            
            debugLog('info', 'üîß Mudando para aba de config Deploy 72.3', { configTab: configTabName });
        }
        
        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('info', 'üöÄ DOM carregado, inicializando aplica√ß√£o Deploy 72.3');
            
            // === BARRA DE ABAS STICKY COM EFEITO AO ROLAR ===
            const tabsElement = document.querySelector('.tabs');

            if (tabsElement) {
                window.addEventListener('scroll', function() {
                    const scrollY = window.scrollY || window.pageYOffset;
                    
                    // Se rolou mais de 100px, adicionar efeito
                    if (scrollY > 100) {
                        tabsElement.classList.add('scrolled');
                    } else {
                        tabsElement.classList.remove('scrolled');
                    }
                });
                
                debugLog('info', '‚úÖ Sistema de abas sticky configurado');
            }

            // Navega√ß√£o das abas principais
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
            
            // === NAVEGA√á√ÉO DAS ABAS DE CONFIGURA√á√ÉO (Deploy 72.3) ===
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const configTabName = this.dataset.configTab;
                    switchConfigTab(configTabName);
                });
            });
            
            // Formul√°rio de abertura
            document.getElementById('rncForm').addEventListener('submit', function(e) {
                console.log('üî¥üî¥üî¥ FORM SUBMIT CAPTURADO! üî¥üî¥üî¥');
                e.preventDefault();

                const submitBtn = document.getElementById('submitRnc');
                const submitText = document.getElementById('submitText');
                const submitLoading = document.getElementById('submitLoading');

                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                submitLoading.classList.remove('hidden');

                console.log('üî¥ Chamando saveRnc()...');
                saveRnc().finally(() => {
                    console.log('üî¥ saveRnc() finalizado');
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    submitLoading.classList.add('hidden');
                });
            });
            
            // Formul√°rio de edi√ß√£o
            document.getElementById('rncEditForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const updateBtn = document.getElementById('updateRnc');
                const updateText = document.getElementById('updateText');
                const updateLoading = document.getElementById('updateLoading');
                
                updateBtn.disabled = true;
                updateText.classList.add('hidden');
                updateLoading.classList.remove('hidden');
                
                updateRnc().finally(() => {
                    updateBtn.disabled = false;
                    updateText.classList.remove('hidden');
                    updateLoading.classList.add('hidden');
                });
            });
            
            // Sele√ß√£o de RNC para edi√ß√£o
            document.getElementById('rncSelect').addEventListener('change', function() {
                const rncNumber = this.value;
                if (rncNumber) {
                    loadRncForEdit(rncNumber);
                } else {
                    document.getElementById('editForm').classList.add('hidden');
                    currentRnc = null;
                }
            });
            
            // Gera√ß√£o de relat√≥rios
            document.getElementById('generateReport').addEventListener('click', function() {
                const reportBtn = this;
                const reportText = document.getElementById('reportText');
                const reportLoading = document.getElementById('reportLoading');
                
                reportBtn.disabled = true;
                reportText.classList.add('hidden');
                reportLoading.classList.remove('hidden');
                
                generateReport().finally(() => {
                    reportBtn.disabled = false;
                    reportText.classList.remove('hidden');
                    reportLoading.classList.add('hidden');
                });
            });

            // Exporta√ß√£o PDF (DEPLOY 38)
            document.getElementById('exportPdf').addEventListener('click', exportToPdf);

            // Limpar filtros
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            
            // === CONFIGURA√á√ïES (Deploy 72.3) ===
            document.getElementById('saveSystemConfig').addEventListener('click', saveSystemConfig);

            // Deploy 74.5: Bot√£o de limpar cache
            document.getElementById('btnLimparCache').addEventListener('click', async function() {
                try {
                    const btn = this;
                    const icon = document.getElementById('btnLimparCacheIcon');
                    const text = document.getElementById('btnLimparCacheText');
                    const resultDiv = document.getElementById('cacheResultMessage');

                    // Deploy 74.7: Usar modal customizado
                    const confirmed = await showConfirmModal(
                        'üóëÔ∏è Limpar Cache',
                        'Tem certeza que deseja limpar todo o cache do sistema?\n\nIsso vai for√ßar o recarregamento de todos os dados.'
                    );

                    if (!confirmed) {
                        return;
                    }

                    // Estado de loading
                    btn.disabled = true;
                    icon.textContent = '‚è≥';
                    text.textContent = 'Limpando cache...';
                    resultDiv.innerHTML = '';

                    debugLog('info', 'üóëÔ∏è Limpando cache do sistema...');

                    // Chamar fun√ß√£o do backend
                    const result = await apiCall('limparTodosCaches');

                    if (result && result.success) {
                        // Sucesso
                        icon.textContent = '‚úÖ';
                        text.textContent = 'Cache Limpo!';

                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <strong>‚úÖ Cache limpo com sucesso!</strong>
                                <p style="margin: 0.5rem 0 0 0;">
                                    ‚Ä¢ Cache de RNCs: ${result.details.rncCache ? '‚úÖ' : '‚ùå'}<br>
                                    ‚Ä¢ Cache do Dashboard: ${result.details.dashboardCache ? '‚úÖ' : '‚ùå'}<br>
                                    ‚Ä¢ Cache do Script: ${result.details.scriptCache ? '‚úÖ' : '‚ùå'}
                                </p>
                                <p style="margin-top: 0.5rem; font-weight: bold;">Recarregue a p√°gina para ver os dados atualizados.</p>
                            </div>
                        `;

                        debugLog('success', '‚úÖ Cache limpo com sucesso', result.details);

                        // Resetar bot√£o ap√≥s 3 segundos
                        setTimeout(() => {
                            icon.textContent = 'üóëÔ∏è';
                            text.textContent = 'Limpar Todo o Cache do Sistema';
                            btn.disabled = false;
                        }, 3000);

                    } else {
                        // Erro
                        icon.textContent = '‚ùå';
                        text.textContent = 'Erro ao Limpar Cache';

                        resultDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <strong>‚ùå Erro ao limpar cache</strong>
                                <p style="margin: 0.5rem 0 0 0;">${result ? result.message : 'Erro desconhecido'}</p>
                            </div>
                        `;

                        debugLog('error', '‚ùå Erro ao limpar cache', result);

                        // Resetar bot√£o ap√≥s 3 segundos
                        setTimeout(() => {
                            icon.textContent = 'üóëÔ∏è';
                            text.textContent = 'Limpar Todo o Cache do Sistema';
                            btn.disabled = false;
                        }, 3000);
                    }

                } catch (error) {
                    debugLog('error', '‚ùå Erro ao limpar cache', { error: error.message });

                    document.getElementById('cacheResultMessage').innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå Erro ao limpar cache</strong>
                            <p style="margin: 0.5rem 0 0 0;">${error.message}</p>
                        </div>
                    `;

                    // Resetar bot√£o
                    document.getElementById('btnLimparCacheIcon').textContent = 'üóëÔ∏è';
                    document.getElementById('btnLimparCacheText').textContent = 'Limpar Todo o Cache do Sistema';
                    this.disabled = false;
                }
            });

            // Deploy 74.5.2: Bot√£o de limpar logs
            document.getElementById('btnLimparLogs').addEventListener('click', async function() {
                try {
                    const btn = this;
                    const icon = document.getElementById('btnLimparLogsIcon');
                    const text = document.getElementById('btnLimparLogsText');
                    const resultDiv = document.getElementById('logsResultMessage');

                    // Deploy 74.7: Usar modal customizado - primeira confirma√ß√£o
                    const confirmed1 = await showConfirmModal(
                        '‚ö†Ô∏è ATEN√á√ÉO',
                        'Voc√™ est√° prestes a DELETAR TODOS OS LOGS da planilha!\n\nEsta a√ß√£o N√ÉO PODE SER DESFEITA!\n\nDeseja continuar?'
                    );

                    if (!confirmed1) {
                        return;
                    }

                    // Segunda confirma√ß√£o
                    const confirmed2 = await showConfirmModal(
                        '‚ö†Ô∏è Confirma√ß√£o Final',
                        'Tem certeza ABSOLUTA?\n\nTodos os logs ser√£o permanentemente removidos!'
                    );

                    if (!confirmed2) {
                        return;
                    }

                    // Estado de loading
                    btn.disabled = true;
                    icon.textContent = '‚è≥';
                    text.textContent = 'Limpando logs...';
                    resultDiv.innerHTML = '';

                    debugLog('info', 'üóëÔ∏è Limpando aba de logs...');

                    // Chamar fun√ß√£o do backend
                    const result = await apiCall('limparAbaLogs');

                    if (result && result.success) {
                        // Sucesso
                        icon.textContent = '‚úÖ';
                        text.textContent = 'Logs Limpos!';

                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <strong>‚úÖ Logs limpos com sucesso!</strong>
                                <p style="margin: 0.5rem 0 0 0;">
                                    ${result.logsRemovidos} registro(s) foram removidos da planilha.
                                </p>
                            </div>
                        `;

                        debugLog('success', '‚úÖ Logs limpos', { logsRemovidos: result.logsRemovidos });

                        // Resetar bot√£o ap√≥s 3 segundos
                        setTimeout(() => {
                            icon.textContent = 'üóëÔ∏è';
                            text.textContent = 'Limpar Aba de Logs';
                            btn.disabled = false;
                        }, 3000);

                    } else {
                        // Erro
                        icon.textContent = '‚ùå';
                        text.textContent = 'Erro ao Limpar Logs';

                        resultDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <strong>‚ùå Erro ao limpar logs</strong>
                                <p style="margin: 0.5rem 0 0 0;">${result ? result.message : 'Erro desconhecido'}</p>
                            </div>
                        `;

                        debugLog('error', '‚ùå Erro ao limpar logs', result);

                        // Resetar bot√£o ap√≥s 3 segundos
                        setTimeout(() => {
                            icon.textContent = 'üóëÔ∏è';
                            text.textContent = 'Limpar Aba de Logs';
                            btn.disabled = false;
                        }, 3000);
                    }

                } catch (error) {
                    debugLog('error', '‚ùå Erro ao limpar logs', { error: error.message });

                    document.getElementById('logsResultMessage').innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå Erro ao limpar logs</strong>
                            <p style="margin: 0.5rem 0 0 0;">${error.message}</p>
                        </div>
                    `;

                    // Resetar bot√£o
                    document.getElementById('btnLimparLogsIcon').textContent = 'üóëÔ∏è';
                    document.getElementById('btnLimparLogsText').textContent = 'Limpar Aba de Logs';
                    this.disabled = false;
                }
            });

            // Deploy 76: Sistema de Backup - Event Listeners

            // Salvar pasta de backup
            // Salvar pasta de backup
            document.getElementById('btnSaveBackupFolder').addEventListener('click', async function() {
                try {
                    const folderIdInput = document.getElementById('backupFolderIdInput');
                    const folderId = folderIdInput.value.trim();
                    const statusDiv = document.getElementById('backupFolderStatus');

                    if (!folderId) {
                        statusDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Por favor, informe o ID da pasta</div>';
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '‚è≥ Salvando...';

                    const result = await apiCall('setSystemBackupFolder', folderId);

                    if (result && result.success) {
                        statusDiv.innerHTML = `
                            <div class="alert alert-success">
                                ${result.message || '‚úÖ Pasta de backup configurada com sucesso!'}
                                <br><small>Pasta: ${result.folderName || folderId}</small>
                            </div>
                        `;
                        debugLog('success', '‚úÖ Pasta de backup configurada', { folderId: result.folderId });
                    } else {
                        statusDiv.innerHTML = `
                            <div class="alert alert-danger">
                                ‚ùå ${result ? result.error : 'Erro desconhecido'}
                            </div>
                        `;
                        debugLog('error', '‚ùå Erro ao configurar pasta de backup', result);
                    }

                } catch (error) {
                    document.getElementById('backupFolderStatus').innerHTML = `
                        <div class="alert alert-danger">‚ùå Erro: ${error.message}</div>
                    `;
                    debugLog('error', '‚ùå Erro ao configurar pasta de backup', { error: error.message });
                } finally {
                    this.disabled = false;
                    this.innerHTML = 'üíæ Salvar';
                }
            });

            // Criar backup
            document.getElementById('btnCreateBackup').addEventListener('click', async function() {
                try {
                    const resultDiv = document.getElementById('backupActionResult');
                    const btn = this;

                    btn.disabled = true;
                    btn.innerHTML = '<div style="font-size: 2rem;">‚è≥</div><div>Criando Backup...</div>';
                    resultDiv.innerHTML = '<div class="alert alert-info">‚è≥ Exportando dados das tabelas...</div>';

                    debugLog('info', 'üì¶ Criando backup do sistema...');

                    const result = await apiCall('createSystemBackup');

                    if (result && result.success) {
                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="font-size: 3rem;">‚úÖ</div>
                                    <div>
                                        <strong style="font-size: 1.2rem; color: var(--success);">Backup criado com sucesso!</strong>
                                        <div style="color: #666; margin-top: 0.25rem;">Arquivo salvo no Google Drive</div>
                                    </div>
                                </div>

                                <div style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem; border: 1px solid #dee2e6;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 0.75rem 1rem; font-weight: 600; color: #495057; width: 40%;">üìÑ Arquivo</td>
                                            <td style="padding: 0.75rem 1rem; color: #212529;">${result.backup.fileName}</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 0.75rem 1rem; font-weight: 600; color: #495057;">üìÖ Data</td>
                                            <td style="padding: 0.75rem 1rem; color: #212529;">${result.backup.backupDate}</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 0.75rem 1rem; font-weight: 600; color: #495057;">üìä Tabelas</td>
                                            <td style="padding: 0.75rem 1rem; color: #212529;">${result.backup.sheetsExported}</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 0.75rem 1rem; font-weight: 600; color: #495057;">üìù Total de Linhas</td>
                                            <td style="padding: 0.75rem 1rem; color: #212529;">${result.backup.totalRows}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 0.75rem 1rem; font-weight: 600; color: #495057;">üíæ Tamanho</td>
                                            <td style="padding: 0.75rem 1rem; color: #212529;">${result.backup.fileSize}</td>
                                        </tr>
                                    </table>

                                    <div style="margin-top: 1.5rem; text-align: center;">
                                        <a href="${result.backup.fileUrl}" target="_blank" class="btn btn-primary" style="padding: 0.75rem 2rem; font-size: 1rem;">
                                            üîó Abrir Arquivo no Drive
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                        debugLog('success', '‚úÖ Backup criado', result.backup);

                        // Atualizar lista de backups se estiver vis√≠vel
                        if (document.getElementById('backupListContainer').style.display !== 'none') {
                            document.getElementById('btnListBackups').click();
                        }
                    } else {
                        resultDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <strong>‚ùå Erro ao criar backup</strong>
                                <p style="margin: 0.5rem 0 0 0;">${result ? result.error : 'Erro desconhecido'}</p>
                            </div>
                        `;
                        debugLog('error', '‚ùå Erro ao criar backup', result);
                    }

                } catch (error) {
                    document.getElementById('backupActionResult').innerHTML = `
                        <div class="alert alert-danger">‚ùå Erro: ${error.message}</div>
                    `;
                    debugLog('error', '‚ùå Erro ao criar backup', { error: error.message });
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<div style="font-size: 2rem; margin-bottom: 0.5rem;">üì¶</div><div>Criar Backup Agora</div>';
                }
            });

            // Listar backups
            document.getElementById('btnListBackups').addEventListener('click', async function() {
                try {
                    const listContainer = document.getElementById('backupListContainer');
                    const listDiv = document.getElementById('backupList');
                    const btn = this;

                    btn.disabled = true;
                    btn.innerHTML = '<div style="font-size: 2rem;">‚è≥</div><div>Carregando...</div>';

                    debugLog('info', 'üìã Listando backups...');

                    const result = await apiCall('listSystemBackups');

                    if (result && result.success) {
                        if (result.backups.length === 0) {
                            listDiv.innerHTML = `
                                <div class="alert alert-info" style="text-align: center;">
                                    üì¶ Nenhum backup encontrado.<br>
                                    <small>Crie seu primeiro backup clicando no bot√£o "Criar Backup Agora"</small>
                                </div>
                            `;
                        } else {
                            let html = '<div style="display: grid; gap: 1.25rem;">';

                            result.backups.forEach(backup => {
                                html += `
                                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #dee2e6;">
                                            <div style="font-size: 2.5rem;">üì¶</div>
                                            <div style="flex: 1;">
                                                <h4 style="margin: 0; color: var(--primary); font-size: 1.1rem; font-weight: 600;">
                                                    ${backup.fileName}
                                                </h4>
                                            </div>
                                            <div style="display: flex; gap: 0.75rem;">
                                                <button class="btn btn-sm btn-primary" onclick="window.open('${backup.fileUrl}', '_blank')" title="Abrir no Drive" style="padding: 0.5rem 1rem;">
                                                    üîó Abrir
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteBackupFile('${backup.fileId}', '${backup.fileName}')" title="Deletar" style="padding: 0.5rem 1rem;">
                                                    üóëÔ∏è Deletar
                                                </button>
                                            </div>
                                        </div>

                                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                                            <tr style="border-bottom: 1px solid #dee2e6;">
                                                <td style="padding: 0.75rem 1rem; font-weight: 600; color: #495057; width: 35%; background: #f8f9fa;">üìÖ Criado em</td>
                                                <td style="padding: 0.75rem 1rem; color: #212529;">${backup.createdDate}</td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid #dee2e6;">
                                                <td style="padding: 0.75rem 1rem; font-weight: 600; color: #495057; background: #f8f9fa;">üîÑ √öltima Modifica√ß√£o</td>
                                                <td style="padding: 0.75rem 1rem; color: #212529;">${backup.lastModified}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 0.75rem 1rem; font-weight: 600; color: #495057; background: #f8f9fa;">üíæ Tamanho</td>
                                                <td style="padding: 0.75rem 1rem; color: #212529;"><strong>${backup.size}</strong></td>
                                            </tr>
                                        </table>
                                    </div>
                                `;
                            });

                            html += '</div>';

                            html += `
                                <div style="margin-top: 1rem; text-align: center;">
                                    <a href="${result.folderUrl}" target="_blank" class="btn btn-secondary">
                                        üìÇ Abrir Pasta no Drive
                                    </a>
                                </div>
                            `;

                            listDiv.innerHTML = html;
                        }

                        listContainer.style.display = 'block';
                        debugLog('success', '‚úÖ Backups listados', { total: result.backups.length });

                    } else {
                        listDiv.innerHTML = `
                            <div class="alert alert-danger">
                                ‚ùå ${result ? result.error : 'Erro ao listar backups'}
                            </div>
                        `;
                        listContainer.style.display = 'block';
                        debugLog('error', '‚ùå Erro ao listar backups', result);
                    }

                } catch (error) {
                    document.getElementById('backupList').innerHTML = `
                        <div class="alert alert-danger">‚ùå Erro: ${error.message}</div>
                    `;
                    document.getElementById('backupListContainer').style.display = 'block';
                    debugLog('error', '‚ùå Erro ao listar backups', { error: error.message });
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div><div>Listar Backups</div>';
                }
            });

            // Abrir pasta de backup
            document.getElementById('btnOpenBackupFolder').addEventListener('click', async function() {
                try {
                    const folderId = await apiCall('getSystemBackupFolder');

                    if (!folderId) {
                        showError('‚ö†Ô∏è Pasta de backup n√£o configurada. Configure primeiro o ID da pasta.');
                        return;
                    }

                    const folderUrl = `https://drive.google.com/drive/folders/${folderId}`;
                    window.open(folderUrl, '_blank');

                } catch (error) {
                    showError('‚ùå Erro ao abrir pasta: ' + error.message);
                    debugLog('error', '‚ùå Erro ao abrir pasta de backup', { error: error.message });
                }
            });

            // Fun√ß√£o global para deletar backup
            window.deleteBackupFile = async function(fileId, fileName) {
                try {
                    const confirmed = await showConfirmModal(
                        '‚ö†Ô∏è Confirmar Exclus√£o',
                        `Deseja realmente deletar o backup:\n\n${fileName}?\n\nEsta a√ß√£o n√£o pode ser desfeita!`
                    );

                    if (!confirmed) return;

                    showLoading('Deletando backup...');

                    const result = await apiCall('deleteSystemBackup', fileId);

                    hideLoading();

                    if (result && result.success) {
                        showSuccess(`‚úÖ Backup "${result.fileName}" deletado com sucesso!`);
                        // Atualizar lista
                        document.getElementById('btnListBackups').click();
                    } else {
                        await showErrorModal('Erro ao Deletar Backup', result ? result.error : 'Erro desconhecido');
                    }

                } catch (error) {
                    hideLoading();
                    debugLog('error', '‚ùå Erro ao deletar backup', { error: error.message });
                    await showErrorModal('Erro ao Deletar Backup', error.message);
                }
            };

            // Carregar pasta de backup configurada ao iniciar
            setTimeout(async function() {
                try {
                    const folderId = await apiCall('getSystemBackupFolder');
                    if (folderId) {
                        document.getElementById('backupFolderIdInput').value = folderId;
                        document.getElementById('backupFolderStatus').innerHTML = `
                            <div class="alert alert-success">
                                ‚úÖ Pasta configurada: ${folderId}
                            </div>
                        `;
                    }
                } catch (error) {
                    debugLog('warning', 'N√£o foi poss√≠vel carregar configura√ß√£o de backup', { error: error.message });
                }
            }, 2000);

            // Debug toggle
            document.getElementById('debugToggle').addEventListener('click', function() {
                const panel = document.getElementById('debugPanel');
                panel.style.display = panel.style.display === 'none' || !panel.style.display ? 'block' : 'none';
            });
            
            // Inicializar aplica√ß√£o
            initializeApp();
        });
        
        // === FUN√á√ïES GLOBAIS DE DEBUG ===
        window.debugSystem = function() {
            return {
                systemReady: !!appContext,
                currentRnc: currentRnc,
                availableRncs: availableRncs.length,
                reportData: reportData ? `${reportData.rncs ? reportData.rncs.length : 0} RNCs` : null,
                appContext: appContext ? {
                    email: appContext.email,
                    role: appContext.role,
                    fieldsCount: Object.keys(appContext.fieldsConfig).length,
                    sectionsCount: appContext.sections.length,
                    listsCount: appContext.listNames.length,
                    statusPipeline: appContext.statusPipeline,
                    systemConfig: appContext.systemConfig
                } : null,
                debugLogs: debugLogs.length,
                version: 'Deploy 30 - Corre√ß√µes Cr√≠ticas'
            };
        };
        
        console.log('üöÄ Sistema RNC Deploy 72.3 carregado com TODAS as corre√ß√µes!');
        console.log('‚úÖ Corre√ß√µes implementadas:');
        console.log('  - Campo "Setor onde foi feita abertura" corrigido com \\n');
        console.log('  - Se√ß√£o "Informa√ß√µes da RNC" removida da edi√ß√£o');
        console.log('  - Campos de edi√ß√£o carregam valores reais');
        console.log('  - Kanban inclui cards finalizados');
        console.log('  - Configura√ß√µes com abas restauradas');
        console.log('Debug: window.debugSystem()');

        
console.log('Script carregado completamente!');

// Verificar se fun√ß√µes cr√≠ticas existem
if (typeof initializeApp === 'function') {
    console.log('‚úÖ initializeApp existe');
} else {
    console.error('‚ùå initializeApp N√ÉO existe!');
}

if (typeof saveRnc === 'function') {
    console.log('‚úÖ saveRnc existe');
} else {
    console.error('‚ùå saveRnc N√ÉO existe!');
}

// Tentar inicializar se n√£o foi inicializado
if (typeof appContext === 'undefined' || appContext === null) {
    console.log('Tentando inicializa√ß√£o de emerg√™ncia...');
    initializeApp();
}

// ADICIONE ESTAS FUN√á√ïES OTIMIZADAS no index.html

// === DEBOUNCE PARA EVITAR CHAMADAS EXCESSIVAS ===
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}



// MODIFICAR switchTab existente
function switchTab(tabName) {
    // ‚úÖ NOVO: Limpar arquivos selecionados ao trocar de aba
    selectedFiles = [];
    
    // Remover classe ativa de todas as abas
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Ativar aba selecionada
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    debugLog('info', 'üîÑ Mudando para aba', { tab: tabName, alreadyLoaded: loadedTabs[tabName] });
    
    // === LAZY LOADING - S√ì CARREGAR SE NECESS√ÅRIO ===
    if (!loadedTabs[tabName]) {
        loadedTabs[tabName] = true;
        
        switch (tabName) {
            case 'kanban':
                loadKanban();
                break;
            case 'dashboard':
                loadDashboard();
                break;
            case 'relatorios':
                loadReportFilters();
                break;
            case 'configuracoes':
                loadConfigurations();
                break;
            case 'editar':
                Promise.all([
                    loadSetoresFilter(),
                    loadAvailableRncs()
                ]).then(() => {
                    debugLog('success', '‚úÖ Aba Editar carregada');
                });
                break;
        }
    } else {
        debugLog('info', '‚ö° Aba j√° carregada, pulando');
    }
}
// === SISTEMA DE CACHE (DEPLOY 31) ===
var appCache = {
    rncs: null,
    rncNumbers: null,
    dashboard: null,
    kanban: null,
    reportFilters: null,
    timestamp: {}
};

// ‚úÖ DEPLOY 116 - FASE 5: Cache Duration (estrat√©gia unificada - 5 minutos)
var CACHE_DURATION = 5 * 60 * 1000; // 5 minutos (CONFIG.CACHE.MEDIUM em ms)

function isCacheValid(key) {
    if (!appCache[key]) return false;
    if (!appCache.timestamp[key]) return false;
    
    var age = Date.now() - appCache.timestamp[key];
    return age < CACHE_DURATION;
}

function setCache(key, value) {
    appCache[key] = value;
    appCache.timestamp[key] = Date.now();
    debugLog('info', 'üíæ Cache atualizado', { key: key });
}

function getCache(key) {
    if (isCacheValid(key)) {
        debugLog('info', '‚ö° Usando cache', { key: key });
        return appCache[key];
    }
    return null;
}

function clearCache(key) {
    if (key) {
        appCache[key] = null;
        appCache.timestamp[key] = null;
        debugLog('info', 'üóëÔ∏è Cache limpo', { key: key });
    } else {
        appCache = { timestamp: {} };
        debugLog('info', 'üóëÔ∏è Todo cache limpo');
    }
}

// === FUN√á√ïES DE RECARGA FOR√áADA (Deploy 72.3) ===
async function forceReloadKanban() {
    debugLog('info', 'üîÑ Recarga for√ßada do Kanban');
    clearCache('kanban');
    loadedTabs.kanban = false;
    await loadKanban();
    showSuccess('Kanban atualizado!');
}

async function forceReloadDashboard() {
    debugLog('info', 'üîÑ Recarga for√ßada do Dashboard (BYPASS CACHE BACKEND)');
    // ‚úÖ DEPLOY 109: Limpar cache frontend E backend
    clearCache('dashboard');
    dashboardCache = null;
    dashboardCacheTime = null;
    loadedTabs.dashboard = false;
    // Passar forceRefresh=true para bypass cache do backend
    await refreshDashboard(0, true);
    showSuccess('Dashboard atualizado! Cache limpo.');
}

// === SISTEMA DE INVALIDA√á√ÉO DE CACHE (Deploy 30) ===
function invalidateCache(keys) {
    if (Array.isArray(keys)) {
        keys.forEach(function(key) {
            clearCache(key);
        });
    } else if (keys === 'all') {
        clearCache();
    }
    
    debugLog('info', 'üóëÔ∏è Cache invalidado', { keys: keys });
}

// === ATUALIZAR ABAS AUTOMATICAMENTE ===
function refreshActiveTab() {
    var activeTab = document.querySelector('.tab.active');
    if (!activeTab) return;
    
    var tabName = activeTab.dataset.tab;
    debugLog('info', 'üîÑ Atualizando aba ativa', { tab: tabName });
    
    // For√ßar recarregamento
    loadedTabs[tabName] = false;
    switchTab(tabName);
}

// === SISTEMA DE INVALIDA√á√ÉO DE CACHE (Deploy 30) ===
function invalidateCache(keys) {
    if (Array.isArray(keys)) {
        keys.forEach(function(key) {
            clearCache(key);
        });
    } else if (keys === 'all') {
        clearCache();
    }
    
    debugLog('info', 'üóëÔ∏è Cache invalidado', { keys: keys });
}

// === ATUALIZAR ABAS AUTOMATICAMENTE ===
function refreshActiveTab() {
    var activeTab = document.querySelector('.tab.active');
    if (!activeTab) return;
    
    var tabName = activeTab.dataset.tab;
    debugLog('info', 'üîÑ Atualizando aba ativa', { tab: tabName });
    
    // For√ßar recarregamento
    loadedTabs[tabName] = false;
    switchTab(tabName);
}

// ==========================================
// FUN√á√ïES DE FILTRO POR SETOR - KANBAN
// ==========================================

async function loadSetoresFilterKanban() {
    try {
        const setorFilter = document.getElementById('setorFilterKanban');
        if (!setorFilter) return;
        
        const setores = await apiCall('getSetoresUnicos', []);
        
        setorFilter.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
        
        if (setores && setores.length > 0) {
            setores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = `üè¢ ${setor}`;
                setorFilter.appendChild(option);
            });
        }
        
        setorFilter.addEventListener('change', function() {
            refreshKanban();
        });
        
    } catch (error) {
        debugLog('error', 'Erro ao carregar setores Kanban');
    }
}

/**
 * Renderiza badges de roles do usu√°rio
 * Deploy 32 - Sistema de Permiss√µes
 */
function renderUserRoles() {
    const rolesContainer = document.getElementById('userRoles');
    
    if (!appContext || !appContext.roles || !rolesContainer) {
        return;
    }
    
    const roleColors = {
        'Admin': 'admin',
        'Abertura': 'abertura',
        'Qualidade': 'qualidade',
        'Lideran√ßa': 'lideranca',
        'Espectador': 'espectador'
    };
    
    const rolesHtml = appContext.roles.map(role => {
        const colorClass = roleColors[role] || '';
        return `<span class="role-badge ${colorClass}">${role}</span>`;
    }).join('');
    
    rolesContainer.innerHTML = rolesHtml;

    debugLog('info', 'üé≠ Roles do usu√°rio renderizadas', {
        roles: appContext.roles.join(', ')
    });
}

/**
 * Inicializa a se√ß√£o de ajuda com conte√∫do personalizado
 * Deploy 75.4 - Manual de Ajuda Expandido
 */
function initializeHelpSection() {
    if (!appContext) {
        console.warn('‚ö†Ô∏è appContext n√£o dispon√≠vel para inicializar se√ß√£o de ajuda');
        return;
    }

    try {
        // 1. Mostrar/Ocultar se√ß√£o de administrador
        const adminSections = document.querySelectorAll('.admin-only-section');
        if (appContext.isAdmin) {
            console.log('‚úÖ Usu√°rio √© ADMIN - Mostrando manual do administrador');
            adminSections.forEach(section => {
                section.style.display = 'block';
            });
        } else {
            console.log('‚ÑπÔ∏è Usu√°rio n√£o √© admin - Ocultando manual do administrador');
            adminSections.forEach(section => {
                section.style.display = 'none';
            });
        }

        // 2. Preencher badge de n√≠vel de acesso
        const helpAccessBadge = document.getElementById('helpAccessBadge');
        if (helpAccessBadge) {
            const isAdmin = appContext.isAdmin;
            const badgeHtml = isAdmin
                ? `<div style="display: inline-block; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                       <span style="font-size: 1.2rem;">üëë</span> Voc√™ tem acesso <strong>ADMINISTRADOR</strong> ao sistema
                   </div>`
                : `<div style="display: inline-block; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #42a5f5 0%, #478ed1 100%); color: white; border-radius: 20px; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                       <span style="font-size: 1.2rem;">üë§</span> N√≠vel de acesso: <strong>${appContext.roles.join(', ')}</strong>
                   </div>`;
            helpAccessBadge.innerHTML = badgeHtml;
        }

        // 3. Preencher informa√ß√µes de vers√£o
        const helpVersionInfo = document.getElementById('helpVersionInfo');
        if (helpVersionInfo) {
            // Usar vers√£o do appContext ou string padr√£o
            helpVersionInfo.textContent = 'Sistema RNC v2.4 - Deploy 123';
        }

        debugLog('info', 'üìñ Se√ß√£o de ajuda inicializada', {
            isAdmin: appContext.isAdmin,
            roles: appContext.roles.join(', ')
        });

    } catch (error) {
        console.error('‚ùå Erro ao inicializar se√ß√£o de ajuda:', error);
        debugLog('error', 'Erro ao inicializar se√ß√£o de ajuda', { error: error.message });
    }
}

// ==========================================
// GERENCIAMENTO DE USU√ÅRIOS - Deploy 32
// ==========================================

/**
 * Carrega e renderiza lista de usu√°rios
 */
/**
 * Carrega e renderiza lista de usu√°rios
 * Deploy 32 - UI Refresh
 */
/**
 * Carrega e renderiza lista de usu√°rios
 * Deploy 32 - Grid Padronizado
 */
async function loadUsers() {
    try {
        debugLog('info', 'üë• Carregando usu√°rios');
        
        const container = document.getElementById('users-container');
        
        if (!container) {
            debugLog('error', '‚ùå Container users-container n√£o encontrado');
            return;
        }
        
        // Mostrar loading
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
                Carregando usu√°rios...
            </div>
        `;
        
        const users = await apiCall('getAllUsers');
        
        renderUsersTable(users);
        
        debugLog('success', '‚úÖ Usu√°rios carregados', { count: users.length });
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar usu√°rios', { error: error.message });
        
        const container = document.getElementById('users-container');
        if (container) {
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 15px; color: #F44336;">‚ö†Ô∏è</div>
                    <div style="color: #F44336; font-size: 16px; margin-bottom: 15px;">
                        Erro ao carregar usu√°rios
                    </div>
                    <div style="color: #666; font-size: 14px; margin-bottom: 20px;">
                        ${error.message}
                    </div>
                    <button onclick="loadUsers()" class="btn btn-primary">
                        üîÑ Tentar Novamente
                    </button>
                </div>
            `;
        }
    }
}

/**
 * Renderiza cards de usu√°rios - VERS√ÉO COMPACTA
 * Deploy 33 - Layout Otimizado
 */
function renderUsersTable(users) {
    const container = document.getElementById('users-container');
    
    if (!container) {
        debugLog('error', 'Container users-container n√£o encontrado');
        return;
    }
    
    const roleColors = {
        'Admin': 'admin',
        'Abertura': 'abertura',
        'Qualidade': 'qualidade',
        'Lideran√ßa': 'lideranca',
        'Espectador': 'espectador'
    };
    
    // Se n√£o houver usu√°rios
    if (!users || users.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                <div style="color: #999; font-size: 16px;">Nenhum usu√°rio cadastrado</div>
                <button onclick="document.getElementById('addNewUser').click()" class="btn btn-primary" style="margin-top: 20px;">
                    ‚ûï Adicionar Primeiro Usu√°rio
                </button>
            </div>
        `;
        return;
    }
    
    // ‚ú® NOVO: Cards compactos
    const usersHtml = users.map(user => {
        const isAdmin = user.roles.indexOf('Admin') !== -1;
        
        // Badge "VOC√ä" inline
        const youBadge = user.email === appContext.email 
            ? '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 6px; font-weight: bold;">VOC√ä</span>' 
            : '';
        
        // Roles inline (badges menores)
        const rolesBadges = user.roles.map(role => {
            const colorClass = roleColors[role] || '';
            return `<span class="role-badge ${colorClass}" style="font-size: 10px; padding: 2px 6px;">${role}</span>`;
        }).join(' ');
        
        return `
            <div style="
                background: white;
                border: 1px solid #e5e7eb;
                border-left: 3px solid ${isAdmin ? '#F44336' : '#009688'};
                border-radius: 8px;
                padding: 12px;
                transition: all 0.2s ease;
                cursor: pointer;
            " onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)';">
                
                <!-- Email + Badge VOC√ä -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <div style="font-size: 13px; font-weight: 500; color: #1e1e1e; display: flex; align-items: center;">
                        üìß <span style="margin-left: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;" title="${user.email}">${user.email}</span>
                        ${youBadge}
                    </div>
                </div>

                <!-- Setor do Usu√°rio -->
                ${user.setor ? `
                    <div style="font-size: 11px; color: #2196F3; margin-bottom: 8px; display: flex; align-items: center; gap: 4px;">
                        üè¢ <span style="font-weight: 500;">${user.setor}</span>
                    </div>
                ` : ''}

                <!-- Roles (badges inline) -->
                <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px;">
                    ${rolesBadges}
                </div>
                
                <!-- Bot√µes de a√ß√£o (inline) -->
                <div style="display: flex; gap: 6px; padding-top: 8px; border-top: 1px solid #f0f0f0;">
                    <button onclick="editUserRoles('${user.email}')" style="
                        flex: 1;
                        padding: 6px 10px;
                        font-size: 11px;
                        border: 1px solid #009688;
                        background: white;
                        color: #009688;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#009688'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='#009688';">
                        ‚úèÔ∏è Editar
                    </button>
                    
                    ${!isAdmin || user.email !== appContext.email ? `
                        <button onclick="confirmDeleteUser('${user.email}')" style="
                            flex: 1;
                            padding: 6px 10px;
                            font-size: 11px;
                            border: 1px solid #F44336;
                            background: white;
                            color: #F44336;
                            border-radius: 4px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='#F44336'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='#F44336';">
                            üóëÔ∏è Deletar
                        </button>
                    ` : `
                        <button disabled style="
                            flex: 1;
                            padding: 6px 10px;
                            font-size: 11px;
                            border: 1px solid #ddd;
                            background: #f5f5f5;
                            color: #999;
                            border-radius: 4px;
                            cursor: not-allowed;
                        ">
                            üîí Protegido
                        </button>
                    `}
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = usersHtml;
    
    debugLog('success', `‚úÖ ${users.length} usu√°rios renderizados (layout compacto)`);
}

function closeAddUserModal() {
    const modal = document.getElementById('addUserModal');
    if (modal) modal.remove();
}

async function saveNewUser() {
    try {
        const email = document.getElementById('newUserEmail').value.trim();
        // Deploy 124: Obter ARRAY de setores selecionados dos chips
        const setores = getSelectedSetores('newUserSetorChips');

        if (!email) {
            await showErrorModal('Campo Obrigat√≥rio', 'Digite um email v√°lido.');
            return;
        }

        // Validar formato de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            await showErrorModal('Email Inv√°lido', 'Por favor, digite um endere√ßo de email v√°lido (exemplo: usuario@empresa.com)');
            return;
        }

        // Deploy 124: Validar se pelo menos um setor foi selecionado
        if (setores.length === 0) {
            await showErrorModal('Campo Obrigat√≥rio', 'Selecione pelo menos um setor para o usu√°rio.');
            return;
        }

        // Coletar roles selecionadas
        const selectedRoles = [];

        if (document.getElementById('role_admin').checked) selectedRoles.push('Admin');
        if (document.getElementById('role_abertura').checked) selectedRoles.push('Abertura');
        if (document.getElementById('role_qualidade').checked) selectedRoles.push('Qualidade');
        if (document.getElementById('role_lideranca').checked) selectedRoles.push('Lideran√ßa');
        if (document.getElementById('role_espectador').checked) selectedRoles.push('Espectador');

        if (selectedRoles.length === 0) {
            await showErrorModal('Permiss√µes Obrigat√≥rias', 'Selecione pelo menos uma role (permiss√£o) para o usu√°rio.');
            return;
        }

        showLoading('Adicionando usu√°rio...');

        // Deploy 124: Adicionar cada role para CADA setor selecionado
        for (let i = 0; i < selectedRoles.length; i++) {
            // Passar ARRAY de setores (backend aceitar√° e armazenar√° como "Setor1;Setor2")
            const result = await apiCall('addUserRole', [email, selectedRoles[i], setores]);

            if (!result.success && !result.message.includes('j√° possui')) {
                throw new Error(result.message);
            }
        }

        hideLoading();

        // Deploy 124: Modal de sucesso com m√∫ltiplos setores
        const setoresText = setores.join(', ');
        const rolesText = selectedRoles.join(', ');

        await showConfigSuccessModal(
            'Usu√°rio Adicionado com Sucesso',
            `<strong>Email:</strong> ${email}<br>
             <strong>Setores:</strong> ${setoresText}<br>
             <strong>Permiss√µes:</strong> ${rolesText}`
        );

        closeAddUserModal();
        loadUsers();

    } catch (error) {
        debugLog('error', '‚ùå Erro ao adicionar usu√°rio', { error: error.message });
        hideLoading();
        await showErrorModal('Erro ao Adicionar Usu√°rio', error.message);
    }
}

/**
 * Editar roles de um usu√°rio
 */
/**
 * Editar roles de um usu√°rio - VERS√ÉO CORRIGIDA
 */
async function editUserRoles(email) {
    try {
        debugLog('info', '‚úèÔ∏è Editando roles do usu√°rio', { email });
        
        showLoading('Carregando roles do usu√°rio...');
        
        const users = await apiCall('getAllUsers');
        const user = users.find(u => u.email === email);
        
        if (!user) {
            showError('Usu√°rio n√£o encontrado');
            hideLoading();
            return;
        }
        
        hideLoading();
        
        // ‚úÖ CORRE√á√ÉO: Salvar roles no window para evitar problemas com JSON
        window.currentEditingUserRoles = user.roles;
        
        const modalHtml = `
            <div id="editUserRolesModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 1rem; color: #009688;">‚úèÔ∏è Editar Roles de ${email}</h3>

                    <div class="form-group">
                        <label>üè¢ Setor(es) do Usu√°rio</label>
                        <div class="multiselect-wrapper">
                            <!-- Container de chips selecionados -->
                            <div class="chips-container" id="editUserSetorChips" style="min-height: 50px; background: #ffffff; border: 1px solid #ddd; border-radius: 4px; padding: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                                <span style="color: #999; font-size: 13px; font-style: italic;">Nenhum setor selecionado</span>
                            </div>
                            <!-- Dropdown de sele√ß√£o -->
                            <select id="editUserSetor" class="form-control" style="margin-top: 8px;" onchange="addSetorChipToEdit(this)">
                                <option value="">‚ûï Adicionar setor...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>üé≠ Roles Ativas</label>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="edit_role_admin" value="Admin" ${user.roles.indexOf('Admin') !== -1 ? 'checked' : ''}>
                                <span class="role-badge admin">Admin</span>
                                <span style="font-size: 13px; color: #666;">Acesso total</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="edit_role_abertura" value="Abertura" ${user.roles.indexOf('Abertura') !== -1 ? 'checked' : ''}>
                                <span class="role-badge abertura">Abertura</span>
                                <span style="font-size: 13px; color: #666;">Criar RNCs</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="edit_role_qualidade" value="Qualidade" ${user.roles.indexOf('Qualidade') !== -1 ? 'checked' : ''}>
                                <span class="role-badge qualidade">Qualidade</span>
                                <span style="font-size: 13px; color: #666;">Editar Qualidade</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="edit_role_lideranca" value="Lideran√ßa" ${user.roles.indexOf('Lideran√ßa') !== -1 ? 'checked' : ''}>
                                <span class="role-badge lideranca">Lideran√ßa</span>
                                <span style="font-size: 13px; color: #666;">Editar Lideran√ßa</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="edit_role_espectador" value="Espectador" ${user.roles.indexOf('Espectador') !== -1 ? 'checked' : ''}>
                                <span class="role-badge espectador">Espectador</span>
                                <span style="font-size: 13px; color: #666;">Visualizar</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 30px;">
                        <button onclick="closeEditUserRolesModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="saveUserRolesFixed('${email}')" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Deploy 124: Carregar setores e popular chips com setores atuais do usu√°rio
        (async function loadSetoresForEditUser() {
            try {
                // Deploy 68: Buscar setores da planilha Listas
                const response = await apiCall('getSetoresFromListas', []);
                const setores = response && response.data ? response.data : response;
                // Deploy 124: Usar setor(es) do objeto user que j√° foi carregado (pode ser string ou array)
                const currentSetor = user.setor || '';

                debugLog('info', 'Carregando setores para edi√ß√£o', {
                    email: email,
                    currentSetor: currentSetor,
                    totalSetores: setores.length
                });

                const setorSelect = document.getElementById('editUserSetor');

                if (setorSelect && setores && setores.length > 0) {
                    // Deploy 124: Usar placeholder para adicionar setores (n√£o pr√©-selecionar)
                    setorSelect.innerHTML = '<option value="">‚ûï Adicionar setor...</option>';
                    setores.forEach(function(setor) {
                        const option = document.createElement('option');
                        option.value = setor;
                        option.textContent = setor;
                        setorSelect.appendChild(option);
                    });

                    // Deploy 124: Popular chips com setores atuais do usu√°rio
                    populateSetorChips(currentSetor, 'editUserSetorChips', 'editUserSetor');

                    debugLog('info', '‚úÖ Chips populados com setores atuais', { setores: currentSetor });
                } else if (setorSelect) {
                    setorSelect.innerHTML = '<option value="">Nenhum setor dispon√≠vel</option>';
                }
            } catch (error) {
                debugLog('error', 'Erro ao carregar setores para edi√ß√£o', { error: error.message });
                const setorSelect = document.getElementById('editUserSetor');
                if (setorSelect) {
                    setorSelect.innerHTML = '<option value="">Erro ao carregar setores</option>';
                }
            }
        })();

    } catch (error) {
        debugLog('error', '‚ùå Erro ao editar roles', { error: error.message });
        showError('Erro ao carregar roles: ' + error.message);
        hideLoading();
    }
}

/**
 * Salvar roles do usu√°rio - VERS√ÉO CORRIGIDA
 */
async function saveUserRolesFixed(email) {
    try {
        showLoading('Salvando altera√ß√µes...');

        // Deploy 124: Obter ARRAY de setores selecionados dos chips
        const newSetores = getSelectedSetores('editUserSetorChips');

        if (newSetores.length === 0) {
            hideLoading();
            await showErrorModal('Campo Obrigat√≥rio', 'Selecione pelo menos um setor para o usu√°rio.');
            return;
        }

        // Coletar novas roles
        const newRoles = [];

        if (document.getElementById('edit_role_admin').checked) newRoles.push('Admin');
        if (document.getElementById('edit_role_abertura').checked) newRoles.push('Abertura');
        if (document.getElementById('edit_role_qualidade').checked) newRoles.push('Qualidade');
        if (document.getElementById('edit_role_lideranca').checked) newRoles.push('Lideran√ßa');
        if (document.getElementById('edit_role_espectador').checked) newRoles.push('Espectador');

        if (newRoles.length === 0) {
            hideLoading();
            await showErrorModal('Permiss√µes Obrigat√≥rias', 'O usu√°rio deve ter pelo menos uma role (permiss√£o).');
            return;
        }

        // ‚úÖ USAR ROLES SALVAS NO WINDOW
        const oldRoles = window.currentEditingUserRoles || [];

        // Deploy 124: Atualizar setores primeiro (passar ARRAY)
        const setorResult = await apiCall('updateUserSetor', [email, newSetores]);
        if (!setorResult.success) {
            throw new Error('Erro ao atualizar setores: ' + setorResult.message);
        }
        debugLog('info', `üè¢ Setores atualizados: ${newSetores.join(', ')}`);

        // Remover roles antigas que n√£o est√£o mais selecionadas
        for (let i = 0; i < oldRoles.length; i++) {
            if (newRoles.indexOf(oldRoles[i]) === -1) {
                await apiCall('removeUserRole', [email, oldRoles[i]]);
                debugLog('info', `üóëÔ∏è Role removida: ${oldRoles[i]}`);
            }
        }

        // Deploy 124: Adicionar novas roles COM array de setores
        for (let i = 0; i < newRoles.length; i++) {
            if (oldRoles.indexOf(newRoles[i]) === -1) {
                await apiCall('addUserRole', [email, newRoles[i], newSetores]);
                debugLog('info', `‚ûï Role adicionada: ${newRoles[i]}`);
            }
        }

        hideLoading();

        // Deploy 124: Modal de sucesso com m√∫ltiplos setores
        const setoresText = newSetores.join(', ');
        const rolesText = newRoles.join(', ');

        await showConfigSuccessModal(
            'Usu√°rio Atualizado com Sucesso',
            `<strong>Email:</strong> ${email}<br>
             <strong>Setores:</strong> ${setoresText}<br>
             <strong>Permiss√µes:</strong> ${rolesText}`
        );

        closeEditUserRolesModal();
        loadUsers();

        // Limpar vari√°vel tempor√°ria
        delete window.currentEditingUserRoles;

        // Se for o pr√≥prio usu√°rio, recarregar p√°gina
        if (email === appContext.email) {
            await showErrorModal('Aten√ß√£o', 'Suas permiss√µes foram alteradas. A p√°gina ser√° recarregada.');
            setTimeout(() => location.reload(), window.NeoRNC.constants.RELOAD_DELAY);
        }

    } catch (error) {
        debugLog('error', '‚ùå Erro ao salvar roles', { error: error.message });
        hideLoading();
        await showErrorModal('Erro ao Salvar Permiss√µes', error.message);
    }
}


function closeEditUserRolesModal() {
    const modal = document.getElementById('editUserRolesModal');
    if (modal) modal.remove();
    
    // Limpar vari√°vel tempor√°ria
    if (window.currentEditingUserRoles) {
        delete window.currentEditingUserRoles;
    }
}

async function saveUserRoles(email, oldRoles) {
    try {
        showLoading('Salvando roles...');
        
        // Coletar novas roles
        const newRoles = [];
        
        if (document.getElementById('edit_role_admin').checked) newRoles.push('Admin');
        if (document.getElementById('edit_role_abertura').checked) newRoles.push('Abertura');
        if (document.getElementById('edit_role_qualidade').checked) newRoles.push('Qualidade');
        if (document.getElementById('edit_role_lideranca').checked) newRoles.push('Lideran√ßa');
        if (document.getElementById('edit_role_espectador').checked) newRoles.push('Espectador');
        
        if (newRoles.length === 0) {
            hideLoading();
            await showErrorModal('Permiss√µes Obrigat√≥rias', 'O usu√°rio deve ter pelo menos uma role (permiss√£o).');
            return;
        }

        // Remover roles antigas que n√£o est√£o mais selecionadas
        for (let i = 0; i < oldRoles.length; i++) {
            if (newRoles.indexOf(oldRoles[i]) === -1) {
                await apiCall('removeUserRole', [email, oldRoles[i]]);
            }
        }

        // Adicionar novas roles
        for (let i = 0; i < newRoles.length; i++) {
            if (oldRoles.indexOf(newRoles[i]) === -1) {
                await apiCall('addUserRole', [email, newRoles[i]]);
            }
        }

        showSuccess('‚úÖ Roles atualizadas com sucesso!');

        closeEditUserRolesModal();
        loadUsers();
        hideLoading();

        // Se for o pr√≥prio usu√°rio, recarregar p√°gina
        if (email === appContext.email) {
            showInfo('Suas permiss√µes foram alteradas. Recarregando p√°gina...');
            setTimeout(() => location.reload(), window.NeoRNC.constants.RELOAD_DELAY);
        }

    } catch (error) {
        debugLog('error', '‚ùå Erro ao salvar roles', { error: error.message });
        hideLoading();
        await showErrorModal('Erro ao Salvar Permiss√µes', error.message);
    }
}

/**
 * Confirmar remo√ß√£o de usu√°rio
 * Deploy 124 PARTE 5: Modal HTML de confirma√ß√£o
 */
async function confirmDeleteUser(email) {
    if (email === appContext.email) {
        await showErrorModal('Opera√ß√£o N√£o Permitida', 'Voc√™ n√£o pode remover a si mesmo!');
        return;
    }

    // Deploy 124: Usar modal HTML ao inv√©s de confirm() nativo
    const confirmed = await showConfirmModal(
        '‚ö†Ô∏è Confirmar Remo√ß√£o de Usu√°rio',
        `Deseja realmente remover TODAS as permiss√µes do usu√°rio:<br><br>
        <strong>${email}</strong><br><br>
        <span style="color: #F44336; font-weight: 600;">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!</span>`
    );

    if (confirmed) {
        await deleteUser(email);
    }
}

async function deleteUser(email) {
    try {
        showLoading('Removendo usu√°rio...');
        
        // Buscar todas as roles do usu√°rio
        const users = await apiCall('getAllUsers');
        const user = users.find(u => u.email === email);
        
        if (!user) {
            hideLoading();
            await showErrorModal('Usu√°rio N√£o Encontrado', 'O usu√°rio especificado n√£o foi encontrado no sistema.');
            return;
        }

        // Remover todas as roles
        for (let i = 0; i < user.roles.length; i++) {
            await apiCall('removeUserRole', [email, user.roles[i]]);
        }

        hideLoading();

        // Deploy 124: Modal de sucesso
        await showConfigSuccessModal(
            'Usu√°rio Removido',
            `<strong>Email:</strong> ${email}<br>
             <strong>Permiss√µes removidas:</strong> ${user.roles.length}`
        );

        loadUsers();

    } catch (error) {
        debugLog('error', '‚ùå Erro ao remover usu√°rio', { error: error.message });
        hideLoading();
        await showErrorModal('Erro ao Remover Usu√°rio', error.message);
    }
}

/**
 * Recarrega contexto e atualiza formul√°rios
 * Deploy 72.3 - VERS√ÉO CORRIGIDA FINAL
 */
function reloadContextAndForms() {
  try {
    console.log('üîµ [INICIO] reloadContextAndForms()');
    debugLog('info', 'üîÑ Recarregando contexto e formul√°rios...');
    showLoading('Atualizando configura√ß√µes...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('üîµ result.success:', result.success);
        
        if (result.success) {
          // ‚úÖ Atualizar contexto global
          appContext = result.context;
          console.log('üîµ appContext atualizado - Campos:', Object.keys(appContext.fieldsConfig).length);
          
          debugLog('success', '‚úÖ Contexto recarregado', {
              email: appContext.email,
              fieldsCount: Object.keys(appContext.fieldsConfig).length,
              listsCount: Object.keys(appContext.lists).length
          });
          
          // ‚úÖ Atualizar listas em todos os selects
          console.log('üîµ Atualizando listas...');
          Object.keys(appContext.lists).forEach(function(listName) {
              var selects = document.querySelectorAll('select[data-list="' + listName + '"]');
              selects.forEach(function(select) {
                  var currentValue = select.value;
                  select.innerHTML = '<option value="">Selecione...</option>';
                  appContext.lists[listName].forEach(function(item) {
                      var option = document.createElement('option');
                      option.value = item;
                      option.textContent = item;
                      if (item === currentValue) option.selected = true;
                      select.appendChild(option);
                  });
              });
          });
          
          // ‚úÖ CORRE√á√ÉO: For√ßar re-renderiza√ß√£o da aba ativa
          console.log('üîµ Verificando aba ativa...');
          
          // Buscar pela classe 'active' nas abas de conte√∫do
          var abrirContent = document.getElementById('tab-abrir');
          var editarContent = document.getElementById('tab-editar');
          
          console.log('  - #tab-abrir encontrado:', !!abrirContent);
          console.log('  - #tab-editar encontrado:', !!editarContent);
          
          if (abrirContent && abrirContent.classList.contains('active')) {
              console.log('  ‚úÖ ABA ABRIR ATIVA - RE-RENDERIZANDO');
              renderAberturaForm();
              console.log('  ‚úÖ Formul√°rio Abrir re-renderizado!');
          } else {
              console.log('  ‚ö†Ô∏è Aba Abrir N√ÉO est√° ativa');
          }
          
          if (editarContent && editarContent.classList.contains('active')) {
              console.log('  ‚úÖ ABA EDITAR ATIVA - RE-RENDERIZANDO');
              if (typeof window.currentRnc !== 'undefined' && window.currentRnc && window.currentRnc['N¬∫ RNC']) {
                  console.log('  - RNC carregada:', window.currentRnc['N¬∫ RNC']);
                  loadRncForEdit(window.currentRnc['N¬∫ RNC']);
                  console.log('  ‚úÖ Formul√°rio Editar re-renderizado!');
              } else {
                  console.log('  ‚ö†Ô∏è Nenhuma RNC carregada');
              }
          } else {
              console.log('  ‚ö†Ô∏è Aba Editar N√ÉO est√° ativa');
          }
          
          console.log('üü¢ [FIM] Processo completo!');
          showSuccess('‚úÖ Formul√°rios atualizados!');
          hideLoading();
          
        } else {
          console.error('üî¥ result.success = false');
          showError('Erro ao recarregar: ' + result.error);
          hideLoading();
        }
      })
      .withFailureHandler(function(error) {
        console.error('üî¥ Erro:', error);
        showError('Erro ao recarregar: ' + error);
        hideLoading();
      })
      .reloadUserContext();
      
  } catch (error) {
    console.error('üî¥ Exce√ß√£o:', error.message);
    debugLog('error', '‚ùå Erro ao recarregar', { error: error.message });
    showError('Erro: ' + error.message);
    hideLoading();
  }
}

/**
 * Atualiza abas sem recarregar p√°gina
 * Deploy 44 - Corre√ß√£o para aba Abrir RNC
 */
/**
 * Atualiza TODAS as abas ap√≥s mudan√ßa de configura√ß√£o
 * Deploy 45 - For√ßa atualiza√ß√£o mesmo se aba n√£o estiver ativa
 */
function reloadPageAfterConfigChange(action, itemName, delayMs) {
    var messages = {
        'created': '‚úÖ Campo criado: "' + itemName + '"',
        'updated': '‚úÖ Campo atualizado: "' + itemName + '"',
        'deleted': '‚úÖ Campo removido: "' + itemName + '"'
    };
    
    console.log('üîÑ [NO-RELOAD] Atualizando TODAS as abas (ativas ou n√£o)');
    
    // Fechar modais
    document.querySelectorAll('[id$="Modal"]').forEach(function(modal) {
        if (modal && modal.parentNode) modal.remove();
    });
    
    // Esconder loading
    var loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) loadingOverlay.classList.add('hidden');
    
    // Mensagem de sucesso
    showSuccess(messages[action] + ' - Atualizando formul√°rios...');
    
    // ‚úÖ FOR√áAR RELOAD DO CONTEXTO
    showLoading('Atualizando configura√ß√µes...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('üîµ [UPDATE] Callback recebido');
            
            if (result.success) {
                console.log('‚úÖ [UPDATE] Contexto recarregado');
                
                // ‚úÖ ATUALIZAR CONTEXTO GLOBAL
                appContext = result.context;
                
                console.log('‚úÖ [UPDATE] appContext atualizado');
                console.log('üì¶ [UPDATE] Campos:', Object.keys(appContext.fieldsConfig));
                
                // ‚úÖ RESETAR CACHE DE ABAS (for√ßar re-renderiza√ß√£o na pr√≥xima vez)
                console.log('üîÑ [UPDATE] Resetando cache de abas');
                loadedTabs.abrir = false;
                loadedTabs.editar = false;
                
                // ‚úÖ FOR√áAR RE-RENDERIZA√á√ÉO DA ABA ABRIR (SEMPRE, MESMO SE N√ÉO ATIVA)
                console.log('üìù [UPDATE] FOR√áANDO re-renderiza√ß√£o da aba Abrir');
                try {
                    renderAberturaForm();
                    console.log('‚úÖ [UPDATE] Aba Abrir re-renderizada com sucesso');
                } catch (error) {
                    console.error('‚ùå [UPDATE] Erro ao re-renderizar Abrir:', error);
                }
                
                // ‚úÖ SE ABA EDITAR EST√Å ATIVA E TEM RNC CARREGADA, RE-RENDERIZAR
                var editarContent = document.getElementById('tab-editar');
                if (editarContent && editarContent.classList.contains('active')) {
                    console.log('‚úèÔ∏è [UPDATE] Aba Editar est√° ativa');
                    
                    if (window.currentRnc && window.currentRnc['N¬∫ RNC']) {
                        console.log('üîÑ [UPDATE] Re-renderizando Editar com RNC:', window.currentRnc['N¬∫ RNC']);
                        try {
                            loadRncForEdit(window.currentRnc['N¬∫ RNC']);
                            console.log('‚úÖ [UPDATE] Aba Editar re-renderizada');
                        } catch (error) {
                            console.error('‚ùå [UPDATE] Erro ao re-renderizar Editar:', error);
                        }
                    } else {
                        console.log('‚ö†Ô∏è [UPDATE] Nenhuma RNC carregada');
                    }
                } else {
                    console.log('‚ö†Ô∏è [UPDATE] Aba Editar n√£o est√° ativa, mas cache resetado para pr√≥xima vez');
                }
                
                // ‚úÖ RECARREGAR CONFIGURA√á√ïES
                console.log('‚öôÔ∏è [UPDATE] Recarregando configura√ß√µes');
                loadConfigurations();
                
                hideLoading();
                showSuccess('‚úÖ Formul√°rios atualizados! As abas Abrir e Editar foram atualizadas.');
                
                console.log('üü¢ [UPDATE] Processo conclu√≠do');
                
            } else {
                console.error('‚ùå [UPDATE] result.success = false');
                hideLoading();
                showError('Erro ao atualizar: ' + result.error);
            }
        })
        .withFailureHandler(function(error) {
            console.error('üî¥ [UPDATE] Erro:', error);
            hideLoading();
            showError('Erro ao atualizar: ' + error);
        })
        .reloadUserContext();
}

/**
 * Detecta e corrige tela branca
 * Deploy 41 - Prote√ß√£o contra travamento
 */
window.addEventListener('load', function() {
    console.log('‚úÖ P√°gina carregada completamente');
    
    // Se ap√≥s 5 segundos o body estiver vazio, recarregar
    setTimeout(function() {
        if (document.body.children.length < 3) {
            console.warn('‚ö†Ô∏è Tela branca detectada, for√ßando reload');
            location.reload();
        }
    }, 5000);
});

// Detectar erros de carregamento
window.addEventListener('error', function(e) {
    console.error('‚ùå Erro de carregamento:', e.message);
    
    // Se for erro cr√≠tico, tentar recarregar
    if (e.message.includes('script') || e.message.includes('load')) {
        console.warn('‚ö†Ô∏è Erro cr√≠tico, tentando recarregar em 3 segundos...');
        setTimeout(function() {
            location.reload();
        }, 3000);
    }
});



function updateActiveFormSections() {
  try {
    debugLog('info', 'üîÑ Atualizando se√ß√µes ativas de formul√°rios');
    
    // Verificar se est√° na aba "Abrir RNC"
    var abrirTab = document.querySelector('[data-tab="tab-abrir"]');
    if (abrirTab && abrirTab.classList.contains('active')) {
      debugLog('info', 'üìù Atualizando formul√°rio de Abrir RNC');
      renderAberturaForm();
    }
    
    // Verificar se est√° na aba "Editar RNC"
    var editarTab = document.querySelector('[data-tab="tab-editar"]');
    if (editarTab && editarTab.classList.contains('active')) {
      debugLog('info', '‚úèÔ∏è Atualizando formul√°rio de Editar RNC');
      
      // Se h√° uma RNC carregada, recarregar o formul√°rio completo
      if (typeof window.currentRnc !== 'undefined' && window.currentRnc && window.currentRnc['N¬∫ RNC']) {
        loadRncForEdit(window.currentRnc['N¬∫ RNC']);
      } else {
        // Apenas atualizar as se√ß√µes dispon√≠veis
        var sections = appContext.sections || [];
        for (var i = 0; i < sections.length; i++) {
          var section = sections[i];
          if (section.ativo === 'Sim') {
            var sectionFields = appContext.fieldsConfig[section.nome] || [];
            if (sectionFields.length > 0) {
              var containerId = section.nome.toLowerCase().replace(/\s+/g, '-') + '-form';
              var container = document.getElementById(containerId);
              if (container) {
                debugLog('info', 'üîÑ Atualizando se√ß√£o: ' + section.nome);
                // Renderizar campos da se√ß√£o
                renderFormSection(container, sectionFields, section.nome);
              }
            }
          }
        }
      }
    }
    
    debugLog('success', '‚úÖ Formul√°rios atualizados com sucesso');
    
  } catch (error) {
    debugLog('error', '‚ùå Erro ao atualizar formul√°rios', { error: error.message });
  }
}

/**
 * Renderiza uma se√ß√£o espec√≠fica do formul√°rio
 * Deploy 30 - Fun√ß√£o auxiliar para atualiza√ß√£o de se√ß√µes
 */
function renderFormSection(container, fields, sectionName) {
  try {
    if (!container || !fields || fields.length === 0) {
      debugLog('warning', 'Container ou campos inv√°lidos para se√ß√£o', { sectionName: sectionName });
      return;
    }
    
    // Verificar permiss√£o para a se√ß√£o
    var permission = appContext.permissions[sectionName] || 'visualizar';
    
    if (permission === 'negar') {
      container.innerHTML = '<div class="alert alert-warning">üîí Sem permiss√£o para visualizar esta se√ß√£o</div>';
      return;
    }
    
    // Renderizar campos
    var fieldsHtml = fields.map(function(field) {
      var currentValue = '';
      
      // Se existe uma RNC carregada, buscar o valor atual
      if (typeof window.currentRnc !== 'undefined' && window.currentRnc) {
        currentValue = window.currentRnc[field.name] || '';
      }
      
      return renderField(field, currentValue, sectionName);
    }).join('');
    
    container.innerHTML = `
      <div class="form-section">
        <h3>üìã ${sectionName}</h3>
        <div class="form-grid">
          ${fieldsHtml}
        </div>
      </div>
    `;
    
    debugLog('success', 'Se√ß√£o renderizada', { 
      section: sectionName, 
      fieldsCount: fields.length 
    });
    
  } catch (error) {
    debugLog('error', 'Erro ao renderizar se√ß√£o', { 
      section: sectionName, 
      error: error.message 
    });
  }
}

// ========================================
// SISTEMA MULTISELECT - FUN√á√ïES
// ========================================

/**
 * Adiciona um chip ao container
 */
function addChip(selectId, containerId, fieldName) {
    const select = document.getElementById(selectId);
    const container = document.getElementById(containerId);
    const hiddenInput = document.querySelector(`input[name="${fieldName}"]`);
    
    const selectedValue = select.value;
    const selectedText = select.options[select.selectedIndex].text;
    
    if (!selectedValue) {
        showNotification('‚ö†Ô∏è Selecione uma op√ß√£o primeiro', 'warning');
        return;
    }
    
    // Verificar se j√° existe
    const existingValues = getChipValues(containerId);
    if (existingValues.includes(selectedValue)) {
        showNotification('‚ö†Ô∏è Esta op√ß√£o j√° foi adicionada', 'warning');
        select.value = '';
        return;
    }
    
    // Criar chip
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.dataset.value = selectedValue;
    chip.innerHTML = `
        ${selectedText}
        <button type="button" onclick="removeChip(this, '${containerId}', '${fieldName}')" title="Remover">
            √ó
        </button>
    `;
    
    container.appendChild(chip);
    container.classList.remove('empty');
    
    // Atualizar input hidden
    updateHiddenInput(containerId, fieldName);
    
    // Resetar select
    select.value = '';
    
    debugLog('info', `‚úÖ Chip adicionado: ${selectedText}`, { fieldName, value: selectedValue });
}

/**
 * Remove um chip
 */
function removeChip(button, containerId, fieldName) {
    const chip = button.parentElement;
    const container = document.getElementById(containerId);
    
    chip.style.animation = 'chipAppear 0.2s ease reverse';
    
    setTimeout(() => {
        chip.remove();
        
        // Verificar se ficou vazio
        if (container.children.length === 0) {
            container.classList.add('empty');
        }
        
        // Atualizar input hidden
        updateHiddenInput(containerId, fieldName);
        
        debugLog('info', `üóëÔ∏è Chip removido`, { fieldName });
    }, 200);
}

/**
 * Obt√©m valores atuais dos chips
 */
function getChipValues(containerId) {
    const container = document.getElementById(containerId);
    const chips = container.querySelectorAll('.chip');
    
    return Array.from(chips).map(chip => chip.dataset.value);
}

/**
 * Atualiza o input hidden com valores separados por ponto-e-v√≠rgula
 */
function updateHiddenInput(containerId, fieldName) {
    const values = getChipValues(containerId);
    const hiddenInput = document.querySelector(`input[name="${fieldName}"]`);
    
    if (hiddenInput) {
        hiddenInput.value = values.join('; ');
        debugLog('debug', `üíæ Hidden input atualizado`, { 
            fieldName, 
            value: hiddenInput.value,
            count: values.length 
        });
    }
}

/**
 * Inicializa chips a partir de um valor salvo
 */
function initializeMultiselectChips(containerId, savedValue, fieldName, isReadOnly) {
    const container = document.getElementById(containerId);

    if (!container) {
        return;
    }

    // ‚úÖ SEMPRE limpar container primeiro (corrige bug de valores persistentes)
    container.innerHTML = '';

    if (!savedValue) {
        container.classList.add('empty');
        return;
    }

    // Dividir valores salvos
    const values = savedValue.split(';').map(v => v.trim()).filter(v => v);

    if (values.length === 0) {
        container.classList.add('empty');
        return;
    }
    
    // Criar chips para cada valor
    values.forEach(value => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.dataset.value = value;
        chip.innerHTML = `
            ${value}
            ${!isReadOnly ? `<button type="button" onclick="removeChip(this, '${containerId}', '${fieldName}')" title="Remover">√ó</button>` : ''}
        `;
        
        container.appendChild(chip);
    });
    
    container.classList.remove('empty');
    
    debugLog('success', `‚úÖ Chips inicializados: ${values.length}`, { fieldName, values });
}

/**
 * Obt√©m todos os valores multiselect do formul√°rio
 */
function getAllMultiselectValues() {
    const multiselectFields = document.querySelectorAll('.multiselect-wrapper');
    const values = {};
    
    multiselectFields.forEach(wrapper => {
        const fieldName = wrapper.dataset.field;
        const hiddenInput = wrapper.querySelector('input[type="hidden"]');
        
        if (hiddenInput) {
            values[fieldName] = hiddenInput.value;
        }
    });
    
    return values;
}
/**
 * Adiciona chip automaticamente ao selecionar no dropdown
 * Vers√£o simplificada SEM bot√£o
 */
function addChipOnSelect(selectElement, containerId, fieldName) {
    const selectedValue = selectElement.value;
    const selectedText = selectElement.options[selectElement.selectedIndex].text;
    
    if (!selectedValue) {
        return; // Op√ß√£o padr√£o "Selecione..."
    }
    
    const container = document.getElementById(containerId);
    const hiddenInput = document.querySelector(`input[name="${fieldName}"]`);
    
    // Verificar se j√° existe
    const existingValues = getChipValues(containerId);
    if (existingValues.includes(selectedValue)) {
        showNotification('‚ö†Ô∏è Esta op√ß√£o j√° foi adicionada', 'warning');
        selectElement.value = ''; // Resetar select
        return;
    }
    
    // Criar chip
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.dataset.value = selectedValue;
    chip.innerHTML = `
        ${selectedText}
        <button type="button" onclick="removeChip(this, '${containerId}', '${fieldName}')" title="Remover">
            √ó
        </button>
    `;
    
    container.appendChild(chip);
    container.classList.remove('empty');
    
    // Atualizar input hidden
    updateHiddenInput(containerId, fieldName);
    
    // Resetar select
    selectElement.value = '';
    
    debugLog('info', `‚úÖ Chip adicionado automaticamente: ${selectedText}`, { fieldName, value: selectedValue });
}

// ========== SISTEMA DE IMPRESS√ÉO - DEPLOY 34 ==========

async function printRnc(rncNumber) {
  try {
    // ‚úÖ VERIFICAR SE √â ADMIN
    if (!appContext || !appContext.isAdmin) {
      showError('‚ùå Apenas administradores podem imprimir RNCs');
      debugLog('warning', '‚ö†Ô∏è Tentativa de impress√£o negada', { 
        user: appContext?.email,
        isAdmin: appContext?.isAdmin 
      });
      return;
    }
    
    debugLog('info', 'üñ®Ô∏è Iniciando impress√£o', { rncNumber });
    
    if (!rncNumber || rncNumber === '') {
      showError('‚ùå N√∫mero da RNC inv√°lido!');
      return;
    }
    
    showLoading('‚è≥ Preparando impress√£o...');
    
    const result = await apiCall('fillPrintTemplateAndGetUrl', [rncNumber], 1, 60000);
    
    if (!result || !result.success) {
      throw new Error(result.error || 'Erro ao preparar impress√£o');
    }
    
    debugLog('success', '‚úÖ Template preenchido', { 
      fieldsProcessed: result.fieldsProcessed,
      printUrl: result.printUrl 
    });
    
    hideLoading();
    
    // ‚úÖ ABRIR DIRETAMENTE A IMPRESS√ÉO (sem modal)
    openPrintWindow(result);
    
  } catch (error) {
    debugLog('error', '‚ùå Erro na impress√£o', { error: error.message });
    hideLoading();
    showError('Erro ao preparar impress√£o: ' + error.message);
  }
}

function showPrintDialog(result) {
  const modal = document.createElement('div');
  modal.id = 'printModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;
  
  modal.innerHTML = `
    <div style="
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    ">
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #009688, #00796B); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px;">
          üñ®Ô∏è
        </div>
        <div>
          <h2 style="margin: 0; font-size: 24px; color: #222;">Impress√£o Preparada</h2>
          <p style="margin: 4px 0 0 0; color: #666; font-size: 14px;">RNC ${result.rncNumber}</p>
        </div>
      </div>
      
      <div style="background: #F5F5F5; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span style="color: #666; font-size: 14px;">üìã Campos preenchidos:</span>
          <strong style="color: #009688; font-size: 18px;">${result.fieldsProcessed}</strong>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="color: #666; font-size: 14px;">‚è≠Ô∏è Campos ignorados:</span>
          <strong style="color: #888; font-size: 18px;">${result.fieldsSkipped}</strong>
        </div>
      </div>
      
      <div style="background: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <p style="margin: 0; color: #2E7D32; font-size: 14px; line-height: 1.6;">
          ‚úÖ <strong>Pr√≥ximo passo:</strong><br>
          A aba "Print" foi preenchida com os dados da RNC.<br>
          Clique no bot√£o abaixo para abrir a planilha e imprimir.
        </p>
      </div>
      
      <div style="display: flex; gap: 12px;">
        <button 
          id="btnCancelPrint"
          style="flex: 1; padding: 14px 24px; background: #F5F5F5; color: #666; border: none; border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer;"
        >
          ‚ùå Cancelar
        </button>
        
        <button 
          id="btnOpenPrint"
          style="flex: 2; padding: 14px 24px; background: linear-gradient(135deg, #009688, #00796B); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);"
        >
          üñ®Ô∏è Abrir e Imprimir
        </button>
      </div>
      
      <p style="margin: 16px 0 0 0; text-align: center; color: #999; font-size: 12px;">
        üí° Use CTRL+P ou Arquivo > Imprimir na planilha
      </p>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  function closeModal() {
    modal.remove();
  }
  
  document.getElementById('btnCancelPrint').addEventListener('click', function() {
    debugLog('info', '‚ùå Impress√£o cancelada pelo usu√°rio');
    closeModal();
  });
  
  document.getElementById('btnOpenPrint').addEventListener('click', function() {
    debugLog('info', '‚úÖ Abrindo planilha para impress√£o', { url: result.printUrl });
    window.open(result.printUrl, '_blank');
    setTimeout(() => {
      closeModal();
      showSuccess('‚úÖ Planilha aberta! Use CTRL+P para imprimir.');
    }, 1000);
  });
  
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });
}

function openPrintWindow(result) {
  // ‚úÖ ABRIR PREVIEW DO PDF EM NOVA ABA
  const pdfWindow = window.open(result.printUrl, '_blank', 'width=1200,height=800');
  
  if (!pdfWindow) {
    showError('‚ùå Bloqueador de popup detectado! Permita pop-ups para este site.');
    debugLog('error', 'Popup bloqueado pelo navegador');
    return;
  }
  
  // ‚úÖ MOSTRAR NOTIFICA√á√ÉO DE SUCESSO
  showSuccess(`‚úÖ Preview de impress√£o aberto! ${result.fieldsProcessed} campos preenchidos.`);
  
  debugLog('success', '‚úÖ Preview PDF aberto em nova aba', {
    rncNumber: result.rncNumber,
    url: result.printUrl
  });
  
  // ‚úÖ INSTRU√á√ïES PARA O USU√ÅRIO
  setTimeout(() => {
    showInfo('üí° No preview, clique no √≠cone da impressora ou use CTRL+P para imprimir');
  }, 2000);
}

window.printRnc = printRnc;

function showSuccessModal(rncNumber) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        ">
            <div style="font-size: 72px; margin-bottom: 20px;">‚úÖ</div>
            <h2 style="color: #10B981; margin-bottom: 15px; font-size: 28px;">
                RNC Criada com Sucesso!
            </h2>
            <div style="
                background: #F0FDF4;
                padding: 20px;
                border-radius: 12px;
                margin: 20px 0;
                border-left: 4px solid #10B981;
            ">
                <p style="color: #666; font-size: 14px; margin-bottom: 5px;">N√∫mero da RNC:</p>
                <p style="font-size: 36px; font-weight: bold; color: #009688; margin: 0;">
                    ${rncNumber}
                </p>
            </div>
            <p style="color: #666; margin: 20px 0;">
                üéâ Voc√™ pode criar outra RNC ou fechar esta janela
            </p>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="
                background: #009688;
                color: white;
                border: none;
                padding: 14px 40px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);
            " onmouseover="this.style.background='#00796B'" onmouseout="this.style.background='#009688'">
                OK, Entendi
            </button>
        </div>
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translateY(50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        </style>
    `;
    
    document.body.appendChild(modal);
    
    // Fechar ao clicar fora
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

/**
 * Fun√ß√£o de teste - Execute no console do navegador
 * Digite: testComparacao()
 */
function testComparacao() {
    console.clear();
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë   TESTE DE NORMALIZA√á√ÉO DE VALORES    ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    
    const testes = [
        { nome: 'N√∫mero vs String', old: 123, new: '123', esperado: false },
        { nome: 'Null vs Vazio', old: null, new: '', esperado: false },
        { nome: 'Undefined vs Vazio', old: undefined, new: '', esperado: false },
        { nome: 'Data BR vs ISO', old: '21/10/2025', new: '2025-10-21', esperado: false },
        { nome: 'String com espa√ßos', old: '  abc  ', new: 'abc', esperado: false },
        { nome: 'Valores diferentes', old: 'abc', new: 'xyz', esperado: true }
    ];
    
    let passou = 0;
    let falhou = 0;
    
    testes.forEach((teste, i) => {
        const campo = teste.nome.includes('Data') ? 'Data Teste' : 'Campo';
        const resultado = valuesAreDifferent(teste.old, teste.new, campo);
        const ok = resultado === teste.esperado;
        
        if (ok) {
            console.log(`‚úÖ Teste ${i + 1}: ${teste.nome}`);
            passou++;
        } else {
            console.log(`‚ùå Teste ${i + 1}: ${teste.nome} (esperado: ${teste.esperado}, obtido: ${resultado})`);
            falhou++;
        }
        console.log(`   Old: ${JSON.stringify(teste.old)} ‚Üí New: ${JSON.stringify(teste.new)}\n`);
    });
    
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log(`‚ïë  RESULTADO: ${passou}/${testes.length} testes passaram      ‚ïë`);
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    
    if (passou === testes.length) {
        console.log('üéâ TODOS OS TESTES PASSARAM! Corre√ß√£o funcionando corretamente.');
    } else {
        console.log('‚ö†Ô∏è Alguns testes falharam. Verifique a implementa√ß√£o.');
    }
}

// ============================================
// üéØ DEPLOY 124 - M√öLTIPLOS SETORES (CHIPS)
// ============================================

/**
 * Adiciona chip de setor no modal de NOVO usu√°rio
 * @param {HTMLSelectElement} selectElement - Select que disparou o evento
 */
function addSetorChipToNew(selectElement) {
  const setorValue = selectElement.value;

  if (!setorValue) {
    return; // Op√ß√£o vazia selecionada
  }

  addSetorChip(setorValue, 'newUserSetorChips', selectElement);

  // Reset select para voltar ao placeholder
  selectElement.value = '';
}

/**
 * Adiciona chip de setor no modal de EDITAR usu√°rio
 * @param {HTMLSelectElement} selectElement - Select que disparou o evento
 */
function addSetorChipToEdit(selectElement) {
  const setorValue = selectElement.value;

  if (!setorValue) {
    return; // Op√ß√£o vazia selecionada
  }

  addSetorChip(setorValue, 'editUserSetorChips', selectElement);

  // Reset select para voltar ao placeholder
  selectElement.value = '';
}

/**
 * Adiciona um chip de setor ao container
 * @param {string} setorValue - Valor do setor
 * @param {string} containerId - ID do container de chips
 * @param {HTMLSelectElement} selectElement - Select para desabilitar op√ß√£o
 */
function addSetorChip(setorValue, containerId, selectElement) {
  const container = document.getElementById(containerId);

  if (!container) {
    console.error('Container de chips n√£o encontrado:', containerId);
    return;
  }

  // Verificar se o setor j√° foi adicionado
  const existingChips = container.querySelectorAll('.setor-chip');
  for (let i = 0; i < existingChips.length; i++) {
    if (existingChips[i].getAttribute('data-setor') === setorValue) {
      showWarning('‚ö†Ô∏è Este setor j√° foi adicionado');
      return;
    }
  }

  // Remover mensagem de "nenhum setor selecionado" se existir
  const emptyMessage = container.querySelector('span[style*="italic"]');
  if (emptyMessage) {
    emptyMessage.remove();
  }

  // Criar chip
  const chip = document.createElement('span');
  chip.className = 'setor-chip';
  chip.setAttribute('data-setor', setorValue);
  chip.style.cssText = `
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #009688, #00796B);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(0, 150, 136, 0.3);
    transition: all 0.2s;
  `;

  // Texto do setor
  const text = document.createElement('span');
  text.textContent = setorValue;
  chip.appendChild(text);

  // Bot√£o de remover
  const removeBtn = document.createElement('button');
  removeBtn.innerHTML = '√ó';
  removeBtn.style.cssText = `
    background: rgba(255, 255, 255, 0.3);
    border: none;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    line-height: 1;
    transition: background 0.2s;
  `;

  removeBtn.onmouseover = function() {
    this.style.background = 'rgba(255, 255, 255, 0.5)';
  };

  removeBtn.onmouseout = function() {
    this.style.background = 'rgba(255, 255, 255, 0.3)';
  };

  removeBtn.onclick = function() {
    removeSetorChip(chip, containerId, selectElement);
  };

  chip.appendChild(removeBtn);

  // Adicionar chip ao container
  container.appendChild(chip);

  // Desabilitar op√ß√£o no select para evitar duplicatas
  if (selectElement) {
    const option = selectElement.querySelector(`option[value="${setorValue}"]`);
    if (option) {
      option.disabled = true;
    }
  }

  debugLog('info', '‚úÖ Setor adicionado', { setor: setorValue, container: containerId });
}

/**
 * Remove um chip de setor
 * @param {HTMLElement} chipElement - Elemento do chip a ser removido
 * @param {string} containerId - ID do container de chips
 * @param {HTMLSelectElement} selectElement - Select para reabilitar op√ß√£o
 */
function removeSetorChip(chipElement, containerId, selectElement) {
  const setorValue = chipElement.getAttribute('data-setor');
  const container = document.getElementById(containerId);

  // Remover chip
  chipElement.remove();

  // Reabilitar op√ß√£o no select
  if (selectElement) {
    const option = selectElement.querySelector(`option[value="${setorValue}"]`);
    if (option) {
      option.disabled = false;
    }
  }

  // Se n√£o houver mais chips, mostrar mensagem de "nenhum setor"
  const remainingChips = container.querySelectorAll('.setor-chip');
  if (remainingChips.length === 0) {
    const emptyMessage = document.createElement('span');
    emptyMessage.style.cssText = 'color: #999; font-size: 13px; font-style: italic;';
    emptyMessage.textContent = 'Nenhum setor selecionado';
    container.appendChild(emptyMessage);
  }

  debugLog('info', '‚ùå Setor removido', { setor: setorValue, container: containerId });
}

/**
 * Obt√©m array de setores selecionados a partir dos chips
 * @param {string} containerId - ID do container de chips
 * @return {Array<string>} Array de setores selecionados
 */
function getSelectedSetores(containerId) {
  const container = document.getElementById(containerId);

  if (!container) {
    console.error('Container de chips n√£o encontrado:', containerId);
    return [];
  }

  const chips = container.querySelectorAll('.setor-chip');
  const setores = [];

  for (let i = 0; i < chips.length; i++) {
    const setor = chips[i].getAttribute('data-setor');
    if (setor) {
      setores.push(setor);
    }
  }

  return setores;
}

/**
 * Popula chips a partir de um array de setores
 * @param {Array<string>|string} setores - Array de setores ou string separada por v√≠rgula/ponto-e-v√≠rgula
 * @param {string} containerId - ID do container de chips
 * @param {string} selectId - ID do select para desabilitar op√ß√µes
 */
function populateSetorChips(setores, containerId, selectId) {
  const container = document.getElementById(containerId);
  const selectElement = document.getElementById(selectId);

  if (!container) {
    console.error('Container de chips n√£o encontrado:', containerId);
    return;
  }

  // Limpar container (remover mensagem vazia e chips antigos)
  container.innerHTML = '';

  // Reabilitar todas as op√ß√µes do select
  if (selectElement) {
    const options = selectElement.querySelectorAll('option');
    for (let i = 0; i < options.length; i++) {
      options[i].disabled = false;
    }
  }

  // Converter para array se for string
  let setoresArray = [];
  if (typeof setores === 'string') {
    // Split por v√≠rgula ou ponto-e-v√≠rgula
    setoresArray = setores.split(/[;,]/).map(function(s) { return s.trim(); }).filter(function(s) { return s !== ''; });
  } else if (Array.isArray(setores)) {
    setoresArray = setores;
  }

  // Se n√£o houver setores, mostrar mensagem vazia
  if (setoresArray.length === 0) {
    const emptyMessage = document.createElement('span');
    emptyMessage.style.cssText = 'color: #999; font-size: 13px; font-style: italic;';
    emptyMessage.textContent = 'Nenhum setor selecionado';
    container.appendChild(emptyMessage);
    return;
  }

  // Adicionar cada setor como chip
  for (let i = 0; i < setoresArray.length; i++) {
    const setor = setoresArray[i];
    if (setor) {
      addSetorChip(setor, containerId, selectElement);
    }
  }

  debugLog('info', '‚úÖ Chips populados', { setores: setoresArray, container: containerId });
}

// ============================================
// FIM - DEPLOY 124
// ============================================

    </script>
</body>
</html>
<!-- Force update 1764870979 -->
