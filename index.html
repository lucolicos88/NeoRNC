<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- TASK-005: Content Security Policy (Phase 1 - com 'unsafe-inline') -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https://script.google.com https://script.googleusercontent.com;
        script-src 'self' 'unsafe-inline'
            https://cdn.jsdelivr.net
            https://cdnjs.cloudflare.com
            https://script.google.com
            https://script.googleusercontent.com;
        style-src 'self' 'unsafe-inline'
            https://fonts.googleapis.com;
        font-src 'self'
            https://fonts.gstatic.com;
        img-src 'self' data: https:;
        connect-src 'self'
            https://script.google.com
            https://script.googleusercontent.com;
    ">

    <title>RNC ‚Ä¢ Neoformula</title>
    
    <!-- ‚ú® CHART.JS - Biblioteca de Gr√°ficos Animados -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- ‚ú® DEPLOY 37: jsPDF - Gera√ß√£o de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>

/* ========================================
   SISTEMA MULTISELECT COM CHIPS/TAGS
   VERS√ÉO 4.0 - CORES PADR√ÉO DO APP
   ======================================== */

.multiselect-wrapper {
    margin-bottom: 20px;
    position: relative;
    z-index: 1;
}

.multiselect-wrapper label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
    font-size: 14px;
}

/* ‚úÖ Container de Chips - FUNDO BRANCO */
.chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    min-height: 50px;
    padding: 10px;
    border: 1px solid #ddd;  /* ‚úÖ Borda igual aos outros inputs */
    border-radius: 4px;      /* ‚úÖ Border radius padr√£o */
    background: #ffffff;     /* ‚úÖ FUNDO BRANCO */
    margin-bottom: 12px;
    transition: all 0.3s;
}

.chips-container:hover {
    border-color: #009688;
}

.chips-container:focus-within {
    border-color: #009688;
    box-shadow: 0 0 0 0.2rem rgba(0, 150, 136, 0.1);
}

/* Container vazio */
.chips-container.empty {
    border-style: dashed;
    border-color: #ccc;
    background: #fafafa;
    justify-content: center;
    align-items: center;
}

.chips-container.empty::after {
    content: 'Nenhuma op√ß√£o selecionada';
    color: #999;
    font-size: 13px;
    font-style: italic;
}

/* ‚úÖ Chips - Verde do sistema */
.chip {
    background: linear-gradient(135deg, #009688 0%, #00796b 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 16px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0, 150, 136, 0.2);
    transition: all 0.2s;
    animation: chipAppear 0.3s ease;
}

@keyframes chipAppear {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.chip:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 150, 136, 0.3);
}

.chip button {
    background: rgba(255, 255, 255, 0.3);
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;
    padding: 0;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    line-height: 1;
}

.chip button:hover {
    background: rgba(255, 255, 255, 0.5);
    transform: rotate(90deg);
}

/* ‚úÖ Select - IGUAL AOS OUTROS CAMPOS DO SISTEMA */
.multiselect-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;              /* ‚úÖ Mesma borda */
    border-radius: 4px;                  /* ‚úÖ Mesmo border radius */
    font-size: 14px;                     /* ‚úÖ Mesmo tamanho de fonte */
    background: #ffffff;                 /* ‚úÖ FUNDO BRANCO */
    color: #333;                         /* ‚úÖ Texto escuro */
    cursor: pointer;
    transition: all 0.3s;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    margin-bottom: 8px;
    height: 40px;                        /* ‚úÖ Mesma altura dos outros inputs */
    line-height: 1.5;
}

.multiselect-select:hover {
    border-color: #009688;
}

.multiselect-select:focus {
    outline: none;
    border-color: #009688;
    box-shadow: 0 0 0 0.2rem rgba(0, 150, 136, 0.1);
}

.multiselect-select:disabled {
    background: #e9ecef;
    cursor: not-allowed;
    opacity: 0.6;
}

/* ‚úÖ Op√ß√µes do dropdown - FUNDO BRANCO */
.multiselect-select option {
    background: #ffffff;     /* ‚úÖ FUNDO BRANCO */
    color: #333;            /* ‚úÖ Texto escuro */
    padding: 8px 12px;
}

.multiselect-select option:hover {
    background: #f8f9fa;    /* ‚úÖ Hover suave */
}

.multiselect-select option:checked {
    background: #009688;    /* ‚úÖ Selecionado verde */
    color: white;
}

/* Hint text */
.multiselect-hint {
    display: block;
    font-size: 12px;
    color: #6c757d;
    font-style: italic;
    margin-top: 4px;
}

/* ‚úÖ Campo obrigat√≥rio vazio */
.multiselect-wrapper.required .chips-container.empty {
    border-color: #ffc107;
    background: #fff3cd;
}

.multiselect-wrapper.required .chips-container.empty::after {
    content: '‚ö†Ô∏è Campo obrigat√≥rio - selecione ao menos uma op√ß√£o';
    color: #856404;
}

/* ‚úÖ Garantir que n√£o sobreponha outros campos */
.multiselect-wrapper {
    margin-bottom: 25px;
}

textarea.form-control,
.form-control {
    position: relative;
    z-index: 2;
}

/* ‚úÖ Badge de somente leitura */
.multiselect-wrapper .badge-readonly {
    display: inline-block;
    padding: 2px 8px;
    background: #6c757d;
    color: white;
    font-size: 11px;
    border-radius: 12px;
    margin-left: 8px;
    font-weight: normal;
}

/* ‚úÖ Campo somente leitura */
.multiselect-wrapper.field-readonly .chips-container {
    background: #e9ecef;
    cursor: not-allowed;
}

.multiselect-wrapper.field-readonly .chip button {
    display: none;  /* Esconder bot√£o X em modo somente leitura */
}

/* Responsivo */
@media (max-width: 768px) {
    .chip {
        font-size: 11px;
        padding: 5px 10px;
    }
    
    .multiselect-select {
        font-size: 13px;
    }
}

/* ‚úÖ REMOVER qualquer estilo de tema escuro que possa estar interferindo */
@media (prefers-color-scheme: dark) {
    .chips-container,
    .multiselect-select,
    .multiselect-select option {
        background: #ffffff !important;  /* For√ßar branco */
        color: #333 !important;          /* For√ßar texto escuro */
    }
}

/* ‚úÖ Garantir que o select dropdown n√£o seja transparente */
.multiselect-select::-webkit-scrollbar {
    width: 8px;
}

.multiselect-select::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.multiselect-select::-webkit-scrollbar-thumb {
    background: #009688;
    border-radius: 4px;
}

.multiselect-select::-webkit-scrollbar-thumb:hover {
    background: #00796b;
}


      /* ===== SISTEMA DE PERMISS√ïES - Deploy 32 ===== */
/* Campo somente leitura */
.field-readonly {
    position: relative;
}

.field-readonly input,
.field-readonly textarea,
.field-readonly select {
    background-color: #f5f5f5 !important;
    border: 1px solid #ddd !important;
    cursor: not-allowed !important;
    color: #666 !important;
}

.field-readonly input:disabled,
.field-readonly textarea:disabled,
.field-readonly select:disabled {
    opacity: 0.7;
}

/* Badge de somente leitura */
.badge-readonly {
    display: inline-block;
    background: #FF9800;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    margin-left: 8px;
    font-weight: normal;
}

/* Se√ß√£o bloqueada */
.section-blocked {
    opacity: 0.5;
    pointer-events: none;
    position: relative;
}

.section-blocked::before {
    content: 'üîí Se√ß√£o Bloqueada';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(244, 67, 54, 0.9);
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 10;
}

/* Indicador de roles */
.user-roles {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-top: 5px;
}

.role-badge {
    background: #009688;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
}

.role-badge.admin {
    background: #F44336;
}

.role-badge.abertura {
    background: #2196F3;
}

.role-badge.qualidade {
    background: #4CAF50;
}

.role-badge.lideranca {
    background: #FF9800;
}

.role-badge.espectador {
    background: #9E9E9E;
}
        /* === DEPLOY 39 - ESTILOS CORRIGIDOS === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #009688;
            --primary-dark: #00796B;
            --primary-light: #4DB6AC;
            --accent: #FFB300;
            --accent-light: #FFD54F;
            --background: #F8F9FA;
            --surface: #FFFFFF;
            --surface-2: #F5F5F5;
            --text: #1E1E1E;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --border: #E5E7EB;
            --border-light: #F3F4F6;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 8px;
            --radius-lg: 12px;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            font-size: 14px;
        }
        
       /* ========================================== */
        /* ‚úÖ HEADER FIXO NO TOPO - DEPLOY 41 */
        /* ========================================== */
        .header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            z-index: 1001 !important;
            background: var(--surface) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
            border-bottom: 1px solid var(--border) !important;
            height: 80px !important;
            padding: 0 !important;
            margin: 0 !important;
            display: block !important;
        }

        .header-content {
            max-width: 1400px !important;
            margin: 0 auto !important;
            padding: 0.75rem 1.5rem !important;
            display: grid !important;
            grid-template-columns: 180px 1fr 240px !important;
            align-items: center !important;
            gap: 1.5rem !important;
            height: 100% !important;
        }

        .logo {
            display: flex !important;
            align-items: center !important;
            gap: 0.75rem !important;
            font-size: 1.125rem !important;
            font-weight: 600 !important;
            color: var(--primary) !important;
            justify-self: start !important;
        }

        .logo img {
            height: 60px !important;
            width: auto !important;
            border-radius: 4px !important;
            display: block !important;
        }

        .system-title {
            justify-self: center !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .system-title span {
            font-size: 2rem !important;
            font-weight: 700 !important;
            color: var(--primary) !important;
            white-space: nowrap !important;
            letter-spacing: 0.5px !important;
            line-height: 1.2 !important;
        }

      .user-info {
            justify-self: end !important;
            display: flex !important;
            flex-direction: row !important;  /* ‚úÖ HORIZONTAL */
            align-items: center !important;  /* ‚úÖ CENTRALIZADO VERTICALMENTE */
            gap: 0.75rem !important;  /* ‚úÖ ESPA√áO ENTRE EMAIL E BADGES */
            font-size: 0.65rem !important;
            color: var(--text-secondary) !important;
            background: var(--surface-2) !important;
            padding: 0.4rem 0.8rem !important;
            border-radius: var(--radius) !important;
            border: 1px solid var(--border) !important;
            min-height: auto !important;
            max-height: 45px !important;  /* ‚úÖ ALTURA M√ÅXIMA CONTROLADA */
            white-space: nowrap !important;
        }

      .user-info > div {
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-end !important;
            gap: 0.2rem !important;
        }

        .user-info #userEmail {
            font-size: 0.6rem !important;
            opacity: 0.9 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            max-width: 160px !important;
            line-height: 1.2 !important;
        }

        .user-info .user-roles {
            display: flex !important;
            gap: 0.25rem !important;
            flex-wrap: nowrap !important;
            overflow: hidden !important;
        }

        .user-info .role-badge {
            font-size: 0.5rem !important;
            padding: 0.1rem 0.3rem !important;
            border-radius: 4px !important;
            white-space: nowrap !important;
        }

        /* Badge principal (Admin) - ao lado direito */
        .user-info .user-badge {
            background: var(--primary) !important;
            color: white !important;
            padding: 0.25rem 0.5rem !important;
            border-radius: 8px !important;
            font-size: 0.65rem !important;
            font-weight: 600 !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;  /* ‚úÖ N√ÉO ENCOLHE */
        }


      /* ========================================== */
      /* ‚úÖ TABS FIXAS LOGO ABAIXO - DEPLOY 41 */
      /* ========================================== */
        .tabs-wrapper {
            position: fixed !important;
            top: 80px !important;  /* ‚úÖ EXATAMENTE ABAIXO DO HEADER */
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            z-index: 1000 !important;
            background: var(--surface) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
            border-bottom: 2px solid var(--border) !important;
            height: 58px !important;
            padding: 0 !important;
            margin: 0 !important;
            display: block !important;
        }
        
        .tabs {
            display: flex !important;
            max-width: 1400px !important;
            margin: 0 auto !important;
            padding: 0 1rem !important;
            background: transparent !important;
            height: 100% !important;
            align-items: center !important;
        }

        .tab {
            flex: 1 !important;
            padding: 0 0.75rem !important;
            height: 100% !important;
            text-align: center !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            border: none !important;
            background: transparent !important;
            font-size: 0.85rem !important;
            font-weight: 500 !important;
            color: var(--text-secondary) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 0.5rem !important;
            white-space: nowrap !important;
        }
        
        .tab:hover {
            background: var(--surface-2) !important;
            color: var(--text) !important;
        }

        .tab.active {
            background: var(--primary) !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(0, 150, 136, 0.3) !important;
        }

        .tab span {
            display: inline-block !important;
        }

        /* ========================================== */
        /* ‚úÖ CONTAINER COM ESPA√áO CORRETO */
        /* ========================================== */
        .container {
            max-width: 1400px !important;
            margin: 0 auto !important;
            padding: 1.5rem 1rem !important;
            padding-top: 160px !important;  /* ‚úÖ Header (80) + Tabs (58) + Margem (22) */
        }
        
        .tab-content {
            display: none;
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            min-height: 600px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .form-section {
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: var(--surface);
        }
        
        .form-section h3 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.875rem;
        }
        
        .form-group.required label::after {
            content: '*';
            color: var(--error);
            margin-left: 0.25rem;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: var(--surface);
            color: var(--text);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.1);
        }
        
        .form-control:invalid {
            border-color: var(--error);
        }
        
        .form-control::placeholder {
            color: var(--text-muted);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 150px;
        }
        
        .file-upload {
            border: 3px dashed var(--primary);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, rgba(0, 150, 136, 0.03) 0%, rgba(0, 150, 136, 0.08) 100%);
            position: relative;
            overflow: hidden;
            max-height: 180px;
        }

        .file-upload::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        
        .file-upload:hover {
            border-color: var(--primary-dark);
            background: linear-gradient(135deg, rgba(0, 150, 136, 0.08) 0%, rgba(0, 150, 136, 0.15) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 150, 136, 0.15);
        }
        
        .file-upload:hover::before {
            left: 100%;
        }


       .file-upload.dragover {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(255, 179, 0, 0.1) 0%, rgba(255, 179, 0, 0.2) 100%);
            transform: scale(1.02);
            box-shadow: 0 12px 30px rgba(255, 179, 0, 0.25);
        }

        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            color: var(--primary);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .file-upload p {
            margin: 0.25rem 0;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .file-upload p:first-of-type {
            font-size: 1rem;
            color: var(--text);
            font-weight: 600;
        }

        .file-upload small {
            display: block;
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* ========================================== */
        /* CONTADOR DE ARQUIVOS SELECIONADOS - Deploy 37 */
        /* ========================================== */

          .file-upload-counter {
              position: absolute;
              top: 10px;
              right: 10px;
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 5px;
              background: linear-gradient(135deg, #009688 0%, #00796B 100%);
              padding: 10px 15px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);
              animation: slideInRight 0.3s ease;
          }

          .counter-badge {
              font-size: 1.2rem;
              font-weight: 700;
              color: white;
              display: flex;
              align-items: center;
              gap: 5px;
          }

          .counter-text {
              font-size: 0.75rem;
              color: rgba(255, 255, 255, 0.9);
              text-align: center;
              font-weight: 500;
          }

          @keyframes slideInRight {
              from {
                  opacity: 0;
                  transform: translateX(20px);
              }
              to {
                  opacity: 1;
                  transform: translateX(0);
              }
          }

          /* Ajustar posi√ß√£o relativa do file-upload para o contador absolute funcionar */
          .file-upload {
              position: relative;
          }


        .file-list {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s ease;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

        .file-item:hover {
          background: var(--surface-2);
          border-color: var(--primary);
          transform: translateX(5px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .file-item .file-info {
          display: flex;
          align-items: center;
          gap: 1rem;
          flex: 1;
      }

      .file-item .file-icon {
          font-size: 2rem;
          filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }

      .file-item .file-details {
          flex: 1;
      }

      .file-item .file-name {
          font-weight: 600;
          color: var(--text);
          font-size: 0.9375rem;
          margin-bottom: 0.25rem;
          display: block;
      }

      .file-item .file-size {
          color: var(--text-muted);
          font-size: 0.8125rem;
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .file-item .file-size::before {
          content: 'üìä';
          font-size: 0.875rem;
      }

      .file-item button {
          background: linear-gradient(135deg, var(--error) 0%, #DC2626 100%);
          color: white;
          border: none;
          padding: 0.5rem 1rem;
          border-radius: 6px;
          cursor: pointer;
          font-size: 0.8125rem;
          font-weight: 600;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          gap: 0.375rem;
          box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
      }

      .file-item button::before {
          content: 'üóëÔ∏è';
      }

      .file-item button:hover {
          background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
      }

      .file-item button:active {
          transform: translateY(0);
      }
        


.attachments-section {
    margin-top: 2rem;
    padding: 0;
    background: transparent;
    border: none;
    border-radius: 0;
}

.attachments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: var(--radius);
    border-left: 4px solid var(--primary);
}

.attachments-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.attachments-count {
    background: var(--primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
}

.attachments-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.attachment-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    transition: all 0.2s ease;
}

.attachment-item:hover {
    background: #f9f9f9;
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(0, 150, 136, 0.1);
    transform: translateX(5px);
}

.attachment-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.attachment-icon {
    font-size: 2rem;
    min-width: 40px;
    text-align: center;
}

.attachment-details {
    flex: 1;
}

.attachment-name {
    font-weight: 600;
    color: var(--text);
    font-size: 0.9375rem;
    margin-bottom: 0.25rem;
    display: block;
    word-break: break-word;
}

.attachment-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.8125rem;
    color: var(--text-muted);
}

.attachment-actions {
    display: flex;
    gap: 0.5rem;
}

.attachment-actions button {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8125rem;
    font-weight: 600;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.btn-download {
    background: linear-gradient(135deg, var(--info) 0%, #2563EB 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
}

.btn-download:hover {
    background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
}

.btn-delete-attachment {
    background: linear-gradient(135deg, var(--error) 0%, #DC2626 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
}

.btn-delete-attachment:hover {
    background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
}

.no-attachments {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
    font-size: 0.9375rem;
    background: #f9f9f9;
    border-radius: var(--radius);
}

.no-attachments-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}



/* Modal/Popup de confirma√ß√£o */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.2s ease;
}

.modal-content {
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow: auto;
  animation: slideUp 0.3s ease;
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid #eee;
}

.modal-header h3 {
  margin: 0;
  font-size: 20px;
  color: #222;
}

.modal-body {
  padding: 24px;
  color: #555;
  line-height: 1.6;
}

.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid #eee;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.btn-secondary {
  background: #e0e0e0;
  color: #555;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-secondary:hover {
  background: #d0d0d0;
}

.btn-danger {
  background: #F44336;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-danger:hover {
  background: #d32f2f;
}

.btn-danger:disabled,
.btn-secondary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--surface-2);
            border-color: var(--text-secondary);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #059669;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #D97706;
        }
        
        .btn-error {
            background: var(--error);
            color: white;
        }
        
        .btn-error:hover:not(:disabled) {
            background: #DC2626;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            border-left: 4px solid;
            font-size: 0.875rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
            color: #065F46;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error);
            color: #991B1B;
        }
        
        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--info);
            color: #1E3A8A;
        }
        
        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
            color: #92400E;
        }
        
        /* === KANBAN CORRIGIDO DEPLOY 30 - COM FINALIZADAS === */
        .kanban-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .kanban-column {
            background: var(--background);
            border-radius: var(--radius-lg);
            padding: 0;
            border: 1px solid var(--border);
            min-height: 600px;
        }
        
        .kanban-header {
            text-align: center;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            font-weight: 600;
            color: white;
            font-size: 0.875rem;
        }
        
        .kanban-header.abertura { background: var(--info); }
        .kanban-header.analise-qualidade { background: var(--warning); }
        .kanban-header.analise-acao { background: var(--accent); }
        .kanban-header.finalizada { background: var(--success); }
        
        .kanban-cards {
            padding: 0 1rem 1rem;
        }
        
        .kanban-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
        }
        
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .card-number {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.875rem;
        }
        
        .card-priority {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .priority-alta { background: #FEE2E2; color: #991B1B; }
        .priority-media { background: #FEF3C7; color: #92400E; }
        .priority-normal { background: #E0F2FE; color: #0E7490; }
        
        .card-cliente {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-weight: 500;
        }
        
        .card-descricao {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
        }
        
        .card-responsavel {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .card-dias {
            background: var(--surface-2);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .card-risco {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
            margin-top: 0.5rem;
        }
        
        .risco-baixo { background: #DCFCE7; color: #166534; }
        .risco-medio { background: #FEF3C7; color: #92400E; }
        .risco-alto { background: #FEE2E2; color: #991B1B; }
        .risco-critico { background: #FDF2F8; color: #9D174D; }
        
        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }
        
        .card-tag {
            font-size: 0.6875rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            background: var(--surface-2);
            color: var(--text-muted);
            font-weight: 500;
        }
        
        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .dashboard-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            border-top: 4px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 4px;
              background: linear-gradient(90deg, currentColor, transparent);
              opacity: 0;
              transition: opacity 0.3s ease;
          }
        
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .dashboard-card:hover::before {
            opacity: 1;
        }
        
        .dashboard-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            line-height: 1;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dashboard-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .dashboard-icon {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.8;
        }
        
        .chart-container {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: var(--shadow-md);
        }
        
        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        
        /* Relat√≥rios Styles */
        .filters-grid {
              display: grid;
              gap: 1rem;
              margin-bottom: 1.5rem;
          }

          .filters-container {
              background: var(--surface);
              border-radius: var(--radius-lg);
              padding: 1.5rem;
              margin-bottom: 1.5rem;
              box-shadow: var(--shadow);
              border: 1px solid var(--border);
          }

          .filters-container h3 {
              margin-bottom: 1.5rem;
              color: var(--primary);
              font-size: 1.125rem;
              font-weight: 600;
              display: flex;
              align-items: center;
              gap: 0.5rem;
              padding-bottom: 0.75rem;
              border-bottom: 2px solid var(--border);
          }

          .form-group {
              margin-bottom: 0;
          }

          .form-group label {
              display: block;
              margin-bottom: 0.5rem;
              font-weight: 500;
              color: var(--text);
              font-size: 0.875rem;
          }

          @media (max-width: 768px) {
              .filters-grid {
                  grid-template-columns: 1fr !important;
              }
          }
        
        .report-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .report-summary {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        
        .report-table th,
        .report-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .report-table th {
            background: var(--surface-2);
            font-weight: 600;
            color: var(--text);
        }
        
        .report-table tbody tr:hover {
            background: var(--background);
        }
        
        /* RNC Selection */
        .rnc-selector {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .rnc-selector h3 {
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .rnc-selector .form-control {
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* === CONFIG STYLES RESTAURADAS COM ABAS (DEPLOY 30) === */
        .config-tabs {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius-lg);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .config-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .config-tab:hover {
            background: var(--surface-2);
            color: var(--text);
        }
        
        .config-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .config-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .config-tab-content.active {
            display: block;
        }
        
        .config-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        
        .config-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .config-item {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--background);
        }

                /* Bot√µes de a√ß√µes nos cards de usu√°rios */
        .config-item button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .config-item button:active {
            transform: translateY(0);
        }

        /* Melhorar espa√ßamento dos cards */
        .config-item {
            transition: all 0.2s ease;
        }

        .config-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .config-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .config-item-title {
            font-weight: 500;
            color: var(--text);
            font-size: 0.875rem;
        }
        
        .config-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .config-item-actions button {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            background: var(--surface);
            color: var(--text);
            transition: all 0.2s ease;
        }
        
        .config-item-actions button:hover {
            background: var(--surface-2);
        }
        
        .config-item-actions .btn-edit {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .config-item-actions .btn-delete {
            border-color: var(--error);
            color: var(--error);
        }
        
        .config-item-meta {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }
        
        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1F2937;
            color: #10B981;
            padding: 1rem;
            border-radius: var(--radius-lg);
            font-family: 'Fira Code', 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 2000;
            display: none;
            box-shadow: var(--shadow-lg);
            border: 1px solid #374151;
        }
        
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #374151;
        }
        
        .debug-title {
            font-weight: 600;
            color: #F3F4F6;
        }
        
        .debug-clear {
            background: #374151;
            color: #10B981;
            border: 1px solid #10B981;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.6875rem;
        }
        
        .debug-section {
            margin-bottom: 0.75rem;
        }
        
        .debug-section h4 {
            color: #F59E0B;
            margin-bottom: 0.25rem;
        }
        
        .debug-log {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 2001;
            box-shadow: var(--shadow-lg);
            transition: all 0.2s ease;
        }
        
        .debug-toggle:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }
        
        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .loading-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .container { padding: 1rem 0.75rem; padding-top: calc(80px + 60px + 1rem); }
            .header-content { padding: 0 0.75rem; }
            .tabs { overflow-x: auto; }
            .tab { min-width: 120px; }
            .config-tabs { overflow-x: auto; }
            .config-tab { min-width: 120px; }
            .kanban-container { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
        }
        

/* ========================================== */
/* ‚úÖ RESPONSIVO MOBILE - DEPLOY 41 */
/* ========================================== */
@media (max-width: 768px) {
    .header {
        min-height: auto;
        padding: 0.6rem 0;
    }
    
    .header-content {
        grid-template-columns: 1fr;  /* ‚úÖ 1 coluna em mobile */
        grid-template-rows: auto auto auto;
        gap: 0.5rem;
        padding: 0 0.75rem;
        min-height: auto;
    }
    
    .logo {
        justify-self: center;
        order: 1;  /* ‚úÖ Logo primeiro */
    }
    
    .logo img {
        height: 50px;  /* ‚úÖ Logo menor em mobile */
    }
    
    .system-title {
        justify-self: center;
        order: 2;  /* ‚úÖ T√≠tulo segundo */
    }
    
    .system-title span {
        font-size: 1.25rem;  /* Titulo menor em mobile */
        letter-spacing: 0.3px;
    }
    
    .user-info {
        justify-self: center;
        order: 3;  /* ‚úÖ User info por √∫ltimo */
        font-size: 0.6rem;
        padding: 0.35rem 0.65rem;
        min-height: auto;
        gap: 0.35rem;
    }
    
    .user-info #userEmail {
        font-size: 0.55rem;
    }
    
    .user-info .user-badge {
        font-size: 0.6rem;
        padding: 0.1rem 0.35rem;
    }
    
    /* ‚úÖ TABS RESPONSIVAS EM MOBILE */
    .tabs-wrapper {
        position: sticky !important;  /* ‚úÖ Sticky em vez de fixed */
        top: 0 !important;
        min-height: 52px;
    }
    
    .tabs {
        overflow-x: auto;  /* ‚úÖ Scroll horizontal se necess√°rio */
        -webkit-overflow-scrolling: touch;
    }
    
    .tab {
        padding: 0.75rem 1rem;
        min-height: 48px;
        min-width: 100px;  /* ‚úÖ Largura m√≠nima */
        font-size: 0.8rem;
    }
    
    .container {
        padding: 1rem 0.75rem;
        padding-top: 1rem !important;  /* ‚úÖ Sem margem extra */
    }
    
    .tab-content {
        padding: 1rem;
    }
}

@media (max-width: 480px) {
    .logo img {
        height: 45px;
    }
    
    .system-title span {
        font-size: 1.15rem;
    }
    
    .tab {
        padding: 0.65rem 0.75rem;
        font-size: 0.75rem;
        min-width: 90px;
    }
}
        
        @media (max-width: 480px) {
            .container { padding: 0.75rem 0.5rem; padding-top: calc(80px + 60px + 0.75rem); }
            .header-content { 
                flex-direction: column; 
                gap: 0.75rem; 
                text-align: center; 
            }
            .logo { font-size: 1rem; }
            .tab-content { padding: 1rem; }
            .form-section { padding: 1rem; }
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-weight-bold { font-weight: 600; }
        .text-muted { color: var(--text-muted); }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .text-warning { color: var(--warning); }
        .text-info { color: var(--info); }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--background);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Filtros por Setor */
        .filter-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-container label {
            color: #333;
            font-size: 0.95em;
            font-weight: 600;
        }

        .filter-container select {
            flex: 1;
            max-width: 300px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.95em;
            cursor: pointer;
        }

        .filter-container select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.1);
        }

        @media (max-width: 768px) {
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-container select {
                max-width: 100%;
            }
        }

    </style>
</head>
<body>
    <!-- ========================================== -->
    <!-- HEADER FIXO NO TOPO -->
    <!-- ========================================== -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <img src="https://neoformula.com.br/cdn/shop/files/Logotipo-NeoFormula-Manipulacao-Homeopatia_76b2fa98-5ffa-4cc3-ac0a-6d41e1bc8810.png?height=100&v=1677088468" alt="Neoformula">
            </div>
            
            <!-- T√≠tulo centralizado -->
            <div class="system-title">
                <span>REGISTRO DE N√ÉO CONFORMIDADE</span>
            </div>
            
            <div class="user-info">
                <div>
                    <span id="userEmail">Carregando...</span>
                    <div class="user-roles" id="userRoles"></div>
                </div>
                <span class="user-badge" id="userRole">Admin</span>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- TABS FIXAS (FORA DO CONTAINER) -->
    <!-- ========================================== -->
    <div class="tabs-wrapper">
        <div class="tabs">
            <button class="tab active" data-tab="abrir">
                <span>üìù</span>
                <span>Abrir RNC</span>
            </button>
            <button class="tab" data-tab="editar">
                <span>‚úèÔ∏è</span>
                <span>Editar RNC</span>
            </button>
            <button class="tab" data-tab="kanban">
                <span>üìã</span>
                <span>Kanban</span>
            </button>
            <button class="tab" data-tab="dashboard">
                <span>üìä</span>
                <span>Dashboard</span>
            </button>
            <button class="tab" data-tab="relatorios">
                <span>üìà</span>
                <span>Relat√≥rios</span>
            </button>
            <button class="tab" data-tab="configuracoes" id="configTab" style="display: none;">
                <span>‚öôÔ∏è</span>
                <span>Configura√ß√µes</span>
            </button>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- CONTAINER COM CONTE√öDO (COM PADDING-TOP) -->
    <!-- ========================================== -->
    <div class="container">

        <!-- Abrir RNC -->
        <div class="tab-content active" id="tab-abrir">
            <div class="page-title">
                <span>üìù</span>
                <span>Abertura de Nova RNC</span>
            </div>
            <form id="rncForm" novalidate>
                <div id="abertura-form"></div>
                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-primary" id="submitRnc">
                        <span id="submitText">üíæ Criar RNC</span>
                        <div class="loading hidden" id="submitLoading"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Editar RNC -->
        <div class="tab-content" id="tab-editar">
            <div class="page-title">
                <span>‚úèÔ∏è</span>
                <span>Edi√ß√£o de RNC</span>
            </div>
            <div class="rnc-selector">
                <h3>Selecione a RNC para editar:</h3>

                <!-- FILTROS DUPLOS - EDITAR RNC -->
                <div class="filter-container" style="margin-bottom: 20px;">
                    <label for="tipoSetorEdit">üìä Filtrar por:</label>
                    <select id="tipoSetorEdit" style="max-width: 200px;">
                        <option value="qualidade">üîç Setor da N√£o Conformidade</option>
                        <option value="abertura">üè¢ Setor de Abertura</option>
                    </select>
                    
                    <label for="setorFilterEdit" style="margin-left: 15px;">Setor:</label>
                    <select id="setorFilterEdit" style="max-width: 250px;">
                        <option value="Todos">üìã Todos os Setores</option>
                    </select>
                    
                    <span id="rncCountEdit" style="color: #666; font-size: 0.9em; margin-left: 10px;"></span>
                </div>

                <select id="rncSelect" class="form-control">
                    <option value="">Carregando RNCs...</option>
                </select>
            </div>
            <div id="editForm" class="hidden">
                <form id="rncEditForm" novalidate>
                    <div id="edit-sections"></div>
                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-primary" id="updateRnc">
                            <span id="updateText">üíæ Salvar Altera√ß√µes</span>
                            <div class="loading hidden" id="updateLoading"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Kanban -->
        <div class="tab-content" id="tab-kanban">
            <div class="page-title">
                <span>üìã</span>
                <span>Kanban de RNCs</span>
                <button class="btn btn-secondary" onclick="forceReloadKanban()" style="margin-left: auto;">
                    üîÑ Atualizar
                </button>
            </div>
        
            <!-- FILTROS DUPLOS KANBAN -->
            <div class="filter-container" style="margin-bottom: 20px;">
                <label for="tipoSetorKanban">üìä Filtrar por:</label>
                <select id="tipoSetorKanban" style="max-width: 200px;">
                    <option value="qualidade">üîç Setor da N√£o Conformidade</option>
                    <option value="abertura">üè¢ Setor de Abertura</option>
                </select>
                
                <label for="setorFilterKanban" style="margin-left: 15px;">Setor:</label>
                <select id="setorFilterKanban" style="max-width: 250px;">
                    <option value="Todos">üìã Todos os Setores</option>
                </select>
                
                <span id="rncCountKanban" style="color: #666; font-size: 0.9em; margin-left: 10px;"></span>
            </div>
            
            <div id="kanban-container"></div>
        </div>

        <!-- Dashboard -->
        <div class="tab-content" id="tab-dashboard">
            <div class="page-title">
                <span>üìä</span>
                <span>Dashboard</span>
                <button class="btn btn-secondary" onclick="forceReloadDashboard()" style="margin-left: auto;">
                    üîÑ Atualizar
                </button>
            </div>
            
            <!-- FILTROS -->
            <div class="filter-container" style="margin-bottom: 20px;">
                <label for="tipoSetorDashboard">üìä Filtrar por:</label>
                <select id="tipoSetorDashboard" style="max-width: 200px;">
                    <option value="qualidade">üîç Setor da N√£o Conformidade</option>
                    <option value="abertura">üè¢ Setor de Abertura</option>
                </select>
                
                <label for="setorFilterDashboard" style="margin-left: 15px;">Setor:</label>
                <select id="setorFilterDashboard" style="max-width: 250px;">
                    <option value="Todos">üìã Todos os Setores</option>
                </select>
                
                <span id="rncCountDashboard" style="color: #666; font-size: 0.9em; margin-left: 10px;"></span>
            </div>
            
            <div id="dashboard-content"></div>
        </div>

        <!-- Relat√≥rios -->
        <div class="tab-content" id="tab-relatorios">
            <div class="page-title">
                <span>üìà</span>
                <span>Relat√≥rios Personalizados</span>
            </div>
            
            <div class="filters-container">
                <h3 class="chart-title">üîç Filtros do Relat√≥rio</h3>
                
                <!-- LINHA 1: Data In√≠cio / Data Fim / Status -->
                <div class="filters-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="dataInicio">üìÖ Data In√≠cio</label>
                        <input type="date" id="dataInicio" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="dataFim">üìÖ Data Fim</label>
                        <input type="date" id="dataFim" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="statusFiltro">üìä Status</label>
                        <select id="statusFiltro" class="form-control">
                            <option value="Todos">Todos os Status</option>
                        </select>
                    </div>
                </div>
                
                <!-- LINHA 2: Tipo do Setor / Setor / Tipo RNC -->
                <div class="filters-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="tipoSetorRelatorio">üìä Tipo do Setor</label>
                        <select id="tipoSetorRelatorio" class="form-control">
                            <option value="qualidade">üîç Setor da N√£o Conformidade</option>
                            <option value="abertura">üè¢ Setor de Abertura</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="setorFiltro">üè¢ Setor</label>
                        <select id="setorFiltro" class="form-control">
                            <option value="Todos">Todos os Setores</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoFiltro">üìã Tipo de RNC</label>
                        <select id="tipoFiltro" class="form-control">
                            <option value="Todos">Todos os Tipos</option>
                        </select>
                    </div>
                </div>
                
                <!-- BOT√ïES DE A√á√ÉO -->
                <div class="report-actions">
                    <button class="btn btn-primary" id="generateReport">
                        <span id="reportText">üìä Gerar Relat√≥rio</span>
                        <div class="loading hidden" id="reportLoading"></div>
                    </button>
                    <button class="btn btn-success" id="exportPdf" disabled>üìÑ Exportar PDF Gerencial</button>
                    <button class="btn btn-secondary" id="clearFilters">üßπ Limpar Filtros</button>
                </div>
            </div>

            <div id="report-content"></div>
        </div>

        <!-- === CONFIGURA√á√ïES COM ABAS === -->
        <div class="tab-content" id="tab-configuracoes">
            <div class="page-title">
                <span>‚öôÔ∏è</span>
                <span>Configura√ß√µes do Sistema</span>
            </div>
            
            <div class="config-tabs">
                <button class="config-tab active" data-config-tab="sistema">
                    <span>üîß</span>
                    <span>Sistema</span>
                </button>
                <button class="config-tab" data-config-tab="listas">
                    <span>üìã</span>
                    <span>Listas</span>
                </button>
                <button class="config-tab" data-config-tab="secoes">
                    <span>üìÑ</span>
                    <span>Se√ß√µes</span>
                </button>
                <button class="config-tab" data-config-tab="campos">
                    <span>üè∑Ô∏è</span>
                    <span>Campos</span>
                </button>
                <button class="config-tab" data-config-tab="usuarios">
                    <span>üë•</span>
                    <span>Usu√°rios</span>
                </button>
            </div>
            
            <!-- ABA SISTEMA -->
            <div class="config-tab-content active" id="config-tab-sistema">
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üîß</span>
                            <span>Configura√ß√µes Gerais</span>
                        </div>
                    </div>
                    
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="pastaGID">üìÅ ID da Pasta do Google Drive</label>
                            <input type="text" id="pastaGID" class="form-control" placeholder="ID da pasta para anexos">
                            <small class="text-muted">ID da pasta onde os anexos das RNCs ser√£o salvos</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="renomearArquivos">üè∑Ô∏è Renomear Arquivos</label>
                            <select id="renomearArquivos" class="form-control">
                                <option value="Sim">Sim - RNC_0001_2025 - Imagem 1 de 3</option>
                                <option value="N√£o">N√£o - Manter nome original</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" id="saveSystemConfig">
                            üíæ Salvar Configura√ß√µes
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ABA LISTAS -->
            <div class="config-tab-content" id="config-tab-listas">
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üìã</span>
                            <span>Gerenciar Listas</span>
                        </div>
                        <button class="btn btn-primary" id="addNewList">‚ûï Nova Lista</button>
                    </div>
                    <div id="lists-container"></div>
                </div>
            </div>
            
            <!-- ABA SE√á√ïES -->
            <div class="config-tab-content" id="config-tab-secoes">
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üìÑ</span>
                            <span>Se√ß√µes do Formul√°rio</span>
                        </div>
                        <button class="btn btn-primary" id="addNewSection">‚ûï Nova Se√ß√£o</button>
                    </div>
                    <div id="sections-container"></div>
                </div>
            </div>
            
            <!-- ABA CAMPOS -->
            <div class="config-tab-content" id="config-tab-campos">
                <div class="config-section">
                    <div class="config-header">
                        <div class="config-title">
                            <span>üè∑Ô∏è</span>
                            <span>Campos dos Formul√°rios</span>
                        </div>
                        <button class="btn btn-primary" id="addNewField">‚ûï Novo Campo</button>
                    </div>
                    <div id="fields-container"></div>
                </div>
            </div>
   
            <!-- ABA USU√ÅRIOS -->
            <div class="config-tab-content" id="config-tab-usuarios">
                
                <!-- LEGENDA DE ROLES -->
                <div class="config-section" style="margin-bottom: 20px;">
                    <div class="config-header" style="padding-bottom: 10px; margin-bottom: 15px;">
                        <div class="config-title">
                            <span>üìñ</span>
                            <span>Legenda de Roles</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff3f3; border-left: 3px solid #F44336; border-radius: 6px;">
                            <span class="role-badge admin" style="font-size: 11px; padding: 2px 6px;">Admin</span>
                            <span style="font-size: 11px; color: #666;">Acesso total</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f0f8ff; border-left: 3px solid #2196F3; border-radius: 6px;">
                            <span class="role-badge abertura" style="font-size: 11px; padding: 2px 6px;">Abertura</span>
                            <span style="font-size: 11px; color: #666;">Cria RNCs</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f0fff4; border-left: 3px solid #4CAF50; border-radius: 6px;">
                            <span class="role-badge qualidade" style="font-size: 11px; padding: 2px 6px;">Qualidade</span>
                            <span style="font-size: 11px; color: #666;">Edita Qualidade</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff8f0; border-left: 3px solid #FF9800; border-radius: 6px;">
                            <span class="role-badge lideranca" style="font-size: 11px; padding: 2px 6px;">Lideran√ßa</span>
                            <span style="font-size: 11px; color: #666;">Edita Lideran√ßa</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f5f5f5; border-left: 3px solid #9E9E9E; border-radius: 6px;">
                            <span class="role-badge espectador" style="font-size: 11px; padding: 2px 6px;">Espectador</span>
                            <span style="font-size: 11px; color: #666;">Visualiza</span>
                        </div>
                    </div>
                </div>
                
                <!-- LISTA DE USU√ÅRIOS -->
                <div class="config-section">
                    <div class="config-header" style="padding-bottom: 10px; margin-bottom: 15px;">
                        <div class="config-title">
                            <span>üë•</span>
                            <span>Usu√°rios Cadastrados</span>
                        </div>
                        <button class="btn btn-primary" id="addNewUser" style="font-size: 13px; padding: 8px 16px;">
                            ‚ûï Novo Usu√°rio
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;" id="users-container">
                        <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: #999;">
                            Carregando usu√°rios...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div id="loadingMessage">Carregando...</div>
        </div>
    </div>

    <!-- Debug Panel -->
    <button class="debug-toggle" id="debugToggle" title="Debug">üêõ</button>
    <div class="debug-panel" id="debugPanel">
        <div class="debug-header">
            <div class="debug-title">üêõ SISTEMA RNC DEBUG</div>
            <button class="debug-clear" onclick="clearDebugLog()">Clear</button>
        </div>
        <div class="debug-section">
            <div>systemReady: <span id="debugSystemReady">false</span></div>
            <div>currentRnc: <span id="debugCurrentRnc">null</span></div>
            <div>availableRncs: <span id="debugAvailableRncs">0</span></div>
            <div>reportData: <span id="debugReportData">null</span></div>
        </div>
        <div class="debug-section">
            <h4>üìã √öLTIMOS LOGS:</h4>
            <div class="debug-log" id="debugLogs"></div>
        </div>
    </div>

    <script>

// ==========================================
// TASK-001: FUN√á√ÉO DE SANITIZA√á√ÉO HTML
// SEGURAN√áA: Previne XSS (Cross-Site Scripting)
// ==========================================

/**
 * Sanitiza HTML removendo tags e atributos perigosos
 * @param {string} html - HTML a ser sanitizado
 * @returns {string} HTML sanitizado e seguro
 */
function sanitizeHTML(html) {
    if (!html) return '';

    // Criar elemento tempor√°rio para parsing
    const temp = document.createElement('div');
    temp.textContent = html; // textContent automaticamente escapa HTML

    // Lista de tags permitidas (whitelist)
    const allowedTags = ['b', 'i', 'u', 'strong', 'em', 'br', 'p', 'span', 'div'];

    // Lista de atributos perigosos (blacklist)
    const dangerousAttributes = [
        'onclick', 'onload', 'onerror', 'onmouseover', 'onmouseout',
        'onfocus', 'onblur', 'onchange', 'onsubmit', 'onkeydown',
        'onkeyup', 'onkeypress', 'javascript:', 'data:', 'vbscript:'
    ];

    let sanitized = temp.innerHTML;

    // Remover scripts
    sanitized = sanitized.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');

    // Remover iframes
    sanitized = sanitized.replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '');

    // Remover event handlers
    dangerousAttributes.forEach(attr => {
        const regex = new RegExp(`\\s*${attr}\\s*=\\s*["'][^"']*["']`, 'gi');
        sanitized = sanitized.replace(regex, '');
    });

    return sanitized;
}

/**
 * Define conte√∫do HTML de forma segura
 * @param {HTMLElement} element - Elemento DOM
 * @param {string} html - Conte√∫do HTML
 * @param {boolean} sanitize - Se deve sanitizar (padr√£o: true)
 */
function safeSetHTML(element, html, sanitize = true) {
    if (!element) return;

    if (sanitize) {
        element.innerHTML = sanitizeHTML(html);
    } else {
        element.innerHTML = html;
    }
}

// ==========================================
        // INICIALIZAR SISTEMA DE TABS
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando sistema de tabs...');
            
            // Selecionar todas as tabs principais
            const tabs = document.querySelectorAll('.tab[data-tab]');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('üìã Total de tabs encontradas:', tabs.length);
            console.log('üìÑ Total de conte√∫dos encontrados:', tabContents.length);
            
            // Adicionar evento de clique em cada tab
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    console.log('üëÜ Clicou na tab:', targetTab);
                    switchTab(targetTab);
                });
            });
            
            // Inicializar tabs de configura√ß√£o
            initConfigTabs();
            
            console.log('‚úÖ Sistema de tabs inicializado com sucesso!');
        });

        // ==========================================
        // FUN√á√ÉO PARA TROCAR DE TAB PRINCIPAL
        // ==========================================
        function switchTab(tabName) {
    // Remover classe ativa de todas as abas
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Ativar aba selecionada
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    debugLog('info', 'üîÑ Mudando para aba', { tab: tabName, alreadyLoaded: loadedTabs[tabName] });
    
    // ‚úÖ SEMPRE re-renderizar abas Abrir e Editar (mesmo se j√° carregadas)
    if (tabName === 'abrir') {
        console.log('üìù Renderizando formul√°rio de Abertura');
        renderAberturaForm();
        loadedTabs[tabName] = true;
        return;
    }
    
    if (tabName === 'editar') {
        console.log('‚úèÔ∏è Preparando aba de Edi√ß√£o');
        if (!loadedTabs[tabName]) {
            Promise.all([
                loadSetoresFilter(),
                loadAvailableRncs()
            ]).then(() => {
                debugLog('success', '‚úÖ Aba Editar carregada');
                loadedTabs[tabName] = true;
            });
        }
        return;
    }
    
    // === LAZY LOADING para outras abas ===
    if (!loadedTabs[tabName]) {
        loadedTabs[tabName] = true;
        
        switch (tabName) {
            case 'kanban':
                loadKanban();
                break;
            case 'dashboard':
                loadDashboard();
                break;
            case 'relatorios':
                loadReportFilters();
                break;
            case 'configuracoes':
                loadConfigurations();
                break;
        }
    } else {
        debugLog('info', '‚ö° Aba j√° carregada, pulando');
    }
}

/**
 * For√ßa re-renderiza√ß√£o da aba ativa
 */
function forceRefreshActiveTab() {
    console.log('üîÑ For√ßando refresh da aba ativa');
    
    var abrirContent = document.getElementById('tab-abrir');
    var editarContent = document.getElementById('tab-editar');
    
    if (abrirContent && abrirContent.classList.contains('active')) {
        console.log('  ‚úÖ Re-renderizando Abrir RNC');
        renderAberturaForm();
    }
    
    if (editarContent && editarContent.classList.contains('active')) {
        console.log('  ‚úÖ Verificando Editar RNC');
        if (typeof window.currentRnc !== 'undefined' && window.currentRnc && window.currentRnc['N¬∫ RNC']) {
            loadRncForEdit(window.currentRnc['N¬∫ RNC']);
        }
    }
}


        // ==========================================
        // FUN√á√ÉO PARA TABS DE CONFIGURA√á√ÉO
        // ==========================================
        function initConfigTabs() {
            const configTabs = document.querySelectorAll('.config-tab[data-config-tab]');
            
            console.log('‚öôÔ∏è Inicializando', configTabs.length, 'config-tabs');
            
            configTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-config-tab');
                    console.log('üëÜ Clicou na config-tab:', targetTab);
                    
                    try {
                        // Remover active de todas as config-tabs
                        configTabs.forEach(t => t.classList.remove('active'));
                        
                        // Adicionar active na tab clicada
                        this.classList.add('active');
                        
                        // Remover active de todos os conte√∫dos de config
                        const contents = document.querySelectorAll('.config-tab-content');
                        contents.forEach(c => c.classList.remove('active'));
                        
                        // Adicionar active no conte√∫do correspondente
                        const activeContent = document.getElementById('config-tab-' + targetTab);
                        if (activeContent) {
                            activeContent.classList.add('active');
                            console.log('‚úÖ Config-tab ativada:', targetTab);
                        } else {
                            console.error('‚ùå Config-tab n√£o encontrada:', targetTab);
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao trocar config-tab:', error);
                    }
                });
            });
        }

        // ==========================================
        // EXPOR FUN√á√ÉO GLOBALMENTE (para debug)
        // ==========================================
        window.switchTab = switchTab;
        
        console.log('üì¶ Script de navega√ß√£o carregado!');

// === VARI√ÅVEIS GLOBAIS - DECLARADAS UMA √öNICA VEZ ===
let debugLogs = [];
let appContext = null;  // Ser√° preenchido ap√≥s carregar
let currentRnc = null;
let availableRncs = [];
let reportData = null;
let selectedFiles = [];

// === INICIALIZA√á√ÉO SEGURA ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, iniciando sistema...');
    
    // Garantir que elementos existem antes de acessar
    var userEmailEl = document.getElementById('userEmail');
    var userRoleEl = document.getElementById('userRole');
    
    // Definir valores tempor√°rios enquanto carrega
    if (userEmailEl) userEmailEl.textContent = 'Carregando...';
    if (userRoleEl) userRoleEl.textContent = 'Carregando...';
    
    // Inicializar aplica√ß√£o
    setTimeout(function() {
        if (typeof initializeApp === 'function') {
            initializeApp();
        }
    }, 500);
});

// === TRATAMENTO DE ERROS GLOBAL ===
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('Erro JavaScript:', {
        message: msg,
        line: lineNo,
        column: columnNo
    });
    
    // N√£o bloquear a aplica√ß√£o por erros menores
    if (msg.includes('appContext') && !appContext) {
        console.log('Inicializando appContext de emerg√™ncia...');
        appContext = {
            email: 'usuario@neoformula.com',
            role: 'Usuario',
            fieldsConfig: { Abertura: [] },
            lists: {},
            sections: [],
            canConfig: false
        };
    }
    
    return true; // Previne o erro padr√£o do navegador
};


        // === SISTEMA DE DEBUG E LOGGING ===
        function debugLog(level, message, data = {}) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                level,
                message,
                data: data
            };
            
            debugLogs.unshift(logEntry);
            if (debugLogs.length > 100) debugLogs.pop();
            
            console.log(`[${timestamp}] [${level.toUpperCase()}] ${message}`, data);
            
            updateDebugPanel();
        }
        
        function updateDebugPanel() {
            try {
                document.getElementById('debugSystemReady').textContent = !!appContext;
                document.getElementById('debugCurrentRnc').textContent = currentRnc || 'null';
                document.getElementById('debugAvailableRncs').textContent = availableRncs.length;
                document.getElementById('debugReportData').textContent = reportData ? `${reportData.rncs ? reportData.rncs.length : 0} RNCs` : 'null';
                
                const levelColors = {
                    'info': '#10B981',
                    'error': '#EF4444', 
                    'warning': '#F59E0B',
                    'success': '#10B981'
                };
                
                const logsHtml = debugLogs.slice(0, 15).map(log => {
                    return `<div style="color: ${levelColors[log.level] || '#10B981'}; margin-bottom: 0.25rem; font-size: 0.6875rem;">[${log.timestamp}] [${log.level.toUpperCase()}] ${log.message}</div>`;
                }).join('');
                
                document.getElementById('debugLogs').innerHTML = logsHtml;
            } catch(e) {
                console.error('Erro ao atualizar debug panel:', e);
            }
        }
        
        function clearDebugLog() {
            debugLogs = [];
            updateDebugPanel();
        }
        
        // === SISTEMA DE COMUNICA√á√ÉO COM BACKEND ===
        async function apiCall(funcName, params = [], maxRetries = 1, timeout = 90000) {
            debugLog('info', `üì° API Call DEPLOY 30: ${funcName}`, { params, maxRetries });
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    debugLog('info', `üîÑ Tentativa ${attempt}/${maxRetries}: ${funcName}`);
                    
                    const result = await new Promise((resolve, reject) => {
                        const timer = setTimeout(() => {
                            reject(new Error(`Timeout de ${timeout}ms excedido`));
                        }, timeout);
                        
                        google.script.run
                            .withSuccessHandler(response => {
                                clearTimeout(timer);
                                resolve(response);
                            })
                            .withFailureHandler(error => {
                                clearTimeout(timer);
                                reject(error);
                            })
                            [funcName](...params);
                    });
                    
                    debugLog('success', `‚úÖ Sucesso: ${funcName}`, { hasResult: !!result });
                    return result;
                    
                } catch (error) {
                    debugLog('error', `‚ùå Tentativa ${attempt} falhou: ${funcName}`, { error: error.message });
                    
                    if (attempt === maxRetries) {
                        debugLog('error', `üí• Todas as tentativas falharam: ${funcName}`, { error: error.message });
                        throw error;
                    }
                    
                    const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // === INICIALIZA√á√ÉO ===
        // No topo do arquivo, adicione:
        var appInitialized = false;

       async function initializeApp() {

         if (appInitialized) {
        console.log('‚ö†Ô∏è [INIT] App j√° inicializado, ignorando chamada duplicada');
        return;
    }
    
    appInitialized = true; 

    try {

        console.log('üöÄ [INIT] Iniciando aplica√ß√£o RNC - Deploy 41');
        console.log('üöÄ [INIT] URL:', window.location.href);
        console.log('üöÄ [INIT] Timestamp:', new Date().toISOString());

        debugLog('info', 'üöÄ Iniciando aplica√ß√£o RNC DEPLOY 33 (Corre√ß√£o Final)');
        showLoading('Carregando configura√ß√µes...');
        
        // === CARREGAR CONTEXTO (J√Å COM DIAGN√ìSTICO INTEGRADO) ===
        appContext = await apiCall('getUserContextOptimized');

        // ‚ú® DEBUG TEMPOR√ÅRIO - REMOVER DEPOIS
        console.log('=== DEBUG: LISTAS CARREGADAS ===');
        console.log('appContext.lists:', appContext.lists);
        console.log('Total de listas:', Object.keys(appContext.lists || {}).length);
        Object.keys(appContext.lists || {}).forEach(listName => {
            console.log(`  - ${listName}:`, appContext.lists[listName]);
        });
        console.log('=== FIM DEBUG ===');
        
        console.log('üì¶ Contexto recebido:', appContext);
        
        // === VERIFICAR SE TEM PERMISS√ïES ===
        if (!appContext || appContext.error || !appContext.hasPermissions) {
            hideLoading();
            
            const errorMessage = appContext ? (appContext.error || 'Sem permiss√µes ativas') : 'Erro ao carregar';
            
            document.body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #f5f5f5; font-family: Inter, sans-serif;">
                    <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 600px; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üîí</div>
                        <h2 style="color: #F44336; margin-bottom: 20px;">Acesso Negado</h2>
                        <p style="margin-bottom: 15px; color: #666;">Seu email <strong>${sanitizeHTML(appContext.email) || 'desconhecido'}</strong> n√£o possui permiss√µes cadastradas.</p>
                        <p style="margin-bottom: 20px; color: #666;">Entre em contato com o administrador e informe:</p>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; margin-bottom: 20px; text-align: left;">
                            <strong>Email:</strong> ${sanitizeHTML(appContext.email) || 'N/A'}<br>
                            <strong>Status:</strong> ${sanitizeHTML(errorMessage)}<br>
                            <strong>Total de usu√°rios na planilha:</strong> ${appContext.totalLinhasPlanilha || 'N/A'}
                        </div>
                        <button onclick="location.reload()" style="background: #009688; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                </div>
            `;
            return;
        }
        
        // === USU√ÅRIO TEM PERMISS√ïES - CONTINUAR ===
        debugLog('success', '‚úÖ Contexto carregado', {
            email: appContext.email,
            roles: appContext.roles.join(', '),
            isAdmin: appContext.isAdmin,
            fieldsCount: Object.keys(appContext.fieldsConfig).length
        });
        
        // Atualizar interface
        var userEmailEl = document.getElementById('userEmail');
        if (userEmailEl) userEmailEl.textContent = appContext.email || 'An√¥nimo';
        
        var userRoleEl = document.getElementById('userRole');
        if (userRoleEl) userRoleEl.textContent = appContext.role || 'Usuario';
        
        var configTab = document.getElementById('configTab');
        if (configTab && appContext.canConfig) {
            configTab.style.display = 'flex';
        }
        
        // Renderizar formul√°rio de abertura
        renderAberturaForm();
        
        // Renderizar roles do usu√°rio
        renderUserRoles();
        
        hideLoading();
        debugLog('success', 'üéâ Aplica√ß√£o inicializada');
        
    } catch (error) {
        debugLog('error', 'üí• Erro na inicializa√ß√£o', { error: error.message });
        console.error('Erro completo:', error);
        hideLoading();
        
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #f5f5f5; font-family: Inter, sans-serif;">
                <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 600px; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h2 style="color: #F44336; margin-bottom: 20px;">Erro ao Carregar</h2>
                    <p style="margin-bottom: 20px; color: #666;">${sanitizeHTML(error.message)}</p>
                    <button onclick="location.reload()" style="background: #009688; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                        üîÑ Recarregar P√°gina
                    </button>
                </div>
            </div>
        `;
    }
}

// ADICIONE ESTA NOVA FUN√á√ÉO
function continueInitialization() {
    debugLog('success', '‚úÖ Contexto carregado DEPLOY 30', {
        email: appContext.email || 'n√£o definido',
        role: appContext.role || 'n√£o definido',
        fieldsCount: appContext.fieldsConfig ? Object.keys(appContext.fieldsConfig).length : 0,
        statusPipeline: appContext.statusPipeline
    });
    
 // Verifica√ß√£o completa antes de acessar
if (typeof appContext !== 'undefined' && appContext && appContext.email) {
    if (document.getElementById('userEmail')) {
        document.getElementById('userEmail').textContent = appContext.email;
    }
} else {
    console.log('appContext ainda n√£o carregado na linha 143');
    if (document.getElementById('userEmail')) {
        document.getElementById('userEmail').textContent = 'Carregando...';
    }
}
    document.getElementById('userRole').textContent = appContext.role || 'Usuario';
    
    if (appContext.canConfig) {
        document.getElementById('configTab').style.display = 'flex';
    }
    
    // Renderizar formul√°rio de abertura
    renderAberturaForm();
    
    // Carregar RNCs dispon√≠veis para edi√ß√£o
    loadAvailableRncs().then(() => {
        hideLoading();
        debugLog('success', 'üéâ Aplica√ß√£o inicializada DEPLOY 30');
    });
}
        
// === RENDERIZA√á√ÉO DE FORMUL√ÅRIO DE ABERTURA ===
function renderAberturaForm() {
    try {
        console.log('üîµ [RENDER] Iniciando renderAberturaForm()');
        console.log('üîµ [RENDER] appContext existe:', !!appContext);
        console.log('üîµ [RENDER] appContext.fieldsConfig existe:', !!appContext.fieldsConfig);
        console.log('üîµ [RENDER] appContext.fieldsConfig.Abertura existe:', !!appContext.fieldsConfig.Abertura);
        
        debugLog('info', 'üèóÔ∏è Renderizando formul√°rio de abertura Deploy 32');
        
        const permission = appContext.permissions['Abertura'] || 'visualizar';
        console.log('üîµ [RENDER] Permiss√£o para Abertura:', permission);
        
        if (permission === 'negar') {
            const container = document.getElementById('abertura-form');
            container.innerHTML = `
                <div class="alert alert-error">
                    <h3>üîí Acesso Negado</h3>
                    <p>Voc√™ n√£o tem permiss√£o para abrir novas RNCs.</p>
                    <p>Entre em contato com o administrador do sistema.</p>
                </div>
            `;
            document.getElementById('submitRnc').style.display = 'none';
            return;
        }
        
        const container = document.getElementById('abertura-form');
        const aberturaFields = appContext.fieldsConfig.Abertura || [];
        
        console.log('üîµ [RENDER] Total de campos de Abertura:', aberturaFields.length);
        console.log('üîµ [RENDER] Campos:', aberturaFields.map(f => f.name));
        
        debugLog('info', 'üìã Campos de abertura encontrados', { 
            count: aberturaFields.length,
            fields: aberturaFields.map(f => f.name)
        });
        
        if (aberturaFields.length === 0) {
            container.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Nenhum campo de abertura configurado. Configure os campos na aba "Configura√ß√µes".</div>';
            console.log('‚ö†Ô∏è [RENDER] Nenhum campo encontrado, abortando');
            return;
        }
        
        console.log('üîµ [RENDER] Gerando HTML dos campos...');
        
        const sectionHtml = `
            <div class="form-section">
                <h3>üìù Dados da Abertura</h3>
                <div class="form-grid">
                    ${aberturaFields.map(field => {
                        let defaultValue = '';
                        
                        if (field.name === 'N¬∫ RNC') {
                            defaultValue = 'Gerado automaticamente';
                        } else if (field.name === 'Status') {
                            defaultValue = 'Abertura RNC';
                        } else if (field.name === 'Data Abertura' || field.name === 'Data') {
                            defaultValue = formatDateForInput(new Date());
                        }
                        
                        return renderField(field, defaultValue, 'Abertura');
                    }).join('')}
                </div>
            </div>
        `;
        
        console.log('üîµ [RENDER] HTML gerado, atualizando container');
        container.innerHTML = sectionHtml;
        
        console.log('üîµ [RENDER] Configurando upload de arquivos');
        setupFileUpload();
        
        console.log('‚úÖ [RENDER] renderAberturaForm() conclu√≠da com sucesso');
        
        debugLog('success', '‚úÖ Formul√°rio de abertura renderizado com valores autom√°ticos', { 
            fieldsCount: aberturaFields.length 
        });
        
    } catch (error) {
        console.error('‚ùå [RENDER] Erro em renderAberturaForm():', error);
        console.error('‚ùå [RENDER] Stack:', error.stack);
        debugLog('error', '‚ùå Erro ao renderizar formul√°rio', { error: error.message });
        showError('Erro ao renderizar formul√°rio: ' + error.message);
    }
}
        
        // === RENDERIZA√á√ÉO DE CAMPOS CORRIGIDA (DEPLOY 30) ===
        /**
 * Renderiza campo individual COM PERMISS√ïES
 * Deploy 32 - Sistema de Permiss√µes
 */
/**
 * Renderiza campo individual COM PERMISS√ïES
 * Deploy 32 - Sistema de Permiss√µes
 */
function renderField(field, value, secao, isEditContext = false) {
    const fieldName = field.name;
    const fieldType = field.type;
    const isRequired = field.required;
    const placeholder = field.placeholder || '';
    
    // ‚ú® NOVO: Verificar permiss√£o para a se√ß√£o
    const permission = appContext.permissions[secao] || 'visualizar';
    
    // ‚ú® NOVO: Se permiss√£o √© "negar", n√£o renderizar
    if (permission === 'negar') {
        return '';
    }
    
    // ‚ú® NOVO: Se permiss√£o √© "visualizar", desabilitar campo
    const isReadOnly = (permission === 'visualizar');
    const disabledAttr = isReadOnly ? 'disabled' : '';
    const readonlyClass = isReadOnly ? 'field-readonly' : '';
    
    let fieldHtml = `
        <div class="form-group ${readonlyClass}">
            <label for="${fieldName}">
                ${fieldName}
                ${isRequired ? '<span style="color: red;">*</span>' : ''}
                ${isReadOnly ? '<span class="badge-readonly">üîí Somente Leitura</span>' : ''}
            </label>
    `;
    
    switch (fieldType) {
        case 'input':
            fieldHtml += `<input 
                type="text" 
                id="${fieldName}" 
                name="${fieldName}" 
                class="form-control" 
                placeholder="${placeholder}"
                value="${value || ''}"
                ${disabledAttr}
                ${isRequired ? 'required' : ''}>`;
            break;
            
        case 'textarea':
            fieldHtml += `<textarea 
                id="${fieldName}" 
                name="${fieldName}" 
                class="form-control" 
                rows="4" 
                placeholder="${placeholder}"
                ${disabledAttr}
                ${isRequired ? 'required' : ''}>${value || ''}</textarea>`;
            break;
            
        case 'select':
    console.log('=== DEBUG SELECT ===');
    console.log('Campo:', field.name);
    console.log('field.list:', field.list);
    console.log('Valor recebido:', value);
    console.log('Tipo do valor:', typeof value);
    console.log('appContext.lists:', appContext.lists);
    console.log('Lista encontrada:', appContext.lists[field.list]);
    console.log('==================');
    
    const listItems = appContext.lists[field.list] || [];
    
    fieldHtml += `<select 
        id="${fieldName}" 
        name="${fieldName}" 
        class="form-control"
        ${disabledAttr}
        ${isRequired ? 'required' : ''}>
        <option value="">${placeholder}</option>`;
    
    if (listItems.length === 0) {
        console.warn(`‚ö†Ô∏è Lista vazia para campo "${field.name}" (lista: "${field.list}")`);
    }
    
    // ‚úÖ CORRE√á√ÉO: Converter valor para string para compara√ß√£o
    const valueStr = value !== null && value !== undefined ? String(value).trim() : '';
    
    listItems.forEach(item => {
        const itemStr = String(item).trim();
        const selected = (valueStr === itemStr) ? 'selected' : '';
        fieldHtml += `<option value="${item}" ${selected}>${item}</option>`;
        
        // Debug detalhado
        if (field.name === 'Filial de Origem') {
            console.log('Comparando:', {
                value: valueStr,
                item: itemStr,
                match: valueStr === itemStr,
                selected: selected
            });
        }
    });
    
    fieldHtml += `</select>`;
    break;

            case 'multiselect':
    // Gerar op√ß√µes da lista
    let multiselectOptions = '';
    if (field.list && appContext.lists[field.list]) {
        multiselectOptions = appContext.lists[field.list]
            .map(option => `<option value="${option}">${option}</option>`)
            .join('');
    }
    
    // Gerar IDs √∫nicos
    const multiselectId = `multiselect_${fieldName.replace(/\s+/g, '_')}`;
    const chipsContainerId = `chips_${fieldName.replace(/\s+/g, '_')}`;
    const selectId = `select_${fieldName.replace(/\s+/g, '_')}`;
    
    // Construir HTML SEM BOT√ÉO
    fieldHtml += `
        <div class="multiselect-wrapper ${isRequired ? 'required' : ''}" data-field="${fieldName}">
            <div class="chips-container ${value ? '' : 'empty'}" 
                 id="${chipsContainerId}" 
                 data-field-name="${fieldName}">
            </div>
            
            <select id="${selectId}" 
                    class="multiselect-select" 
                    ${disabledAttr}
                    onchange="addChipOnSelect(this, '${chipsContainerId}', '${fieldName}')">
                <option value="">-- Selecione para adicionar --</option>
                ${multiselectOptions}
            </select>
            
            <input type="hidden" 
                   name="${fieldName}" 
                   id="${multiselectId}" 
                   value="${value || ''}"
                   ${isRequired ? 'required' : ''}>
            
            <small class="multiselect-hint">
                üí° Clique em uma op√ß√£o para adicionar como tag
            </small>
        </div>
    `;
    
    // Inicializar chips ap√≥s renderiza√ß√£o
    setTimeout(() => initializeMultiselectChips(chipsContainerId, value, fieldName, isReadOnly), 100);
    break;

            
            case 'date':
        // ‚úÖ CORRE√á√ÉO: Formatar data para yyyy-MM-dd
        const formattedDate = formatDateForInput(value);
        
        fieldHtml += `<input 
            type="date" 
            id="${fieldName}" 
            name="${fieldName}" 
            class="form-control"
            value="${formattedDate}"
            ${disabledAttr}
            ${isRequired ? 'required' : ''}>`;
        break;

        
            
        case 'number':
            fieldHtml += `<input 
                type="number" 
                id="${fieldName}" 
                name="${fieldName}" 
                class="form-control"
                placeholder="${placeholder}"
                value="${value || ''}"
                ${disabledAttr}
                ${isRequired ? 'required' : ''}>`;
            break;
            
        case 'file':
    if (isReadOnly) {
        fieldHtml += `<div class="alert alert-info">
            üìé Voc√™ n√£o pode fazer upload de arquivos nesta se√ß√£o (somente leitura)
        </div>`;
    } else {
        // ‚úÖ CORRE√á√ÉO: IDs din√¢micos baseados no contexto (Abrir ou Editar)
        const inputId = isEditContext ? 'fileInputEdit' : fieldName;
        const uploadDivId = isEditContext ? 'fileUploadEdit' : 'fileUpload';
        const listDivId = isEditContext ? 'fileListEdit' : 'fileList';
        
        fieldHtml += `
            <input 
                type="file" 
                id="${inputId}" 
                name="${inputId}" 
                style="display: none;"
                multiple
                accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
            
            <!-- Bot√£o customizado -->
            <div id="${uploadDivId}" class="file-upload" onclick="document.getElementById('${inputId}').click()">
                <div class="file-upload-icon">üìé</div>
                <p>Clique ou arraste arquivos aqui</p>
                <small>PDF, DOC, XLS, JPG, PNG (M√°x. 10MB)</small>
            </div>
            
            <!-- Lista de arquivos selecionados -->
            <div id="${listDivId}" class="file-list"></div>
        `;
    }
    break;
            
        case 'label':
            fieldHtml += `<div class="form-control-static">${value || '-'}</div>`;
            break;
            
        default:
            fieldHtml += `<input 
                type="text" 
                id="${fieldName}" 
                name="${fieldName}" 
                class="form-control"
                value="${value || ''}"
                ${disabledAttr}>`;
    }
    
    fieldHtml += `</div>`;
    return fieldHtml;
}
        
        // === SISTEMA DE UPLOAD DE ARQUIVOS ===
        function setupFileUpload(isEdit = false) {
    // ‚úÖ IDs corretos
    const fileInputId = isEdit ? 'fileInputEdit' : 'Anexo de Documentos';
    const fileUploadId = isEdit ? 'fileUploadEdit' : 'fileUpload';
    const fileListId = isEdit ? 'fileListEdit' : 'fileList';
    
    const fileInput = document.getElementById(fileInputId);
    const fileUpload = document.getElementById(fileUploadId);
    const fileList = document.getElementById(fileListId);
    
    // ‚úÖ Se algum elemento n√£o existir, retornar silenciosamente
    if (!fileInput || !fileUpload || !fileList) {
        console.log('‚ö†Ô∏è [UPLOAD] Elementos n√£o encontrados (normal se n√£o houver campo de arquivo)');
        return;
    }
    
    debugLog('info', 'üìé Configurando sistema de upload', { isEdit });
    
    fileInput.addEventListener('change', (e) => handleFileSelect(e, isEdit));
    
    // Drag & Drop
    fileUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUpload.classList.add('dragover');
    });
    
    fileUpload.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUpload.classList.remove('dragover');
    });
    
    fileUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUpload.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files, isEdit);
    });
}

        
        function handleFileSelect(e, isEdit = false) {
            const files = Array.from(e.target.files);
            handleFiles(files, isEdit);
        }
        
        function handleFiles(files, isEdit = false) {
            debugLog('info', 'üìÇ Processando arquivos DEPLOY 30', { count: files.length, isEdit });

            files.forEach(file => {
                // ‚úÖ DEPLOY 33 FIX: Validar tamanho (10MB) com modal vis√≠vel
                if (file.size > 10 * 1024 * 1024) {
                    const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                    showErrorModal(
                        '‚ùå Arquivo Muito Grande',
                        `<strong>Arquivo:</strong> ${file.name}<br>` +
                        `<strong>Tamanho:</strong> ${sizeInMB} MB<br><br>` +
                        `<strong>Tamanho m√°ximo permitido:</strong> 10 MB<br><br>` +
                        `Por favor, reduza o tamanho do arquivo ou divida-o em partes menores.`
                    );
                    debugLog('error', `‚ùå Arquivo rejeitado (muito grande): ${file.name}`, { size: sizeInMB + ' MB' });
                    return;
                }

                // ‚úÖ DEPLOY 33 FIX: Validar tipo com modal vis√≠vel
                const allowedTypes = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.jpg', '.jpeg', '.png'];
                const extension = '.' + file.name.split('.').pop().toLowerCase();

                if (!allowedTypes.includes(extension)) {
                    showErrorModal(
                        '‚ùå Tipo de Arquivo N√£o Permitido',
                        `<strong>Arquivo:</strong> ${file.name}<br>` +
                        `<strong>Tipo:</strong> ${extension}<br><br>` +
                        `<strong>Tipos permitidos:</strong><br>` +
                        `‚Ä¢ Documentos: .pdf, .doc, .docx<br>` +
                        `‚Ä¢ Planilhas: .xls, .xlsx<br>` +
                        `‚Ä¢ Imagens: .jpg, .jpeg, .png`
                    );
                    debugLog('error', `‚ùå Arquivo rejeitado (tipo n√£o permitido): ${file.name}`, { extension });
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileData = {
                        name: file.name,
                        size: file.size,
                        mimeType: file.type,
                        content: e.target.result.split(',')[1] // Remove data:type;base64,
                    };

                    selectedFiles.push(fileData);
                    updateFileList(isEdit);

                    debugLog('success', `‚úÖ Arquivo carregado DEPLOY 30: ${file.name}`, {
                        size: formatFileSize(file.size)
                    });
                };
                reader.readAsDataURL(file);
            });
        }
        
        /**
 * Atualiza lista de arquivos selecionados COM CONTADOR
 * Deploy 37 - Adicionar contador visual de arquivos
 */
function updateFileList(isEdit = false) {
    const fileListId = isEdit ? 'fileListEdit' : 'fileList';
    const fileList = document.getElementById(fileListId);
    
    if (!fileList) return;
    
    // ‚úÖ NOVO: Atualizar contador na interface de upload
    updateFileUploadCounter(selectedFiles.length, isEdit);
    
    if (selectedFiles.length === 0) {
        fileList.innerHTML = '';
        return;
    }
    
    // TASK-004: Sanitizar file.name para prevenir XSS
    fileList.innerHTML = selectedFiles.map((file, index) => `
        <div class="file-item">
            <div class="file-info">
                <div class="file-icon">üìÑ</div>
                <div class="file-details">
                    <div class="file-name">${sanitizeHTML(file.name)}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                </div>
            </div>
            <button type="button" onclick="removeFile(${index}, ${isEdit})">üóëÔ∏è Remover</button>
        </div>
    `).join('');
    
    debugLog('info', `üìé Lista de arquivos atualizada: ${selectedFiles.length} arquivo(s)`);
}
        
/**
 * Atualiza contador visual de arquivos na interface de upload
 * Deploy 37 - Contador de arquivos anexados
 */
function updateFileUploadCounter(count, isEdit = false) {
    const fileUploadId = isEdit ? 'fileUploadEdit' : 'fileUpload';
    const fileUpload = document.getElementById(fileUploadId);
    
    if (!fileUpload) return;
    
    // Remover contador anterior se existir
    const oldCounter = fileUpload.querySelector('.file-upload-counter');
    if (oldCounter) {
        oldCounter.remove();
    }
    
    // Se h√° arquivos, adicionar contador
    if (count > 0) {
        const counter = document.createElement('div');
        counter.className = 'file-upload-counter';
        counter.innerHTML = `
            <span class="counter-badge">üìé ${count}</span>
            <span class="counter-text">${count === 1 ? 'arquivo selecionado' : 'arquivos selecionados'}</span>
        `;
        fileUpload.appendChild(counter);
        
        debugLog('info', `‚úÖ Contador atualizado: ${count} arquivo(s)`);
    }
}


        /**
         * Remove arquivo da lista de selecionados
         * Deploy 37 - Suporte para edi√ß√£o
         */
        function removeFile(index, isEdit = false) {
            selectedFiles.splice(index, 1);
            updateFileList(isEdit);
            
            debugLog('info', `üóëÔ∏è Arquivo removido: index ${index}`);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
/**
 * Valida permiss√µes antes de salvar
 * Deploy 32
 */
function validatePermissionsBeforeSave() {
    const permission = appContext.permissions['Abertura'];
    
    if (permission !== 'editar') {
        showError('Voc√™ n√£o tem permiss√£o para criar RNCs');
        return false;
    }
    
    return true;
}

/**
 * Modal de ERRO customizado - Deploy 33 Fix v3
 * Mostra erros de valida√ß√£o de forma MUITO vis√≠vel
 * COM FALLBACK para alert()
 */
function showErrorModal(title, message) {
    console.log('üî¥ showErrorModal chamado:', title, message);

    try {
        return new Promise((resolve) => {
            // Remover modais anteriores
            const oldModal = document.getElementById('errorModal');
            if (oldModal) oldModal.remove();

            const modalHtml = `
                <div id="errorModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
                    <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 600px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: slideUp 0.3s;">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                        <h2 style="color: #f44336; margin-bottom: 15px; font-size: 24px; font-weight: 700;">${title}</h2>
                        <div style="color: #666; font-size: 15px; line-height: 1.8; margin-bottom: 30px; text-align: left; max-height: 300px; overflow-y: auto; padding: 15px; background: #fff3cd; border-left: 4px solid #f44336; border-radius: 8px;">${message}</div>
                        <button id="errorModalOk" style="
                            background: #f44336;
                            color: white;
                            border: none;
                            padding: 14px 40px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.2s;
                            min-width: 150px;
                            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
                        " onmouseover="this.style.background='#d32f2f'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='#f44336'; this.style.transform='scale(1)';">
                            ENTENDI
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                </style>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            console.log('‚úÖ Modal inserido no DOM');

            const modal = document.getElementById('errorModal');
            const btnOk = document.getElementById('errorModalOk');

            if (!modal || !btnOk) {
                console.error('‚ùå Modal ou bot√£o n√£o encontrado!');
                // Fallback para alert
                alert(title + '\n\n' + message.replace(/<br>/g, '\n').replace(/<[^>]*>/g, ''));
                resolve(true);
                return;
            }

            // Fun√ß√£o para remover modal
            const removeModal = () => {
                if (modal && modal.parentNode) {
                    modal.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => modal.remove(), 300);
                }
            };

            // Evento de clique no OK
            btnOk.addEventListener('click', () => {
                console.log('‚úÖ Bot√£o OK clicado');
                removeModal();
                resolve(true);
            });

            // Fechar ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    console.log('‚úÖ Clicado fora do modal');
                    removeModal();
                    resolve(true);
                }
            });
        });
    } catch (error) {
        console.error('‚ùå Erro ao mostrar modal:', error);
        // Fallback definitivo para alert
        alert(title + '\n\n' + message.replace(/<br>/g, '\n').replace(/<[^>]*>/g, ''));
        return Promise.resolve(true);
    }
}

/**
 * Modal de confirma√ß√£o customizado
 * Deploy 35 - Padroniza√ß√£o de UI
 */
function showConfirmModal(title, message) {
    return new Promise((resolve) => {
        const modalHtml = `
            <div id="confirmModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
                <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùì</div>
                    <h2 style="color: #009688; margin-bottom: 15px; font-size: 22px; font-weight: 600;">${title}</h2>
                    <p style="color: #666; font-size: 15px; line-height: 1.6; margin-bottom: 30px;">${message}</p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="confirmCancel" style="
                            background: white;
                            color: #666;
                            border: 2px solid #E5E7EB;
                            padding: 12px 32px;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            min-width: 120px;
                        " onmouseover="this.style.background='#F9FAFB'; this.style.borderColor='#D1D5DB';" onmouseout="this.style.background='white'; this.style.borderColor='#E5E7EB';">
                            Cancelar
                        </button>
                        <button id="confirmOk" style="
                            background: #009688;
                            color: white;
                            border: none;
                            padding: 12px 32px;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            min-width: 120px;
                        " onmouseover="this.style.background='#00796B';" onmouseout="this.style.background='#009688';">
                            OK
                        </button>
                    </div>
                </div>
            </div>
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            </style>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const modal = document.getElementById('confirmModal');
        const btnOk = document.getElementById('confirmOk');
        const btnCancel = document.getElementById('confirmCancel');

        // Fun√ß√£o para remover modal
        const removeModal = () => {
            if (modal && modal.parentNode) {
                modal.remove();
            }
        };

        // Evento de clique no OK
        btnOk.addEventListener('click', () => {
            removeModal();
            resolve(true);
        });

        // Evento de clique no Cancelar
        btnCancel.addEventListener('click', () => {
            removeModal();
            resolve(false);
        });
        
        // Pressionar ESC cancela
        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                removeModal();
                resolve(false);
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
    });
}

/**
 * Exibe modal informativo (sem altera√ß√µes detectadas)
 * Deploy 42 - Modal visual para feedback ao usu√°rio
 */
function showInfoModal(title, message, icon) {
    return new Promise((resolve) => {
        // Remover modais antigos
        const oldModal = document.getElementById('infoModal');
        if (oldModal) oldModal.remove();
        
        const iconEmoji = icon || '‚ÑπÔ∏è';
        
        const modalHtml = `
            <div id="infoModal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            ">
                <div style="
                    background: white;
                    padding: 0;
                    border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    max-width: 500px;
                    width: 90%;
                    animation: slideUp 0.3s ease-out;
                ">
                    <!-- Cabe√ßalho -->
                    <div style="
                        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
                        padding: 24px;
                        border-radius: 12px 12px 0 0;
                        text-align: center;
                    ">
                        <div style="font-size: 48px; margin-bottom: 12px;">
                            ${iconEmoji}
                        </div>
                        <h3 style="
                            margin: 0;
                            color: white;
                            font-size: 20px;
                            font-weight: 600;
                        ">${title}</h3>
                    </div>
                    
                    <!-- Conte√∫do -->
                    <div style="padding: 24px; text-align: center;">
                        <p style="
                            margin: 0 0 24px 0;
                            color: #555;
                            font-size: 16px;
                            line-height: 1.5;
                        ">${message}</p>
                        
                        <!-- Bot√£o -->
                        <button onclick="closeInfoModal()" style="
                            background: linear-gradient(135deg, #009688 0%, #00796b 100%);
                            color: white;
                            border: none;
                            padding: 12px 32px;
                            border-radius: 6px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            box-shadow: 0 2px 8px rgba(0, 150, 136, 0.3);
                            transition: all 0.2s;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 150, 136, 0.4)';"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 150, 136, 0.3)';">
                            OK, Entendi
                        </button>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes slideUp {
                    from {
                        transform: translateY(50px);
                        opacity: 0;
                    }
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
            </style>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Salvar resolve para uso posterior
        window._infoModalResolve = resolve;
        
        console.log('‚úÖ Modal informativo exibido:', title);
    });
}

/**
 * Fecha modal informativo
 */
function closeInfoModal() {
    const modal = document.getElementById('infoModal');
    if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease-in';
        setTimeout(() => {
            modal.remove();
            if (window._infoModalResolve) {
                window._infoModalResolve();
                delete window._infoModalResolve;
            }
        }, 300);
    }
}

// Adicionar anima√ß√£o de fadeOut
if (!document.getElementById('modal-animations')) {
    const style = document.createElement('style');
    style.id = 'modal-animations';
    style.textContent = `
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}


       /**
 * Salva nova RNC - Deploy 40 com suporte a Multiselect
 */
async function saveRnc() {
    console.log('üü¢üü¢üü¢ saveRnc() CHAMADA! üü¢üü¢üü¢');
    try {
        // Validar permiss√µes primeiro
        console.log('üü¢ Validando permiss√µes...');
        if (!validatePermissionsBeforeSave()) {
            console.log('üî¥ Permiss√µes falharam!');
            return;
        }
        console.log('‚úÖ Permiss√µes OK');

        debugLog('info', 'üíæ Iniciando salvamento da RNC');
        
        const form = document.getElementById('rncForm');
        const formData = new FormData(form);
        const data = {};
        
        // ‚úÖ COLETAR DADOS DO FORMUL√ÅRIO (incluindo multiselect)
        for (let [key, value] of formData.entries()) {
            // Ignorar campos de arquivo
            if (key !== 'Anexo de Documentos' && 
                key !== 'fileInput' && 
                key !== 'fileUpload') {
                data[key] = value;
            }
        }
        
        // ‚úÖ ADICIONAR: Capturar valores de campos multiselect dos inputs hidden
        const multiselectInputs = document.querySelectorAll('.multiselect-wrapper input[type="hidden"]');
        multiselectInputs.forEach(input => {
            const fieldName = input.name;
            const fieldValue = input.value;
            
            if (fieldName && fieldValue) {
                data[fieldName] = fieldValue;
                debugLog('debug', `üìã Multiselect capturado: ${fieldName}`, { value: fieldValue });
            }
        });
        
        debugLog('info', 'üìã Dados coletados do formul√°rio', {
            fields: Object.keys(data),
            hasFiles: selectedFiles.length > 0,
            multiselectCount: multiselectInputs.length
        });

        console.log('üîç DEBUG: Iniciando valida√ß√£o de campos obrigat√≥rios');
        console.log('üîç DEBUG: appContext.fieldsConfig:', appContext.fieldsConfig);

        // ‚úÖ DEPLOY 33 FIX: Validar campos obrigat√≥rios com modal vis√≠vel
        const aberturaFields = appContext.fieldsConfig.Abertura || [];
        console.log('üîç DEBUG: aberturaFields:', aberturaFields);

        const requiredFields = aberturaFields.filter(f => f.required);
        console.log('üîç DEBUG: requiredFields:', requiredFields);

        const missingFields = [];

        requiredFields.forEach(field => {
            // Ignorar campo de arquivo na valida√ß√£o
            const fieldValue = data[field.name];
            console.log(`üîç DEBUG: Verificando campo "${field.name}": valor = "${fieldValue}"`);

            if (field.type !== 'file' && (!fieldValue || fieldValue.trim() === '')) {
                console.log(`‚ùå Campo obrigat√≥rio vazio: ${field.name}`);
                missingFields.push(field.name);
            }
        });

        console.log('üîç DEBUG: missingFields:', missingFields);

        if (missingFields.length > 0) {
            console.log('üö® VALIDA√á√ÉO FALHOU! Chamando showErrorModal...');
            const fieldsList = missingFields.map(f => `‚Ä¢ ${f}`).join('<br>');

            await showErrorModal(
                '‚ö†Ô∏è Campos Obrigat√≥rios N√£o Preenchidos',
                `<strong>Voc√™ precisa preencher os seguintes campos antes de salvar a RNC:</strong><br><br>` +
                fieldsList +
                `<br><br>Por favor, volte e preencha todos os campos obrigat√≥rios (marcados com <span style="color: red;">*</span>).`
            );
            debugLog('warning', '‚ö†Ô∏è Valida√ß√£o falhou - campos obrigat√≥rios', { missingFields });
            return;
        }

        console.log('‚úÖ Valida√ß√£o passou! Continuando com save...');
        
        // Confirma√ß√£o antes de salvar
        const confirmed = await showConfirmModal(
            'Deseja realmente criar esta RNC?',
            'Ap√≥s confirmar, os dados ser√£o salvos permanentemente.'
        );
        
        if (!confirmed) {
            debugLog('info', '‚ùå Usu√°rio cancelou o salvamento');
            return;
        }
        
        showLoading('Salvando RNC...');
        
        debugLog('info', 'üöÄ Enviando dados para o backend', { 
            dataKeys: Object.keys(data),
            filesCount: selectedFiles.length 
        });
        
        // Chamar backend
        const result = await apiCall('saveRnc', [data, selectedFiles]);
        
        if (result.success) {
            debugLog('success', '‚úÖ RNC salva com sucesso', { 
                rncNumber: result.rncNumber 
            });
            
            // Limpar formul√°rio e arquivos
            form.reset();
            selectedFiles = [];
            updateFileList();
            
            // Limpar containers de chips
            document.querySelectorAll('.chips-container').forEach(container => {
                container.innerHTML = '';
                container.classList.add('empty');
            });
            
            // Limpar inputs hidden de multiselect
            document.querySelectorAll('.multiselect-wrapper input[type="hidden"]').forEach(input => {
                input.value = '';
            });
            
            // Esconder loading
            hideLoading();
            
            // Mostrar modal de sucesso
            showSuccessModal(result.rncNumber);
            
            debugLog('info', '‚úÖ Formul√°rio resetado e pronto para nova RNC');
            
        } else {
            hideLoading();

            // ‚úÖ DEPLOY 33 FIX: Mostrar erros de valida√ß√£o do backend com modal
            if (result.validationErrors && result.validationErrors.length > 0) {
                const errorsList = result.validationErrors.map(e => `‚Ä¢ ${e}`).join('<br>');
                await showErrorModal(
                    '‚ö†Ô∏è Erro de Valida√ß√£o',
                    `<strong>Os seguintes erros foram encontrados:</strong><br><br>` +
                    errorsList
                );
            } else {
                throw new Error(result.error || 'Erro desconhecido ao salvar RNC');
            }
        }

    } catch (error) {
        debugLog('error', '‚ùå Erro ao salvar RNC', { error: error.message });
        hideLoading();

        // ‚úÖ DEPLOY 33 FIX: Modal de erro para exce√ß√µes
        await showErrorModal(
            '‚ùå Erro ao Salvar RNC',
            `<strong>Ocorreu um erro ao tentar salvar a RNC:</strong><br><br>` +
            `${error.message}<br><br>` +
            `Por favor, tente novamente. Se o erro persistir, entre em contato com o suporte.`
        );
    }
}


        
        // === CARREGAR RNCS DISPON√çVEIS ===
        async function loadAvailableRncs(setor) {
    try {
        const select = document.getElementById('rncSelect');
        const tipoSetorSelect = document.getElementById('tipoSetorEdit');
        const setorFilter = document.getElementById('setorFilterEdit');
        const countSpan = document.getElementById('rncCountEdit');
        
        if (!select) return;
        
        showLoading('Carregando RNCs...');
        
        const tipoSetor = tipoSetorSelect ? tipoSetorSelect.value : 'qualidade';
        const setorAtual = setor || (setorFilter ? setorFilter.value : 'Todos');
        
        debugLog('info', 'üìã Carregando RNCs', { tipoSetor, setor: setorAtual });
        
        let numbers = await apiCall('getRncNumbersBySetor', [tipoSetor, setorAtual]);
        
        availableRncs = numbers || [];
        
        select.innerHTML = '<option value="">Selecione uma RNC</option>';
        
        if (availableRncs.length > 0) {
            availableRncs.forEach(num => {
                const option = document.createElement('option');
                option.value = num;
                option.textContent = `RNC ${num}`;
                select.appendChild(option);
            });
            
            if (countSpan) {
                countSpan.textContent = `${availableRncs.length} RNC(s) encontrada(s)`;
                countSpan.style.color = '#4CAF50';
                countSpan.style.fontWeight = '600';
            }
            
            debugLog('success', `‚úÖ ${availableRncs.length} RNCs carregadas`);
        } else {
            if (countSpan) {
                countSpan.textContent = 'Nenhuma RNC encontrada';
                countSpan.style.color = '#999';
            }
            debugLog('warning', '‚ö†Ô∏è Nenhuma RNC encontrada para o filtro');
        }
        
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar RNCs', { error: error.message });
        showError('Erro ao carregar lista de RNCs: ' + error.message);
        hideLoading();
    }
}

async function loadSetoresFilter() {
    try {
        const tipoSetorSelect = document.getElementById('tipoSetorEdit');
        const setorFilterSelect = document.getElementById('setorFilterEdit');
        
        if (!tipoSetorSelect || !setorFilterSelect) return;
        
        debugLog('info', 'üè¢ Carregando filtros de setores - Editar RNC');
        
        const setores = await apiCall('getSetoresDuplos', []);
        
        // Fun√ß√£o para atualizar lista de setores
        function atualizarListaSetores() {
            const tipoSetor = tipoSetorSelect.value;
            const listaSetores = tipoSetor === 'abertura' 
                ? setores.setoresAbertura 
                : setores.setoresQualidade;
            
            setorFilterSelect.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
            
            listaSetores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = `üè¢ ${setor}`;
                setorFilterSelect.appendChild(option);
            });
            
            debugLog('success', `‚úÖ ${listaSetores.length} setores carregados (${tipoSetor}) - Editar`);
        }
        
        // Event listeners
        tipoSetorSelect.addEventListener('change', function() {
            debugLog('info', 'üîÑ Tipo de setor alterado - Editar', { tipo: this.value });
            atualizarListaSetores();
            loadAvailableRncs(); // Recarregar RNCs com novo tipo
        });
        
        setorFilterSelect.addEventListener('change', function() {
            const setorSelecionado = this.value;
            debugLog('info', 'üîÑ Setor alterado - Editar', { setor: setorSelecionado });
            loadAvailableRncs(setorSelecionado);
        });
        
        // Carregar lista inicial
        atualizarListaSetores();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar filtros - Editar RNC', { error: error.message });
        showError('Erro ao carregar filtro de setores');
    }
}

// Fun√ß√£o auxiliar para atualizar o select
function updateRncSelect() {
    const select = document.getElementById('rncSelect');
    if (select) {
        if (availableRncs.length === 0) {
            select.innerHTML = '<option value="">Nenhuma RNC encontrada</option>';
        } else {
            const options = availableRncs.map(num => 
                `<option value="${num}">${num}</option>`
            ).join('');
            select.innerHTML = '<option value="">Selecione uma RNC...</option>' + options;
        }
    }
}
        
        /**
 * Carrega RNC para edi√ß√£o + GUARDA valores originais
 * Deploy 38 - Rastreamento de altera√ß√µes
 */
async function loadRncForEdit(rncNumber) {
    try {
        debugLog('info', 'üîç Carregando RNC para edi√ß√£o', { rncNumber });
        
        showLoading('Carregando dados da RNC...');
        
        const rncData = await apiCall('getRncByNumber', [rncNumber]);
        
        if (!rncData) {
            showError(`RNC ${rncNumber} n√£o encontrada`);
            debugLog('error', '‚ùå RNC n√£o encontrada', { rncNumber });
            return;
        }
        
        currentRnc = rncNumber;
        
        // ‚úÖ NOVO: Guardar valores originais para compara√ß√£o
        window.originalRncData = JSON.parse(JSON.stringify(rncData));
        
        debugLog('success', '‚úÖ RNC carregada para edi√ß√£o', { 
            rncNumber, 
            cliente: rncData['Nome do Cliente'],
            status: rncData['Status Geral']
        });
        
        // Renderizar formul√°rio de edi√ß√£o
        renderEditForm(rncData);
        
        // ‚úÖ ADICIONAR BOT√ïES AQUI
        addPrintButtonToEditForm(rncNumber);
        addHistoricoButtonToEditForm(rncNumber); // ‚úÖ Deploy 34: Bot√£o de hist√≥rico

        document.getElementById('editForm').classList.remove('hidden');
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar RNC', { rncNumber, error: error.message });
        showError('Erro ao carregar RNC: ' + error.message);
        hideLoading();
    }
}

// ‚úÖ NOVA FUN√á√ÉO: Adicionar bot√£o de impress√£o no formul√°rio de edi√ß√£o
function addPrintButtonToEditForm(rncNumber) {
    // ‚úÖ VERIFICAR SE √â ADMIN ANTES DE ADICIONAR BOT√ÉO
    if (!appContext || !appContext.isAdmin) {
        debugLog('info', '‚ÑπÔ∏è Bot√£o de impress√£o oculto (usu√°rio n√£o √© admin)');
        return; // N√£o adiciona o bot√£o se n√£o for admin
    }
    
    const editForm = document.getElementById('editForm');
    
    if (!editForm) return;
    
    // ‚úÖ CORRE√á√ÉO 1: Remover TODOS os bot√µes de impress√£o existentes ANTES de procurar container
    const allExistingButtons = editForm.querySelectorAll('[onclick*="printRnc"], .btn-print-rnc');
    allExistingButtons.forEach(btn => {
        debugLog('info', 'üóëÔ∏è Removendo bot√£o de impress√£o duplicado');
        btn.remove();
    });
    
    let buttonContainer = editForm.querySelector('.form-actions, .modal-footer, .edit-actions');
    
    if (!buttonContainer) {
        const saveButton = editForm.querySelector('button[onclick*="saveEdit"], button[onclick*="save"]');
        if (saveButton && saveButton.parentElement) {
            buttonContainer = saveButton.parentElement;
        }
    }
    
    if (!buttonContainer) {
        buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;';
        editForm.appendChild(buttonContainer);
    }
    
    // ‚úÖ CORRE√á√ÉO 2: Criar bot√£o com classe √∫nica para identifica√ß√£o
    const printButton = document.createElement('button');
    printButton.type = 'button';
    printButton.className = 'btn btn-secondary btn-print-rnc'; // ‚úÖ Classe √∫nica adicionada
    printButton.id = 'printRncBtn_' + rncNumber.replace('/', '_'); // ‚úÖ ID √∫nico
    printButton.onclick = function() { printRnc(rncNumber); };
    printButton.style.cssText = 'display: flex; align-items: center; gap: 8px;';
    printButton.innerHTML = `
        <span>üñ®Ô∏è</span>
        <span>Imprimir RNC</span>
    `;
    
    buttonContainer.appendChild(printButton);

    debugLog('info', '‚úÖ Bot√£o de impress√£o adicionado', {
        rncNumber,
        buttonId: printButton.id
    });
}

// ‚úÖ Deploy 34: Adicionar bot√£o de hist√≥rico no formul√°rio de edi√ß√£o
function addHistoricoButtonToEditForm(rncNumber) {
    const editForm = document.getElementById('editForm');

    if (!editForm) return;

    // Remover bot√µes de hist√≥rico existentes
    const existingButtons = editForm.querySelectorAll('.btn-historico-rnc');
    existingButtons.forEach(btn => btn.remove());

    let buttonContainer = editForm.querySelector('.form-actions, .modal-footer, .edit-actions');

    if (!buttonContainer) {
        const saveButton = editForm.querySelector('button[onclick*="saveEdit"], button[onclick*="save"]');
        if (saveButton && saveButton.parentElement) {
            buttonContainer = saveButton.parentElement;
        }
    }

    if (!buttonContainer) {
        buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;';
        editForm.appendChild(buttonContainer);
    }

    const historicoButton = document.createElement('button');
    historicoButton.type = 'button';
    historicoButton.className = 'btn btn-secondary btn-historico-rnc';
    historicoButton.id = 'historicoRncBtn_' + rncNumber.replace('/', '_');
    historicoButton.onclick = function() { showHistoricoModal(rncNumber); };
    historicoButton.style.cssText = 'display: flex; align-items: center; gap: 8px;';
    historicoButton.innerHTML = `
        <span>üìú</span>
        <span>Ver Hist√≥rico</span>
    `;

    buttonContainer.appendChild(historicoButton);

    debugLog('info', '‚úÖ Bot√£o de hist√≥rico adicionado', {
        rncNumber,
        buttonId: historicoButton.id
    });
}

// ‚úÖ Deploy 34: Mostrar modal com hist√≥rico de altera√ß√µes
async function showHistoricoModal(rncNumber) {
    try {
        showLoading('Carregando hist√≥rico...');

        const historico = await apiCall('getHistoricoRnc', [rncNumber]);

        hideLoading();

        // ‚úÖ Debug: Ver o que est√° sendo retornado
        console.log('üîç DEBUG historico:', historico);
        console.log('üîç DEBUG historico type:', typeof historico);
        console.log('üîç DEBUG historico.length:', historico?.length);
        console.log('üîç DEBUG Array.isArray:', Array.isArray(historico));

        if (!historico || historico.length === 0) {
            showErrorModal(
                'Sem Hist√≥rico',
                'N√£o h√° altera√ß√µes registradas para esta RNC ainda.'
            );
            return;
        }

        // Criar modal HTML
        const modalHtml = `
            <div id="historicoModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
                <div style="background: white; padding: 0; border-radius: 16px; max-width: 900px; width: 90%; max-height: 80vh; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: slideUp 0.3s; overflow: hidden; display: flex; flex-direction: column;">
                    <!-- Header -->
                    <div style="padding: 25px 30px; background: linear-gradient(135deg, #009688 0%, #00796B 100%); color: white;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <span>üìú</span>
                            <span>Hist√≥rico de Altera√ß√µes - RNC ${rncNumber}</span>
                        </h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">${historico.length} altera√ß√µes registradas</p>
                    </div>

                    <!-- Timeline -->
                    <div style="flex: 1; overflow-y: auto; padding: 30px;">
                        <div class="timeline">
                            ${historico.map((item, index) => `
                                <div class="timeline-item" style="position: relative; padding-left: 40px; padding-bottom: ${index === historico.length - 1 ? '0' : '30px'}; border-left: ${index === historico.length - 1 ? 'none' : '3px solid #e0e0e0'}; margin-left: 10px;">
                                    <div class="timeline-marker" style="position: absolute; left: -11px; top: 0; width: 20px; height: 20px; border-radius: 50%; background: ${getTimelineColor(item.tipo)}; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>

                                    <div style="background: #f8f9fa; padding: 18px; border-radius: 12px; border-left: 4px solid ${getTimelineColor(item.tipo)};">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <div>
                                                <div style="font-weight: 700; font-size: 15px; color: #333; margin-bottom: 4px;">
                                                    ${getTimelineIcon(item.tipo)} ${item.campo}
                                                </div>
                                                <div style="font-size: 13px; color: #666;">
                                                    ${item.secao} ‚Ä¢ ${item.tipo}
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 12px; color: #666; font-weight: 500;">
                                                    ${formatarDataHora(item.timestamp)}
                                                </div>
                                                <div style="font-size: 12px; color: #999;">
                                                    ${item.usuario}
                                                </div>
                                            </div>
                                        </div>

                                        ${item.tipo !== 'Cria√ß√£o' ? `
                                            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; margin-top: 12px;">
                                                <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107;">
                                                    <div style="font-size: 11px; color: #856404; font-weight: 600; margin-bottom: 4px;">ANTERIOR</div>
                                                    <div style="font-size: 13px; color: #333; word-break: break-word;">${item.valorAnterior}</div>
                                                </div>
                                                <div style="color: #999;">‚Üí</div>
                                                <div style="background: #d4edda; padding: 10px; border-radius: 6px; border-left: 3px solid #28a745;">
                                                    <div style="font-size: 11px; color: #155724; font-weight: 600; margin-bottom: 4px;">NOVO</div>
                                                    <div style="font-size: 13px; color: #333; word-break: break-word;">${item.valorNovo}</div>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="padding: 20px 30px; background: #f5f5f5; border-top: 1px solid #ddd; text-align: right;">
                        <button id="historicoModalClose" style="
                            background: #009688;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#00796B'" onmouseout="this.style.background='#009688'">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            </style>
        `;

        // Remover modal anterior
        const oldModal = document.getElementById('historicoModal');
        if (oldModal) oldModal.remove();

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const modal = document.getElementById('historicoModal');
        const btnClose = document.getElementById('historicoModalClose');

        const closeModal = () => {
            if (modal && modal.parentNode) {
                modal.remove();
            }
        };

        btnClose.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

    } catch (error) {
        hideLoading();
        console.error('Erro ao carregar hist√≥rico:', error);
        showErrorModal('Erro', 'N√£o foi poss√≠vel carregar o hist√≥rico: ' + error.message);
    }
}

// Helper: Cor da timeline por tipo
function getTimelineColor(tipo) {
    const cores = {
        'Cria√ß√£o': '#4CAF50',
        'Edi√ß√£o': '#2196F3',
        'Mudan√ßa Status': '#FF9800',
        'Arquivo': '#9C27B0',
        'Remo√ß√£o': '#F44336'
    };
    return cores[tipo] || '#757575';
}

// Helper: √çcone da timeline por tipo
function getTimelineIcon(tipo) {
    const icones = {
        'Cria√ß√£o': '‚ú®',
        'Edi√ß√£o': '‚úèÔ∏è',
        'Mudan√ßa Status': 'üîÑ',
        'Arquivo': 'üìé',
        'Remo√ß√£o': 'üóëÔ∏è'
    };
    return icones[tipo] || 'üìù';
}

// Helper: Formatar data/hora
function formatarDataHora(timestamp) {
    const date = new Date(timestamp);
    const dia = String(date.getDate()).padStart(2, '0');
    const mes = String(date.getMonth() + 1).padStart(2, '0');
    const ano = date.getFullYear();
    const hora = String(date.getHours()).padStart(2, '0');
    const minuto = String(date.getMinutes()).padStart(2, '0');
    return `${dia}/${mes}/${ano} ${hora}:${minuto}`;
}

       /**
 * Renderiza formul√°rio de edi√ß√£o COM ANEXOS NA SE√á√ÉO ABERTURA
 * Deploy 36.1 - Reposicionamento de Anexos
 */
function renderEditForm(rncData) {
    try {
        debugLog('info', 'üèóÔ∏è Renderizando formul√°rio de edi√ß√£o Deploy 36.1', { 
            rncNumber: rncData['N¬∫ RNC'],
            status: rncData['Status Geral'],
            totalFields: Object.keys(rncData).length
        });
        
        // ‚úÖ ADICIONAR ESTA LINHA NO IN√çCIO:
        window.originalRncData = JSON.parse(JSON.stringify(rncData));

        const container = document.getElementById('edit-sections');
        let sectionsHtml = '';
        
        const sections = appContext.sections.filter(s => s.ativo === 'Sim');
        
        sections.forEach(section => {
            const sectionFields = appContext.fieldsConfig[section.nome] || [];
            const permission = appContext.permissions[section.nome] || 'visualizar';
            
            if (permission === 'negar') {
                return;
            }
            
            let permissionBadge = '';
            if (permission === 'visualizar') {
                permissionBadge = '<span class="badge-readonly">üîí Somente Leitura</span>';
            } else if (permission === 'editar') {
                permissionBadge = '<span style="background: #4CAF50; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">‚úèÔ∏è Edit√°vel</span>';
            }
            
            if (sectionFields.length > 0) {
                sectionsHtml += `
                    <div class="form-section">
                        <h3>
                            ${getSectionIcon(section.nome)} ${section.nome}
                            ${permissionBadge}
                        </h3>
                        <div class="form-grid">
                            ${sectionFields.map(field => {
                                let value = '';
                                
                                if (field.name === 'Status' || field.name === 'Status Geral') {
                                    value = rncData['Status Geral'] || '';
                                    return renderField(field, value, section.nome, true);
                                } else if (field.name === 'N¬∫ RNC') {
                                    value = rncData['N¬∫ RNC'] || '';
                                    return renderField(field, value, section.nome, true);
                                }
                                
                                var possibleKeys = [
                                    field.name,
                                    field.name.replace(/\s+/g, ''),
                                    field.name.toLowerCase(),
                                    field.name.replace(/\s+/g, '').toLowerCase()
                                ];
                                
                                if (appContext.fieldMapping && appContext.fieldMapping[field.name]) {
                                    var mappedName = appContext.fieldMapping[field.name];
                                    possibleKeys.push(mappedName);
                                    possibleKeys.push(mappedName.replace(/\s+/g, ''));
                                    possibleKeys.push(mappedName.toLowerCase());
                                }
                                
                                for (var i = 0; i < possibleKeys.length; i++) {
                                    var key = possibleKeys[i];
                                    if (rncData[key] !== undefined && rncData[key] !== null && rncData[key] !== '') {
                                        value = rncData[key];
                                        break;
                                    }
                                }
                                
                                return renderField(field, value, section.nome, true);
                            }).join('')}
                        </div>
                        
                        ${section.nome === 'Abertura' ? `
                            <!-- ‚úÖ ANEXOS DENTRO DA SE√á√ÉO ABERTURA -->
                            <div id="attachments-container" style="margin-top: 2rem;">
                                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                                    Carregando anexos...
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        });
        
        container.innerHTML = sectionsHtml;
        setupFileUpload(true);

        // ‚úÖ CARREGAR ANEXOS (agora dentro da se√ß√£o Abertura)
        loadAttachments(rncData['N¬∫ RNC']);
        
        debugLog('success', '‚úÖ Formul√°rio renderizado com anexos na se√ß√£o Abertura');
        
    } catch (error) {
        console.error('ERRO renderEditForm:', error);
        debugLog('error', '‚ùå Erro ao renderizar formul√°rio', { error: error.message });
        showError('Erro ao renderizar formul√°rio: ' + error.message);
    }
}

/**
 * Carrega anexos da RNC
 * Deploy 36.3
 */
async function loadAttachments(rncNumber) {
    try {
        debugLog('info', 'üìé Carregando anexos', { rncNumber });
        
        const attachments = await apiCall('getAttachments', [rncNumber]);
        
        renderAttachments(attachments || [], rncNumber);
        
        debugLog('success', '‚úÖ Anexos carregados', { count: attachments.length });
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar anexos', { error: error.message });
        renderAttachments([], rncNumber);
    }
}


/**
 * Renderiza lista de anexos COM EVENT LISTENERS (sem onclick inline)
 * Deploy 36.3 - Corre√ß√£o de erro de sintaxe
 */
/**
 * Renderiza lista de anexos COM EVENT LISTENERS (sem onclick inline)
 * Deploy 36.4 - CORRE√á√ÉO: Adicionar type="button" para evitar submit
 */
function renderAttachments(attachments, rncNumber) {
    const container = document.getElementById('attachments-container');
    
    if (!container) {
        debugLog('warning', '‚ö†Ô∏è Container de anexos n√£o encontrado');
        return;
    }
    
    if (!attachments || attachments.length === 0) {
        container.innerHTML = `
            <div class="no-attachments">
                <div class="no-attachments-icon">üìé</div>
                <p>Nenhum arquivo anexado a esta RNC</p>
            </div>
        `;
        return;
    }
    
    // ‚úÖ GERAR HTML SEM ONCLICK (mais seguro)
    const attachmentsHtml = attachments.map((file, index) => {
        const icon = getFileIcon(file.name);
        const size = formatFileSize(file.size || 0);
        
        return `
            <div class="attachment-item" data-file-id="${file.id}" data-file-name="${file.name}" data-rnc-number="${rncNumber}">
                <div class="attachment-info">
                    <div class="attachment-icon">${icon}</div>
                    <div class="attachment-details">
                        <span class="attachment-name">${file.name}</span>
                        <div class="attachment-meta">
                            <span>üìä ${size}</span>
                            ${file.uploadDate ? `<span>üìÖ ${formatDate(file.uploadDate)}</span>` : ''}
                            ${file.uploadedBy ? `<span>üë§ ${file.uploadedBy}</span>` : ''}
                        </div>
                    </div>
                </div>
                <div class="attachment-actions">
                    <button type="button" class="btn-download" data-action="download" title="Baixar arquivo">
                        ‚¨áÔ∏è Baixar
                    </button>
                    <button type="button" class="btn-delete-attachment" data-action="delete" title="Excluir arquivo">
                        üóëÔ∏è Excluir
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="attachments-header">
            <div class="attachments-title">
                üìé Anexos da RNC
                <span class="attachments-count">${attachments.length}</span>
            </div>
        </div>
        <div class="attachments-list">
            ${attachmentsHtml}
        </div>
    `;
    
    // ‚úÖ ADICIONAR EVENT LISTENERS ap√≥s renderizar HTML
    setupAttachmentListeners();
}

/**
 * Configura event listeners dos anexos (seguro)
 * Deploy 36.3
 */
function setupAttachmentListeners() {
    try {
        debugLog('info', 'üîó Configurando listeners de anexos');
        
        const attachmentItems = document.querySelectorAll('.attachment-item');
        
        attachmentItems.forEach(item => {
            const fileId = item.dataset.fileId;
            const fileName = item.dataset.fileName;
            const rncNumber = item.dataset.rncNumber;
            
            // Bot√£o DOWNLOAD
            const btnDownload = item.querySelector('[data-action="download"]');
            if (btnDownload) {
                btnDownload.addEventListener('click', function() {
                    downloadAttachment(fileId, fileName);
                });
            }
            
            // Bot√£o DELETE
            const btnDelete = item.querySelector('[data-action="delete"]');
            if (btnDelete) {
                btnDelete.addEventListener('click', function() {
                    confirmDeleteAttachment(rncNumber, fileId, fileName);
                });
            }
        });
        
        debugLog('success', '‚úÖ Listeners configurados', { 
            total: attachmentItems.length 
        });
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao configurar listeners', { 
            error: error.message 
        });
    }
}

/**
 * Retorna √≠cone baseado no tipo de arquivo
 * Deploy 36.5 - Corre√ß√£o de regex
 */
function getFileIcon(fileName) {
    if (!fileName) return 'üìé';
    
    try {
        // Pegar extens√£o do arquivo
        const parts = fileName.split('.');
        const extension = parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';
        
        const icons = {
            'pdf': 'üìÑ',
            'doc': 'üìù',
            'docx': 'üìù',
            'xls': 'üìä',
            'xlsx': 'üìä',
            'jpg': 'üñºÔ∏è',
            'jpeg': 'üñºÔ∏è',
            'png': 'üñºÔ∏è',
            'gif': 'üñºÔ∏è',
            'zip': 'üì¶',
            'rar': 'üì¶',
            'txt': 'üìù',
            'csv': 'üìä'
        };
        
        return icons[extension] || 'üìé';
        
    } catch (error) {
        debugLog('error', 'Erro em getFileIcon', { fileName, error: error.message });
        return 'üìé';
    }
}

/**
 * Faz download de anexo (SEM confirma√ß√£o)
 * Deploy 36 - Corre√ß√£o
 */
/**
 * Download DIRETO de anexo (SEM popup)
 * Deploy 36.2 - Corre√ß√£o Final
 */
/**
 * Download DIRETO de anexo
 * Deploy 36.3
 */
async function downloadAttachment(fileId, fileName) {
    try {
        debugLog('info', 'üì• Download direto', { fileId, fileName });
        
        showLoading('Preparando download...');
        
        const result = await apiCall('downloadAnexo', [fileId]);
        
        if (result && result.success) {
            debugLog('success', '‚úÖ Download preparado', { fileName });
            
            const downloadUrl = result.downloadUrl || result.url;
            
            if (downloadUrl) {
                window.open(downloadUrl, '_blank');
                showSuccess(`üì• Download de "${fileName}" iniciado!`);
            } else {
                throw new Error('URL de download n√£o dispon√≠vel');
            }
        } else {
            throw new Error(result.error || 'Falha ao preparar download');
        }
        
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro no download', { error: error.message });
        showError('Erro ao baixar: ' + error.message);
        hideLoading();
    }
}

/**
 * Confirma exclus√£o de anexo + AUTO-SALVA RNC
 * Deploy 37 - Auto-salvar ao excluir anexo
 */
async function confirmDeleteAttachment(rncNumber, fileId, fileName) {
    try {
        debugLog('info', 'üóëÔ∏è Confirma√ß√£o de exclus√£o + auto-salvar', { 
            rncNumber, 
            fileId, 
            fileName 
        });
        
        const modalHtml = `
            <div id="deleteAttachmentModal" class="modal-overlay">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>üóëÔ∏è Excluir Anexo</h3>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 15px; font-size: 15px;">
                            Tem certeza que deseja <strong>excluir permanentemente</strong> o anexo:
                        </p>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #009688;">
                            <div style="font-weight: 600; color: #009688; margin-bottom: 5px;">
                                üìé ${fileName}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                RNC: ${rncNumber}
                            </div>
                        </div>
                        <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107; font-size: 13px; color: #856404; margin-bottom: 15px;">
                            <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita!
                        </div>
                        <div style="background: #e7f5ff; padding: 12px; border-radius: 6px; border-left: 4px solid #2196F3; font-size: 13px; color: #0d47a1;">
                            <strong>‚ÑπÔ∏è Ap√≥s confirmar:</strong> O anexo ser√° exclu√≠do e a RNC ser√° salva automaticamente.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" id="btnCancelarExclusao">
                            ‚ùå Cancelar
                        </button>
                        <button class="btn-danger" id="btnConfirmarExclusao">
                            üóëÔ∏è Confirmar Exclus√£o
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Remover modal anterior se existir
        const oldModal = document.getElementById('deleteAttachmentModal');
        if (oldModal) {
            oldModal.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        const modal = document.getElementById('deleteAttachmentModal');
        const btnCancel = document.getElementById('btnCancelarExclusao');
        const btnConfirm = document.getElementById('btnConfirmarExclusao');
        
        function closeModal() {
            if (modal && modal.parentNode) {
                modal.remove();
            }
        }
        
        // Bot√£o CANCELAR
        btnCancel.addEventListener('click', function() {
            debugLog('info', '‚ùå Exclus√£o cancelada');
            closeModal();
        });
        
        // Bot√£o CONFIRMAR
        btnConfirm.addEventListener('click', async function() {
            debugLog('info', 'üîÑ Executando exclus√£o + auto-salvar', { fileId });
            
            btnCancel.disabled = true;
            btnConfirm.disabled = true;
            btnConfirm.innerHTML = '‚è≥ Excluindo...';
            
            showLoading('Excluindo arquivo e salvando RNC...');
            
            try {
                // 1Ô∏è‚É£ EXCLUIR ANEXO
                const deleteResult = await apiCall('deleteAnexo', [rncNumber, fileId]);
                
                if (!deleteResult || !deleteResult.success) {
                    throw new Error(deleteResult?.error || 'Falha ao excluir anexo');
                }
                
                debugLog('success', '‚úÖ Anexo exclu√≠do', { fileId });
                
                // 2Ô∏è‚É£ AUTO-SALVAR RNC (apenas os dados do formul√°rio)
                const form = document.getElementById('rncEditForm');
                const formData = new FormData(form);
                const data = {};
                
                // Filtrar campos de arquivo
                for (let [key, value] of formData.entries()) {
                    if (key !== 'Anexo de Documentos' && 
                        key !== 'fileInput' && 
                        key !== 'fileUpload' &&
                        !key.toLowerCase().includes('anexo')) {
                        data[key] = value;
                    }
                }
                
                // Salvar sem anexos novos (selectedFiles vazio)
                const updateResult = await apiCall('updateRnc', [rncNumber, data, []]);
                
                if (!updateResult || !updateResult.success) {
                    throw new Error(updateResult?.error || 'Falha ao salvar RNC');
                }
                
                debugLog('success', '‚úÖ RNC salva automaticamente', { rncNumber });
                
                // 3Ô∏è‚É£ MOSTRAR MENSAGEM DE SUCESSO
                showSuccess(`‚úÖ Anexo "${fileName}" exclu√≠do e RNC atualizada com sucesso!`);
                
                // 4Ô∏è‚É£ FECHAR MODAL
                closeModal();
                
                // 5Ô∏è‚É£ RECARREGAR ANEXOS
                await loadAttachments(rncNumber);
                
                // 6Ô∏è‚É£ INVALIDAR CACHE
                invalidateCache(['dashboard', 'kanban']);
                
                hideLoading();
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao excluir/salvar', { error: error.message });
                showError('Erro: ' + error.message);
                
                btnCancel.disabled = false;
                btnConfirm.disabled = false;
                btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
                
                hideLoading();
            }
        });
        
        // Fechar ao clicar fora
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // Fechar com ESC
        function handleEsc(e) {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', handleEsc);
            }
        }
        document.addEventListener('keydown', handleEsc);
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao criar modal', { error: error.message });
        showError('Erro: ' + error.message);
    }
}

/**
 * Exclui anexo (COM confirma√ß√£o corrigida)
 * Deploy 36 - Corre√ß√£o do popup
 */
async function deleteAttachment(rncNumber, fileId, fileName) {
  try {
    debugLog('info', 'üóëÔ∏è Solicitando exclus√£o', { rncNumber, fileId, fileName });
    
    // Criar e mostrar popup de confirma√ß√£o CORRETAMENTE
    const confirmDialog = document.createElement('div');
    confirmDialog.className = 'modal-overlay';
    confirmDialog.innerHTML = `
      <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
          <h3>üóëÔ∏è Excluir Anexo</h3>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 15px;">
            Tem certeza que deseja excluir o anexo:
          </p>
          <p style="font-weight: 600; color: #009688;">
            ${fileName}
          </p>
          <p style="margin-top: 15px; color: #F44336; font-size: 13px;">
            ‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" id="btnCancelarExclusao">
            ‚ùå Cancelar
          </button>
          <button class="btn-danger" id="btnConfirmarExclusao">
            üóëÔ∏è Confirmar Exclus√£o
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(confirmDialog);
    
    // Fun√ß√£o para fechar o popup
    function closeDialog() {
      confirmDialog.remove();
    }
    
    // Bot√£o CANCELAR - Apenas fecha o popup
    document.getElementById('btnCancelarExclusao').addEventListener('click', function() {
      debugLog('info', '‚ùå Exclus√£o cancelada pelo usu√°rio');
      closeDialog();
    });
    
    // Bot√£o CONFIRMAR - Executa a exclus√£o
    document.getElementById('btnConfirmarExclusao').addEventListener('click', async function() {
      try {
        debugLog('info', 'üîÑ Executando exclus√£o', { fileId });
        
        // Desabilitar bot√µes durante processamento
        document.getElementById('btnCancelarExclusao').disabled = true;
        document.getElementById('btnConfirmarExclusao').disabled = true;
        document.getElementById('btnConfirmarExclusao').textContent = '‚è≥ Excluindo...';
        
        showLoading('Excluindo arquivo...');
        
        // Chamar backend para excluir
        const result = await apiCall('deleteAnexo', [rncNumber, fileId]);
        
        if (result && result.success) {
          debugLog('success', '‚úÖ Anexo exclu√≠do', { fileId });
          showSuccess('Anexo exclu√≠do com sucesso!');
          
          // Fechar popup
          closeDialog();
          
          // Recarregar lista de anexos
          await loadAttachments(rncNumber);
          
        } else {
          throw new Error('Falha ao excluir anexo');
        }
        
        hideLoading();
        
      } catch (error) {
        debugLog('error', '‚ùå Erro ao excluir', { error: error.message });
        showError('Erro ao excluir arquivo: ' + error.message);
        
        // Reabilitar bot√µes
        document.getElementById('btnCancelarExclusao').disabled = false;
        document.getElementById('btnConfirmarExclusao').disabled = false;
        document.getElementById('btnConfirmarExclusao').textContent = 'üóëÔ∏è Confirmar Exclus√£o';
        
        hideLoading();
      }
    });
    
    // Fechar ao clicar fora do popup
    confirmDialog.addEventListener('click', function(e) {
      if (e.target === confirmDialog) {
        closeDialog();
      }
    });
    
  } catch (error) {
    debugLog('error', '‚ùå Erro cr√≠tico na exclus√£o', { error: error.message });
    showError('Erro ao preparar exclus√£o: ' + error.message);
  }
}


// === FUN√á√ÉO DE DEBUG TEMPOR√ÅRIA ===
function debugRncData(rncNumber) {
    google.script.run
        .withSuccessHandler(function(rnc) {
            console.log('=== DEBUG RNC DATA ===');
            console.log('N¬∫ RNC:', rncNumber);
            console.log('Todas as chaves:', Object.keys(rnc));
            console.log('Filial de Origem:', rnc['Filial de Origem']);
            console.log('Tipo RNC:', rnc['Tipo RNC']);
            console.log('Tipo da RNC:', rnc['Tipo da RNC']);
            console.log('RNC completa:', rnc);
        })
        .getRncByNumber(rncNumber);
}

// Chamar no console: debugRncData('0001/2025')
        
        function getSectionIcon(sectionName) {
            const icons = {
                'Abertura': 'üìù',
                'Qualidade': 'üîç',
                'Lideran√ßa': 'üëî'
            };
            return icons[sectionName] || 'üìã';
        }
        
/**
 * Detecta e retorna altera√ß√µes feitas na RNC
 * Deploy 38 - Resumo de altera√ß√µes
 */
function getChangedFields(originalData, newData) {
    const changes = [];
    
    // Campos relevantes para rastrear (excluir campos t√©cnicos)
    const fieldsToTrack = Object.keys(newData).filter(key => {
        return !key.toLowerCase().includes('anexo') && 
               !key.toLowerCase().includes('file') &&
               key !== 'N¬∫ RNC' &&
               key !== 'Data Abertura' &&
               key !== 'timestamp';
    });
    
    fieldsToTrack.forEach(fieldName => {
        const oldValue = originalData[fieldName] || '';
        const newValue = newData[fieldName] || '';
        
        // Se os valores s√£o diferentes
        if (String(oldValue).trim() !== String(newValue).trim()) {
            changes.push({
                field: fieldName,
                oldValue: oldValue || '(vazio)',
                newValue: newValue || '(vazio)'
            });
        }
    });
    
    debugLog('info', 'üìù Altera√ß√µes detectadas', { 
        total: changes.length,
        fields: changes.map(c => c.field)
    });
    
    return changes;
}

/**
 * Exibe modal de sucesso ap√≥s edi√ß√£o com suporte a multiselect
 * Deploy 40 - Atualizado
 */
function showEditSuccessModal(rncNumber, changes, newStatus) {
    // Gerar HTML das altera√ß√µes
    let changesHtml = '';
    
    if (changes.length === 0) {
        changesHtml = `
            <div style="background: #e7f5ff; padding: 12px; border-radius: 6px; border-left: 4px solid #2196F3; font-size: 13px; color: #0d47a1;">
                <strong>‚ÑπÔ∏è Nenhuma altera√ß√£o de campo detectada</strong>
                <p style="margin: 5px 0 0 0; font-size: 12px;">
                    Possivelmente foram adicionados/removidos apenas anexos.
                </p>
            </div>
        `;
    } else {
        changesHtml = `
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; margin: 15px 0;">
                <div style="font-weight: 600; color: #009688; margin-bottom: 10px; font-size: 14px;">
                    üìù ${changes.length} ${changes.length === 1 ? 'campo alterado' : 'campos alterados'}:
                </div>
                ${changes.map(change => {
    // ‚úÖ DETECTAR SE √â MULTISELECT - COM PROTE√á√ÉO
    const isMultiselect = (change.oldValue && typeof change.oldValue === 'string' && change.oldValue.includes(';')) || 
                         (change.newValue && typeof change.newValue === 'string' && change.newValue.includes(';'));
    
    if (isMultiselect) {
        // Processar tags antigas e novas
        const oldTags = change.oldValue && typeof change.oldValue === 'string' ? 
            change.oldValue.split(';').map(v => v.trim()).filter(v => v) : [];
        const newTags = change.newValue && typeof change.newValue === 'string' ? 
            change.newValue.split(';').map(v => v.trim()).filter(v => v) : [];
        
        return `
            <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid #009688;">
                <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 8px;">
                    üè∑Ô∏è ${change.field}
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; font-size: 12px;">
                    <div style="padding: 8px; background: #ffebee; border-radius: 4px;">
                        <div style="font-size: 10px; opacity: 0.8; margin-bottom: 4px; text-align: center; color: #c62828;">ANTES</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;">
                            ${oldTags.length > 0 ? 
                                oldTags.map(tag => `
                                    <span style="display: inline-block; background: #f44336; color: white; padding: 3px 8px; border-radius: 10px; font-size: 11px;">
                                        ${tag}
                                    </span>
                                `).join('') : 
                                '<span style="color: #999; font-style: italic; font-size: 11px;">(vazio)</span>'
                            }
                        </div>
                    </div>
                    <div style="font-size: 16px; color: #009688; display: flex; align-items: center;">‚Üí</div>
                    <div style="padding: 8px; background: #e8f5e9; border-radius: 4px;">
                        <div style="font-size: 10px; opacity: 0.8; margin-bottom: 4px; text-align: center; color: #2e7d32;">DEPOIS</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;">
                            ${newTags.length > 0 ? 
                                newTags.map(tag => `
                                    <span style="display: inline-block; background: #4CAF50; color: white; padding: 3px 8px; border-radius: 10px; font-size: 11px;">
                                        ${tag}
                                    </span>
                                `).join('') : 
                                '<span style="color: #999; font-style: italic; font-size: 11px;">(vazio)</span>'
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Campo normal (sem multiselect) - COM FORMATA√á√ÉO DE DATA
        let oldValueDisplay = change.oldValue !== null && change.oldValue !== undefined ? String(change.oldValue) : '(vazio)';
        let newValueDisplay = change.newValue !== null && change.newValue !== undefined ? String(change.newValue) : '(vazio)';
        
        // Tentar formatar datas
        if (typeof oldValueDisplay === 'string' && 
            (oldValueDisplay.includes('T') || oldValueDisplay.match(/^\d{4}-\d{2}-\d{2}/))) {
            const formatted = formatDate(oldValueDisplay);
            if (formatted) oldValueDisplay = formatted;
        }
        
        if (typeof newValueDisplay === 'string' && 
            (newValueDisplay.includes('T') || newValueDisplay.match(/^\d{4}-\d{2}-\d{2}/))) {
            const formatted = formatDate(newValueDisplay);
            if (formatted) newValueDisplay = formatted;
        }
        
        return `
            <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid #009688;">
                <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 5px;">
                    üè∑Ô∏è ${change.field}
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; font-size: 12px;">
                    <div style="padding: 6px; background: #ffebee; border-radius: 4px; color: #c62828; text-align: center;">
                        <div style="font-size: 10px; opacity: 0.8; margin-bottom: 2px;">ANTES</div>
                        <div style="font-weight: 500;">${oldValueDisplay}</div>
                    </div>
                    <div style="font-size: 16px; color: #009688;">‚Üí</div>
                    <div style="padding: 6px; background: #e8f5e9; border-radius: 4px; color: #2e7d32; text-align: center;">
                        <div style="font-size: 10px; opacity: 0.8; margin-bottom: 2px;">DEPOIS</div>
                        <div style="font-weight: 500;">${newValueDisplay}</div>
                    </div>
                </div>
            </div>
        `;
    }
}).join('')}
            </div>
        `;
    }
    
    const modalHtml = `
        <div id="editSuccessModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
            <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s;">
                
                <!-- √çcone de Sucesso -->
                <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                
                <!-- T√≠tulo -->
                <h2 style="color: #10B981; margin-bottom: 15px; font-size: 24px;">RNC Atualizada com Sucesso!</h2>
                
                <!-- N√∫mero da RNC -->
                <div style="background: #F0FDF4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10B981;">
                    <p style="font-size: 14px; color: #666; margin-bottom: 10px;">N√∫mero da RNC:</p>
                    <p style="font-size: 28px; font-weight: bold; color: #009688; margin: 0;">${rncNumber}</p>
                </div>
                
                <!-- Status (se mudou) -->
                ${newStatus ? `
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <p style="color: #856404; font-size: 14px; margin: 0;">
                            <strong>üìä Novo Status:</strong> ${newStatus}
                        </p>
                    </div>
                ` : ''}
                
                <!-- Resumo de Altera√ß√µes -->
                ${changesHtml}
                
                <!-- Timestamp -->
                <p style="color: #999; font-size: 12px; margin-top: 20px; margin-bottom: 25px;">
                    üïê Salvo em ${new Date().toLocaleString('pt-BR')}
                </p>
                
                <!-- Bot√£o OK -->
                <button onclick="closeEditSuccessModal()" style="
                    background: #009688; 
                    color: white; 
                    border: none; 
                    padding: 14px 40px; 
                    border-radius: 8px; 
                    font-size: 16px; 
                    font-weight: 600; 
                    cursor: pointer; 
                    transition: all 0.2s;
                    box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);
                " onmouseover="this.style.background='#00796B'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0, 150, 136, 0.4)';" onmouseout="this.style.background='#009688'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 150, 136, 0.3)';">
                    OK, Entendi
                </button>
            </div>
        </div>
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translateY(50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        </style>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    debugLog('success', '‚úÖ Modal de sucesso exibido', { 
        rncNumber, 
        changesCount: changes.length 
    });
}

/**
 * Fecha modal de sucesso de edi√ß√£o
 */
function closeEditSuccessModal() {
    const modal = document.getElementById('editSuccessModal');
    if (modal) {
        modal.remove();
    }
}



/**
 * FUN√á√ÉO 1: Normaliza valores para compara√ß√£o
 * Trata null, undefined, n√∫meros e strings
 */
function normalizeValue(value) {
    // Valores vazios = string vazia
    if (value === null || value === undefined || value === '') {
        return '';
    }
    
    // Converter para string e limpar espa√ßos
    const strValue = String(value).trim();
    
    // Valores especiais
    if (strValue === 'null' || strValue === 'undefined' || strValue === '(vazio)') {
        return '';
    }
    
    return strValue;
}

/**
 * FUN√á√ÉO 2: Normaliza datas para formato consistente
 * Converte DD/MM/YYYY e YYYY-MM-DD para formato padr√£o
 */
function normalizeDateValue(value) {
    if (!value) return '';
    
    const strValue = String(value).trim();
    if (!strValue) return '';
    
    // Formato DD/MM/YYYY (brasileiro)
    const brMatch = strValue.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (brMatch) {
        const [_, day, month, year] = brMatch;
        return `${year}-${month}-${day}`;
    }
    
    // Formato YYYY-MM-DD (ISO)
    const isoMatch = strValue.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (isoMatch) {
        const [_, year, month, day] = isoMatch;
        return `${year}-${month}-${day}`;
    }
    
    return strValue;
}

/**
 * FUN√á√ÉO 3: Verifica se campo √© de data pelo nome
 */
function isDateField(fieldName) {
    const lowerField = fieldName.toLowerCase();
    return lowerField.includes('data') || lowerField.includes('date');
}

/**
 * FUN√á√ÉO 4: Compara valores com normaliza√ß√£o inteligente
 * Retorna true se os valores s√£o DIFERENTES
 */
function valuesAreDifferent(oldValue, newValue, fieldName) {
    // Se √© campo de data, usar normaliza√ß√£o de data
    if (isDateField(fieldName)) {
        const oldNormalized = normalizeDateValue(oldValue);
        const newNormalized = normalizeDateValue(newValue);
        
        // Debug de datas (pode remover depois)
        if (oldNormalized !== newNormalized) {
            console.log(`üìÖ Data realmente diferente: ${fieldName}`, {
                old: oldValue,
                new: newValue,
                oldNorm: oldNormalized,
                newNorm: newNormalized
            });
        }
        
        return oldNormalized !== newNormalized;
    }
    
    // Para outros campos, usar normaliza√ß√£o padr√£o
    const oldNormalized = normalizeValue(oldValue);
    const newNormalized = normalizeValue(newValue);
    
    return oldNormalized !== newNormalized;
}


/**
 * Atualiza RNC existente - Deploy 40 com suporte a Multiselect
 */
async function updateRnc() {
    try {
        debugLog('info', 'üíæ Atualizando RNC', { currentRnc });
        
        const form = document.getElementById('rncEditForm');
        const formData = new FormData(form);
        const data = {};

        // ‚úÖ FILTRAR campos de arquivo
        for (let [key, value] of formData.entries()) {
            if (key !== 'Anexo de Documentos' && 
                key !== 'fileInput' && 
                key !== 'fileInputEdit' &&
                key !== 'fileUpload' &&
                !key.toLowerCase().includes('anexo')) {
                data[key] = value;
            }
        }
        
        // ‚úÖ ADICIONAR: Capturar valores de campos multiselect dos inputs hidden
        const multiselectInputs = document.querySelectorAll('.multiselect-wrapper input[type="hidden"]');
        multiselectInputs.forEach(input => {
            const fieldName = input.name;
            const fieldValue = input.value;
            
            if (fieldName) {
                data[fieldName] = fieldValue || '';
                debugLog('debug', `üìã Multiselect capturado na edi√ß√£o: ${fieldName}`, { value: fieldValue });
            }
        });
        
        debugLog('info', 'üìã Dados coletados para atualiza√ß√£o', { 
            fields: Object.keys(data),
            hasNewFiles: selectedFiles.length > 0,
            multiselectCount: multiselectInputs.length
        });
        
        // ‚úÖ COMPARA√á√ÉO CORRIGIDA COM NORMALIZA√á√ÉO
const changes = [];
const originalData = window.originalRncData || {};

// Lista de campos t√©cnicos que devem ser ignorados
const fieldsToIgnore = [
    'Anexo de Documentos',
    'fileInput',
    'fileInputEdit',
    'fileUpload',
    'N¬∫ RNC',
    'Data Abertura',
    'timestamp',
    'Data Cria√ß√£o',
    'Usu√°rio Cria√ß√£o',
    '√öltima Edi√ß√£o',
    'Editado Por'
];

// Comparar apenas campos relevantes
for (let key in data) {
    // Ignorar campos t√©cnicos
    if (fieldsToIgnore.includes(key)) {
        console.log(`‚è≠Ô∏è Ignorando campo t√©cnico: ${key}`);
        continue;
    }
    
    // Ignorar campos de arquivo
    const lowerKey = key.toLowerCase();
    if (lowerKey.includes('file') || lowerKey.includes('anexo')) {
        console.log(`‚è≠Ô∏è Ignorando campo de arquivo: ${key}`);
        continue;
    }
    
    const oldValue = originalData[key];
    const newValue = data[key];
    
    // Usar compara√ß√£o inteligente com normaliza√ß√£o
    if (valuesAreDifferent(oldValue, newValue, key)) {
        console.log(`‚úèÔ∏è Campo realmente alterado: ${key}`, {
            old: oldValue,
            new: newValue
        });
        
        changes.push({
            field: key,
            oldValue: oldValue || '(vazio)',
            newValue: newValue || '(vazio)'
        });
    } else {
        console.log(`‚úÖ Campo sem altera√ß√£o: ${key} (${normalizeValue(oldValue)} === ${normalizeValue(newValue)})`);
    }
}

// Log consolidado
console.log('üîç RESULTADO DA COMPARA√á√ÉO:', {
    totalCamposVerificados: Object.keys(data).length,
    camposIgnorados: fieldsToIgnore.length,
    alteracoesREAIS: changes.length,
    camposAlterados: changes.map(c => c.field)
});
        
        debugLog('info', `üîç ${changes.length} altera√ß√µes detectadas`, { changes });
        
        if (changes.length === 0 && selectedFiles.length === 0) {
        debugLog('info', '‚ÑπÔ∏è Nenhuma altera√ß√£o detectada');
        
        // Exibir modal informativo
        await showInfoModal(
            'Nenhuma Altera√ß√£o Detectada',
            'Voc√™ n√£o modificou nenhum campo desta RNC.<br><br>Para salvar altera√ß√µes, voc√™ precisa editar pelo menos um campo.',
            '‚ÑπÔ∏è'
        );
        
        hideLoading();
        return;
    }
        
        // Confirma√ß√£o
        const confirmed = await showConfirmModal(
            'Deseja salvar as altera√ß√µes?',
            `${changes.length} campo(s) modificado(s)`
        );
        
        if (!confirmed) {
            debugLog('info', '‚ùå Usu√°rio cancelou a atualiza√ß√£o');
            return;
        }
        
        showLoading('Salvando altera√ß√µes...');
        
        // Chamar backend
        const result = await apiCall('updateRnc', [currentRnc, data, selectedFiles]);
        
        if (result.success) {
            debugLog('success', '‚úÖ RNC atualizada', { 
                rncNumber: currentRnc,
                changesCount: changes.length
            });
            
            // Exibir modal de sucesso com resumo
            showEditSuccessModal(currentRnc, changes);
            
            // Limpar arquivos selecionados
            selectedFiles = [];
            updateFileList();
            
            // Recarregar RNC atualizada
            setTimeout(() => {
                loadRncForEdit(currentRnc);
            }, 2000);
            
        } else {
            throw new Error(result.error || 'Erro ao atualizar RNC');
        }
        
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao atualizar RNC', { error: error.message });
        showError('Erro ao atualizar: ' + error.message);
        hideLoading();
    }
}
        
        // === KANBAN CORRIGIDO COM FINALIZADAS (DEPLOY 30) ===
        async function loadKanban() {
    try {
        debugLog('info', 'üìã Carregando Kanban');
        
        showLoading('Carregando kanban...');
        
        // Carregar filtros de setores
        await loadSetoresKanban();
        
        // Carregar dados do kanban (sem filtro inicialmente)
        await refreshKanban();
        
        hideLoading();
        
        debugLog('success', '‚úÖ Kanban carregado');
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar kanban', { error: error.message });
        showError('Erro ao carregar kanban: ' + error.message);
        hideLoading();
    }
}
        
async function loadSetoresKanban() {
    try {
        const tipoSetorSelect = document.getElementById('tipoSetorKanban');
        const setorFilterSelect = document.getElementById('setorFilterKanban');
        
        if (!tipoSetorSelect || !setorFilterSelect) return;
        
        debugLog('info', 'üè¢ Carregando filtros de setores - Kanban');
        
        const setores = await apiCall('getSetoresDuplos', []);
        
        // Fun√ß√£o para atualizar lista de setores
        function atualizarListaSetores() {
            const tipoSetor = tipoSetorSelect.value;
            const listaSetores = tipoSetor === 'abertura' 
                ? setores.setoresAbertura 
                : setores.setoresQualidade;
            
            setorFilterSelect.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
            
            listaSetores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = `üè¢ ${setor}`;
                setorFilterSelect.appendChild(option);
            });
            
            debugLog('success', `‚úÖ ${listaSetores.length} setores carregados (${tipoSetor})`);
        }
        
        // Event listeners
        tipoSetorSelect.addEventListener('change', function() {
            atualizarListaSetores();
            refreshKanban();
        });
        
        setorFilterSelect.addEventListener('change', function() {
            refreshKanban();
        });
        
        // Carregar lista inicial
        atualizarListaSetores();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar filtros Kanban', { error: error.message });
    }
}

async function refreshKanban() {
    try {
        const tipoSetor = document.getElementById('tipoSetorKanban')?.value || 'qualidade';
        const setor = document.getElementById('setorFilterKanban')?.value || 'Todos';
        const countSpan = document.getElementById('rncCountKanban');
        
        debugLog('info', 'üîÑ Atualizando Kanban', { tipoSetor, setor });
        
        showLoading('Carregando Kanban...');
        
        const data = await apiCall('getKanbanDataFiltered', [tipoSetor, setor]);
        
        if (!data) {
            throw new Error('Nenhum dado retornado');
        }
        
        renderKanban(data);
        
        // Atualizar contador
        if (countSpan) {
            let total = 0;
            Object.keys(data).forEach(status => {
                total += data[status].length;
            });
            countSpan.textContent = `${total} RNC(s) exibida(s)`;
            countSpan.style.color = total > 0 ? '#4CAF50' : '#999';
            countSpan.style.fontWeight = '600';
        }
        
        hideLoading();
        
        debugLog('success', '‚úÖ Kanban atualizado');
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao atualizar Kanban', { error: error.message });
        showError('Erro ao carregar Kanban');
        hideLoading();
    }
}


        function renderKanban(kanbanData) {
            try {
                const container = document.getElementById('kanban-container');
                
                // === TODAS AS COLUNAS INCLUINDO FINALIZADAS (DEPLOY 30) ===
                const columns = ['Abertura RNC', 'An√°lise Qualidade', 'An√°lise do problema e A√ß√£o Corretiva', 'Finalizada'];
                const columnClasses = ['abertura', 'analise-qualidade', 'analise-acao', 'finalizada'];
                const columnTitles = ['üìù Abertura RNC', 'üîç An√°lise Qualidade', '‚ö° An√°lise e A√ß√£o', '‚úÖ Finalizadas'];
                
                debugLog('info', 'üé® Renderizando Kanban DEPLOY 30 COM FINALIZADAS', {
                    columns: columns,
                    itemCounts: columns.map(col => kanbanData[col] ? kanbanData[col].length : 0)
                });
                
                let kanbanHtml = '<div class="kanban-container">';
                
                columns.forEach((column, index) => {
                    const items = kanbanData[column] || [];
                    const columnClass = columnClasses[index];
                    const columnTitle = columnTitles[index];
                    
                    kanbanHtml += `
                        <div class="kanban-column">
                            <div class="kanban-header ${columnClass}">
                                ${columnTitle} (${items.length})
                            </div>
                            <div class="kanban-cards">
                    `;
                    
                    items.forEach(item => {
                        const risco = item.risco || '';
                        const riscoClass = risco.toLowerCase().includes('cr√≠tico') ? 'risco-critico' :
                                         risco.toLowerCase().includes('alto') ? 'risco-alto' :
                                         risco.toLowerCase().includes('m√©dio') ? 'risco-medio' :
                                         risco.toLowerCase().includes('baixo') ? 'risco-baixo' : '';
                        
                        const priorityClass = item.prioridade === 'Alta' ? 'priority-alta' :
                                            item.prioridade === 'M√©dia' ? 'priority-media' : 'priority-normal';
                        
                        kanbanHtml += `
                            <div class="kanban-card" onclick="editRncFromKanban('${item.numero}')">
                                <div class="card-header">
                                    <div class="card-number">üìÑ ${item.numero}</div>
                                    <div class="card-priority ${priorityClass}">${item.prioridade}</div>
                                </div>
                                <div class="card-cliente">üë§ ${item.cliente}</div>
                                <div class="card-descricao">${item.descricao || 'Sem descri√ß√£o'}</div>
                                <div class="card-meta">
                                    <div class="card-responsavel">üë®‚Äçüíº ${item.responsavel}</div>
                                    <div class="card-dias">${item.diasAberto || 0} dias</div>
                                </div>
                                ${risco ? `<div class="card-risco ${riscoClass}">${risco}</div>` : ''}
                                <div class="card-tags">
                                    <div class="card-tag">üè¢ ${item.setor || 'N/A'}</div>
                                    <div class="card-tag">üìã ${item.tipo || 'N/A'}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    kanbanHtml += `
                            </div>
                        </div>
                    `;
                });
                
                kanbanHtml += '</div>';
                container.innerHTML = kanbanHtml;
                
                debugLog('success', '‚úÖ Kanban renderizado DEPLOY 30 COM FINALIZADAS', {
                    totalItems: columns.reduce((sum, col) => sum + (kanbanData[col] ? kanbanData[col].length : 0), 0)
                });
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao renderizar kanban DEPLOY 30', { error: error.message });
                showError('Erro ao renderizar kanban: ' + error.message);
            }
        }
        
        function editRncFromKanban(rncNumber) {
            debugLog('info', 'üéØ Editando RNC do kanban DEPLOY 30', { rncNumber });
            switchTab('editar');
            document.getElementById('rncSelect').value = rncNumber;
            loadRncForEdit(rncNumber);
        }
        
        // === DASHBOARD ===
        async function loadDashboard() {
    try {
        debugLog('info', 'üìä Carregando Dashboard');
        
        showLoading('Carregando dashboard...');
        
        // Carregar filtros de setores
        await loadSetoresDashboard();
        
        // Carregar dados do dashboard
        await refreshDashboard();
        
        hideLoading();
        
        debugLog('success', '‚úÖ Dashboard carregado');
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar dashboard', { error: error.message });
        showError('Erro ao carregar dashboard: ' + error.message);
        hideLoading();
    }
}

   async function loadSetoresDashboard() {
    try {
        const tipoSetorSelect = document.getElementById('tipoSetorDashboard');
        const setorFilterSelect = document.getElementById('setorFilterDashboard');
        
        if (!tipoSetorSelect || !setorFilterSelect) return;
        
        debugLog('info', 'üè¢ Carregando filtros de setores - Dashboard');
        
        const setores = await apiCall('getSetoresDuplos', []);
        
        function atualizarListaSetores() {
            const tipoSetor = tipoSetorSelect.value;
            const listaSetores = tipoSetor === 'abertura' 
                ? setores.setoresAbertura 
                : setores.setoresQualidade;
            
            setorFilterSelect.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
            
            listaSetores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = `üè¢ ${setor}`;
                setorFilterSelect.appendChild(option);
            });
        }
        
        tipoSetorSelect.addEventListener('change', function() {
            atualizarListaSetores();
            refreshDashboard();
        });
        
        setorFilterSelect.addEventListener('change', function() {
            refreshDashboard();
        });
        
        atualizarListaSetores();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar filtros Dashboard');
    }
}     

// === GR√ÅFICO DE PIZZA COM SVG ===
// === GR√ÅFICO DE PIZZA COM SVG E CORES VARIADAS ===
// === GR√ÅFICO DE PIZZA ANIMADO COM CHART.JS ===
function renderPieChart(containerId, data) {
    const container = document.getElementById(containerId);
    if (!container || !data) return;
    
    const entries = Object.entries(data);
    if (entries.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">üìä Sem dados</div>';
        return;
    }
    
    const total = entries.reduce((sum, [, value]) => sum + value, 0);
    if (total === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">üìä Sem dados</div>';
        return;
    }
    
    // Cores vibrantes
    const colors = [
        '#009688', '#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336', 
        '#FFB300', '#00BCD4', '#8BC34A', '#E91E63', '#3F51B5', '#FF5722'
    ];
    
    // Container centralizado
    const canvasId = containerId + '_canvas';
    container.innerHTML = `
        <div style="position: relative; height: 300px; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
            <canvas id="${canvasId}" style="max-width: 300px; max-height: 300px;"></canvas>
        </div>
    `;
    
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    
    // Destruir gr√°fico anterior
    if (window[canvasId + '_chart']) {
        window[canvasId + '_chart'].destroy();
    }
    
    // ‚úÖ NOVO: Plugin para mostrar valores dentro dos segmentos
    const centerTextPlugin = {
        id: 'centerText',
        afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            const meta = chart.getDatasetMeta(0);
            
            meta.data.forEach((element, index) => {
                const dataset = chart.data.datasets[0];
                const value = dataset.data[index];
                const total = dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                
                // Calcular posi√ß√£o do texto (centro do segmento)
                const angle = (element.startAngle + element.endAngle) / 2;
                const radius = (element.innerRadius + element.outerRadius) / 2;
                const x = element.x + Math.cos(angle) * radius;
                const y = element.y + Math.sin(angle) * radius;
                
                // Configurar texto
                ctx.save();
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 4;
                
                // Desenhar valor
                ctx.fillText(value, x, y - 8);
                
                // Desenhar percentual
                ctx.font = 'bold 12px Inter, sans-serif';
                ctx.fillText(`(${percentage}%)`, x, y + 8);
                
                ctx.restore();
            });
        }
    };
    
    // Criar gr√°fico COM plugin de texto
    window[canvasId + '_chart'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: entries.map(([label]) => label),
            datasets: [{
                data: entries.map(([, value]) => value),
                backgroundColor: colors.slice(0, entries.length),
                borderColor: '#ffffff',
                borderWidth: 3,
                hoverOffset: 15,
                hoverBorderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return ` ${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 1500,
                easing: 'easeInOutQuart'
            },
            cutout: '60%'
        },
        plugins: [centerTextPlugin] // ‚úÖ Ativar plugin
    });
    
    debugLog('success', `‚ú® Gr√°fico de pizza com valores: ${containerId}`);
}
function renderDashboard(stats) {
    const container = document.getElementById('dashboard-content');
    
    const dashboardHtml = `
        <!-- ========================================== -->
        <!-- LINHA 1: KPIs DE PIPELINE (5 CARDS) -->
        <!-- ========================================== -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px;">
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üìä</div>
                <div class="dashboard-number">${stats.total || 0}</div>
                <div class="dashboard-label">Total de RNCs</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üìù</div>
                <div class="dashboard-number">${stats.aberturaRnc || 0}</div>
                <div class="dashboard-label">Abertura RNC</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üîç</div>
                <div class="dashboard-number">${stats.analiseQualidade || 0}</div>
                <div class="dashboard-label">An√°lise Qualidade</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">‚ö°</div>
                <div class="dashboard-number">${stats.analiseAcao || 0}</div>
                <div class="dashboard-label">An√°lise e A√ß√£o</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">‚úÖ</div>
                <div class="dashboard-number">${stats.finalizadas || 0}</div>
                <div class="dashboard-label">Finalizadas</div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- LINHA 2: KPIs OPERACIONAIS B√ÅSICOS (5 CARDS) -->
        <!-- ========================================== -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px;">
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üí∞</div>
                <div class="dashboard-number">R$ ${(stats.custoTotal || 0).toFixed(2)}</div>
                <div class="dashboard-label">Custo Total</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">‚è±Ô∏è</div>
                <div class="dashboard-number">${stats.tempoMedioResolucao || 0}</div>
                <div class="dashboard-label">Dias M√©dio Resolu√ß√£o</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: ${stats.rncsVencidas > 0 ? '#F44336' : '#009688'};">
                <div class="dashboard-icon">‚ö†Ô∏è</div>
                <div class="dashboard-number">${stats.rncsVencidas || 0}</div>
                <div class="dashboard-label">RNCs Vencidas</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: ${stats.rncsProximasVencer > 0 ? '#FFC107' : '#009688'};">
                <div class="dashboard-icon">üïê</div>
                <div class="dashboard-number">${stats.rncsProximasVencer || 0}</div>
                <div class="dashboard-label">Pr√≥ximas Vencer</div>
            </div>
            
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üéØ</div>
                <div class="dashboard-number">${stats.acoesCorretivaTomadas || 0}</div>
                <div class="dashboard-label">A√ß√µes Corretivas Tomadas</div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- ‚ú® LINHA 3: NOVOS KPIs ESTRAT√âGICOS (5 CARDS) -->
        <!-- ========================================== -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px;">
            
            <!-- KPI 1: % Impacto ao Cliente -->
            <div class="dashboard-card" style="border-top-color: ${stats.impactoClientePercentual > 30 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">üë•</div>
                <div class="dashboard-number">${stats.impactoClientePercentual || 0}%</div>
                <div class="dashboard-label">Impacto ao Cliente</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.impactoClienteTotal || 0} de ${stats.total || 0} RNCs
                </div>
            </div>
            
            <!-- KPI 2: Taxa Detec√ß√£o Interna -->
            <div class="dashboard-card" style="border-top-color: ${stats.deteccaoInternaPercentual >= 70 ? '#4CAF50' : '#FFC107'};">
                <div class="dashboard-icon">üîç</div>
                <div class="dashboard-number">${stats.deteccaoInternaPercentual || 0}%</div>
                <div class="dashboard-label">Detec√ß√£o Interna</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.deteccaoInternaTotal || 0} detectadas internamente
                </div>
            </div>
            
            <!-- KPI 3: Taxa N√£o Procede -->
            <div class="dashboard-card" style="border-top-color: ${stats.naoProcedeTaxa > 10 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">‚ùå</div>
                <div class="dashboard-number">${stats.naoProcedeTaxa || 0}%</div>
                <div class="dashboard-label">Taxa N√£o Procede</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.naoProcede || 0} RNCs n√£o procederam
                </div>
            </div>
            
            <!-- KPI 6: √çndice de Severidade -->
            <div class="dashboard-card" style="border-top-color: ${stats.indiceSeveridadePonderado > 50 ? '#F44336' : stats.indiceSeveridadePonderado > 30 ? '#FFC107' : '#4CAF50'};">
                <div class="dashboard-icon">üìà</div>
                <div class="dashboard-number">${stats.indiceSeveridadePonderado || 0}</div>
                <div class="dashboard-label">√çndice de Severidade</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ISP Ponderado
                </div>
            </div>
            
            <!-- KPI 7: Taxa Cumprimento Prazo -->
            <div class="dashboard-card" style="border-top-color: ${stats.taxaCumprimentoPrazo >= 80 ? '#4CAF50' : stats.taxaCumprimentoPrazo >= 60 ? '#FFC107' : '#F44336'};">
                <div class="dashboard-icon">‚è∞</div>
                <div class="dashboard-number">${stats.taxaCumprimentoPrazo || 0}%</div>
                <div class="dashboard-label">Cumprimento de Prazo</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    RNCs finalizadas no prazo
                </div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- GR√ÅFICOS DE PIZZA (mantidos) -->
        <!-- ========================================== -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            
            <div class="chart-container">
                <h3 class="chart-title">üìã RNCs por Tipo</h3>
                <div id="chartPorTipo"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">‚ö†Ô∏è RNCs por Risco</h3>
                <div id="chartPorRisco"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üîß RNCs por Tipo de Falha</h3>
                <div id="chartPorTipoFalha"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üè¢ Setor de Abertura</h3>
                <div id="chartSetorAbertura"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üîç Setor N√£o Conformidade</h3>
                <div id="chartSetorNaoConf"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üéØ Status A√ß√£o Corretiva</h3>
                <div id="chartStatusAcao"></div>
            </div>
        </div>
        
        <!-- Timeline (mantido) -->
        <div class="chart-container" style="margin-bottom: 30px;">
            <h3 class="chart-title">üìà Timeline de RNCs</h3>
            <div id="timelineChart"></div>
        </div>
        
        <!-- ========================================== -->
        <!-- ‚ú® NOVO: TABELA DE CUSTO M√âDIO POR TIPO (KPI 5) -->
        <!-- ========================================== -->
        ${Object.keys(stats.custoMedioPorTipo || {}).length > 0 ? `
        <div class="chart-container">
            <h3 class="chart-title">üí∞ Custo M√©dio por Tipo de RNC</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Tipo de RNC</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Quantidade</th>
                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Custo Total</th>
                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Custo M√©dio</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(stats.custoMedioPorTipo).map(tipo => {
                        const dados = stats.custoMedioPorTipo[tipo];
                        return `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;">${tipo}</td>
                                <td style="padding: 10px; text-align: center;">${dados.count}</td>
                                <td style="padding: 10px; text-align: right;">R$ ${dados.soma.toFixed(2)}</td>
                                <td style="padding: 10px; text-align: right; font-weight: bold;">R$ ${dados.media.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        ` : ''}
        
        <!-- Resumo Executivo (mantido) -->
        <div class="chart-container">
            <h3 class="chart-title">üìã Resumo Executivo</h3>
            <div style="padding: 15px; line-height: 1.8;">
                ${stats.total ? `
                    <p>üìä <strong>${stats.total}</strong> RNC(s) registrada(s) no sistema.</p>
                    <p>üìù <strong>${stats.aberturaRnc || 0}</strong> em fase de abertura.</p>
                    <p>üîç <strong>${stats.analiseQualidade || 0}</strong> em an√°lise de qualidade.</p>
                    <p>‚ö° <strong>${stats.analiseAcao || 0}</strong> em an√°lise e a√ß√£o corretiva.</p>
                    <p>‚úÖ <strong>${stats.finalizadas || 0}</strong> finalizadas.</p>
                    <p>üí∞ Custo total: <strong>R$ ${(stats.custoTotal || 0).toFixed(2)}</strong></p>
                    <p>‚è±Ô∏è Tempo m√©dio de resolu√ß√£o: <strong>${stats.tempoMedioResolucao || 0} dias</strong>.</p>
                    ${stats.rncsVencidas > 0 ? `<p style="color: #F44336;">‚ö†Ô∏è <strong>${stats.rncsVencidas}</strong> RNC(s) vencida(s) requerem aten√ß√£o!</p>` : ''}
                    ${stats.rncsProximasVencer > 0 ? `<p style="color: #FFC107;">üïê <strong>${stats.rncsProximasVencer}</strong> RNC(s) pr√≥ximas de vencer.</p>` : ''}
                    <p>üéØ <strong>${stats.acoesCorretivaTomadas || 0}</strong> a√ß√£o(√µes) corretiva(s) tomada(s).</p>
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
                    <h4 style="color: #009688; margin-bottom: 10px;">üìä KPIs Estrat√©gicos</h4>
                    <p>üë• Impacto ao Cliente: <strong>${stats.impactoClientePercentual}%</strong> (${stats.impactoClienteTotal} RNCs)</p>
                    <p>üîç Detec√ß√£o Interna: <strong>${stats.deteccaoInternaPercentual}%</strong> ${stats.deteccaoInternaPercentual >= 70 ? '‚úÖ' : '‚ö†Ô∏è'}</p>
                    <p>‚ùå Taxa N√£o Procede: <strong>${stats.naoProcedeTaxa}%</strong> ${stats.naoProcedeTaxa <= 10 ? '‚úÖ' : '‚ö†Ô∏è'}</p>
                    <p>üìà √çndice de Severidade: <strong>${stats.indiceSeveridadePonderado}</strong> pontos</p>
                    <p>‚è∞ Cumprimento de Prazo: <strong>${stats.taxaCumprimentoPrazo}%</strong> ${stats.taxaCumprimentoPrazo >= 80 ? '‚úÖ' : '‚ö†Ô∏è'}</p>
                ` : '<p>üì≠ Nenhuma RNC encontrada.</p>'}
            </div>
        </div>

        <!-- ========================================== -->
        <!-- ‚ú® DEPLOY 36: COMPARATIVO MENSAL -->
        <!-- ========================================== -->
        ${stats.total > 0 ? `
        <div class="chart-container" style="margin-top: 30px;">
            <h3 class="chart-title">üìä Comparativo Mensal</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px;">
                <div style="text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">M√™s Atual</div>
                    <div style="font-size: 32px; font-weight: bold; color: #009688;">${stats.esteMes || 0}</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">RNCs criadas</div>
                </div>
                <div style="text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">M√™s Anterior</div>
                    <div style="font-size: 32px; font-weight: bold; color: #666;">${stats.mesAnterior || 0}</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">RNCs criadas</div>
                </div>
                <div style="text-align: center; padding: 20px; background: ${(stats.esteMes || 0) > (stats.mesAnterior || 0) ? '#ffebee' : '#e8f5e9'}; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">Tend√™ncia</div>
                    <div style="font-size: 32px; font-weight: bold; color: ${(stats.esteMes || 0) > (stats.mesAnterior || 0) ? '#F44336' : '#4CAF50'};">
                        ${(stats.esteMes || 0) > (stats.mesAnterior || 0) ? '‚Üë' : '‚Üì'}
                        ${stats.mesAnterior > 0 ? Math.abs(Math.round((((stats.esteMes || 0) - (stats.mesAnterior || 0)) / (stats.mesAnterior || 1)) * 100)) + '%' : '0%'}
                    </div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        ${(stats.esteMes || 0) > (stats.mesAnterior || 0) ? 'Aumento' : 'Redu√ß√£o'}
                    </div>
                </div>
            </div>
        </div>
        ` : ''}

        <!-- ========================================== -->
        <!-- ‚ú® DEPLOY 36: EVOLU√á√ÉO SEMANAL -->
        <!-- ========================================== -->
        ${stats.porSemana && Object.keys(stats.porSemana).length > 0 ? `
        <div class="chart-container" style="margin-top: 30px;">
            <h3 class="chart-title">üìà Evolu√ß√£o nas √öltimas 4 Semanas</h3>
            <div style="display: flex; gap: 15px; padding: 20px; justify-content: center; align-items: flex-end; height: 200px;">
                ${['Semana -3', 'Semana -2', 'Semana -1', 'Semana -0'].map(semana => {
                    const valor = stats.porSemana[semana] || 0;
                    const maxValue = Math.max(...Object.values(stats.porSemana));
                    const altura = maxValue > 0 ? (valor / maxValue) * 150 : 10;
                    return `
                        <div style="flex: 1; text-align: center;">
                            <div style="background: linear-gradient(to top, #009688, #4CAF50);
                                        height: ${altura}px;
                                        border-radius: 8px 8px 0 0;
                                        margin-bottom: 10px;
                                        display: flex;
                                        align-items: flex-start;
                                        justify-content: center;
                                        padding-top: 10px;
                                        color: white;
                                        font-weight: bold;
                                        font-size: 16px;">
                                ${valor}
                            </div>
                            <div style="font-size: 12px; color: #666;">${semana.replace('-', ' ')}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        ` : ''}

        <!-- ========================================== -->
        <!-- ‚ú® DEPLOY 36: TOP 5 RANKINGS -->
        <!-- ========================================== -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">

            ${stats.top5Setores && stats.top5Setores.length > 0 ? `
            <div class="chart-container">
                <h3 class="chart-title">üèÜ Top 5 Setores com Mais RNCs</h3>
                <div style="padding: 20px;">
                    ${stats.top5Setores.map((setor, index) => {
                        const maxValue = stats.top5Setores[0].total;
                        const largura = (setor.total / maxValue) * 100;
                        const cores = ['#F44336', '#FF9800', '#FFC107', '#4CAF50', '#2196F3'];
                        return `
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-size: 13px; font-weight: 500;">${index + 1}. ${setor.nome}</span>
                                    <span style="font-weight: bold; color: ${cores[index]};">${setor.total}</span>
                                </div>
                                <div style="background: #f5f5f5; height: 24px; border-radius: 12px; overflow: hidden;">
                                    <div style="background: ${cores[index]};
                                                width: ${largura}%;
                                                height: 100%;
                                                border-radius: 12px;
                                                transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            ` : ''}

            ${stats.top5TiposFalha && stats.top5TiposFalha.length > 0 ? `
            <div class="chart-container">
                <h3 class="chart-title">üîß Top 5 Tipos de Falha</h3>
                <div style="padding: 20px;">
                    ${stats.top5TiposFalha.map((tipo, index) => {
                        const maxValue = stats.top5TiposFalha[0].total;
                        const largura = (tipo.total / maxValue) * 100;
                        const cores = ['#F44336', '#FF9800', '#FFC107', '#4CAF50', '#2196F3'];
                        return `
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-size: 13px; font-weight: 500;">${index + 1}. ${tipo.nome}</span>
                                    <span style="font-weight: bold; color: ${cores[index]};">${tipo.total}</span>
                                </div>
                                <div style="background: #f5f5f5; height: 24px; border-radius: 12px; overflow: hidden;">
                                    <div style="background: ${cores[index]};
                                                width: ${largura}%;
                                                height: 100%;
                                                border-radius: 12px;
                                                transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            ` : ''}

        </div>

        <!-- ========================================== -->
        <!-- ‚ú® DEPLOY 36: A√á√ïES RECOMENDADAS -->
        <!-- ========================================== -->
        ${stats.acoesRecomendadas && stats.acoesRecomendadas.length > 0 ? `
        <div class="chart-container" style="margin-top: 30px;">
            <h3 class="chart-title">üí° A√ß√µes Recomendadas</h3>
            <div style="padding: 20px;">
                ${stats.acoesRecomendadas.map(acao => {
                    const corBorda = acao.prioridade === 'Alta' ? '#F44336' :
                                     acao.prioridade === 'M√©dia' ? '#FFC107' : '#4CAF50';
                    const corFundo = acao.prioridade === 'Alta' ? '#ffebee' :
                                     acao.prioridade === 'M√©dia' ? '#fff8e1' : '#e8f5e9';
                    return `
                        <div style="border-left: 4px solid ${corBorda};
                                    background: ${corFundo};
                                    padding: 15px;
                                    margin-bottom: 15px;
                                    border-radius: 4px;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="font-size: 28px;">${acao.icone}</div>
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-weight: bold; font-size: 15px; color: #333;">${acao.titulo}</span>
                                        <span style="background: ${corBorda};
                                                     color: white;
                                                     padding: 4px 12px;
                                                     border-radius: 12px;
                                                     font-size: 11px;
                                                     font-weight: bold;">
                                            ${acao.prioridade.toUpperCase()}
                                        </span>
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 8px;">${acao.descricao}</div>
                                    <div style="font-size: 12px; color: ${corBorda}; font-weight: 500;">
                                        ‚Üí ${acao.acao}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        ` : ''}
    `;

    container.innerHTML = dashboardHtml;
    
    // Renderizar gr√°ficos
    renderPieChart('chartPorTipo', stats.porTipo || {});
    renderPieChart('chartPorRisco', stats.porRisco || {});
    renderPieChart('chartPorTipoFalha', stats.porTipoFalha || {});
    renderPieChart('chartSetorAbertura', stats.porSetorAbertura || {});
    renderPieChart('chartSetorNaoConf', stats.porSetorNaoConformidade || {});
    renderPieChart('chartStatusAcao', stats.porStatusAcaoCorretiva || {});
    renderLineChart('timelineChart', stats.porMes || {});
    
    debugLog('success', '‚úÖ Dashboard renderizado com 15 cards + 8 KPIs avan√ßados');
}
        
var dashboardCache = null;
var dashboardCacheTime = null;
var CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

async function refreshDashboard() {
    try {
        // ‚úÖ Verificar cache
        if (dashboardCache && dashboardCacheTime && (Date.now() - dashboardCacheTime < CACHE_DURATION)) {
            debugLog('info', '‚ö° Usando cache do Dashboard');
            renderDashboard(dashboardCache);
            hideLoading();
            return;
        }
        
        const tipoSetor = document.getElementById('tipoSetorDashboard')?.value || 'qualidade';
        const setor = document.getElementById('setorFilterDashboard')?.value || 'Todos';
        
        showLoading('Carregando Dashboard...');
        
        const stats = await apiCall('getDashboardDataFiltered', [tipoSetor, setor]);
        
        // ‚úÖ Salvar no cache
        dashboardCache = stats;
        dashboardCacheTime = Date.now();
        
        renderDashboard(stats);
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao atualizar Dashboard');
        hideLoading();
    }
}

        function renderSimpleChart(containerId, data) {
            const container = document.getElementById(containerId);
            if (!container || !data) return;
            
            const entries = Object.entries(data);
            if (entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted);">üìä Sem dados para exibir</div>';
                return;
            }
            
            const total = entries.reduce((sum, [, value]) => sum + value, 0);
            const colors = ['var(--primary)', 'var(--warning)', 'var(--accent)', 'var(--success)', 'var(--error)'];
            
            let chartHtml = '<div style="display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: center;">';
            
            entries.forEach(([label, value], index) => {
                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                const color = colors[index % colors.length];
                
                chartHtml += `
                    <div style="text-align: center; min-width: 100px;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: ${color}; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.125rem; box-shadow: var(--shadow-md);">
                            ${value}
                        </div>
                        <div style="margin-top: 0.75rem; font-size: 0.875rem; font-weight: 500; color: var(--text);">${label}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${percentage}%</div>
                    </div>
                `;
            });
            
            chartHtml += '</div>';
            container.innerHTML = chartHtml;
        }
        
        // === GR√ÅFICO DE LINHA ANIMADO COM CHART.JS ===
// === GR√ÅFICO DE LINHA ANIMADO - LARGURA TOTAL ===
function renderLineChart(containerId, data) {
    const container = document.getElementById(containerId);
    if (!container || !data) return;
    
    const entries = Object.entries(data).sort((a, b) => {
        const [monthA, yearA] = a[0].split('/').map(Number);
        const [monthB, yearB] = b[0].split('/').map(Number);
        return (yearA * 12 + monthA) - (yearB * 12 + monthB);
    });
    
    if (entries.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">üìà Sem dados temporais</div>';
        return;
    }
    
    const canvasId = containerId + '_canvas';
    
    // CONTAINER COM 100% DE LARGURA
    container.innerHTML = `
        <div style="position: relative; width: 100%; height: 400px; padding: 0;">
            <canvas id="${canvasId}" style="width: 100% !important; height: 100% !important;"></canvas>
        </div>
    `;
    
    // Aguardar o DOM renderizar
    setTimeout(function() {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fico anterior se existir
        if (window[canvasId + '_chart']) {
            window[canvasId + '_chart'].destroy();
        }
        
        // Criar gradiente para √°rea abaixo da linha
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(0, 150, 136, 0.3)');
        gradient.addColorStop(1, 'rgba(0, 150, 136, 0)');
        
        window[canvasId + '_chart'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: entries.map(([period]) => period),
                datasets: [{
                    label: 'RNCs por Per√≠odo',
                    data: entries.map(([, value]) => value),
                    borderColor: '#009688',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 10,
                    pointBackgroundColor: '#009688',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 3,
                    pointHoverBackgroundColor: '#ffffff',
                    pointHoverBorderColor: '#009688',
                    pointHoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // ‚Üê MUDAN√áA CR√çTICA
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 10,
                        bottom: 10
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'start',
                        labels: {
                            font: {
                                size: 13,
                                family: 'Inter, sans-serif',
                                weight: '600'
                            },
                            color: '#333',
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                return ` ${context.dataset.label}: ${context.parsed.y} RNC(s)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            font: {
                                size: 12,
                                family: 'Inter, sans-serif'
                            },
                            color: '#666'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)',
                            drawBorder: false
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 12,
                                family: 'Inter, sans-serif',
                                weight: '500'
                            },
                            color: '#666'
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
        
        debugLog('success', `‚ú® Gr√°fico de linha (largura total) criado: ${containerId}`);
    }, 100);
}
        
        // === RELAT√ìRIOS ===
        async function loadReportFilters() {
    try {
        debugLog('info', 'üìä Carregando filtros de relat√≥rio');
        
        const setores = await apiCall('getSetoresDuplos', []);
        const tipoSetorSelect = document.getElementById('tipoSetorRelatorio');
        const setorSelect = document.getElementById('setorFiltro');
        
        // Definir datas padr√£o
        const hoje = new Date();
        const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        
        document.getElementById('dataInicio').value = primeiroDia.toISOString().split('T')[0];
        document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
        
        // Fun√ß√£o para atualizar lista de setores
        function atualizarListaSetores() {
            const tipoSetor = tipoSetorSelect.value;
            const listaSetores = tipoSetor === 'abertura' 
                ? setores.setoresAbertura 
                : setores.setoresQualidade;
            
            setorSelect.innerHTML = '<option value="Todos">Todos os Setores</option>';
            
            listaSetores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = setor;
                setorSelect.appendChild(option);
            });
        }
        
        // Event listener
        tipoSetorSelect.addEventListener('change', atualizarListaSetores);
        
        // Carregar lista inicial
        atualizarListaSetores();
        
        // Popular outros filtros
        const options = await apiCall('getReportFilterOptions');
        populateFilterOptions('tipoFiltro', options.tipos || []);
        populateFilterOptions('statusFiltro', options.status || []);
        
        debugLog('success', '‚úÖ Filtros de relat√≥rio carregados');
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar filtros', { error: error.message });
    }
}
        
        function populateFilterOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Manter primeira op√ß√£o (Todos)
            const firstOption = select.children[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }
        
        async function generateReport() {
    try {
        debugLog('info', 'üìä Gerando relat√≥rio');
        
        const filters = {
            dataInicio: document.getElementById('dataInicio').value,
            dataFim: document.getElementById('dataFim').value,
            status: document.getElementById('statusFiltro').value,
            tipoSetor: document.getElementById('tipoSetorRelatorio').value,
            setor: document.getElementById('setorFiltro').value,
            tipo: document.getElementById('tipoFiltro').value
        };
        
        if (!filters.dataInicio || !filters.dataFim) {
            showError('Por favor, preencha as datas de in√≠cio e fim');
            return;
        }
        
        // Modal de confirma√ß√£o HTML
        const confirmModal = document.createElement('div');
        confirmModal.className = 'modal-overlay';
        confirmModal.innerHTML = `
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h3>üìä Gerar Relat√≥rio</h3>
                    <button class="close-modal" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 15px; color: #555;">Confirme os filtros selecionados:</p>
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="margin-bottom: 10px;">
                            <strong>üìÖ Per√≠odo:</strong> ${formatDate(filters.dataInicio)} at√© ${formatDate(filters.dataFim)}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>üìä Status:</strong> ${filters.status}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>üìä Tipo de Setor:</strong> ${filters.tipoSetor === 'qualidade' ? 'N√£o Conformidade' : 'Abertura'}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>üè¢ Setor:</strong> ${filters.setor}
                        </div>
                        <div>
                            <strong>üìã Tipo RNC:</strong> ${filters.tipo}
                        </div>
                    </div>
                    <p style="color: #666; font-size: 13px;">
                        ‚ö†Ô∏è Esta opera√ß√£o pode levar alguns segundos.
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" id="confirmGenerateReport">
                        üìä Gerar Relat√≥rio
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(confirmModal);

        // Retornar Promise para aguardar confirma√ß√£o
        const userConfirmed = await new Promise((resolve) => {
            const confirmBtn = document.getElementById('confirmGenerateReport');
            confirmBtn.onclick = () => {
                confirmModal.remove();
                resolve(true);
            };
            // Se fechar o modal, resolve como false
            confirmModal.querySelector('.close-modal').onclick = () => {
                confirmModal.remove();
                resolve(false);
            };
            confirmModal.querySelector('.btn-secondary').onclick = () => {
                confirmModal.remove();
                resolve(false);
            };
        });

        if (!userConfirmed) {
            debugLog('info', 'Usuario cancelou geracao de relatorio');
            return;
        }
        
        showLoading('Gerando relat√≥rio...');
        
        const result = await apiCall('generateReport', [filters]);
        
        if (!result) {
            throw new Error('Nenhum dado retornado');
        }
        
        reportData = result;
        renderReport(result);

        document.getElementById('exportPdf').disabled = false;
        hideLoading();
        
        showSuccess(`Relat√≥rio gerado: ${result.rncs ? result.rncs.length : 0} RNC(s) encontrada(s)`);
        
        debugLog('success', '‚úÖ Relat√≥rio gerado', { 
            totalRncs: result.rncs ? result.rncs.length : 0 
        });
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao gerar relat√≥rio', { error: error.message });
        showError('Erro ao gerar relat√≥rio: ' + error.message);
        hideLoading();
    }
}
        

// Fun√ß√£o auxiliar para editar RNC pelo relat√≥rio
function editRncFromReport(rncNumber) {
    if (!rncNumber) return;
    
    // Mudar para aba Editar
    showTab('tab-editar');
    
    // Preencher n√∫mero e buscar
    document.getElementById('searchRncNumber').value = rncNumber;
    loadRncForEdit();
}


        function renderReport(data) {
    const container = document.getElementById('report-content');
    const rncs = data.rncs || [];
    const stats = data.stats || {};
    
    const reportHtml = `
        <!-- ========================================== -->
        <!-- CABE√áALHO DO RELAT√ìRIO -->
        <!-- ========================================== -->
        <div class="report-summary" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h3 class="chart-title">üìã Informa√ß√µes do Relat√≥rio</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                <div>
                    <p><strong>üìä Total de RNC(s):</strong> ${rncs.length}</p>
                    <p><strong>üìÖ Per√≠odo:</strong> ${formatDate(data.filters.dataInicio)} at√© ${formatDate(data.filters.dataFim)}</p>
                    <p><strong>‚è∞ Gerado em:</strong> ${new Date(data.dataGeracao).toLocaleString('pt-BR')}</p>
                </div>
                <div>
                    <p><strong>üè¢ Setor:</strong> ${data.filters.setor}</p>
                    <p><strong>üìã Tipo:</strong> ${data.filters.tipo}</p>
                    <p><strong>üéØ Status:</strong> ${data.filters.status}</p>
                </div>
            </div>
        </div>
        
        ${rncs.length > 0 ? `
        
        <!-- ========================================== -->
        <!-- SE√á√ÉO 1: KPIs ESTRAT√âGICOS (CARDS) -->
        <!-- ========================================== -->
        <h3 class="chart-title" style="margin-top: 30px; margin-bottom: 20px;">üìä KPIs Estrat√©gicos</h3>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
            
            <!-- KPI: Impacto Cliente -->
            <div class="dashboard-card" style="border-top-color: ${stats.impactoClientePercentual > 30 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">üë•</div>
                <div class="dashboard-number">${stats.impactoClientePercentual || 0}%</div>
                <div class="dashboard-label">Impacto Cliente</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.impactoClienteTotal || 0} RNCs
                </div>
            </div>
            
            <!-- KPI: Detec√ß√£o Interna -->
            <div class="dashboard-card" style="border-top-color: ${stats.deteccaoInternaPercentual >= 70 ? '#4CAF50' : '#FFC107'};">
                <div class="dashboard-icon">üîç</div>
                <div class="dashboard-number">${stats.deteccaoInternaPercentual || 0}%</div>
                <div class="dashboard-label">Detec√ß√£o Interna</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.deteccaoInternaTotal || 0} RNCs
                </div>
            </div>
            
            <!-- KPI: N√£o Procede -->
            <div class="dashboard-card" style="border-top-color: ${stats.naoProcedeTaxa > 10 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">‚ùå</div>
                <div class="dashboard-number">${stats.naoProcedeTaxa || 0}%</div>
                <div class="dashboard-label">N√£o Procede</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.naoProcede || 0} RNCs
                </div>
            </div>
            
            <!-- KPI: ISP -->
            <div class="dashboard-card" style="border-top-color: ${stats.indiceSeveridadePonderado > 50 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">üìà</div>
                <div class="dashboard-number">${stats.indiceSeveridadePonderado || 0}</div>
                <div class="dashboard-label">√çndice Severidade</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ISP Ponderado
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
            
            <!-- KPI: Custo Total -->
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">üí∞</div>
                <div class="dashboard-number">R$ ${(stats.custoTotal || 0).toFixed(2)}</div>
                <div class="dashboard-label">Custo Total</div>
            </div>
            
            <!-- KPI: Tempo M√©dio -->
            <div class="dashboard-card" style="border-top-color: #009688;">
                <div class="dashboard-icon">‚è±Ô∏è</div>
                <div class="dashboard-number">${stats.tempoMedioResolucao || 0} dias</div>
                <div class="dashboard-label">Tempo M√©dio</div>
            </div>
            
            <!-- KPI: Cumprimento Prazo -->
            <div class="dashboard-card" style="border-top-color: ${stats.taxaCumprimentoPrazo >= 80 ? '#4CAF50' : '#F44336'};">
                <div class="dashboard-icon">‚è∞</div>
                <div class="dashboard-number">${stats.taxaCumprimentoPrazo || 0}%</div>
                <div class="dashboard-label">Prazo Cumprido</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${stats.finalizadasNoPrazo || 0} de ${stats.finalizadasTotal || 0}
                </div>
            </div>
            
            <!-- KPI: Atrasadas -->
            <div class="dashboard-card" style="border-top-color: ${stats.rncsComAtraso > 0 ? '#F44336' : '#4CAF50'};">
                <div class="dashboard-icon">‚ö†Ô∏è</div>
                <div class="dashboard-number">${stats.rncsComAtraso || 0}</div>
                <div class="dashboard-label">RNCs Atrasadas</div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- SE√á√ÉO 2: GR√ÅFICOS DE DISTRIBUI√á√ÉO -->
        <!-- ========================================== -->
        <h3 class="chart-title" style="margin-top: 30px; margin-bottom: 20px;">üìä Distribui√ß√£o das RNCs</h3>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            
            <div class="chart-container">
                <h3 class="chart-title">üìã Por Tipo</h3>
                <div id="reportChartTipo"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">‚ö†Ô∏è Por Risco</h3>
                <div id="reportChartRisco"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üè¢ Por Setor</h3>
                <div id="reportChartSetor"></div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- SE√á√ÉO 3: TABELA DE CUSTO M√âDIO -->
        <!-- ========================================== -->
        ${Object.keys(stats.custoMedioPorTipo || {}).length > 0 ? `
        <h3 class="chart-title" style="margin-top: 30px; margin-bottom: 20px;">üí∞ An√°lise de Custos por Tipo</h3>
        
        <div class="chart-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #009688; color: white;">
                        <th style="padding: 12px; text-align: left;">Tipo de RNC</th>
                        <th style="padding: 12px; text-align: center;">Quantidade</th>
                        <th style="padding: 12px; text-align: right;">Custo Total</th>
                        <th style="padding: 12px; text-align: right;">Custo M√©dio</th>
                        <th style="padding: 12px; text-align: center;">% do Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(stats.custoMedioPorTipo)
                        .sort((a, b) => stats.custoMedioPorTipo[b].soma - stats.custoMedioPorTipo[a].soma)
                        .map(tipo => {
                            const dados = stats.custoMedioPorTipo[tipo];
                            const percentual = ((dados.soma / stats.custoTotal) * 100).toFixed(1);
                            return `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px;">${tipo}</td>
                                    <td style="padding: 10px; text-align: center;">${dados.count}</td>
                                    <td style="padding: 10px; text-align: right;">R$ ${dados.soma.toFixed(2)}</td>
                                    <td style="padding: 10px; text-align: right; font-weight: bold; color: #009688;">R$ ${dados.media.toFixed(2)}</td>
                                    <td style="padding: 10px; text-align: center;">
                                        <div style="background: #e0f2f1; padding: 4px 8px; border-radius: 4px; display: inline-block;">
                                            ${percentual}%
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    <tr style="background: #f5f5f5; font-weight: bold;">
                        <td style="padding: 12px;">TOTAL</td>
                        <td style="padding: 12px; text-align: center;">${stats.total}</td>
                        <td style="padding: 12px; text-align: right;">R$ ${stats.custoTotal.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: right;">-</td>
                        <td style="padding: 12px; text-align: center;">100%</td>
                    </tr>
                </tbody>
            </table>
        </div>
        ` : ''}
        
        <!-- ========================================== -->
        <!-- SE√á√ÉO 4: LISTA DETALHADA DE RNCs -->
        <!-- ========================================== -->
        <h3 class="chart-title" style="margin-top: 30px; margin-bottom: 20px;">üìã Lista Detalhada de RNCs</h3>
        
        <div class="chart-container">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: #009688; color: white;">
                        <th style="padding: 10px; text-align: left;">N¬∫ RNC</th>
                        <th style="padding: 10px; text-align: left;">Cliente</th>
                        <th style="padding: 10px; text-align: center;">Status</th>
                        <th style="padding: 10px; text-align: center;">Tipo</th>
                        <th style="padding: 10px; text-align: center;">Risco</th>
                        <th style="padding: 10px; text-align: right;">Custo</th>
                        <th style="padding: 10px; text-align: center;">Respons√°vel</th>
                    </tr>
                </thead>
                <tbody>
                    ${rncs.map(rnc => `
                        <tr style="border-bottom: 1px solid #eee; cursor: pointer;" onclick="editRncFromReport('${rnc['N¬∫ RNC']}')">
                            <td style="padding: 8px; font-weight: bold;">${rnc['N¬∫ RNC']}</td>
                            <td style="padding: 8px;">${rnc['Nome do Cliente'] || '-'}</td>
                            <td style="padding: 8px; text-align: center;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; 
                                    background: ${rnc['Status Geral'] === 'Finalizada' ? '#4CAF50' : 
                                               rnc['Status Geral'] === 'Abertura RNC' ? '#2196F3' : '#FFC107'}; 
                                    color: white;">
                                    ${rnc['Status Geral'] || 'N/A'}
                                </span>
                            </td>
                            <td style="padding: 8px; text-align: center; font-size: 11px;">${rnc['Tipo RNC'] || '-'}</td>
                            <td style="padding: 8px; text-align: center;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px;
                                    background: ${(rnc['Risco'] || '').toLowerCase().includes('cr√≠tico') ? '#F44336' :
                                               (rnc['Risco'] || '').toLowerCase().includes('alto') ? '#FF9800' :
                                               (rnc['Risco'] || '').toLowerCase().includes('m√©dio') ? '#FFC107' : '#4CAF50'};
                                    color: white;">
                                    ${rnc['Risco'] || 'Baixo'}
                                </span>
                            </td>
                            <td style="padding: 8px; text-align: right;">R$ ${(parseFloat(rnc['Valor']) || 0).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: center; font-size: 11px;">${rnc['Respons√°vel pela abertura da RNC'] || '-'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        ` : `
            <div class="chart-container" style="text-align: center; padding: 40px;">
                <h3>üì≠ Nenhuma RNC encontrada</h3>
                <p style="color: #666; margin-top: 10px;">
                    Tente ajustar os filtros para visualizar resultados diferentes.
                </p>
            </div>
        `}
    `;
    
    container.innerHTML = reportHtml;
    
    // Renderizar gr√°ficos se houver dados
    if (rncs.length > 0) {
        renderPieChart('reportChartTipo', stats.porTipo || {});
        renderPieChart('reportChartRisco', stats.porRisco || {});
        renderPieChart('reportChartSetor', stats.porSetor || {});
    }
    
    debugLog('success', '‚úÖ Relat√≥rio renderizado com 8 KPIs + gr√°ficos + tabelas');
}
        
/**
 * ============================================
 * DEPLOY 39: RELATORIO PDF MEGA COMPLETO - BUILD 20251204
 * Ultra-Professional Report - Board Ready
 * ============================================
 */
function exportToPdf() {
    if (!reportData || !reportData.rncs || reportData.rncs.length === 0) {
        showError('Nenhum dado para exportar');
        return;
    }

    try {
        showLoading('Gerando PDF mega-completo...');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const stats = reportData.stats;
        const rncs = reportData.rncs;

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let yPos = 20;

        // Helper: Add Section Header
        function addSectionHeader(title, yPosition) {
            if (yPosition > pageHeight - 40) {
                doc.addPage();
                yPosition = 20;
            }
            doc.setFillColor(0, 150, 136);
            doc.rect(margin, yPosition, pageWidth - 2 * margin, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(title, margin + 3, yPosition + 7);
            return yPosition + 15;
        }

        // Helper: Draw Horizontal Bar Chart
        function drawBarChart(data, startY, maxWidth = 120) {
            const barHeight = 8;
            const barSpacing = 12;
            let y = startY;

            const maxValue = Math.max(...data.map(d => d.value));
            const colors = [
                [244, 67, 54],   // Red
                [255, 152, 0],   // Orange
                [255, 193, 7],   // Yellow
                [76, 175, 80],   // Green
                [33, 150, 243]   // Blue
            ];

            data.forEach((item, index) => {
                if (y > pageHeight - 20) {
                    doc.addPage();
                    y = 20;
                }

                const barWidth = (item.value / maxValue) * maxWidth;
                const color = colors[index % 5];

                // Draw bar
                doc.setFillColor(color[0], color[1], color[2]);
                doc.rect(margin + 50, y, barWidth, barHeight, 'F');

                // Label
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                const label = item.label.substring(0, 18);
                doc.text(label, margin, y + 5.5);

                // Value
                doc.setFont('helvetica', 'bold');
                doc.text(String(item.value), margin + 52 + barWidth, y + 5.5);

                y += barSpacing;
            });

            return y + 5;
        }

        // Helper: Draw Pie Chart
        function drawPieChart(data, centerX, centerY, radius) {
            const total = data.reduce((sum, d) => sum + d.value, 0);
            let startAngle = 0;

            const colors = [
                [76, 175, 80],   // Green
                [255, 152, 0],   // Orange
                [244, 67, 54],   // Red
                [33, 150, 243],  // Blue
                [156, 39, 176],  // Purple
                [255, 193, 7],   // Yellow
                [0, 150, 136],   // Teal
                [121, 85, 72]    // Brown
            ];

            data.forEach((item, index) => {
                const sliceAngle = (item.value / total) * 2 * Math.PI;
                const color = colors[index % colors.length];

                // Draw slice
                doc.setFillColor(color[0], color[1], color[2]);
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(0.5);

                // Calculate points
                const x1 = centerX + radius * Math.cos(startAngle);
                const y1 = centerY + radius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(startAngle + sliceAngle);
                const y2 = centerY + radius * Math.sin(startAngle + sliceAngle);

                // Draw filled triangle (approximation of pie slice)
                doc.triangle(centerX, centerY, x1, y1, x2, y2, 'FD');

                startAngle += sliceAngle;
            });

            // Draw legend
            let legendY = centerY - radius;
            data.forEach((item, index) => {
                const color = colors[index % colors.length];
                const pct = ((item.value / total) * 100).toFixed(1);

                // Color box
                doc.setFillColor(color[0], color[1], color[2]);
                doc.rect(centerX + radius + 10, legendY - 2, 4, 4, 'F');

                // Text
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.text(`${item.label}: ${item.value} (${pct}%)`, centerX + radius + 16, legendY + 1);

                legendY += 6;
            });
        }

        // ============================================
        // PAGE 1: CAPA PROFISSIONAL
        // ============================================
        doc.setFillColor(0, 150, 136);
        doc.rect(0, 0, pageWidth, 90, 'F');

        // LOGO NEOFORMULA (estilizado)
        doc.setFillColor(255, 255, 255);
        doc.roundedRect(pageWidth / 2 - 30, 20, 60, 18, 3, 3, 'F');
        doc.setTextColor(0, 150, 136);
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text('NEOFORMULA', pageWidth / 2, 32, { align: 'center' });

        // Titulo principal
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(36);
        doc.text('RELATORIO', pageWidth / 2, 55, { align: 'center' });
        doc.setFontSize(32);
        doc.text('GERENCIAL', pageWidth / 2, 70, { align: 'center' });

        doc.setFontSize(14);
        doc.setFont('helvetica', 'normal');
        doc.text('Sistema de Gestao de Nao Conformidades', pageWidth / 2, 82, { align: 'center' });

        // Informacoes do periodo
        yPos = 105;
        doc.setTextColor(51, 51, 51);
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');

        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const periodo = dataInicio && dataFim ?
            `Periodo: ${dataInicio} ate ${dataFim}` :
            'Periodo: Todos os registros';

        doc.text(periodo, pageWidth / 2, yPos, { align: 'center' });
        yPos += 8;

        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        const hoje = new Date();
        const dataGeracao = `${hoje.getDate().toString().padStart(2, '0')}/${(hoje.getMonth() + 1).toString().padStart(2, '0')}/${hoje.getFullYear()}`;
        const horaGeracao = `${hoje.getHours().toString().padStart(2, '0')}:${hoje.getMinutes().toString().padStart(2, '0')}`;
        doc.text(`Data de Geracao: ${dataGeracao} as ${horaGeracao}`, pageWidth / 2, yPos, { align: 'center' });

        // Box de destaque
        yPos += 20;
        doc.setFillColor(245, 245, 245);
        doc.roundedRect(margin + 10, yPos, pageWidth - 2 * margin - 20, 60, 5, 5, 'F');

        yPos += 12;
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 150, 136);
        doc.text('INDICADORES PRINCIPAIS', pageWidth / 2, yPos, { align: 'center' });

        yPos += 10;
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(51, 51, 51);

        const indicadores = [
            `Total de RNCs: ${stats.total || 0}`,
            `Custo Total: R$ ${(stats.custoTotal || 0).toFixed(2)}`,
            `Taxa de Finalizacao: ${Math.round((stats.finalizadas / stats.total) * 100) || 0}%`,
            `Tempo Medio de Resolucao: ${stats.tempoMedioResolucao || 0} dias`
        ];

        indicadores.forEach(ind => {
            doc.text(ind, pageWidth / 2, yPos, { align: 'center' });
            yPos += 7;
        });

        // ============================================
        // PAGE 2: DASHBOARD EXECUTIVO
        // ============================================
        doc.addPage();
        yPos = addSectionHeader('DASHBOARD EXECUTIVO', 20);

        // KPIs em grid 3x3
        const kpis = [
            { label: 'Total de RNCs', value: stats.total || 0, unit: '' },
            { label: 'RNCs Finalizadas', value: stats.finalizadas || 0, unit: '' },
            { label: 'RNCs Abertas', value: stats.abertas || 0, unit: '' },
            { label: 'Custo Total', value: (stats.custoTotal || 0).toFixed(2), unit: 'R$' },
            { label: 'Custo Medio', value: (stats.custoTotal / stats.total || 0).toFixed(2), unit: 'R$' },
            { label: 'Tempo Medio', value: stats.tempoMedioResolucao || 0, unit: 'dias' },
            { label: 'Taxa Cumprimento', value: stats.taxaCumprimentoPrazo || 0, unit: '%' },
            { label: 'RNCs Vencidas', value: stats.rncsVencidas || 0, unit: '' },
            { label: 'Indice Severidade', value: stats.indiceSeveridadePonderado || 0, unit: 'pts' }
        ];

        const kpiWidth = 55;
        const kpiHeight = 25;
        const kpiSpacing = 5;
        let kpiX = margin;
        let kpiY = yPos;
        let kpiCount = 0;

        kpis.forEach((kpi, index) => {
            // New row every 3 KPIs
            if (kpiCount === 3) {
                kpiX = margin;
                kpiY += kpiHeight + kpiSpacing;
                kpiCount = 0;
            }

            // Box
            doc.setFillColor(245, 245, 245);
            doc.roundedRect(kpiX, kpiY, kpiWidth, kpiHeight, 2, 2, 'F');

            // Label
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(kpi.label, kpiX + kpiWidth / 2, kpiY + 8, { align: 'center' });

            // Value
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 150, 136);
            const valueText = kpi.unit === 'R$' ? `${kpi.unit} ${kpi.value}` : `${kpi.value}${kpi.unit}`;
            doc.text(valueText, kpiX + kpiWidth / 2, kpiY + 19, { align: 'center' });

            kpiX += kpiWidth + kpiSpacing;
            kpiCount++;
        });

        yPos = kpiY + kpiHeight + 15;

        // ============================================
        // PAGE 3: DISTRIBUICAO POR STATUS
        // ============================================
        yPos = addSectionHeader('DISTRIBUICAO POR STATUS', yPos);

        const statusData = Object.entries(stats.porStatus || {}).map(([status, count]) => ({
            label: status,
            value: count
        }));

        if (statusData.length > 0) {
            // Tabela
            doc.autoTable({
                startY: yPos,
                head: [['Status', 'Quantidade', 'Percentual']],
                body: statusData.map(item => [
                    item.label,
                    item.value,
                    `${((item.value / stats.total) * 100).toFixed(1)}%`
                ]),
                theme: 'grid',
                headStyles: { fillColor: [0, 150, 136], textColor: [255, 255, 255], fontSize: 10, fontStyle: 'bold' },
                bodyStyles: { fontSize: 9 },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Grafico de pizza
            if (yPos > pageHeight - 70) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Grafico - Distribuicao por Status:', margin, yPos);
            yPos += 10;

            drawPieChart(statusData.slice(0, 6), pageWidth / 3, yPos + 25, 25);
            yPos += 60;
        }

        // ============================================
        // PAGE 4: DISTRIBUICAO POR RISCO
        // ============================================
        if (yPos > pageHeight - 80) {
            doc.addPage();
            yPos = 20;
        }

        yPos = addSectionHeader('DISTRIBUICAO POR RISCO', yPos);

        const riscoData = Object.entries(stats.porRisco || {}).map(([risco, count]) => ({
            label: risco,
            value: count
        }));

        if (riscoData.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Nivel de Risco', 'Quantidade', 'Percentual']],
                body: riscoData.map(item => [
                    item.label,
                    item.value,
                    `${((item.value / stats.total) * 100).toFixed(1)}%`
                ]),
                theme: 'grid',
                headStyles: { fillColor: [244, 67, 54], textColor: [255, 255, 255], fontSize: 10, fontStyle: 'bold' },
                bodyStyles: { fontSize: 9 },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Grafico de pizza
            if (yPos > pageHeight - 70) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Grafico - Distribuicao por Risco:', margin, yPos);
            yPos += 10;

            drawPieChart(riscoData.slice(0, 5), pageWidth / 3, yPos + 25, 25);
            yPos += 60;
        }

        // ============================================
        // PAGE 5: DISTRIBUICAO POR TIPO
        // ============================================
        doc.addPage();
        yPos = addSectionHeader('DISTRIBUICAO POR TIPO DE RNC', 20);

        const tipoData = Object.entries(stats.porTipo || {})
            .sort((a, b) => b[1] - a[1])
            .map(([tipo, count]) => ({
                label: tipo,
                value: count
            }));

        if (tipoData.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Tipo de RNC', 'Quantidade', 'Percentual']],
                body: tipoData.map(item => [
                    item.label,
                    item.value,
                    `${((item.value / stats.total) * 100).toFixed(1)}%`
                ]),
                theme: 'striped',
                headStyles: { fillColor: [0, 150, 136], textColor: [255, 255, 255], fontSize: 10, fontStyle: 'bold' },
                bodyStyles: { fontSize: 9 },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Grafico de barras
            if (yPos > pageHeight - 80) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Grafico - Top 10 Tipos:', margin, yPos);
            yPos += 8;

            yPos = drawBarChart(tipoData.slice(0, 10), yPos, 110);
        }

        // ============================================
        // PAGE 6: DISTRIBUICAO POR SETOR
        // ============================================
        doc.addPage();
        yPos = addSectionHeader('DISTRIBUICAO POR SETOR', 20);

        const setorData = Object.entries(stats.porSetor || {})
            .sort((a, b) => b[1] - a[1])
            .map(([setor, count]) => ({
                label: setor,
                value: count
            }));

        if (setorData.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Setor', 'Quantidade', 'Percentual']],
                body: setorData.slice(0, 15).map(item => [
                    item.label,
                    item.value,
                    `${((item.value / stats.total) * 100).toFixed(1)}%`
                ]),
                theme: 'grid',
                headStyles: { fillColor: [0, 150, 136], textColor: [255, 255, 255], fontSize: 10, fontStyle: 'bold' },
                bodyStyles: { fontSize: 9 },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Grafico de barras
            if (yPos > pageHeight - 80) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Grafico - Top 10 Setores:', margin, yPos);
            yPos += 8;

            yPos = drawBarChart(setorData.slice(0, 10), yPos, 110);
        }

        // ============================================
        // PAGE 7: ANALISE DE CUSTOS
        // ============================================
        doc.addPage();
        yPos = addSectionHeader('ANALISE DETALHADA DE CUSTOS', 20);

        if (Object.keys(stats.custoMedioPorTipo || {}).length > 0) {
            const custoData = Object.entries(stats.custoMedioPorTipo)
                .sort((a, b) => b[1].soma - a[1].soma);

            doc.autoTable({
                startY: yPos,
                head: [['Tipo', 'Qtd', 'Custo Total', 'Custo Medio', '% Total']],
                body: custoData.map(([tipo, dados]) => [
                    tipo,
                    dados.count,
                    `R$ ${dados.soma.toFixed(2)}`,
                    `R$ ${dados.media.toFixed(2)}`,
                    `${((dados.soma / stats.custoTotal) * 100).toFixed(1)}%`
                ]),
                theme: 'striped',
                headStyles: { fillColor: [0, 150, 136], textColor: [255, 255, 255], fontSize: 9, fontStyle: 'bold' },
                bodyStyles: { fontSize: 8 },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Grafico de custos
            if (yPos > pageHeight - 80) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Grafico - Top 8 Maiores Custos:', margin, yPos);
            yPos += 8;

            const custoChartData = custoData.slice(0, 8).map(([tipo, dados]) => ({
                label: tipo,
                value: dados.soma
            }));

            yPos = drawBarChart(custoChartData, yPos, 110);
        }

        // ============================================
        // PAGE 8: TOP 5 SETORES COM MAIS RNCs
        // ============================================
        doc.addPage();
        yPos = addSectionHeader('TOP 5 SETORES COM MAIS RNCs', 20);

        if (stats.top5Setores && stats.top5Setores.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Posicao', 'Setor', 'Quantidade', 'Percentual']],
                body: stats.top5Setores.map((setor, index) => [
                    `${index + 1}o`,
                    setor.nome,
                    setor.total,
                    `${Math.round((setor.total / stats.total) * 100)}%`
                ]),
                theme: 'grid',
                headStyles: { fillColor: [244, 67, 54], textColor: [255, 255, 255], fontSize: 10, fontStyle: 'bold' },
                bodyStyles: { fontSize: 9 },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Grafico
            if (yPos > pageHeight - 80) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Grafico - Top 5 Setores:', margin, yPos);
            yPos += 8;

            const top5Data = stats.top5Setores.map(setor => ({
                label: setor.nome,
                value: setor.total
            }));

            yPos = drawBarChart(top5Data, yPos, 120);
        }

        // ============================================
        // PAGE 9: TOP 5 TIPOS DE FALHA
        // ============================================
        if (yPos > pageHeight - 80) {
            doc.addPage();
            yPos = 20;
        }

        yPos = addSectionHeader('TOP 5 TIPOS DE FALHA', yPos);

        if (stats.top5TiposFalha && stats.top5TiposFalha.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Posicao', 'Tipo de Falha', 'Quantidade', 'Percentual']],
                body: stats.top5TiposFalha.map((tipo, index) => [
                    `${index + 1}o`,
                    tipo.nome,
                    tipo.total,
                    `${Math.round((tipo.total / stats.total) * 100)}%`
                ]),
                theme: 'striped',
                headStyles: { fillColor: [255, 152, 0], textColor: [255, 255, 255], fontSize: 10, fontStyle: 'bold' },
                bodyStyles: { fontSize: 9 },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 10;
        }

        // ============================================
        // PAGE 10: ANALISE DE PRAZOS
        // ============================================
        doc.addPage();
        yPos = addSectionHeader('ANALISE DE PRAZOS E VENCIMENTOS', 20);

        doc.autoTable({
            startY: yPos,
            head: [['Metrica', 'Valor']],
            body: [
                ['RNCs no Prazo', stats.rncsPrazo || 0],
                ['RNCs Atrasadas', stats.rncsAtrasadas || 0],
                ['RNCs Vencidas', stats.rncsVencidas || 0],
                ['Taxa de Cumprimento', `${stats.taxaCumprimentoPrazo || 0}%`],
                ['Tempo Medio de Resolucao', `${stats.tempoMedioResolucao || 0} dias`],
                ['Maior Tempo de Resolucao', `${stats.maiorTempoResolucao || 0} dias`],
                ['Menor Tempo de Resolucao', `${stats.menorTempoResolucao || 0} dias`]
            ],
            theme: 'striped',
            headStyles: { fillColor: [0, 150, 136], textColor: [255, 255, 255], fontSize: 10, fontStyle: 'bold' },
            bodyStyles: { fontSize: 9 },
            margin: { left: margin, right: margin }
        });

        yPos = doc.lastAutoTable.finalY + 10;

        // ============================================
        // PAGE 11: ACOES RECOMENDADAS
        // ============================================
        if (yPos > pageHeight - 80) {
            doc.addPage();
            yPos = 20;
        }

        yPos = addSectionHeader('ACOES RECOMENDADAS PARA GESTAO', yPos);

        if (stats.acoesRecomendadas && stats.acoesRecomendadas.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Prioridade', 'Problema Identificado', 'Acao Recomendada']],
                body: stats.acoesRecomendadas.map(acao => [
                    acao.prioridade,
                    acao.titulo,
                    acao.acao
                ]),
                theme: 'grid',
                headStyles: { fillColor: [0, 150, 136], textColor: [255, 255, 255], fontSize: 10, fontStyle: 'bold' },
                bodyStyles: { fontSize: 9 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 65 },
                    2: { cellWidth: 90 }
                },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 10;
        }

        // ============================================
        // PAGE 12: RESUMO DE IMPACTO
        // ============================================
        doc.addPage();
        yPos = addSectionHeader('RESUMO DE IMPACTO E TENDENCIAS', 20);

        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 150, 136);
        doc.text('IMPACTO FINANCEIRO', margin, yPos);
        yPos += 7;

        doc.setFont('helvetica', 'normal');
        doc.setTextColor(51, 51, 51);
        doc.setFontSize(9);
        doc.text(`Custo Total de Nao Conformidades: R$ ${(stats.custoTotal || 0).toFixed(2)}`, margin + 5, yPos);
        yPos += 5;
        doc.text(`Custo Medio por RNC: R$ ${((stats.custoTotal / stats.total) || 0).toFixed(2)}`, margin + 5, yPos);
        yPos += 5;
        doc.text(`Maior Custo Individual: R$ ${(stats.maiorCusto || 0).toFixed(2)}`, margin + 5, yPos);
        yPos += 10;

        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 150, 136);
        doc.text('IMPACTO NO CLIENTE', margin, yPos);
        yPos += 7;

        doc.setFont('helvetica', 'normal');
        doc.setTextColor(51, 51, 51);
        doc.setFontSize(9);
        doc.text(`RNCs com Impacto ao Cliente: ${stats.impactoClientePercentual || 0}%`, margin + 5, yPos);
        yPos += 5;
        doc.text(`Deteccao Interna: ${stats.deteccaoInternaPercentual || 0}%`, margin + 5, yPos);
        yPos += 5;
        doc.text(`Taxa de Nao Procede: ${stats.naoProcedeTaxa || 0}%`, margin + 5, yPos);
        yPos += 10;

        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 150, 136);
        doc.text('IMPACTO NA QUALIDADE', margin, yPos);
        yPos += 7;

        doc.setFont('helvetica', 'normal');
        doc.setTextColor(51, 51, 51);
        doc.setFontSize(9);
        doc.text(`Indice de Severidade Ponderado: ${stats.indiceSeveridadePonderado || 0} pontos`, margin + 5, yPos);
        yPos += 5;
        doc.text(`RNCs Criticas: ${stats.criticas || 0}`, margin + 5, yPos);
        yPos += 5;
        doc.text(`Taxa de Reincidencia: ${stats.taxaReincidencia || 0}%`, margin + 5, yPos);
        yPos += 10;

        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 150, 136);
        doc.text('TENDENCIAS IDENTIFICADAS', margin, yPos);
        yPos += 7;

        doc.setFont('helvetica', 'normal');
        doc.setTextColor(51, 51, 51);
        doc.setFontSize(9);

        const tendencias = [
            `Setores com maior incidencia precisam de atencao especial`,
            `Tipos de falha recorrentes devem ser investigados`,
            `${stats.rncsVencidas > 0 ? 'Atencao: Existem RNCs vencidas!' : 'Todas as RNCs estao dentro do prazo'}`,
            `Taxa de cumprimento de prazo: ${stats.taxaCumprimentoPrazo >= 80 ? 'Satisfatoria' : 'Requer melhoria'}`,
            `Custo medio por RNC: ${(stats.custoTotal / stats.total) > 100 ? 'Alto' : 'Controlado'}`
        ];

        tendencias.forEach(tendencia => {
            doc.text(`- ${tendencia}`, margin + 5, yPos);
            yPos += 5;
        });

        // ============================================
        // RODAPE EM TODAS AS PAGINAS
        // ============================================
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);

            // Linha superior
            doc.setDrawColor(0, 150, 136);
            doc.setLineWidth(0.5);
            doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);

            // Texto do rodape
            doc.setFontSize(8);
            doc.setTextColor(120, 120, 120);
            doc.setFont('helvetica', 'normal');
            doc.text(
                'Neoformula - Sistema de Gestao de Nao Conformidades',
                pageWidth / 2,
                pageHeight - 10,
                { align: 'center' }
            );

            // Numero da pagina
            doc.setFont('helvetica', 'bold');
            doc.text(
                `Pagina ${i} de ${totalPages}`,
                pageWidth - margin,
                pageHeight - 10,
                { align: 'right' }
            );
        }

        // ============================================
        // SALVAR PDF
        // ============================================
        const filename = `relatorio_mega_completo_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);

        hideLoading();
        showSuccess(`PDF mega-completo exportado! (${totalPages} paginas)`);
        debugLog('success', `PDF mega-completo exportado - ${totalPages} paginas - DEPLOY 39`);

    } catch (error) {
        hideLoading();
        debugLog('error', 'Erro ao exportar PDF DEPLOY 39', { error: error.message });
        showError('Erro ao exportar PDF: ' + error.message);
    }
}

function clearFilters() {
            document.getElementById('dataInicio').value = '';
            document.getElementById('dataFim').value = '';
            document.getElementById('setorFiltro').value = 'Todos';
            document.getElementById('tipoFiltro').value = 'Todos';
            document.getElementById('statusFiltro').value = 'Todos';

            document.getElementById('report-content').innerHTML = '';
            document.getElementById('exportPdf').disabled = true;
            reportData = null;

            debugLog('info', 'üßπ Filtros limpos DEPLOY 30');
        }
        
        // === CONFIGURA√á√ïES RESTAURADAS COM ABAS (DEPLOY 30) ===
        async function loadConfigurations() {
    try {
        debugLog('info', '‚öôÔ∏è Carregando configura√ß√µes Deploy 32');
        
        // Carregar configura√ß√µes do sistema
        if (appContext && appContext.systemConfig) {
            document.getElementById('pastaGID').value = appContext.systemConfig.pastaGID || '';
            document.getElementById('renomearArquivos').value = appContext.systemConfig.renomearArquivos ? 'Sim' : 'N√£o';
        }
        
        // Carregar listas, se√ß√µes, campos e ‚ú® USU√ÅRIOS
        await loadLists();
        await loadSections();
        await loadFields();
        await loadUsers(); // ‚ú® NOVO
        
        debugLog('success', '‚úÖ Configura√ß√µes carregadas Deploy 32');
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar configura√ß√µes', { error: error.message });
        showError('Erro ao carregar configura√ß√µes: ' + error.message);
    }
}
        
        async function saveSystemConfig() {
            try {
                debugLog('info', 'üíæ Salvando configura√ß√µes do sistema DEPLOY 30');
                
                const pastaGID = document.getElementById('pastaGID').value;
                const renomearArquivos = document.getElementById('renomearArquivos').value;
                
                showLoading('Salvando configura√ß√µes...');
                
                await apiCall('setSystemConfig', ['PastaGID', pastaGID, 'ID da pasta do Google Drive para anexos']);
                await apiCall('setSystemConfig', ['RenomearArquivos', renomearArquivos, 'Renomear arquivos anexados']);
                
                showSuccess('Configura√ß√µes salvas com sucesso!');
                hideLoading();
                
                debugLog('success', '‚úÖ Configura√ß√µes do sistema salvas DEPLOY 30');
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao salvar configura√ß√µes DEPLOY 30', { error: error.message });
                showError('Erro ao salvar configura√ß√µes: ' + error.message);
                hideLoading();
            }
        }
        
        async function loadLists() {
            try {
                const lists = await apiCall('getLists');
                const container = document.getElementById('lists-container');
                
                let listsHtml = '';
                Object.keys(lists).forEach(listName => {
                    const items = lists[listName] || [];
                    listsHtml += `
                        <div class="config-item">
                            <div class="config-item-header">
                                <div class="config-item-title">üìã ${listName}</div>
                                <div class="config-item-actions">
                                    <button class="btn-edit" onclick="editList('${listName}')">‚úèÔ∏è Editar</button>
                                    <button class="btn-delete" onclick="deleteListConfirm('${listName}')">üóëÔ∏è Deletar</button>
                                </div>
                            </div>
                            <div class="config-item-meta">${items.length} itens</div>
                        </div>
                    `;
                });
                
                container.innerHTML = listsHtml;
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao carregar listas DEPLOY 30', { error: error.message });
            }
        }
        
        async function loadSections() {
            try {
                const sections = await apiCall('getSections');
                const container = document.getElementById('sections-container');
                
                let sectionsHtml = '';
                sections.forEach(section => {
                    sectionsHtml += `
                        <div class="config-item">
                            <div class="config-item-header">
                                <div class="config-item-title">üìÑ ${section.nome}</div>
                                <div class="config-item-actions">
                                    <button class="btn-edit" onclick="editSection('${section.nome}')">‚úèÔ∏è Editar</button>
                                    <button class="btn-delete" onclick="deleteSectionConfirm('${section.nome}')">üóëÔ∏è Deletar</button>
                                </div>
                            </div>
                            <div class="config-item-meta">Ordem: ${section.ordem}, Status: ${section.ativo}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = sectionsHtml;
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao carregar se√ß√µes DEPLOY 30', { error: error.message });
            }
        }
        
        async function loadFields() {
            try {
                const fields = await apiCall('getAllFieldsFromConfig');
                const container = document.getElementById('fields-container');
                
                let fieldsHtml = '';
                fields.forEach(field => {
                    fieldsHtml += `
                        <div class="config-item">
                            <div class="config-item-header">
                                <div class="config-item-title">üè∑Ô∏è ${field.campo}</div>
                                <div class="config-item-actions">
                                    <button class="btn-edit" onclick="editField('${field.secao}', '${field.campo}')">‚úèÔ∏è Editar</button>
                                    <button class="btn-delete" onclick="deleteFieldConfirm('${field.secao}', '${field.campo}')">üóëÔ∏è Deletar</button>
                                </div>
                            </div>
                            <div class="config-item-meta">${field.secao} ‚Ä¢ ${field.tipo} ‚Ä¢ ${field.obrigatorio}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = fieldsHtml;
                
            } catch (error) {
                debugLog('error', '‚ùå Erro ao carregar campos DEPLOY 30', { error: error.message });
            }
        }
        
        // Fun√ß√µes placeholder para configura√ß√µes (ser√£o implementadas em vers√£o futura)
function editList(listName) {
    debugLog('info', 'Editando lista', { listName: listName });
    
    // Obter valores atuais da lista
    var currentValues = appContext.lists[listName] || [];
    
    // Criar modal de edi√ß√£o de lista
    var modalHtml = `
        <div id="editListModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 1rem; color: #009688;">‚úèÔ∏è Editar Lista: ${listName}</h3>
                
                <div class="form-group">
                    <label>Itens da Lista:</label>
                    <div id="listItemsContainer" style="margin-top: 10px;">
                        ${currentValues.map(value => `
                            <div class="list-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="text" value="${value}" class="form-control list-value">
                                <button onclick="removeListItem(this)" class="btn btn-error" style="padding: 0.5rem;">üóëÔ∏è</button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addListItem()" class="btn btn-secondary" style="margin-top: 10px;">‚ûï Adicionar Item</button>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 20px;">
                    <button onclick="closeEditListModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="saveListChanges('${listName}')" class="btn btn-primary">üíæ Salvar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function addListItem() {
    var container = document.getElementById('listItemsContainer');
    var newItem = `
        <div class="list-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <input type="text" value="" class="form-control list-value" placeholder="Novo item">
            <button onclick="removeListItem(this)" class="btn btn-error" style="padding: 0.5rem;">üóëÔ∏è</button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', newItem);
}

function removeListItem(button) {
    button.parentElement.remove();
}

function closeEditListModal() {
    var modal = document.getElementById('editListModal');
    if (modal) modal.remove();
}

function saveListChanges(listName) {
    var newValues = [];
    document.querySelectorAll('.list-value').forEach(function(input) {
        if (input.value.trim()) {
            newValues.push(input.value.trim());
        }
    });
    
    showLoading('Salvando lista...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeEditListModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('updated', result.listName || listName, 2000);
                } else {
                    showSuccess('Lista atualizada com sucesso!');
                }
            } else {
                showError('Erro ao salvar lista');
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao salvar lista: ' + error);
            hideLoading();
        })
        .saveList(listName, newValues);
}

function deleteListConfirm(listName) {
    // Criar modal de confirma√ß√£o HTML customizado
    var modalHtml = `
        <div id="deleteListModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-bottom: 1.5rem; color: #F44336;">üóëÔ∏è Excluir Lista</h3>
                <div style="margin-bottom: 1.5rem;">
                    <p style="margin-bottom: 1rem;">
                        Tem certeza que deseja deletar a lista:
                    </p>
                    <p style="font-weight: 600; color: #009688; font-size: 16px;">
                        "${listName}"
                    </p>
                    <p style="margin-top: 1rem; color: #F44336; font-size: 14px;">
                        ‚ö†Ô∏è ATEN√á√ÉO: Isso pode afetar campos que usam esta lista!
                    </p>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeDeleteListModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="executeDeleteList('${listName}')" class="btn btn-danger">üóëÔ∏è Confirmar Exclus√£o</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Fun√ß√£o para fechar modal de deletar lista
function closeDeleteListModal() {
    var modal = document.getElementById('deleteListModal');
    if (modal) modal.remove();
}

// Fun√ß√£o para executar exclus√£o da lista
function executeDeleteList(listName) {
    var btnCancel = document.querySelector('#deleteListModal .btn-secondary');
    var btnConfirm = document.querySelector('#deleteListModal .btn-danger');
    btnCancel.disabled = true;
    btnConfirm.disabled = true;
    btnConfirm.innerHTML = '‚è≥ Excluindo...';
    
    showLoading('Deletando lista...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeDeleteListModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('deleted', result.listName || listName, 2000);
                } else {
                    showSuccess('Lista deletada com sucesso!');
                }
            } else {
                showError('Erro ao deletar lista');
                btnCancel.disabled = false;
                btnConfirm.disabled = false;
                btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao deletar lista: ' + error);
            btnCancel.disabled = false;
            btnConfirm.disabled = false;
            btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
            hideLoading();
        })
        .deleteList(listName);
}

// Adicionar nova lista
document.getElementById('addNewList').addEventListener('click', function() {
    // Criar modal HTML customizado
    var modalHtml = `
        <div id="newListModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-bottom: 1.5rem; color: #009688;">üìã Nova Lista</h3>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nome da nova lista:</label>
                    <input type="text" id="newListName" class="form-control" placeholder="Digite o nome da lista" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeNewListModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="createNewList()" class="btn btn-primary">‚úÖ Criar Lista</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Focar no campo de input
    setTimeout(() => {
        document.getElementById('newListName').focus();
    }, 100);
    
    // Permitir criar com Enter
    document.getElementById('newListName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            createNewList();
        }
    });
});

// Fun√ß√£o para fechar modal de nova lista
function closeNewListModal() {
    var modal = document.getElementById('newListModal');
    if (modal) modal.remove();
}

// Fun√ß√£o para criar nova lista
function createNewList() {
    var listName = document.getElementById('newListName').value.trim();
    
    if (!listName) {
        showError('Por favor, digite um nome para a lista!');
        return;
    }
    
    if (appContext.lists[listName]) {
        showError('Esta lista j√° existe!');
        return;
    }
    
    var btnCreate = document.querySelector('#newListModal .btn-primary');
    btnCreate.disabled = true;
    btnCreate.innerHTML = '‚è≥ Criando...';
    
    showLoading('Criando lista...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeNewListModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('created', result.listName || listName, 2000);
                } else {
                    showSuccess('Lista criada com sucesso!');
                }
            } else {
                showError('Erro ao criar lista');
                btnCreate.disabled = false;
                btnCreate.innerHTML = '‚úÖ Criar Lista';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao criar lista: ' + error);
            btnCreate.disabled = false;
            btnCreate.innerHTML = '‚úÖ Criar Lista';
            hideLoading();
        })
        .saveList(listName, []);
}

// SE√á√ïES
function editSection(sectionName) {
    debugLog('info', 'Editando se√ß√£o', { sectionName: sectionName });
    
    var section = appContext.sections.find(s => s.nome === sectionName);
    if (!section) return;
    
    var modalHtml = `
        <div id="editSectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                <h3 style="margin-bottom: 1rem;">Editar Se√ß√£o: ${sectionName}</h3>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="sectionDesc" value="${section.descricao}" class="form-control">
                </div>
                <div class="form-group">
                    <label>Ordem</label>
                    <input type="number" id="sectionOrder" value="${section.ordem}" class="form-control">
                </div>
                <div class="form-group">
                    <label>Ativo</label>
                    <select id="sectionActive" class="form-control">
                        <option value="Sim" ${section.ativo === 'Sim' ? 'selected' : ''}>Sim</option>
                        <option value="N√£o" ${section.ativo === 'N√£o' ? 'selected' : ''}>N√£o</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeSectionModal()" class="btn btn-secondary">Cancelar</button>
                    <button onclick="saveSectionChanges('${sectionName}')" class="btn btn-primary">üíæ Salvar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeSectionModal() {
    var modal = document.getElementById('editSectionModal');
    if (modal) modal.remove();
}

function saveSectionChanges(sectionName) {
    var sectionData = {
        nome: sectionName,
        descricao: document.getElementById('sectionDesc').value,
        ordem: parseInt(document.getElementById('sectionOrder').value),
        ativo: document.getElementById('sectionActive').value
    };
    
    showLoading('Salvando se√ß√£o...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeSectionModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('updated', result.sectionName || sectionName, 2000);
                } else {
                    showSuccess('Se√ß√£o atualizada com sucesso!');
                }
            } else {
                showError('Erro ao salvar se√ß√£o');
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao salvar se√ß√£o: ' + error);
            hideLoading();
        })
        .saveSection(sectionData);
}

function deleteSectionConfirm(sectionName) {
    // Criar modal de confirma√ß√£o HTML customizado
    var modalHtml = `
        <div id="deleteSectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-bottom: 1.5rem; color: #F44336;">üóëÔ∏è Excluir Se√ß√£o</h3>
                <div style="margin-bottom: 1.5rem;">
                    <p style="margin-bottom: 1rem;">
                        Tem certeza que deseja deletar a se√ß√£o:
                    </p>
                    <p style="font-weight: 600; color: #009688; font-size: 16px;">
                        "${sectionName}"
                    </p>
                    <p style="margin-top: 1rem; color: #F44336; font-size: 14px;">
                        ‚ö†Ô∏è ATEN√á√ÉO: Todos os campos desta se√ß√£o ser√£o removidos!
                    </p>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeDeleteSectionModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="executeDeleteSection('${sectionName}')" class="btn btn-danger">üóëÔ∏è Confirmar Exclus√£o</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Fun√ß√£o para fechar modal de deletar se√ß√£o
function closeDeleteSectionModal() {
    var modal = document.getElementById('deleteSectionModal');
    if (modal) modal.remove();
}

// Fun√ß√£o para executar exclus√£o da se√ß√£o
function executeDeleteSection(sectionName) {
    var btnCancel = document.querySelector('#deleteSectionModal .btn-secondary');
    var btnConfirm = document.querySelector('#deleteSectionModal .btn-danger');
    btnCancel.disabled = true;
    btnConfirm.disabled = true;
    btnConfirm.innerHTML = '‚è≥ Excluindo...';
    
    showLoading('Deletando se√ß√£o...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeDeleteSectionModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('deleted', result.sectionName || sectionName, 2000);
                } else {
                    showSuccess('Se√ß√£o deletada com sucesso!');
                }
            } else {
                showError('Erro ao deletar se√ß√£o');
                btnCancel.disabled = false;
                btnConfirm.disabled = false;
                btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao deletar se√ß√£o: ' + error);
            btnCancel.disabled = false;
            btnConfirm.disabled = false;
            btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
            hideLoading();
        })
        .deleteSection(sectionName);
}

// Adicionar nova se√ß√£o
document.getElementById('addNewSection').addEventListener('click', function() {
    // Criar modal HTML customizado
    var modalHtml = `
        <div id="newSectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-bottom: 1.5rem; color: #009688;">üìÑ Nova Se√ß√£o</h3>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nome da nova se√ß√£o:</label>
                    <input type="text" id="newSectionName" class="form-control" placeholder="Digite o nome da se√ß√£o" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeNewSectionModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="createNewSection()" class="btn btn-primary">‚úÖ Criar Se√ß√£o</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Focar no campo de input
    setTimeout(() => {
        document.getElementById('newSectionName').focus();
    }, 100);
    
    // Permitir criar com Enter
    document.getElementById('newSectionName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            createNewSection();
        }
    });
});

// Fun√ß√£o para fechar modal de nova se√ß√£o
function closeNewSectionModal() {
    var modal = document.getElementById('newSectionModal');
    if (modal) modal.remove();
}

// Fun√ß√£o para criar nova se√ß√£o
function createNewSection() {
    var sectionName = document.getElementById('newSectionName').value.trim();
    
    if (!sectionName) {
        showError('Por favor, digite um nome para a se√ß√£o!');
        return;
    }
    
    var existingSection = appContext.sections.find(s => s.nome === sectionName);
    if (existingSection) {
        showError('Esta se√ß√£o j√° existe!');
        return;
    }
    
    var btnCreate = document.querySelector('#newSectionModal .btn-primary');
    btnCreate.disabled = true;
    btnCreate.innerHTML = '‚è≥ Criando...';
    
    showLoading('Criando se√ß√£o...');
    
    var sectionData = {
        nome: sectionName,
        descricao: '',
        ordem: 999,
        ativo: 'Sim'
    };
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeNewSectionModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('created', result.sectionName || sectionName, 2000);
                } else {
                    showSuccess('Se√ß√£o criada com sucesso!');
                }
            } else {
                showError('Erro ao criar se√ß√£o');
                btnCreate.disabled = false;
                btnCreate.innerHTML = '‚úÖ Criar Se√ß√£o';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao criar se√ß√£o: ' + error);
            btnCreate.disabled = false;
            btnCreate.innerHTML = '‚úÖ Criar Se√ß√£o';
            hideLoading();
        })
        .saveSection(sectionData);
}

// CAMPOS
function editField(secao, campo) {
    debugLog('info', 'Editando campo', { secao: secao, campo: campo });
    
    // Buscar campo atual
    var allFields = [];
    google.script.run
        .withSuccessHandler(function(fields) {
            var field = fields.find(f => f.secao === secao && f.campo === campo);
            if (!field) return;
            
            var modalHtml = `
                <div id="editFieldModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 1rem;">Editar Campo: ${campo}</h3>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="fieldType" class="form-control">
                                <option value="input" ${field.tipo === 'input' ? 'selected' : ''}>Texto</option>
                                <option value="textarea" ${field.tipo === 'textarea' ? 'selected' : ''}>Texto Longo</option>
                                <option value="select" ${field.tipo === 'select' ? 'selected' : ''}>Lista Suspensa</option>
                                <option value="date" ${field.tipo === 'date' ? 'selected' : ''}>Data</option>
                                <option value="number" ${field.tipo === 'number' ? 'selected' : ''}>N√∫mero</option>
                                <option value="file" ${field.tipo === 'file' ? 'selected' : ''}>Arquivo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Obrigat√≥rio</label>
                            <select id="fieldRequired" class="form-control">
                                <option value="Sim" ${field.obrigatorio === 'Sim' ? 'selected' : ''}>Sim</option>
                                <option value="N√£o" ${field.obrigatorio === 'N√£o' ? 'selected' : ''}>N√£o</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Placeholder</label>
                            <input type="text" id="fieldPlaceholder" value="${field.placeholder || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Lista (para campos select)</label>
                            <select id="fieldList" class="form-control">
                                <option value="">Nenhuma</option>
                                ${Object.keys(appContext.lists).map(list => 
                                    `<option value="${list}" ${field.lista === list ? 'selected' : ''}>${list}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ordem</label>
                            <input type="number" id="fieldOrder" value="${field.ordem}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Ativo</label>
                            <select id="fieldActive" class="form-control">
                                <option value="Sim" ${field.ativo === 'Sim' ? 'selected' : ''}>Sim</option>
                                <option value="N√£o" ${field.ativo === 'N√£o' ? 'selected' : ''}>N√£o</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="closeFieldModal()" class="btn btn-secondary">Cancelar</button>
                            <button onclick="saveFieldChanges('${secao}', '${campo}')" class="btn btn-primary">üíæ Salvar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        })
        .withFailureHandler(function(error) {
            showError('Erro ao carregar campo: ' + error);
        })
        .getAllFieldsFromConfig();
}

function closeFieldModal() {
    var modal = document.getElementById('editFieldModal');
    if (modal) modal.remove();
}

function saveFieldChanges(secao, campo) {
    var fieldData = {
        secao: secao,
        campo: campo,
        tipo: document.getElementById('fieldType').value,
        obrigatorio: document.getElementById('fieldRequired').value,
        placeholder: document.getElementById('fieldPlaceholder').value,
        lista: document.getElementById('fieldList').value,
        ordem: parseInt(document.getElementById('fieldOrder').value),
        ativo: document.getElementById('fieldActive').value
    };
    
    showLoading('Salvando campo...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeFieldModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('updated', result.fieldName || campo, 2000);
                } else {
                    showSuccess('Campo salvo com sucesso!');
                }
            } else {
                showError('Erro ao salvar campo');
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao salvar campo: ' + error);
            hideLoading();
        })
        .saveFieldConfiguration(fieldData);
}
console.log('‚úÖ Todas as fun√ß√µes de configura√ß√£o carregadas!');



function deleteFieldConfirm(secao, campo) {
    // Criar modal de confirma√ß√£o HTML
    var modalHtml = `
        <div id="deleteFieldModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                <h3 style="margin-bottom: 1.5rem; color: #F44336;">Excluir Campo</h3>
                <p>Tem certeza que deseja deletar o campo:</p>
                <p style="font-weight: 600; color: #009688;">"${campo}"</p>
                <p>da se√ß√£o: <strong>"${secao}"</strong></p>
                <p style="color: #F44336;">Esta a√ß√£o n√£o pode ser desfeita!</p>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button onclick="closeDeleteFieldModal()" class="btn btn-secondary">Cancelar</button>
                    <button onclick="executeDeleteField('${secao}', '${campo}')" class="btn btn-danger">Confirmar Exclus√£o</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeDeleteFieldModal() {
    var modal = document.getElementById('deleteFieldModal');
    if (modal) modal.remove();
}

function executeDeleteField(secao, campo) {
    var btnCancel = document.querySelector('#deleteFieldModal .btn-secondary');
    var btnConfirm = document.querySelector('#deleteFieldModal .btn-danger');
    btnCancel.disabled = true;
    btnConfirm.disabled = true;
    btnConfirm.innerHTML = '‚è≥ Excluindo...';
    
    showLoading('Deletando campo...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeDeleteFieldModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('deleted', result.fieldName || campo, 2000);
                } else {
                    showSuccess('Campo deletado com sucesso!');
                }
            } else {
                showError('Erro ao deletar campo');
                btnCancel.disabled = false;
                btnConfirm.disabled = false;
                btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao deletar campo: ' + error);
            btnCancel.disabled = false;
            btnConfirm.disabled = false;
            btnConfirm.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
            hideLoading();
        })
        .deleteFieldConfiguration(secao, campo);
}





// ========================================
// EVENT LISTENER: ADICIONAR NOVO CAMPO COMPLETO
// ========================================
document.getElementById('addNewField').addEventListener('click', function() {
    debugLog('info', '‚ûï Abrindo modal de novo campo completo');
    
    // Verificar se existem se√ß√µes dispon√≠veis
    if (!appContext.sections || appContext.sections.length === 0) {
        showError('Nenhuma se√ß√£o dispon√≠vel! Crie uma se√ß√£o primeiro.');
        return;
    }
    
    // Criar options para se√ß√µes
    var sectionsOptions = appContext.sections.map(section => 
        `<option value="${section.nome}">${section.nome}</option>`
    ).join('');
    
    // Criar options para listas dispon√≠veis
    var listsOptions = '<option value="">Nenhuma</option>';
    if (appContext.lists) {
        listsOptions += Object.keys(appContext.lists).map(listName => 
            `<option value="${listName}">${listName}</option>`
        ).join('');
    }
    
    // Criar modal HTML completo (baseado no editField)
    var modalHtml = `
        <div id="newFieldModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-bottom: 1.5rem; color: #009688;">üè∑Ô∏è Novo Campo</h3>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Se√ß√£o:</label>
                    <select id="newFieldSection" class="form-control" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        ${sectionsOptions}
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nome do Campo:</label>
                    <input type="text" id="newFieldName" class="form-control" placeholder="Digite o nome do campo" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tipo:</label>
                    <select id="newFieldType" class="form-control" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="input">üìù Texto</option>
                        <option value="textarea">üìÑ Texto Longo</option>
                        <option value="select">üìã Lista Suspensa</option>
                        <option value="date">üìÖ Data</option>
                        <option value="number">üî¢ N√∫mero</option>
                        <option value="file">üìé Arquivo</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Obrigat√≥rio:</label>
                    <select id="newFieldRequired" class="form-control" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="N√£o">‚ùå N√£o</option>
                        <option value="Sim">‚úÖ Sim</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Placeholder:</label>
                    <input type="text" id="newFieldPlaceholder" class="form-control" placeholder="Texto de ajuda (opcional)" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Lista (para campos select):</label>
                    <select id="newFieldList" class="form-control" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        ${listsOptions}
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Ordem:</label>
                    <input type="number" id="newFieldOrder" class="form-control" value="999" min="1" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeNewFieldModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button onclick="createNewFieldComplete()" class="btn btn-primary">‚úÖ Criar Campo</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Focar no campo nome
    setTimeout(() => {
        document.getElementById('newFieldName').focus();
    }, 100);
    
    // Permitir criar com Enter
    document.getElementById('newFieldName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            createNewFieldComplete();
        }
    });
});



// ========================================
// EVENT LISTENER: ADICIONAR NOVO USU√ÅRIO
// ========================================
document.getElementById('addNewUser').addEventListener('click', function() {
    debugLog('info', '‚ûï Abrindo modal de novo usu√°rio');
    
    const modalHtml = `
        <div id="addUserModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 1rem; color: #009688;">‚ûï Adicionar Novo Usu√°rio</h3>
                
                <div class="form-group">
                    <label>üìß Email do Usu√°rio</label>
                    <input type="email" id="newUserEmail" class="form-control" placeholder="usuario@exemplo.com">
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>üé≠ Roles do Usu√°rio</label>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                        
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="role_admin" value="Admin">
                            <span class="role-badge admin">Admin</span>
                            <span style="font-size: 13px; color: #666;">Acesso total ao sistema</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="role_abertura" value="Abertura" checked>
                            <span class="role-badge abertura">Abertura</span>
                            <span style="font-size: 13px; color: #666;">Criar RNCs</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="role_qualidade" value="Qualidade">
                            <span class="role-badge qualidade">Qualidade</span>
                            <span style="font-size: 13px; color: #666;">Editar se√ß√£o Qualidade</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="role_lideranca" value="Lideran√ßa">
                            <span class="role-badge lideranca">Lideran√ßa</span>
                            <span style="font-size: 13px; color: #666;">Editar se√ß√£o Lideran√ßa</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="role_espectador" value="Espectador">
                            <span class="role-badge espectador">Espectador</span>
                            <span style="font-size: 13px; color: #666;">Apenas visualizar</span>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 30px;">
                    <button onclick="closeAddUserModal()" class="btn btn-secondary">Cancelar</button>
                    <button onclick="saveNewUser()" class="btn btn-primary">‚ûï Adicionar Usu√°rio</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
});

// Fun√ß√£o para fechar modal de novo campo
function closeNewFieldModal() {
    var modal = document.getElementById('newFieldModal');
    if (modal) modal.remove();
}

// Fun√ß√£o COMPLETA para criar novo campo (VERS√ÉO FINAL CORRIGIDA)
function createNewFieldComplete() {
    var fieldData = {
        secao: document.getElementById('newFieldSection').value,
        campo: document.getElementById('newFieldName').value.trim(),
        tipo: document.getElementById('newFieldType').value,
        obrigatorio: document.getElementById('newFieldRequired').value,
        placeholder: document.getElementById('newFieldPlaceholder').value.trim(),
        lista: document.getElementById('newFieldList').value,
        ordem: parseInt(document.getElementById('newFieldOrder').value) || 999,
        ativo: 'Sim'
    };
    
    if (!fieldData.campo) {
        showError('Por favor, digite o nome do campo!');
        document.getElementById('newFieldName').focus();
        return;
    }
    
    var btnCreate = document.querySelector('#newFieldModal .btn-primary');
    var btnCancel = document.querySelector('#newFieldModal .btn-secondary');
    btnCreate.disabled = true;
    btnCancel.disabled = true;
    btnCreate.innerHTML = '‚è≥ Criando...';
    
    showLoading('Criando campo...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                closeNewFieldModal();
                hideLoading();
                
                // ‚úÖ RECARREGAR P√ÅGINA
                if (result.configChanged) {
                    reloadPageAfterConfigChange('created', result.fieldName || fieldData.campo, 2000);
                } else {
                    showSuccess('Campo criado com sucesso!');
                }
            } else {
                showError('Erro ao criar campo');
                btnCreate.disabled = false;
                btnCancel.disabled = false;
                btnCreate.innerHTML = '‚úÖ Criar Campo';
                hideLoading();
            }
        })
        .withFailureHandler(function(error) {
            showError('Erro ao criar campo: ' + error);
            btnCreate.disabled = false;
            btnCancel.disabled = false;
            btnCreate.innerHTML = '‚úÖ Criar Campo';
            hideLoading();
        })
        .saveFieldConfiguration(fieldData);
}     



/**
 * Formata data para input type="date" (YYYY-MM-DD)
 * Deploy 37 - Aceita DD/MM/YYYY do backend
 */
function formatDateForInput(dateValue) {
    if (!dateValue) return '';
    
    try {
        // Se recebeu DD/MM/YYYY do backend
        if (typeof dateValue === 'string' && dateValue.includes('/')) {
            var parts = dateValue.split('/');
            if (parts.length === 3) {
                var day = parts[0].padStart(2, '0');
                var month = parts[1].padStart(2, '0');
                var year = parts[2];
                return year + '-' + month + '-' + day;
            }
        }
        
        // Se recebeu YYYY-MM-DD ou ISO
        if (typeof dateValue === 'string' && dateValue.includes('-')) {
            return dateValue.split('T')[0]; // Remove hora se tiver
        }
        
        // Se recebeu objeto Date
        if (dateValue instanceof Date) {
            const year = dateValue.getFullYear();
            const month = String(dateValue.getMonth() + 1).padStart(2, '0');
            const day = String(dateValue.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        return '';
        
    } catch (error) {
        debugLog('error', 'Erro ao formatar data para input', { dateValue, error: error.message });
        return '';
    }
}


        /**
 * Formata data para exibi√ß√£o (DD/MM/YYYY)
 * Deploy 37 - Padronizado com backend
 */

 
function formatDate(dateStr) {
    if (!dateStr) return '';
    
    try {
        // Se j√° est√° em DD/MM/YYYY, retornar
        if (typeof dateStr === 'string' && dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            return dateStr;
        }
        
        // Se est√° em YYYY-MM-DD ou ISO (2025-10-16 ou 2025-10-16T03:00:00.000Z)
        if (typeof dateStr === 'string' && dateStr.includes('-')) {
            const parts = dateStr.split('T')[0].split('-');
            if (parts.length === 3) {
                return parts[2] + '/' + parts[1] + '/' + parts[0];
            }
        }
        
        // Se for Date object
        if (dateStr instanceof Date) {
            return dateStr.toLocaleDateString('pt-BR');
        }
        
        return dateStr;
    } catch (error) {
        console.error('Erro ao formatar data:', error);
        return dateStr;
    }
}
        
        function showLoading(message = 'Carregando...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            messageEl.textContent = message;
            overlay.classList.remove('hidden');
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
        }
        
        // === SISTEMA DE ALERTAS MELHORADO (Deploy 30) ===
var activeAlerts = []; // Rastrear alertas ativos

function showAlert(message, type = 'info', duration = 5000) {
    // === PREVENIR DUPLICATAS ===
    var alertKey = type + ':' + message;
    if (activeAlerts.indexOf(alertKey) !== -1) {
        debugLog('warning', '‚ö†Ô∏è Alerta duplicado bloqueado', { message: message });
        return;
    }
    
    activeAlerts.push(alertKey);
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.dataset.alertKey = alertKey;
    
    const icon = {
        'success': '‚úÖ',
        'error': '‚ùå', 
        'warning': '‚ö†Ô∏è',
        'info': '‚ÑπÔ∏è'
    };
    
    alert.innerHTML = `
        <span>${icon[type] || '‚ÑπÔ∏è'}</span>
        <span>${message}</span>
    `;
    
    // Inserir no topo da p√°gina
    const container = document.querySelector('.container');
    container.insertBefore(alert, container.firstChild);
    
    // Auto remover
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
            // Remover do rastreamento
            var index = activeAlerts.indexOf(alertKey);
            if (index > -1) {
                activeAlerts.splice(index, 1);
            }
        }
    }, duration);
    
    debugLog(type, message);
}
        
        function showSuccess(message) { showAlert(message, 'success'); }
        function showError(message) { showAlert(message, 'error', 8000); }
        function showInfo(message) { showAlert(message, 'info'); }
        function showWarning(message) { showAlert(message, 'warning'); }
       /**
 * Exibe notifica√ß√£o gen√©rica GARANTIDA
 * Deploy 42 - Notifica√ß√£o que sempre aparece
 */
function showNotification(message, type) {
    type = type || 'info';
    
    // Tentar usar showAlert primeiro
    try {
        if (typeof showAlert === 'function') {
            showAlert(message, type);
            return;
        }
    } catch(e) {
        console.warn('‚ö†Ô∏è showAlert falhou, usando fallback', e);
    }
    
    // FALLBACK: Criar notifica√ß√£o diretamente
    createDirectNotification(message, type);
}

/**
 * Cria notifica√ß√£o direto no body (fallback garantido)
 */
function createDirectNotification(message, type) {
    // Remover notifica√ß√µes antigas
    const oldNotifications = document.querySelectorAll('.direct-notification');
    oldNotifications.forEach(n => n.remove());
    
    // Criar notifica√ß√£o
    const notification = document.createElement('div');
    notification.className = `direct-notification notification-${type}`;
    
    const icons = {
        'success': '‚úÖ',
        'error': '‚ùå',
        'warning': '‚ö†Ô∏è',
        'info': '‚ÑπÔ∏è'
    };
    
    const colors = {
        'success': '#4caf50',
        'error': '#f44336',
        'warning': '#ff9800',
        'info': '#2196F3'
    };
    
    notification.innerHTML = `
        <span style="margin-right: 10px; font-size: 18px;">${icons[type] || '‚ÑπÔ∏è'}</span>
        <span style="flex: 1;">${message}</span>
    `;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 99999;
        display: flex;
        align-items: center;
        min-width: 300px;
        max-width: 500px;
        font-size: 14px;
        font-weight: 500;
        animation: slideInRight 0.3s ease-out;
    `;
    
    // Adicionar ao body
    document.body.appendChild(notification);
    
    // Auto remover ap√≥s 5 segundos
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
    
    console.log(`üì¢ Notifica√ß√£o [${type}]: ${message}`);
}

// Adicionar anima√ß√µes CSS se n√£o existirem
if (!document.getElementById('notification-animations')) {
    const style = document.createElement('style');
    style.id = 'notification-animations';
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

 /**
 * Exibe notifica√ß√£o de mudan√ßa na configura√ß√£o
 * Deploy 30 - Feedback visual para altera√ß√µes
 */
function showConfigChangeNotification(action, fieldOrSectionName) {
    var actionText = {
        'created': '‚úÖ Criado',
        'updated': '‚úèÔ∏è Atualizado',
        'deleted': 'üóëÔ∏è Removido'
    };
    
    var actionEmoji = {
        'created': '‚ú®',
        'updated': 'üîÑ',
        'deleted': 'üóëÔ∏è'
    };
    
    var message = (actionEmoji[action] || '‚úÖ') + ' ' + 
                  (actionText[action] || 'Atualizado') + 
                  ': "' + fieldOrSectionName + '"';
    
    debugLog('success', 'Configura√ß√£o alterada', {
        action: action,
        item: fieldOrSectionName,
        timestamp: new Date().toISOString()
    });
    
    console.log('üì¢ ' + message);
}
        
        // === NAVEGA√á√ÉO ===
        // === CONTROLE DE ABAS CARREGADAS ===
var loadedTabs = {
    abrir: true,  // J√° carregado na inicializa√ß√£o
    editar: false,
    kanban: false,
    dashboard: false,
    relatorios: false,
    configuracoes: false
};


        
        // === NAVEGA√á√ÉO DAS ABAS DE CONFIGURA√á√ÉO (DEPLOY 30) ===
        function switchConfigTab(configTabName) {
            // Remover classe ativa de todas as abas de config
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.config-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ativar aba selecionada
            document.querySelector(`[data-config-tab="${configTabName}"]`).classList.add('active');
            document.getElementById(`config-tab-${configTabName}`).classList.add('active');
            
            debugLog('info', 'üîß Mudando para aba de config DEPLOY 30', { configTab: configTabName });
        }
        
        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('info', 'üöÄ DOM carregado, inicializando aplica√ß√£o DEPLOY 30');
            
            // === BARRA DE ABAS STICKY COM EFEITO AO ROLAR ===
            const tabsElement = document.querySelector('.tabs');

            if (tabsElement) {
                window.addEventListener('scroll', function() {
                    const scrollY = window.scrollY || window.pageYOffset;
                    
                    // Se rolou mais de 100px, adicionar efeito
                    if (scrollY > 100) {
                        tabsElement.classList.add('scrolled');
                    } else {
                        tabsElement.classList.remove('scrolled');
                    }
                });
                
                debugLog('info', '‚úÖ Sistema de abas sticky configurado');
            }

            // Navega√ß√£o das abas principais
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
            
            // === NAVEGA√á√ÉO DAS ABAS DE CONFIGURA√á√ÉO (DEPLOY 30) ===
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const configTabName = this.dataset.configTab;
                    switchConfigTab(configTabName);
                });
            });
            
            // Formul√°rio de abertura
            document.getElementById('rncForm').addEventListener('submit', function(e) {
                console.log('üî¥üî¥üî¥ FORM SUBMIT CAPTURADO! üî¥üî¥üî¥');
                e.preventDefault();

                const submitBtn = document.getElementById('submitRnc');
                const submitText = document.getElementById('submitText');
                const submitLoading = document.getElementById('submitLoading');

                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                submitLoading.classList.remove('hidden');

                console.log('üî¥ Chamando saveRnc()...');
                saveRnc().finally(() => {
                    console.log('üî¥ saveRnc() finalizado');
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    submitLoading.classList.add('hidden');
                });
            });
            
            // Formul√°rio de edi√ß√£o
            document.getElementById('rncEditForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const updateBtn = document.getElementById('updateRnc');
                const updateText = document.getElementById('updateText');
                const updateLoading = document.getElementById('updateLoading');
                
                updateBtn.disabled = true;
                updateText.classList.add('hidden');
                updateLoading.classList.remove('hidden');
                
                updateRnc().finally(() => {
                    updateBtn.disabled = false;
                    updateText.classList.remove('hidden');
                    updateLoading.classList.add('hidden');
                });
            });
            
            // Sele√ß√£o de RNC para edi√ß√£o
            document.getElementById('rncSelect').addEventListener('change', function() {
                const rncNumber = this.value;
                if (rncNumber) {
                    loadRncForEdit(rncNumber);
                } else {
                    document.getElementById('editForm').classList.add('hidden');
                    currentRnc = null;
                }
            });
            
            // Gera√ß√£o de relat√≥rios
            document.getElementById('generateReport').addEventListener('click', function() {
                const reportBtn = this;
                const reportText = document.getElementById('reportText');
                const reportLoading = document.getElementById('reportLoading');
                
                reportBtn.disabled = true;
                reportText.classList.add('hidden');
                reportLoading.classList.remove('hidden');
                
                generateReport().finally(() => {
                    reportBtn.disabled = false;
                    reportText.classList.remove('hidden');
                    reportLoading.classList.add('hidden');
                });
            });

            // Exporta√ß√£o PDF (DEPLOY 38)
            document.getElementById('exportPdf').addEventListener('click', exportToPdf);

            // Limpar filtros
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            
            // === CONFIGURA√á√ïES (DEPLOY 30) ===
            document.getElementById('saveSystemConfig').addEventListener('click', saveSystemConfig);
            
            // Debug toggle
            document.getElementById('debugToggle').addEventListener('click', function() {
                const panel = document.getElementById('debugPanel');
                panel.style.display = panel.style.display === 'none' || !panel.style.display ? 'block' : 'none';
            });
            
            // Inicializar aplica√ß√£o
            initializeApp();
        });
        
        // === FUN√á√ïES GLOBAIS DE DEBUG ===
        window.debugSystem = function() {
            return {
                systemReady: !!appContext,
                currentRnc: currentRnc,
                availableRncs: availableRncs.length,
                reportData: reportData ? `${reportData.rncs ? reportData.rncs.length : 0} RNCs` : null,
                appContext: appContext ? {
                    email: appContext.email,
                    role: appContext.role,
                    fieldsCount: Object.keys(appContext.fieldsConfig).length,
                    sectionsCount: appContext.sections.length,
                    listsCount: appContext.listNames.length,
                    statusPipeline: appContext.statusPipeline,
                    systemConfig: appContext.systemConfig
                } : null,
                debugLogs: debugLogs.length,
                version: 'Deploy 30 - Corre√ß√µes Cr√≠ticas'
            };
        };
        
        console.log('üöÄ Sistema RNC DEPLOY 30 carregado com TODAS as corre√ß√µes!');
        console.log('‚úÖ Corre√ß√µes implementadas:');
        console.log('  - Campo "Setor onde foi feita abertura" corrigido com \\n');
        console.log('  - Se√ß√£o "Informa√ß√µes da RNC" removida da edi√ß√£o');
        console.log('  - Campos de edi√ß√£o carregam valores reais');
        console.log('  - Kanban inclui cards finalizados');
        console.log('  - Configura√ß√µes com abas restauradas');
        console.log('Debug: window.debugSystem()');

        
console.log('Script carregado completamente!');

// Verificar se fun√ß√µes cr√≠ticas existem
if (typeof initializeApp === 'function') {
    console.log('‚úÖ initializeApp existe');
} else {
    console.error('‚ùå initializeApp N√ÉO existe!');
}

if (typeof saveRnc === 'function') {
    console.log('‚úÖ saveRnc existe');
} else {
    console.error('‚ùå saveRnc N√ÉO existe!');
}

// Tentar inicializar se n√£o foi inicializado
if (typeof appContext === 'undefined' || appContext === null) {
    console.log('Tentando inicializa√ß√£o de emerg√™ncia...');
    initializeApp();
}

// ADICIONE ESTAS FUN√á√ïES OTIMIZADAS no index.html

// === DEBOUNCE PARA EVITAR CHAMADAS EXCESSIVAS ===
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}



// MODIFICAR switchTab existente
function switchTab(tabName) {
    // ‚úÖ NOVO: Limpar arquivos selecionados ao trocar de aba
    selectedFiles = [];
    
    // Remover classe ativa de todas as abas
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Ativar aba selecionada
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    debugLog('info', 'üîÑ Mudando para aba', { tab: tabName, alreadyLoaded: loadedTabs[tabName] });
    
    // === LAZY LOADING - S√ì CARREGAR SE NECESS√ÅRIO ===
    if (!loadedTabs[tabName]) {
        loadedTabs[tabName] = true;
        
        switch (tabName) {
            case 'kanban':
                loadKanban();
                break;
            case 'dashboard':
                loadDashboard();
                break;
            case 'relatorios':
                loadReportFilters();
                break;
            case 'configuracoes':
                loadConfigurations();
                break;
            case 'editar':
                Promise.all([
                    loadSetoresFilter(),
                    loadAvailableRncs()
                ]).then(() => {
                    debugLog('success', '‚úÖ Aba Editar carregada');
                });
                break;
        }
    } else {
        debugLog('info', '‚ö° Aba j√° carregada, pulando');
    }
}
// === SISTEMA DE CACHE (DEPLOY 31) ===
var appCache = {
    rncs: null,
    rncNumbers: null,
    dashboard: null,
    kanban: null,
    reportFilters: null,
    timestamp: {}
};

var CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

function isCacheValid(key) {
    if (!appCache[key]) return false;
    if (!appCache.timestamp[key]) return false;
    
    var age = Date.now() - appCache.timestamp[key];
    return age < CACHE_DURATION;
}

function setCache(key, value) {
    appCache[key] = value;
    appCache.timestamp[key] = Date.now();
    debugLog('info', 'üíæ Cache atualizado', { key: key });
}

function getCache(key) {
    if (isCacheValid(key)) {
        debugLog('info', '‚ö° Usando cache', { key: key });
        return appCache[key];
    }
    return null;
}

function clearCache(key) {
    if (key) {
        appCache[key] = null;
        appCache.timestamp[key] = null;
        debugLog('info', 'üóëÔ∏è Cache limpo', { key: key });
    } else {
        appCache = { timestamp: {} };
        debugLog('info', 'üóëÔ∏è Todo cache limpo');
    }
}

// === FUN√á√ïES DE RECARGA FOR√áADA (DEPLOY 30) ===
async function forceReloadKanban() {
    debugLog('info', 'üîÑ Recarga for√ßada do Kanban');
    clearCache('kanban');
    loadedTabs.kanban = false;
    await loadKanban();
    showSuccess('Kanban atualizado!');
}

async function forceReloadDashboard() {
    debugLog('info', 'üîÑ Recarga for√ßada do Dashboard');
    clearCache('dashboard');
    loadedTabs.dashboard = false;
    await loadDashboard();
    showSuccess('Dashboard atualizado!');
}

// === SISTEMA DE INVALIDA√á√ÉO DE CACHE (Deploy 30) ===
function invalidateCache(keys) {
    if (Array.isArray(keys)) {
        keys.forEach(function(key) {
            clearCache(key);
        });
    } else if (keys === 'all') {
        clearCache();
    }
    
    debugLog('info', 'üóëÔ∏è Cache invalidado', { keys: keys });
}

// === ATUALIZAR ABAS AUTOMATICAMENTE ===
function refreshActiveTab() {
    var activeTab = document.querySelector('.tab.active');
    if (!activeTab) return;
    
    var tabName = activeTab.dataset.tab;
    debugLog('info', 'üîÑ Atualizando aba ativa', { tab: tabName });
    
    // For√ßar recarregamento
    loadedTabs[tabName] = false;
    switchTab(tabName);
}

// === SISTEMA DE INVALIDA√á√ÉO DE CACHE (Deploy 30) ===
function invalidateCache(keys) {
    if (Array.isArray(keys)) {
        keys.forEach(function(key) {
            clearCache(key);
        });
    } else if (keys === 'all') {
        clearCache();
    }
    
    debugLog('info', 'üóëÔ∏è Cache invalidado', { keys: keys });
}

// === ATUALIZAR ABAS AUTOMATICAMENTE ===
function refreshActiveTab() {
    var activeTab = document.querySelector('.tab.active');
    if (!activeTab) return;
    
    var tabName = activeTab.dataset.tab;
    debugLog('info', 'üîÑ Atualizando aba ativa', { tab: tabName });
    
    // For√ßar recarregamento
    loadedTabs[tabName] = false;
    switchTab(tabName);
}

// ==========================================
// FUN√á√ïES DE FILTRO POR SETOR - KANBAN
// ==========================================

async function loadSetoresFilterKanban() {
    try {
        const setorFilter = document.getElementById('setorFilterKanban');
        if (!setorFilter) return;
        
        const setores = await apiCall('getSetoresUnicos', []);
        
        setorFilter.innerHTML = '<option value="Todos">üìã Todos os Setores</option>';
        
        if (setores && setores.length > 0) {
            setores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = `üè¢ ${setor}`;
                setorFilter.appendChild(option);
            });
        }
        
        setorFilter.addEventListener('change', function() {
            refreshKanban(this.value);
        });
        
    } catch (error) {
        debugLog('error', 'Erro ao carregar setores Kanban');
    }
}

async function refreshKanban(setor) {
    try {
        const setorFilter = document.getElementById('setorFilterKanban');
        const countSpan = document.getElementById('rncCountKanban');
        const setorAtual = setor || (setorFilter ? setorFilter.value : 'Todos');
        
        showLoading('Carregando Kanban...');
        
        const data = await apiCall('getKanbanData', []);
        
        if (!data) {
            throw new Error('Nenhum dado retornado');
        }
        
        // Filtrar dados por setor
        let filteredData = {};
        
        if (setorAtual && setorAtual !== 'Todos') {
            Object.keys(data).forEach(status => {
                filteredData[status] = data[status].filter(card => {
                    const cardSetor = card.setor || '';
                    return cardSetor.trim() === setorAtual.trim();
                });
            });
        } else {
            filteredData = data;
        }
        
        renderKanban(filteredData);
        
        if (countSpan) {
            let total = 0;
            Object.keys(filteredData).forEach(status => {
                total += filteredData[status].length;
            });
            countSpan.textContent = `${total} RNC(s) exibida(s)`;
            countSpan.style.color = total > 0 ? '#4CAF50' : '#999';
        }
        
        hideLoading();
        
    } catch (error) {
        debugLog('error', 'Erro ao atualizar Kanban');
        showError('Erro ao carregar Kanban');
        hideLoading();
    }
}
/**
 * Renderiza badges de roles do usu√°rio
 * Deploy 32 - Sistema de Permiss√µes
 */
function renderUserRoles() {
    const rolesContainer = document.getElementById('userRoles');
    
    if (!appContext || !appContext.roles || !rolesContainer) {
        return;
    }
    
    const roleColors = {
        'Admin': 'admin',
        'Abertura': 'abertura',
        'Qualidade': 'qualidade',
        'Lideran√ßa': 'lideranca',
        'Espectador': 'espectador'
    };
    
    const rolesHtml = appContext.roles.map(role => {
        const colorClass = roleColors[role] || '';
        return `<span class="role-badge ${colorClass}">${role}</span>`;
    }).join('');
    
    rolesContainer.innerHTML = rolesHtml;
    
    debugLog('info', 'üé≠ Roles do usu√°rio renderizadas', { 
        roles: appContext.roles.join(', ') 
    });
}

// ==========================================
// GERENCIAMENTO DE USU√ÅRIOS - Deploy 32
// ==========================================

/**
 * Carrega e renderiza lista de usu√°rios
 */
/**
 * Carrega e renderiza lista de usu√°rios
 * Deploy 32 - UI Refresh
 */
/**
 * Carrega e renderiza lista de usu√°rios
 * Deploy 32 - Grid Padronizado
 */
async function loadUsers() {
    try {
        debugLog('info', 'üë• Carregando usu√°rios');
        
        const container = document.getElementById('users-container');
        
        if (!container) {
            debugLog('error', '‚ùå Container users-container n√£o encontrado');
            return;
        }
        
        // Mostrar loading
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
                Carregando usu√°rios...
            </div>
        `;
        
        const users = await apiCall('getAllUsers');
        
        renderUsersTable(users);
        
        debugLog('success', '‚úÖ Usu√°rios carregados', { count: users.length });
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao carregar usu√°rios', { error: error.message });
        
        const container = document.getElementById('users-container');
        if (container) {
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 15px; color: #F44336;">‚ö†Ô∏è</div>
                    <div style="color: #F44336; font-size: 16px; margin-bottom: 15px;">
                        Erro ao carregar usu√°rios
                    </div>
                    <div style="color: #666; font-size: 14px; margin-bottom: 20px;">
                        ${error.message}
                    </div>
                    <button onclick="loadUsers()" class="btn btn-primary">
                        üîÑ Tentar Novamente
                    </button>
                </div>
            `;
        }
    }
}

/**
 * Renderiza cards de usu√°rios - VERS√ÉO COMPACTA
 * Deploy 33 - Layout Otimizado
 */
function renderUsersTable(users) {
    const container = document.getElementById('users-container');
    
    if (!container) {
        debugLog('error', 'Container users-container n√£o encontrado');
        return;
    }
    
    const roleColors = {
        'Admin': 'admin',
        'Abertura': 'abertura',
        'Qualidade': 'qualidade',
        'Lideran√ßa': 'lideranca',
        'Espectador': 'espectador'
    };
    
    // Se n√£o houver usu√°rios
    if (!users || users.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                <div style="color: #999; font-size: 16px;">Nenhum usu√°rio cadastrado</div>
                <button onclick="document.getElementById('addNewUser').click()" class="btn btn-primary" style="margin-top: 20px;">
                    ‚ûï Adicionar Primeiro Usu√°rio
                </button>
            </div>
        `;
        return;
    }
    
    // ‚ú® NOVO: Cards compactos
    const usersHtml = users.map(user => {
        const isAdmin = user.roles.indexOf('Admin') !== -1;
        
        // Badge "VOC√ä" inline
        const youBadge = user.email === appContext.email 
            ? '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 6px; font-weight: bold;">VOC√ä</span>' 
            : '';
        
        // Roles inline (badges menores)
        const rolesBadges = user.roles.map(role => {
            const colorClass = roleColors[role] || '';
            return `<span class="role-badge ${colorClass}" style="font-size: 10px; padding: 2px 6px;">${role}</span>`;
        }).join(' ');
        
        return `
            <div style="
                background: white;
                border: 1px solid #e5e7eb;
                border-left: 3px solid ${isAdmin ? '#F44336' : '#009688'};
                border-radius: 8px;
                padding: 12px;
                transition: all 0.2s ease;
                cursor: pointer;
            " onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)';">
                
                <!-- Email + Badge VOC√ä -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <div style="font-size: 13px; font-weight: 500; color: #1e1e1e; display: flex; align-items: center;">
                        üìß <span style="margin-left: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;" title="${user.email}">${user.email}</span>
                        ${youBadge}
                    </div>
                </div>
                
                <!-- Roles (badges inline) -->
                <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px;">
                    ${rolesBadges}
                </div>
                
                <!-- Bot√µes de a√ß√£o (inline) -->
                <div style="display: flex; gap: 6px; padding-top: 8px; border-top: 1px solid #f0f0f0;">
                    <button onclick="editUserRoles('${user.email}')" style="
                        flex: 1;
                        padding: 6px 10px;
                        font-size: 11px;
                        border: 1px solid #009688;
                        background: white;
                        color: #009688;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#009688'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='#009688';">
                        ‚úèÔ∏è Editar
                    </button>
                    
                    ${!isAdmin || user.email !== appContext.email ? `
                        <button onclick="confirmDeleteUser('${user.email}')" style="
                            flex: 1;
                            padding: 6px 10px;
                            font-size: 11px;
                            border: 1px solid #F44336;
                            background: white;
                            color: #F44336;
                            border-radius: 4px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='#F44336'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='#F44336';">
                            üóëÔ∏è Deletar
                        </button>
                    ` : `
                        <button disabled style="
                            flex: 1;
                            padding: 6px 10px;
                            font-size: 11px;
                            border: 1px solid #ddd;
                            background: #f5f5f5;
                            color: #999;
                            border-radius: 4px;
                            cursor: not-allowed;
                        ">
                            üîí Protegido
                        </button>
                    `}
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = usersHtml;
    
    debugLog('success', `‚úÖ ${users.length} usu√°rios renderizados (layout compacto)`);
}

function closeAddUserModal() {
    const modal = document.getElementById('addUserModal');
    if (modal) modal.remove();
}

async function saveNewUser() {
    try {
        const email = document.getElementById('newUserEmail').value.trim();
        
        if (!email) {
            showError('Digite um email v√°lido');
            return;
        }
        
        // Validar formato de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showError('Email inv√°lido');
            return;
        }
        
        // Coletar roles selecionadas
        const selectedRoles = [];
        
        if (document.getElementById('role_admin').checked) selectedRoles.push('Admin');
        if (document.getElementById('role_abertura').checked) selectedRoles.push('Abertura');
        if (document.getElementById('role_qualidade').checked) selectedRoles.push('Qualidade');
        if (document.getElementById('role_lideranca').checked) selectedRoles.push('Lideran√ßa');
        if (document.getElementById('role_espectador').checked) selectedRoles.push('Espectador');
        
        if (selectedRoles.length === 0) {
            showError('Selecione pelo menos uma role');
            return;
        }
        
        showLoading('Adicionando usu√°rio...');
        
        // Adicionar cada role
        for (let i = 0; i < selectedRoles.length; i++) {
            const result = await apiCall('addUserRole', [email, selectedRoles[i]]);
            
            if (!result.success && !result.message.includes('j√° possui')) {
                throw new Error(result.message);
            }
        }
        
        showSuccess(`‚úÖ Usu√°rio ${email} adicionado com ${selectedRoles.length} role(s)`);
        
        closeAddUserModal();
        loadUsers();
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao adicionar usu√°rio', { error: error.message });
        showError('Erro ao adicionar usu√°rio: ' + error.message);
        hideLoading();
    }
}

/**
 * Editar roles de um usu√°rio
 */
/**
 * Editar roles de um usu√°rio - VERS√ÉO CORRIGIDA
 */
async function editUserRoles(email) {
    try {
        debugLog('info', '‚úèÔ∏è Editando roles do usu√°rio', { email });
        
        showLoading('Carregando roles do usu√°rio...');
        
        const users = await apiCall('getAllUsers');
        const user = users.find(u => u.email === email);
        
        if (!user) {
            showError('Usu√°rio n√£o encontrado');
            hideLoading();
            return;
        }
        
        hideLoading();
        
        // ‚úÖ CORRE√á√ÉO: Salvar roles no window para evitar problemas com JSON
        window.currentEditingUserRoles = user.roles;
        
        const modalHtml = `
            <div id="editUserRolesModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 1rem; color: #009688;">‚úèÔ∏è Editar Roles de ${email}</h3>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>üé≠ Roles Ativas</label>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="edit_role_admin" value="Admin" ${user.roles.indexOf('Admin') !== -1 ? 'checked' : ''}>
                                <span class="role-badge admin">Admin</span>
                                <span style="font-size: 13px; color: #666;">Acesso total</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="edit_role_abertura" value="Abertura" ${user.roles.indexOf('Abertura') !== -1 ? 'checked' : ''}>
                                <span class="role-badge abertura">Abertura</span>
                                <span style="font-size: 13px; color: #666;">Criar RNCs</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="edit_role_qualidade" value="Qualidade" ${user.roles.indexOf('Qualidade') !== -1 ? 'checked' : ''}>
                                <span class="role-badge qualidade">Qualidade</span>
                                <span style="font-size: 13px; color: #666;">Editar Qualidade</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="edit_role_lideranca" value="Lideran√ßa" ${user.roles.indexOf('Lideran√ßa') !== -1 ? 'checked' : ''}>
                                <span class="role-badge lideranca">Lideran√ßa</span>
                                <span style="font-size: 13px; color: #666;">Editar Lideran√ßa</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="edit_role_espectador" value="Espectador" ${user.roles.indexOf('Espectador') !== -1 ? 'checked' : ''}>
                                <span class="role-badge espectador">Espectador</span>
                                <span style="font-size: 13px; color: #666;">Visualizar</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 30px;">
                        <button onclick="closeEditUserRolesModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="saveUserRolesFixed('${email}')" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao editar roles', { error: error.message });
        showError('Erro ao carregar roles: ' + error.message);
        hideLoading();
    }
}

/**
 * Salvar roles do usu√°rio - VERS√ÉO CORRIGIDA
 */
async function saveUserRolesFixed(email) {
    try {
        showLoading('Salvando roles...');
        
        // Coletar novas roles
        const newRoles = [];
        
        if (document.getElementById('edit_role_admin').checked) newRoles.push('Admin');
        if (document.getElementById('edit_role_abertura').checked) newRoles.push('Abertura');
        if (document.getElementById('edit_role_qualidade').checked) newRoles.push('Qualidade');
        if (document.getElementById('edit_role_lideranca').checked) newRoles.push('Lideran√ßa');
        if (document.getElementById('edit_role_espectador').checked) newRoles.push('Espectador');
        
        if (newRoles.length === 0) {
            showError('O usu√°rio deve ter pelo menos uma role');
            hideLoading();
            return;
        }
        
        // ‚úÖ USAR ROLES SALVAS NO WINDOW
        const oldRoles = window.currentEditingUserRoles || [];
        
        // Remover roles antigas que n√£o est√£o mais selecionadas
        for (let i = 0; i < oldRoles.length; i++) {
            if (newRoles.indexOf(oldRoles[i]) === -1) {
                await apiCall('removeUserRole', [email, oldRoles[i]]);
                debugLog('info', `üóëÔ∏è Role removida: ${oldRoles[i]}`);
            }
        }
        
        // Adicionar novas roles
        for (let i = 0; i < newRoles.length; i++) {
            if (oldRoles.indexOf(newRoles[i]) === -1) {
                await apiCall('addUserRole', [email, newRoles[i]]);
                debugLog('info', `‚ûï Role adicionada: ${newRoles[i]}`);
            }
        }
        
        showSuccess('‚úÖ Roles atualizadas com sucesso!');
        
        closeEditUserRolesModal();
        loadUsers();
        hideLoading();
        
        // Limpar vari√°vel tempor√°ria
        delete window.currentEditingUserRoles;
        
        // Se for o pr√≥prio usu√°rio, recarregar p√°gina
        if (email === appContext.email) {
            showInfo('Suas permiss√µes foram alteradas. Recarregando p√°gina...');
            setTimeout(() => location.reload(), 2000);
        }
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao salvar roles', { error: error.message });
        showError('Erro ao salvar roles: ' + error.message);
        hideLoading();
    }
}


function closeEditUserRolesModal() {
    const modal = document.getElementById('editUserRolesModal');
    if (modal) modal.remove();
    
    // Limpar vari√°vel tempor√°ria
    if (window.currentEditingUserRoles) {
        delete window.currentEditingUserRoles;
    }
}

async function saveUserRoles(email, oldRoles) {
    try {
        showLoading('Salvando roles...');
        
        // Coletar novas roles
        const newRoles = [];
        
        if (document.getElementById('edit_role_admin').checked) newRoles.push('Admin');
        if (document.getElementById('edit_role_abertura').checked) newRoles.push('Abertura');
        if (document.getElementById('edit_role_qualidade').checked) newRoles.push('Qualidade');
        if (document.getElementById('edit_role_lideranca').checked) newRoles.push('Lideran√ßa');
        if (document.getElementById('edit_role_espectador').checked) newRoles.push('Espectador');
        
        if (newRoles.length === 0) {
            showError('O usu√°rio deve ter pelo menos uma role');
            hideLoading();
            return;
        }
        
        // Remover roles antigas que n√£o est√£o mais selecionadas
        for (let i = 0; i < oldRoles.length; i++) {
            if (newRoles.indexOf(oldRoles[i]) === -1) {
                await apiCall('removeUserRole', [email, oldRoles[i]]);
            }
        }
        
        // Adicionar novas roles
        for (let i = 0; i < newRoles.length; i++) {
            if (oldRoles.indexOf(newRoles[i]) === -1) {
                await apiCall('addUserRole', [email, newRoles[i]]);
            }
        }
        
        showSuccess('‚úÖ Roles atualizadas com sucesso!');
        
        closeEditUserRolesModal();
        loadUsers();
        hideLoading();
        
        // Se for o pr√≥prio usu√°rio, recarregar p√°gina
        if (email === appContext.email) {
            showInfo('Suas permiss√µes foram alteradas. Recarregando p√°gina...');
            setTimeout(() => location.reload(), 2000);
        }
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao salvar roles', { error: error.message });
        showError('Erro ao salvar roles: ' + error.message);
        hideLoading();
    }
}

/**
 * Confirmar remo√ß√£o de usu√°rio
 */
function confirmDeleteUser(email) {
    if (email === appContext.email) {
        showError('Voc√™ n√£o pode remover a si mesmo!');
        return;
    }
    
    if (confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nDeseja realmente remover TODAS as permiss√µes do usu√°rio:\n${email}\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        deleteUser(email);
    }
}

async function deleteUser(email) {
    try {
        showLoading('Removendo usu√°rio...');
        
        // Buscar todas as roles do usu√°rio
        const users = await apiCall('getAllUsers');
        const user = users.find(u => u.email === email);
        
        if (!user) {
            showError('Usu√°rio n√£o encontrado');
            hideLoading();
            return;
        }
        
        // Remover todas as roles
        for (let i = 0; i < user.roles.length; i++) {
            await apiCall('removeUserRole', [email, user.roles[i]]);
        }
        
        showSuccess(`‚úÖ Usu√°rio ${email} removido com sucesso`);
        
        loadUsers();
        hideLoading();
        
    } catch (error) {
        debugLog('error', '‚ùå Erro ao remover usu√°rio', { error: error.message });
        showError('Erro ao remover usu√°rio: ' + error.message);
        hideLoading();
    }
}

/**
 * Recarrega contexto e atualiza formul√°rios
 * DEPLOY 30 - VERS√ÉO CORRIGIDA FINAL
 */
function reloadContextAndForms() {
  try {
    console.log('üîµ [INICIO] reloadContextAndForms()');
    debugLog('info', 'üîÑ Recarregando contexto e formul√°rios...');
    showLoading('Atualizando configura√ß√µes...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('üîµ result.success:', result.success);
        
        if (result.success) {
          // ‚úÖ Atualizar contexto global
          appContext = result.context;
          console.log('üîµ appContext atualizado - Campos:', Object.keys(appContext.fieldsConfig).length);
          
          debugLog('success', '‚úÖ Contexto recarregado', {
              email: appContext.email,
              fieldsCount: Object.keys(appContext.fieldsConfig).length,
              listsCount: Object.keys(appContext.lists).length
          });
          
          // ‚úÖ Atualizar listas em todos os selects
          console.log('üîµ Atualizando listas...');
          Object.keys(appContext.lists).forEach(function(listName) {
              var selects = document.querySelectorAll('select[data-list="' + listName + '"]');
              selects.forEach(function(select) {
                  var currentValue = select.value;
                  select.innerHTML = '<option value="">Selecione...</option>';
                  appContext.lists[listName].forEach(function(item) {
                      var option = document.createElement('option');
                      option.value = item;
                      option.textContent = item;
                      if (item === currentValue) option.selected = true;
                      select.appendChild(option);
                  });
              });
          });
          
          // ‚úÖ CORRE√á√ÉO: For√ßar re-renderiza√ß√£o da aba ativa
          console.log('üîµ Verificando aba ativa...');
          
          // Buscar pela classe 'active' nas abas de conte√∫do
          var abrirContent = document.getElementById('tab-abrir');
          var editarContent = document.getElementById('tab-editar');
          
          console.log('  - #tab-abrir encontrado:', !!abrirContent);
          console.log('  - #tab-editar encontrado:', !!editarContent);
          
          if (abrirContent && abrirContent.classList.contains('active')) {
              console.log('  ‚úÖ ABA ABRIR ATIVA - RE-RENDERIZANDO');
              renderAberturaForm();
              console.log('  ‚úÖ Formul√°rio Abrir re-renderizado!');
          } else {
              console.log('  ‚ö†Ô∏è Aba Abrir N√ÉO est√° ativa');
          }
          
          if (editarContent && editarContent.classList.contains('active')) {
              console.log('  ‚úÖ ABA EDITAR ATIVA - RE-RENDERIZANDO');
              if (typeof window.currentRnc !== 'undefined' && window.currentRnc && window.currentRnc['N¬∫ RNC']) {
                  console.log('  - RNC carregada:', window.currentRnc['N¬∫ RNC']);
                  loadRncForEdit(window.currentRnc['N¬∫ RNC']);
                  console.log('  ‚úÖ Formul√°rio Editar re-renderizado!');
              } else {
                  console.log('  ‚ö†Ô∏è Nenhuma RNC carregada');
              }
          } else {
              console.log('  ‚ö†Ô∏è Aba Editar N√ÉO est√° ativa');
          }
          
          console.log('üü¢ [FIM] Processo completo!');
          showSuccess('‚úÖ Formul√°rios atualizados!');
          hideLoading();
          
        } else {
          console.error('üî¥ result.success = false');
          showError('Erro ao recarregar: ' + result.error);
          hideLoading();
        }
      })
      .withFailureHandler(function(error) {
        console.error('üî¥ Erro:', error);
        showError('Erro ao recarregar: ' + error);
        hideLoading();
      })
      .reloadUserContext();
      
  } catch (error) {
    console.error('üî¥ Exce√ß√£o:', error.message);
    debugLog('error', '‚ùå Erro ao recarregar', { error: error.message });
    showError('Erro: ' + error.message);
    hideLoading();
  }
}

/**
 * Atualiza abas sem recarregar p√°gina
 * Deploy 44 - Corre√ß√£o para aba Abrir RNC
 */
/**
 * Atualiza TODAS as abas ap√≥s mudan√ßa de configura√ß√£o
 * Deploy 45 - For√ßa atualiza√ß√£o mesmo se aba n√£o estiver ativa
 */
function reloadPageAfterConfigChange(action, itemName, delayMs) {
    var messages = {
        'created': '‚úÖ Campo criado: "' + itemName + '"',
        'updated': '‚úÖ Campo atualizado: "' + itemName + '"',
        'deleted': '‚úÖ Campo removido: "' + itemName + '"'
    };
    
    console.log('üîÑ [NO-RELOAD] Atualizando TODAS as abas (ativas ou n√£o)');
    
    // Fechar modais
    document.querySelectorAll('[id$="Modal"]').forEach(function(modal) {
        if (modal && modal.parentNode) modal.remove();
    });
    
    // Esconder loading
    var loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) loadingOverlay.classList.add('hidden');
    
    // Mensagem de sucesso
    showSuccess(messages[action] + ' - Atualizando formul√°rios...');
    
    // ‚úÖ FOR√áAR RELOAD DO CONTEXTO
    showLoading('Atualizando configura√ß√µes...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('üîµ [UPDATE] Callback recebido');
            
            if (result.success) {
                console.log('‚úÖ [UPDATE] Contexto recarregado');
                
                // ‚úÖ ATUALIZAR CONTEXTO GLOBAL
                appContext = result.context;
                
                console.log('‚úÖ [UPDATE] appContext atualizado');
                console.log('üì¶ [UPDATE] Campos:', Object.keys(appContext.fieldsConfig));
                
                // ‚úÖ RESETAR CACHE DE ABAS (for√ßar re-renderiza√ß√£o na pr√≥xima vez)
                console.log('üîÑ [UPDATE] Resetando cache de abas');
                loadedTabs.abrir = false;
                loadedTabs.editar = false;
                
                // ‚úÖ FOR√áAR RE-RENDERIZA√á√ÉO DA ABA ABRIR (SEMPRE, MESMO SE N√ÉO ATIVA)
                console.log('üìù [UPDATE] FOR√áANDO re-renderiza√ß√£o da aba Abrir');
                try {
                    renderAberturaForm();
                    console.log('‚úÖ [UPDATE] Aba Abrir re-renderizada com sucesso');
                } catch (error) {
                    console.error('‚ùå [UPDATE] Erro ao re-renderizar Abrir:', error);
                }
                
                // ‚úÖ SE ABA EDITAR EST√Å ATIVA E TEM RNC CARREGADA, RE-RENDERIZAR
                var editarContent = document.getElementById('tab-editar');
                if (editarContent && editarContent.classList.contains('active')) {
                    console.log('‚úèÔ∏è [UPDATE] Aba Editar est√° ativa');
                    
                    if (window.currentRnc && window.currentRnc['N¬∫ RNC']) {
                        console.log('üîÑ [UPDATE] Re-renderizando Editar com RNC:', window.currentRnc['N¬∫ RNC']);
                        try {
                            loadRncForEdit(window.currentRnc['N¬∫ RNC']);
                            console.log('‚úÖ [UPDATE] Aba Editar re-renderizada');
                        } catch (error) {
                            console.error('‚ùå [UPDATE] Erro ao re-renderizar Editar:', error);
                        }
                    } else {
                        console.log('‚ö†Ô∏è [UPDATE] Nenhuma RNC carregada');
                    }
                } else {
                    console.log('‚ö†Ô∏è [UPDATE] Aba Editar n√£o est√° ativa, mas cache resetado para pr√≥xima vez');
                }
                
                // ‚úÖ RECARREGAR CONFIGURA√á√ïES
                console.log('‚öôÔ∏è [UPDATE] Recarregando configura√ß√µes');
                loadConfigurations();
                
                hideLoading();
                showSuccess('‚úÖ Formul√°rios atualizados! As abas Abrir e Editar foram atualizadas.');
                
                console.log('üü¢ [UPDATE] Processo conclu√≠do');
                
            } else {
                console.error('‚ùå [UPDATE] result.success = false');
                hideLoading();
                showError('Erro ao atualizar: ' + result.error);
            }
        })
        .withFailureHandler(function(error) {
            console.error('üî¥ [UPDATE] Erro:', error);
            hideLoading();
            showError('Erro ao atualizar: ' + error);
        })
        .reloadUserContext();
}

/**
 * Detecta e corrige tela branca
 * Deploy 41 - Prote√ß√£o contra travamento
 */
window.addEventListener('load', function() {
    console.log('‚úÖ P√°gina carregada completamente');
    
    // Se ap√≥s 5 segundos o body estiver vazio, recarregar
    setTimeout(function() {
        if (document.body.children.length < 3) {
            console.warn('‚ö†Ô∏è Tela branca detectada, for√ßando reload');
            location.reload();
        }
    }, 5000);
});

// Detectar erros de carregamento
window.addEventListener('error', function(e) {
    console.error('‚ùå Erro de carregamento:', e.message);
    
    // Se for erro cr√≠tico, tentar recarregar
    if (e.message.includes('script') || e.message.includes('load')) {
        console.warn('‚ö†Ô∏è Erro cr√≠tico, tentando recarregar em 3 segundos...');
        setTimeout(function() {
            location.reload();
        }, 3000);
    }
});



function updateActiveFormSections() {
  try {
    debugLog('info', 'üîÑ Atualizando se√ß√µes ativas de formul√°rios');
    
    // Verificar se est√° na aba "Abrir RNC"
    var abrirTab = document.querySelector('[data-tab="tab-abrir"]');
    if (abrirTab && abrirTab.classList.contains('active')) {
      debugLog('info', 'üìù Atualizando formul√°rio de Abrir RNC');
      renderAberturaForm();
    }
    
    // Verificar se est√° na aba "Editar RNC"
    var editarTab = document.querySelector('[data-tab="tab-editar"]');
    if (editarTab && editarTab.classList.contains('active')) {
      debugLog('info', '‚úèÔ∏è Atualizando formul√°rio de Editar RNC');
      
      // Se h√° uma RNC carregada, recarregar o formul√°rio completo
      if (typeof window.currentRnc !== 'undefined' && window.currentRnc && window.currentRnc['N¬∫ RNC']) {
        loadRncForEdit(window.currentRnc['N¬∫ RNC']);
      } else {
        // Apenas atualizar as se√ß√µes dispon√≠veis
        var sections = appContext.sections || [];
        for (var i = 0; i < sections.length; i++) {
          var section = sections[i];
          if (section.ativo === 'Sim') {
            var sectionFields = appContext.fieldsConfig[section.nome] || [];
            if (sectionFields.length > 0) {
              var containerId = section.nome.toLowerCase().replace(/\s+/g, '-') + '-form';
              var container = document.getElementById(containerId);
              if (container) {
                debugLog('info', 'üîÑ Atualizando se√ß√£o: ' + section.nome);
                // Renderizar campos da se√ß√£o
                renderFormSection(container, sectionFields, section.nome);
              }
            }
          }
        }
      }
    }
    
    debugLog('success', '‚úÖ Formul√°rios atualizados com sucesso');
    
  } catch (error) {
    debugLog('error', '‚ùå Erro ao atualizar formul√°rios', { error: error.message });
  }
}

/**
 * Renderiza uma se√ß√£o espec√≠fica do formul√°rio
 * Deploy 30 - Fun√ß√£o auxiliar para atualiza√ß√£o de se√ß√µes
 */
function renderFormSection(container, fields, sectionName) {
  try {
    if (!container || !fields || fields.length === 0) {
      debugLog('warning', 'Container ou campos inv√°lidos para se√ß√£o', { sectionName: sectionName });
      return;
    }
    
    // Verificar permiss√£o para a se√ß√£o
    var permission = appContext.permissions[sectionName] || 'visualizar';
    
    if (permission === 'negar') {
      container.innerHTML = '<div class="alert alert-warning">üîí Sem permiss√£o para visualizar esta se√ß√£o</div>';
      return;
    }
    
    // Renderizar campos
    var fieldsHtml = fields.map(function(field) {
      var currentValue = '';
      
      // Se existe uma RNC carregada, buscar o valor atual
      if (typeof window.currentRnc !== 'undefined' && window.currentRnc) {
        currentValue = window.currentRnc[field.name] || '';
      }
      
      return renderField(field, currentValue, sectionName);
    }).join('');
    
    container.innerHTML = `
      <div class="form-section">
        <h3>üìã ${sectionName}</h3>
        <div class="form-grid">
          ${fieldsHtml}
        </div>
      </div>
    `;
    
    debugLog('success', 'Se√ß√£o renderizada', { 
      section: sectionName, 
      fieldsCount: fields.length 
    });
    
  } catch (error) {
    debugLog('error', 'Erro ao renderizar se√ß√£o', { 
      section: sectionName, 
      error: error.message 
    });
  }
}

// ========================================
// SISTEMA MULTISELECT - FUN√á√ïES
// ========================================

/**
 * Adiciona um chip ao container
 */
function addChip(selectId, containerId, fieldName) {
    const select = document.getElementById(selectId);
    const container = document.getElementById(containerId);
    const hiddenInput = document.querySelector(`input[name="${fieldName}"]`);
    
    const selectedValue = select.value;
    const selectedText = select.options[select.selectedIndex].text;
    
    if (!selectedValue) {
        showNotification('‚ö†Ô∏è Selecione uma op√ß√£o primeiro', 'warning');
        return;
    }
    
    // Verificar se j√° existe
    const existingValues = getChipValues(containerId);
    if (existingValues.includes(selectedValue)) {
        showNotification('‚ö†Ô∏è Esta op√ß√£o j√° foi adicionada', 'warning');
        select.value = '';
        return;
    }
    
    // Criar chip
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.dataset.value = selectedValue;
    chip.innerHTML = `
        ${selectedText}
        <button type="button" onclick="removeChip(this, '${containerId}', '${fieldName}')" title="Remover">
            √ó
        </button>
    `;
    
    container.appendChild(chip);
    container.classList.remove('empty');
    
    // Atualizar input hidden
    updateHiddenInput(containerId, fieldName);
    
    // Resetar select
    select.value = '';
    
    debugLog('info', `‚úÖ Chip adicionado: ${selectedText}`, { fieldName, value: selectedValue });
}

/**
 * Remove um chip
 */
function removeChip(button, containerId, fieldName) {
    const chip = button.parentElement;
    const container = document.getElementById(containerId);
    
    chip.style.animation = 'chipAppear 0.2s ease reverse';
    
    setTimeout(() => {
        chip.remove();
        
        // Verificar se ficou vazio
        if (container.children.length === 0) {
            container.classList.add('empty');
        }
        
        // Atualizar input hidden
        updateHiddenInput(containerId, fieldName);
        
        debugLog('info', `üóëÔ∏è Chip removido`, { fieldName });
    }, 200);
}

/**
 * Obt√©m valores atuais dos chips
 */
function getChipValues(containerId) {
    const container = document.getElementById(containerId);
    const chips = container.querySelectorAll('.chip');
    
    return Array.from(chips).map(chip => chip.dataset.value);
}

/**
 * Atualiza o input hidden com valores separados por ponto-e-v√≠rgula
 */
function updateHiddenInput(containerId, fieldName) {
    const values = getChipValues(containerId);
    const hiddenInput = document.querySelector(`input[name="${fieldName}"]`);
    
    if (hiddenInput) {
        hiddenInput.value = values.join('; ');
        debugLog('debug', `üíæ Hidden input atualizado`, { 
            fieldName, 
            value: hiddenInput.value,
            count: values.length 
        });
    }
}

/**
 * Inicializa chips a partir de um valor salvo
 */
function initializeMultiselectChips(containerId, savedValue, fieldName, isReadOnly) {
    const container = document.getElementById(containerId);

    if (!container) {
        return;
    }

    // ‚úÖ SEMPRE limpar container primeiro (corrige bug de valores persistentes)
    container.innerHTML = '';

    if (!savedValue) {
        container.classList.add('empty');
        return;
    }

    // Dividir valores salvos
    const values = savedValue.split(';').map(v => v.trim()).filter(v => v);

    if (values.length === 0) {
        container.classList.add('empty');
        return;
    }
    
    // Criar chips para cada valor
    values.forEach(value => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.dataset.value = value;
        chip.innerHTML = `
            ${value}
            ${!isReadOnly ? `<button type="button" onclick="removeChip(this, '${containerId}', '${fieldName}')" title="Remover">√ó</button>` : ''}
        `;
        
        container.appendChild(chip);
    });
    
    container.classList.remove('empty');
    
    debugLog('success', `‚úÖ Chips inicializados: ${values.length}`, { fieldName, values });
}

/**
 * Obt√©m todos os valores multiselect do formul√°rio
 */
function getAllMultiselectValues() {
    const multiselectFields = document.querySelectorAll('.multiselect-wrapper');
    const values = {};
    
    multiselectFields.forEach(wrapper => {
        const fieldName = wrapper.dataset.field;
        const hiddenInput = wrapper.querySelector('input[type="hidden"]');
        
        if (hiddenInput) {
            values[fieldName] = hiddenInput.value;
        }
    });
    
    return values;
}
/**
 * Adiciona chip automaticamente ao selecionar no dropdown
 * Vers√£o simplificada SEM bot√£o
 */
function addChipOnSelect(selectElement, containerId, fieldName) {
    const selectedValue = selectElement.value;
    const selectedText = selectElement.options[selectElement.selectedIndex].text;
    
    if (!selectedValue) {
        return; // Op√ß√£o padr√£o "Selecione..."
    }
    
    const container = document.getElementById(containerId);
    const hiddenInput = document.querySelector(`input[name="${fieldName}"]`);
    
    // Verificar se j√° existe
    const existingValues = getChipValues(containerId);
    if (existingValues.includes(selectedValue)) {
        showNotification('‚ö†Ô∏è Esta op√ß√£o j√° foi adicionada', 'warning');
        selectElement.value = ''; // Resetar select
        return;
    }
    
    // Criar chip
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.dataset.value = selectedValue;
    chip.innerHTML = `
        ${selectedText}
        <button type="button" onclick="removeChip(this, '${containerId}', '${fieldName}')" title="Remover">
            √ó
        </button>
    `;
    
    container.appendChild(chip);
    container.classList.remove('empty');
    
    // Atualizar input hidden
    updateHiddenInput(containerId, fieldName);
    
    // Resetar select
    selectElement.value = '';
    
    debugLog('info', `‚úÖ Chip adicionado automaticamente: ${selectedText}`, { fieldName, value: selectedValue });
}

// ========== SISTEMA DE IMPRESS√ÉO - DEPLOY 34 ==========

async function printRnc(rncNumber) {
  try {
    // ‚úÖ VERIFICAR SE √â ADMIN
    if (!appContext || !appContext.isAdmin) {
      showError('‚ùå Apenas administradores podem imprimir RNCs');
      debugLog('warning', '‚ö†Ô∏è Tentativa de impress√£o negada', { 
        user: appContext?.email,
        isAdmin: appContext?.isAdmin 
      });
      return;
    }
    
    debugLog('info', 'üñ®Ô∏è Iniciando impress√£o', { rncNumber });
    
    if (!rncNumber || rncNumber === '') {
      showError('‚ùå N√∫mero da RNC inv√°lido!');
      return;
    }
    
    showLoading('‚è≥ Preparando impress√£o...');
    
    const result = await apiCall('fillPrintTemplateAndGetUrl', [rncNumber], 1, 60000);
    
    if (!result || !result.success) {
      throw new Error(result.error || 'Erro ao preparar impress√£o');
    }
    
    debugLog('success', '‚úÖ Template preenchido', { 
      fieldsProcessed: result.fieldsProcessed,
      printUrl: result.printUrl 
    });
    
    hideLoading();
    
    // ‚úÖ ABRIR DIRETAMENTE A IMPRESS√ÉO (sem modal)
    openPrintWindow(result);
    
  } catch (error) {
    debugLog('error', '‚ùå Erro na impress√£o', { error: error.message });
    hideLoading();
    showError('Erro ao preparar impress√£o: ' + error.message);
  }
}

function showPrintDialog(result) {
  const modal = document.createElement('div');
  modal.id = 'printModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;
  
  modal.innerHTML = `
    <div style="
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    ">
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #009688, #00796B); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px;">
          üñ®Ô∏è
        </div>
        <div>
          <h2 style="margin: 0; font-size: 24px; color: #222;">Impress√£o Preparada</h2>
          <p style="margin: 4px 0 0 0; color: #666; font-size: 14px;">RNC ${result.rncNumber}</p>
        </div>
      </div>
      
      <div style="background: #F5F5F5; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span style="color: #666; font-size: 14px;">üìã Campos preenchidos:</span>
          <strong style="color: #009688; font-size: 18px;">${result.fieldsProcessed}</strong>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="color: #666; font-size: 14px;">‚è≠Ô∏è Campos ignorados:</span>
          <strong style="color: #888; font-size: 18px;">${result.fieldsSkipped}</strong>
        </div>
      </div>
      
      <div style="background: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <p style="margin: 0; color: #2E7D32; font-size: 14px; line-height: 1.6;">
          ‚úÖ <strong>Pr√≥ximo passo:</strong><br>
          A aba "Print" foi preenchida com os dados da RNC.<br>
          Clique no bot√£o abaixo para abrir a planilha e imprimir.
        </p>
      </div>
      
      <div style="display: flex; gap: 12px;">
        <button 
          id="btnCancelPrint"
          style="flex: 1; padding: 14px 24px; background: #F5F5F5; color: #666; border: none; border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer;"
        >
          ‚ùå Cancelar
        </button>
        
        <button 
          id="btnOpenPrint"
          style="flex: 2; padding: 14px 24px; background: linear-gradient(135deg, #009688, #00796B); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);"
        >
          üñ®Ô∏è Abrir e Imprimir
        </button>
      </div>
      
      <p style="margin: 16px 0 0 0; text-align: center; color: #999; font-size: 12px;">
        üí° Use CTRL+P ou Arquivo > Imprimir na planilha
      </p>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  function closeModal() {
    modal.remove();
  }
  
  document.getElementById('btnCancelPrint').addEventListener('click', function() {
    debugLog('info', '‚ùå Impress√£o cancelada pelo usu√°rio');
    closeModal();
  });
  
  document.getElementById('btnOpenPrint').addEventListener('click', function() {
    debugLog('info', '‚úÖ Abrindo planilha para impress√£o', { url: result.printUrl });
    window.open(result.printUrl, '_blank');
    setTimeout(() => {
      closeModal();
      showSuccess('‚úÖ Planilha aberta! Use CTRL+P para imprimir.');
    }, 1000);
  });
  
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });
}

function openPrintWindow(result) {
  // ‚úÖ ABRIR PREVIEW DO PDF EM NOVA ABA
  const pdfWindow = window.open(result.printUrl, '_blank', 'width=1200,height=800');
  
  if (!pdfWindow) {
    showError('‚ùå Bloqueador de popup detectado! Permita pop-ups para este site.');
    debugLog('error', 'Popup bloqueado pelo navegador');
    return;
  }
  
  // ‚úÖ MOSTRAR NOTIFICA√á√ÉO DE SUCESSO
  showSuccess(`‚úÖ Preview de impress√£o aberto! ${result.fieldsProcessed} campos preenchidos.`);
  
  debugLog('success', '‚úÖ Preview PDF aberto em nova aba', {
    rncNumber: result.rncNumber,
    url: result.printUrl
  });
  
  // ‚úÖ INSTRU√á√ïES PARA O USU√ÅRIO
  setTimeout(() => {
    showInfo('üí° No preview, clique no √≠cone da impressora ou use CTRL+P para imprimir');
  }, 2000);
}

window.printRnc = printRnc;

function showSuccessModal(rncNumber) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        ">
            <div style="font-size: 72px; margin-bottom: 20px;">‚úÖ</div>
            <h2 style="color: #10B981; margin-bottom: 15px; font-size: 28px;">
                RNC Criada com Sucesso!
            </h2>
            <div style="
                background: #F0FDF4;
                padding: 20px;
                border-radius: 12px;
                margin: 20px 0;
                border-left: 4px solid #10B981;
            ">
                <p style="color: #666; font-size: 14px; margin-bottom: 5px;">N√∫mero da RNC:</p>
                <p style="font-size: 36px; font-weight: bold; color: #009688; margin: 0;">
                    ${rncNumber}
                </p>
            </div>
            <p style="color: #666; margin: 20px 0;">
                üéâ Voc√™ pode criar outra RNC ou fechar esta janela
            </p>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="
                background: #009688;
                color: white;
                border: none;
                padding: 14px 40px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);
            " onmouseover="this.style.background='#00796B'" onmouseout="this.style.background='#009688'">
                OK, Entendi
            </button>
        </div>
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translateY(50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        </style>
    `;
    
    document.body.appendChild(modal);
    
    // Fechar ao clicar fora
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

/**
 * Fun√ß√£o de teste - Execute no console do navegador
 * Digite: testComparacao()
 */
function testComparacao() {
    console.clear();
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë   TESTE DE NORMALIZA√á√ÉO DE VALORES    ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    
    const testes = [
        { nome: 'N√∫mero vs String', old: 123, new: '123', esperado: false },
        { nome: 'Null vs Vazio', old: null, new: '', esperado: false },
        { nome: 'Undefined vs Vazio', old: undefined, new: '', esperado: false },
        { nome: 'Data BR vs ISO', old: '21/10/2025', new: '2025-10-21', esperado: false },
        { nome: 'String com espa√ßos', old: '  abc  ', new: 'abc', esperado: false },
        { nome: 'Valores diferentes', old: 'abc', new: 'xyz', esperado: true }
    ];
    
    let passou = 0;
    let falhou = 0;
    
    testes.forEach((teste, i) => {
        const campo = teste.nome.includes('Data') ? 'Data Teste' : 'Campo';
        const resultado = valuesAreDifferent(teste.old, teste.new, campo);
        const ok = resultado === teste.esperado;
        
        if (ok) {
            console.log(`‚úÖ Teste ${i + 1}: ${teste.nome}`);
            passou++;
        } else {
            console.log(`‚ùå Teste ${i + 1}: ${teste.nome} (esperado: ${teste.esperado}, obtido: ${resultado})`);
            falhou++;
        }
        console.log(`   Old: ${JSON.stringify(teste.old)} ‚Üí New: ${JSON.stringify(teste.new)}\n`);
    });
    
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log(`‚ïë  RESULTADO: ${passou}/${testes.length} testes passaram      ‚ïë`);
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    
    if (passou === testes.length) {
        console.log('üéâ TODOS OS TESTES PASSARAM! Corre√ß√£o funcionando corretamente.');
    } else {
        console.log('‚ö†Ô∏è Alguns testes falharam. Verifique a implementa√ß√£o.');
    }
}
    </script>
</body>
</html>
<!-- Force update 1764870979 -->
